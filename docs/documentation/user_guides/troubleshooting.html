<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Troubleshooting | Malloy Documentation</title>
    <link rel="stylesheet" href="/css/document.css" />
    <link
      rel="shortcut icon"
      type="image/x-icon"
      href="/img/favicon.ico"
    />
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-0M10W7C20Y"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
    
      gtag("config", "G-0M10W7C20Y");
    </script>
    <style>
      malloy-render::part(table-container) {
        width: 100%;
      }
    </style>
  </head>
  <body>
    <div class="top">
      <div class="header">
        <div class="header-banner">
          <a href="http://www.malloydata.dev" target="_blank">
            <img
              class="logo"
              src="/img/logo.png"
              alt="malloy logo"
            />
          </a>

          Malloy
          <span class="subtitle">Documentation</span>
        </div>
        <div class="header-right">
          <div class="header-links">
            <a href="https://github.com/malloydata/malloy" target="_blank"
              ><img
                src="/img/github.svg"
                style="transform: scale(0.5)"
            /></a>
            <a href="/slack" target="_blank"
              ><img src="/img/slack.svg"
            /></a>
          </div>
          <form onSubmit="() => alert('submit')" action="/search">
            <div class="search-input-outer">
              <img src="/img/search.svg" alt="search" />
              <input placeholder="Search" id="search-input" name="query" />
            </div>
            <input type="submit" style="display: none" />
          </form>
        </div>
      </div>
      <div class="main">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-section">
              <div id=about_malloy
                class="sidebar-section-title {% unless /documentation/index.html,/documentation/about/features.html,/documentation/about/tao.html contains page.url)} %}collapsed-this-isnt-working-its-always-collapsed-ben-took-it-out{% endunless %}"
              >
                About Malloy
                <img class="chevron-open" src="/img/section_open.svg" alt="section open"/>
                <img class="chevron-closed" src="/img/section_close.svg" alt="section closed"/>
              </div>
              <div class="sidebar-section-item-group">
                <div class='sidebar-item '>
              <a href="/documentation">
                <img src="/img/article_icon.svg" alt="document"/>
                What Is Malloy
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/about/features">
                <img src="/img/article_icon.svg" alt="document"/>
                Key Features
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/about/tao">
                <img src="/img/article_icon.svg" alt="document"/>
                The Tao of Malloy
              </a>
            </div>
              </div>
            </div>
        <div class="sidebar-section">
              <div id=setting_up malloy
                class="sidebar-section-title {% unless /documentation/setup/extension.html,/documentation/setup/database_support.html,/documentation/setup/config.html,/documentation/setup/cli.html contains page.url)} %}collapsed-this-isnt-working-its-always-collapsed-ben-took-it-out{% endunless %}"
              >
                Setting up Malloy
                <img class="chevron-open" src="/img/section_open.svg" alt="section open"/>
                <img class="chevron-closed" src="/img/section_close.svg" alt="section closed"/>
              </div>
              <div class="sidebar-section-item-group">
                <div class='sidebar-item '>
              <a href="/documentation/setup/extension">
                <img src="/img/article_icon.svg" alt="document"/>
                VS Code Extension
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/setup/database_support">
                <img src="/img/article_icon.svg" alt="document"/>
                Database Support
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/setup/config">
                <img src="/img/article_icon.svg" alt="document"/>
                Configuration
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/setup/cli">
                <img src="/img/article_icon.svg" alt="document"/>
                Malloy CLI
              </a>
            </div>
              </div>
            </div>
        <div class="sidebar-section">
              <div id=user_guides
                class="sidebar-section-title {% unless /documentation/user_guides/querying_a_model.html,/documentation/user_guides/quickstart_modeling.html,/documentation/user_guides/malloy_by_example.html,/documentation/user_guides/notebooks.html,/documentation/user_guides/publishing/explorer.html,/documentation/user_guides/publishing/publishing.html,/documentation/user_guides/publishing/connections.html,/documentation/user_guides/publishing/rest_api.html,/documentation/user_guides/publishing/publisher_sdk.html,/documentation/user_guides/publishing/mcp_agents.html,/documentation/user_guides/sql_experts1.html,/documentation/user_guides/sql_experts2.html,/documentation/user_guides/transform.html,/documentation/user_guides/malloy_for_dbt.html,/documentation/user_guides/troubleshooting.html contains page.url)} %}collapsed-this-isnt-working-its-always-collapsed-ben-took-it-out{% endunless %}"
              >
                User Guides
                <img class="chevron-open" src="/img/section_open.svg" alt="section open"/>
                <img class="chevron-closed" src="/img/section_close.svg" alt="section closed"/>
              </div>
              <div class="sidebar-section-item-group">
                <div class="sidebar-section">
              <div id=getting_started
                class="sidebar-section-title {% unless /documentation/user_guides/querying_a_model.html,/documentation/user_guides/quickstart_modeling.html,/documentation/user_guides/malloy_by_example.html contains page.url)} %}collapsed-this-isnt-working-its-always-collapsed-ben-took-it-out{% endunless %}"
              >
                Getting Started
                <img class="chevron-open" src="/img/section_open.svg" alt="section open"/>
                <img class="chevron-closed" src="/img/section_close.svg" alt="section closed"/>
              </div>
              <div class="sidebar-section-item-group">
                <div class='sidebar-item '>
              <a href="/documentation/user_guides/querying_a_model">
                <img src="/img/article_icon.svg" alt="document"/>
                Querying a Semantic Model
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/user_guides/quickstart_modeling">
                <img src="/img/article_icon.svg" alt="document"/>
                Building a Semantic Model
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/user_guides/malloy_by_example">
                <img src="/img/article_icon.svg" alt="document"/>
                Advanced Modeling
              </a>
            </div>
              </div>
            </div>
        <div class="sidebar-section">
              <div id=analyzing_& exploring
                class="sidebar-section-title {% unless /documentation/user_guides/notebooks.html,/documentation/user_guides/publishing/explorer.html contains page.url)} %}collapsed-this-isnt-working-its-always-collapsed-ben-took-it-out{% endunless %}"
              >
                Analyzing & Exploring
                <img class="chevron-open" src="/img/section_open.svg" alt="section open"/>
                <img class="chevron-closed" src="/img/section_close.svg" alt="section closed"/>
              </div>
              <div class="sidebar-section-item-group">
                <div class='sidebar-item '>
              <a href="/documentation/user_guides/notebooks">
                <img src="/img/article_icon.svg" alt="document"/>
                Analyzing with Notebooks
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/user_guides/publishing/explorer">
                <img src="/img/article_icon.svg" alt="document"/>
                Explorer UI
              </a>
            </div>
              </div>
            </div>
        <div class="sidebar-section">
              <div id=publishing
                class="sidebar-section-title {% unless /documentation/user_guides/publishing/publishing.html,/documentation/user_guides/publishing/connections.html,/documentation/user_guides/publishing/rest_api.html,/documentation/user_guides/publishing/publisher_sdk.html,/documentation/user_guides/publishing/mcp_agents.html contains page.url)} %}collapsed-this-isnt-working-its-always-collapsed-ben-took-it-out{% endunless %}"
              >
                Publishing
                <img class="chevron-open" src="/img/section_open.svg" alt="section open"/>
                <img class="chevron-closed" src="/img/section_close.svg" alt="section closed"/>
              </div>
              <div class="sidebar-section-item-group">
                <div class='sidebar-item '>
              <a href="/documentation/user_guides/publishing/publishing">
                <img src="/img/article_icon.svg" alt="document"/>
                Publish Your Models
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/user_guides/publishing/connections">
                <img src="/img/article_icon.svg" alt="document"/>
                Publisher Connections
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/user_guides/publishing/rest_api">
                <img src="/img/article_icon.svg" alt="document"/>
                REST API
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/user_guides/publishing/publisher_sdk">
                <img src="/img/article_icon.svg" alt="document"/>
                Publisher SDK (React)
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/user_guides/publishing/mcp_agents">
                <img src="/img/article_icon.svg" alt="document"/>
                MCP for AI Agents
              </a>
            </div>
              </div>
            </div>
        <div class="sidebar-section">
              <div id=for_sql users
                class="sidebar-section-title {% unless /documentation/user_guides/sql_experts1.html,/documentation/user_guides/sql_experts2.html contains page.url)} %}collapsed-this-isnt-working-its-always-collapsed-ben-took-it-out{% endunless %}"
              >
                For SQL Users
                <img class="chevron-open" src="/img/section_open.svg" alt="section open"/>
                <img class="chevron-closed" src="/img/section_close.svg" alt="section closed"/>
              </div>
              <div class="sidebar-section-item-group">
                <div class='sidebar-item '>
              <a href="/documentation/user_guides/sql_experts1">
                <img src="/img/article_icon.svg" alt="document"/>
                Malloy for SQL Folks
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/user_guides/sql_experts2">
                <img src="/img/article_icon.svg" alt="document"/>
                Refactoring SQL to Malloy
              </a>
            </div>
              </div>
            </div>
        <div class="sidebar-section">
              <div id=data_transformation
                class="sidebar-section-title {% unless /documentation/user_guides/transform.html,/documentation/user_guides/malloy_for_dbt.html contains page.url)} %}collapsed-this-isnt-working-its-always-collapsed-ben-took-it-out{% endunless %}"
              >
                Data Transformation
                <img class="chevron-open" src="/img/section_open.svg" alt="section open"/>
                <img class="chevron-closed" src="/img/section_close.svg" alt="section closed"/>
              </div>
              <div class="sidebar-section-item-group">
                <div class='sidebar-item '>
              <a href="/documentation/user_guides/transform">
                <img src="/img/article_icon.svg" alt="document"/>
                Transform & Materialize
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/user_guides/malloy_for_dbt">
                <img src="/img/article_icon.svg" alt="document"/>
                Malloy for dbt Users
              </a>
            </div>
              </div>
            </div>
        <div class='sidebar-item active'>
              <a href="/documentation/user_guides/troubleshooting">
                <img src="/img/article_icon.svg" alt="document"/>
                Troubleshooting
              </a>
            </div>
              </div>
            </div>
        <div class="sidebar-section">
              <div id=language_reference
                class="sidebar-section-title {% unless /documentation/language/statement.html,/documentation/language/source.html,/documentation/language/query.html,/documentation/language/views.html,/documentation/language/datatypes.html,/documentation/language/fields.html,/documentation/language/aggregates.html,/documentation/language/expressions.html,/documentation/language/functions.html,/documentation/language/filters.html,/documentation/language/calculations_windows.html,/documentation/language/order_by.html,/documentation/language/join.html,/documentation/language/nesting.html,/documentation/language/sql_sources.html,/documentation/language/imports.html,/documentation/language/connections.html,/documentation/language/tags.html,/documentation/language/quick_reference.html,/documentation/language/changelog.html,/documentation/language/dialect/bigquery.html,/documentation/language/dialect/presto-trino.html,/documentation/language/dialect/snowflake.html,/documentation/language/dialect/mysql.html,/documentation/language/dialect/duckdb.html,/documentation/language/dialect/postgres.html,/documentation/language/dialect/mssql-via-duckdb.html contains page.url)} %}collapsed-this-isnt-working-its-always-collapsed-ben-took-it-out{% endunless %}"
              >
                Language Reference
                <img class="chevron-open" src="/img/section_open.svg" alt="section open"/>
                <img class="chevron-closed" src="/img/section_close.svg" alt="section closed"/>
              </div>
              <div class="sidebar-section-item-group">
                <div class='sidebar-item '>
              <a href="/documentation/language/statement">
                <img src="/img/article_icon.svg" alt="document"/>
                Models
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/language/source">
                <img src="/img/article_icon.svg" alt="document"/>
                Sources
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/language/query">
                <img src="/img/article_icon.svg" alt="document"/>
                Queries
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/language/views">
                <img src="/img/article_icon.svg" alt="document"/>
                Views
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/language/datatypes">
                <img src="/img/article_icon.svg" alt="document"/>
                Data Types
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/language/fields">
                <img src="/img/article_icon.svg" alt="document"/>
                Fields
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/language/aggregates">
                <img src="/img/article_icon.svg" alt="document"/>
                Aggregates
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/language/expressions">
                <img src="/img/article_icon.svg" alt="document"/>
                Expressions
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/language/functions">
                <img src="/img/article_icon.svg" alt="document"/>
                Functions
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/language/filters">
                <img src="/img/article_icon.svg" alt="document"/>
                Filters
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/language/calculations_windows">
                <img src="/img/article_icon.svg" alt="document"/>
                Calculations (window functions)
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/language/order_by">
                <img src="/img/article_icon.svg" alt="document"/>
                Ordering and Limiting
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/language/join">
                <img src="/img/article_icon.svg" alt="document"/>
                Joins
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/language/nesting">
                <img src="/img/article_icon.svg" alt="document"/>
                Nested Views
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/language/sql_sources">
                <img src="/img/article_icon.svg" alt="document"/>
                SQL Sources
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/language/imports">
                <img src="/img/article_icon.svg" alt="document"/>
                Imports
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/language/connections">
                <img src="/img/article_icon.svg" alt="document"/>
                Connections
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/language/tags">
                <img src="/img/article_icon.svg" alt="document"/>
                Tags
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/language/quick_reference.html">
                <img src="/img/article_icon.svg" alt="document"/>
                Quick Reference
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/language/changelog">
                <img src="/img/article_icon.svg" alt="document"/>
                Change Log
              </a>
            </div>
        <div class="sidebar-section">
              <div id=dialects
                class="sidebar-section-title {% unless /documentation/language/dialect/bigquery.html,/documentation/language/dialect/presto-trino.html,/documentation/language/dialect/snowflake.html,/documentation/language/dialect/mysql.html,/documentation/language/dialect/duckdb.html,/documentation/language/dialect/postgres.html,/documentation/language/dialect/mssql-via-duckdb.html contains page.url)} %}collapsed-this-isnt-working-its-always-collapsed-ben-took-it-out{% endunless %}"
              >
                Dialects
                <img class="chevron-open" src="/img/section_open.svg" alt="section open"/>
                <img class="chevron-closed" src="/img/section_close.svg" alt="section closed"/>
              </div>
              <div class="sidebar-section-item-group">
                <div class='sidebar-item '>
              <a href="/documentation/language/dialect/bigquery">
                <img src="/img/article_icon.svg" alt="document"/>
                BigQuery
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/language/dialect/presto-trino">
                <img src="/img/article_icon.svg" alt="document"/>
                Presto / Trino
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/language/dialect/snowflake">
                <img src="/img/article_icon.svg" alt="document"/>
                Snowflake
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/language/dialect/mysql">
                <img src="/img/article_icon.svg" alt="document"/>
                MySQL
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/language/dialect/duckdb">
                <img src="/img/article_icon.svg" alt="document"/>
                DuckDB
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/language/dialect/postgres">
                <img src="/img/article_icon.svg" alt="document"/>
                PostgreSQL
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/language/dialect/mssql-via-duckdb">
                <img src="/img/article_icon.svg" alt="document"/>
                MSSQL via DuckDB
              </a>
            </div>
              </div>
            </div>
              </div>
            </div>
        <div class="sidebar-section">
              <div id=common_patterns
                class="sidebar-section-title {% unless /documentation/patterns/yoy.html,/documentation/patterns/foreign_sums.html,/documentation/patterns/reading_nested.html,/documentation/patterns/percent_of_total.html,/documentation/patterns/cohorts.html,/documentation/patterns/nested_subtotals.html,/documentation/patterns/other.html,/documentation/patterns/autobin.html,/documentation/patterns/moving_avg.html,/documentation/patterns/transform.html,/documentation/patterns/sessionize.html,/documentation/patterns/dim_index.html contains page.url)} %}collapsed-this-isnt-working-its-always-collapsed-ben-took-it-out{% endunless %}"
              >
                Common Patterns
                <img class="chevron-open" src="/img/section_open.svg" alt="section open"/>
                <img class="chevron-closed" src="/img/section_close.svg" alt="section closed"/>
              </div>
              <div class="sidebar-section-item-group">
                <div class='sidebar-item '>
              <a href="/documentation/patterns/yoy">
                <img src="/img/article_icon.svg" alt="document"/>
                Comparing Timeframes
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/patterns/foreign_sums">
                <img src="/img/article_icon.svg" alt="document"/>
                Foreign Sums and Averages
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/patterns/reading_nested">
                <img src="/img/article_icon.svg" alt="document"/>
                Reading Nested Data
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/patterns/percent_of_total">
                <img src="/img/article_icon.svg" alt="document"/>
                Percent of Total
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/patterns/cohorts">
                <img src="/img/article_icon.svg" alt="document"/>
                Cohort Analysis
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/patterns/nested_subtotals">
                <img src="/img/article_icon.svg" alt="document"/>
                Nested Subtotals
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/patterns/other">
                <img src="/img/article_icon.svg" alt="document"/>
                Bucketing with 'Other'
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/patterns/autobin">
                <img src="/img/article_icon.svg" alt="document"/>
                Auto-binning Histograms
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/patterns/moving_avg">
                <img src="/img/article_icon.svg" alt="document"/>
                Moving Average
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/patterns/transform">
                <img src="/img/article_icon.svg" alt="document"/>
                Transform Data
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/patterns/sessionize">
                <img src="/img/article_icon.svg" alt="document"/>
                Sessionize - Map/Reduce
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/patterns/dim_index">
                <img src="/img/article_icon.svg" alt="document"/>
                Dimensional Indexes
              </a>
            </div>
              </div>
            </div>
        <div class="sidebar-section">
              <div id=rendering_results
                class="sidebar-section-title {% unless /documentation/visualizations/about_rendering.html contains page.url)} %}collapsed-this-isnt-working-its-always-collapsed-ben-took-it-out{% endunless %}"
              >
                Rendering Results
                <img class="chevron-open" src="/img/section_open.svg" alt="section open"/>
                <img class="chevron-closed" src="/img/section_close.svg" alt="section closed"/>
              </div>
              <div class="sidebar-section-item-group">
                <div class='sidebar-item '>
              <a href="/documentation/visualizations/about_rendering">
                <img src="/img/article_icon.svg" alt="document"/>
                Overview
              </a>
            </div>
              </div>
            </div>
        <div class="sidebar-section">
              <div id=rendering_legacy docs
                class="sidebar-section-title {% unless /documentation/visualizations/overview.html,/documentation/visualizations/numbers.html,/documentation/visualizations/links.html,/documentation/visualizations/pivots.html,/documentation/visualizations/transpose.html,/documentation/visualizations/dashboards.html,/documentation/visualizations/lists.html,/documentation/visualizations/bar_charts.html,/documentation/visualizations/charts_line_chart.html,/documentation/visualizations/scatter_charts.html,/documentation/visualizations/shape_maps.html,/documentation/visualizations/segment_maps.html,/documentation/visualizations/legacy_renderer.html contains page.url)} %}collapsed-this-isnt-working-its-always-collapsed-ben-took-it-out{% endunless %}"
              >
                Rendering Legacy Docs
                <img class="chevron-open" src="/img/section_open.svg" alt="section open"/>
                <img class="chevron-closed" src="/img/section_close.svg" alt="section closed"/>
              </div>
              <div class="sidebar-section-item-group">
                <div class='sidebar-item '>
              <a href="/documentation/visualizations/overview">
                <img src="/img/article_icon.svg" alt="document"/>
                Overview
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/visualizations/numbers">
                <img src="/img/article_icon.svg" alt="document"/>
                Numbers
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/visualizations/links">
                <img src="/img/article_icon.svg" alt="document"/>
                Links
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/visualizations/pivots">
                <img src="/img/article_icon.svg" alt="document"/>
                Pivoted Tables
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/visualizations/transpose">
                <img src="/img/article_icon.svg" alt="document"/>
                Table Transpose
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/visualizations/dashboards">
                <img src="/img/article_icon.svg" alt="document"/>
                Dashboards
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/visualizations/lists">
                <img src="/img/article_icon.svg" alt="document"/>
                Lists
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/visualizations/bar_charts">
                <img src="/img/article_icon.svg" alt="document"/>
                Bar Charts
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/visualizations/charts_line_chart">
                <img src="/img/article_icon.svg" alt="document"/>
                Line Charts
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/visualizations/scatter_charts">
                <img src="/img/article_icon.svg" alt="document"/>
                Scatter Charts
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/visualizations/shape_maps">
                <img src="/img/article_icon.svg" alt="document"/>
                Shape Maps
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/visualizations/segment_maps">
                <img src="/img/article_icon.svg" alt="document"/>
                Segment Maps
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/visualizations/legacy_renderer">
                <img src="/img/article_icon.svg" alt="document"/>
                Legacy Renderer
              </a>
            </div>
              </div>
            </div>
        <div class="sidebar-section">
              <div id=malloysql
                class="sidebar-section-title {% unless /documentation/malloy_sql/index.html contains page.url)} %}collapsed-this-isnt-working-its-always-collapsed-ben-took-it-out{% endunless %}"
              >
                MalloySQL
                <img class="chevron-open" src="/img/section_open.svg" alt="section open"/>
                <img class="chevron-closed" src="/img/section_close.svg" alt="section closed"/>
              </div>
              <div class="sidebar-section-item-group">
                <div class='sidebar-item '>
              <a href="/documentation/malloy_sql/index">
                <img src="/img/article_icon.svg" alt="document"/>
                Using MalloySQL
              </a>
            </div>
              </div>
            </div>
        <div class="sidebar-section">
              <div id=malloy_cli
                class="sidebar-section-title {% unless /documentation/malloy_cli/index.html contains page.url)} %}collapsed-this-isnt-working-its-always-collapsed-ben-took-it-out{% endunless %}"
              >
                Malloy CLI
                <img class="chevron-open" src="/img/section_open.svg" alt="section open"/>
                <img class="chevron-closed" src="/img/section_close.svg" alt="section closed"/>
              </div>
              <div class="sidebar-section-item-group">
                <div class='sidebar-item '>
              <a href="/documentation/malloy_cli/index">
                <img src="/img/article_icon.svg" alt="document"/>
                The Malloy CLI
              </a>
            </div>
              </div>
            </div>
        <div class="sidebar-section">
              <div id=malloy_with python
                class="sidebar-section-title {% unless /documentation/malloy_python/python_package.html,/documentation/malloy_python/jupyter.html contains page.url)} %}collapsed-this-isnt-working-its-always-collapsed-ben-took-it-out{% endunless %}"
              >
                Malloy with Python
                <img class="chevron-open" src="/img/section_open.svg" alt="section open"/>
                <img class="chevron-closed" src="/img/section_close.svg" alt="section closed"/>
              </div>
              <div class="sidebar-section-item-group">
                <div class='sidebar-item '>
              <a href="/documentation/malloy_python/python_package">
                <img src="/img/article_icon.svg" alt="document"/>
                Malloy Python Package
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/malloy_python/jupyter">
                <img src="/img/article_icon.svg" alt="document"/>
                Malloy in Jupyter Notebooks
              </a>
            </div>
              </div>
            </div>
        <div class="sidebar-section">
              <div id=experiments_(in process features)
                class="sidebar-section-title {% unless /documentation/experiments/experiments.html,/documentation/experiments/joins.html,/documentation/experiments/sql_expressions.html,/documentation/experiments/window.html,/documentation/experiments/parameters.html,/documentation/experiments/composite_sources.html,/documentation/experiments/include.html,/documentation/experiments/persistence.html contains page.url)} %}collapsed-this-isnt-working-its-always-collapsed-ben-took-it-out{% endunless %}"
              >
                Experiments (in process features)
                <img class="chevron-open" src="/img/section_open.svg" alt="section open"/>
                <img class="chevron-closed" src="/img/section_close.svg" alt="section closed"/>
              </div>
              <div class="sidebar-section-item-group">
                <div class='sidebar-item '>
              <a href="/documentation/experiments/experiments">
                <img src="/img/article_icon.svg" alt="document"/>
                Experiments
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/experiments/joins">
                <img src="/img/article_icon.svg" alt="document"/>
                Join INNER/RIGHT/FULL
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/experiments/sql_expressions">
                <img src="/img/article_icon.svg" alt="document"/>
                SQL Expressions
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/experiments/window">
                <img src="/img/article_icon.svg" alt="document"/>
                Window Partitions
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/experiments/parameters">
                <img src="/img/article_icon.svg" alt="document"/>
                Parameters
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/experiments/composite_sources">
                <img src="/img/article_icon.svg" alt="document"/>
                Composite "Cube" Sources
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/experiments/include">
                <img src="/img/article_icon.svg" alt="document"/>
                Access Modifiers
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/experiments/persistence">
                <img src="/img/article_icon.svg" alt="document"/>
                Persistence
              </a>
            </div>
              </div>
            </div>
          </div>        <script src="/js/sidebar_state.js"></script>
        <div class="content">
          <div class="footer">
            
<div class="linear-navigation">
  <div class="item">
      <a href="malloy_for_dbt.html"><img src="/img/previous.svg" alt="previous"/>Malloy for dbt Users</a>
  </div>
  <div class="item">
      <a href="../language/statement.html">Models<img src="/img/next.svg" alt="next"/></a>
  </div>
</div> 
          </div>
          <div class="document-outer"><div class="document"><div class="title-row">
        
      <h1>
        <a id="troubleshooting" class="header-link anchor" href="#troubleshooting">
          Troubleshooting
        </a>
      </h1>
    
        <a class="edit-link" target="_blank" href="https://github.dev/malloydata/malloydata.github.io/blob/main/src/documentation/user_guides/troubleshooting.malloynb#C1">VSCode <img src="/img/open_notebook.svg" alt="document"/></a>
        </div>
      <p>Jump to the section that matches your symptom:</p>
<table>
<thead>
<tr>
<th>Symptom</th>

<th>Problem</th>
</tr>
</thead>
<tbody><tr>
<td>Row count multiplied after join</td>

<td><a href="#problem-1-non-unique-join-key">Non-Unique Join Key</a></td>
</tr>

<tr>
<td>Aggregates inflated 10x</td>

<td><a href="#problem-2-grain-mismatch">Grain Mismatch</a></td>
</tr>

<tr>
<td>Query takes minutes</td>

<td><a href="#problem-3-slow-query">Slow Query</a></td>
</tr>

<tr>
<td>Reference to undefined object</td>

<td><a href="#problem-4-circular-references">Circular References</a></td>
</tr>

<tr>
<td>Date filter syntax questions</td>

<td><a href="#problem-5-date-arithmetic">Date Arithmetic</a></td>
</tr>

<tr>
<td>Can't reference joined field in join</td>

<td><a href="#problem-6-multi-hop-joins">Multi-hop Joins</a></td>
</tr>

<tr>
<td>"Field 'x' not found in source 'y'"</td>

<td><a href="#common-error-messages">Common Errors</a></td>
</tr>
</tbody></table>
<hr/>

      <h2>
        <a id="problem-1-non-unique-join-key" class="header-link anchor" href="#problem-1-non-unique-join-key">
          Problem 1: Non-Unique Join Key
        </a>
      </h2>
    
      <h3>
        <a id="symptoms" class="header-link anchor" href="#symptoms">
          Symptoms
        </a>
      </h3>
    <ul>
<li><p>Query returns 500,000 rows when you expect 50,000</p>
</li>
<li><p>Aggregates are 10x larger than expected</p>
</li>
<li><p>Single row multiplies into many after join</p>
</li></ul>

      <h3>
        <a id="diagnosis" class="header-link anchor" href="#diagnosis">
          Diagnosis
        </a>
      </h3>
    <p><strong>Test join cardinality:</strong></p>
<div class="code-wrapper"><a href="https://github.dev/malloydata/malloydata.github.io/blob/main/src/documentation/user_guides/troubleshooting.malloynb#C2" target="_blank" class="open_notebook"><img src="/img/open_notebook.svg" alt="document"/></a><pre class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">source</span><span style="color: #000000">: </span><span style="color: #001080">airports_p1</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">duckdb</span><span style="color: #000000">.</span><span style="color: #795E26">table</span><span style="color: #000000">(</span><span style="color: #A31515">&#39;../data/airports.parquet&#39;</span><span style="color: #000000">) </span><span style="color: #AF00DB">extend</span><span style="color: #000000"> {</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">primary_key</span><span style="color: #000000">: </span><span style="color: #001080">code</span></span>
<span class="line"><span style="color: #000000">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #AF00DB">source</span><span style="color: #000000">: </span><span style="color: #001080">flights_p1</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">duckdb</span><span style="color: #000000">.</span><span style="color: #795E26">table</span><span style="color: #000000">(</span><span style="color: #A31515">&#39;../data/flights.parquet&#39;</span><span style="color: #000000">) </span><span style="color: #AF00DB">extend</span><span style="color: #000000"> {</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">join_one</span><span style="color: #000000">: </span><span style="color: #001080">airports_p1</span><span style="color: #000000"> </span><span style="color: #AF00DB">with</span><span style="color: #000000"> </span><span style="color: #001080">origin</span></span>
<span class="line"><span style="color: #000000">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #AF00DB">run</span><span style="color: #000000">: </span><span style="color: #001080">flights_p1</span><span style="color: #000000"> -&gt; {</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">where</span><span style="color: #000000">: </span><span style="color: #001080">id2</span><span style="color: #000000"> = </span><span style="color: #098658">30272525</span><span style="color: #000000">  </span><span style="color: #008000">// ONE row</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">aggregate</span><span style="color: #000000">:</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #001080">source_count</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #795E26">count</span><span style="color: #000000">()</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #001080">joined_count</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">airports_p1</span><span style="color: #000000">.</span><span style="color: #795E26">count</span><span style="color: #000000">()</span></span>
<span class="line"><span style="color: #008000">// If source_count=1 and joined_count=1, your join is correct</span></span>
<span class="line"><span style="color: #000000">}</span></span></pre><div class="result-outer small">
    <div class="result-controls-bar">
      <span class="result-label">QUERY RESULTS</span>
      <div class="result-controls">
        <button class="result-control" selected data-result-kind="html">HTML</button>
        <button class="result-control"  data-result-kind="json">JSON</button>
        <button class="result-control"  data-result-kind="sql">SQL</button>
      </div>
    </div>
    <div class="result-middle" data-result-kind="html" selected>
      <div class="result-inner" id="5416563f-cecd-4ee6-a46e-331ea624ba20">
        <script>(()=>{var e=document.getElementById("5416563f-cecd-4ee6-a46e-331ea624ba20"),t=document.createElement("malloy-render");t.modelDef={name:"",exports:["airports_p1","flights_p1"],contents:{airports_p1:{type:"table",name:"duckdb:../data/airports.parquet",dialect:"duckdb",tablePath:"../data/airports.parquet",connection:"duckdb",fields:[{type:"number",numberType:"integer",name:"id",fieldUsage:[{path:["id"]}]},{type:"string",name:"code",fieldUsage:[{path:["code"]}]},{type:"string",name:"site_number",fieldUsage:[{path:["site_number"]}]},{type:"string",name:"fac_type",fieldUsage:[{path:["fac_type"]}]},{type:"string",name:"fac_use",fieldUsage:[{path:["fac_use"]}]},{type:"string",name:"faa_region",fieldUsage:[{path:["faa_region"]}]},{type:"string",name:"faa_dist",fieldUsage:[{path:["faa_dist"]}]},{type:"string",name:"city",fieldUsage:[{path:["city"]}]},{type:"string",name:"county",fieldUsage:[{path:["county"]}]},{type:"string",name:"state",fieldUsage:[{path:["state"]}]},{type:"string",name:"full_name",fieldUsage:[{path:["full_name"]}]},{type:"string",name:"own_type",fieldUsage:[{path:["own_type"]}]},{type:"number",numberType:"float",name:"longitude",fieldUsage:[{path:["longitude"]}]},{type:"number",numberType:"float",name:"latitude",fieldUsage:[{path:["latitude"]}]},{type:"number",numberType:"integer",name:"elevation",fieldUsage:[{path:["elevation"]}]},{type:"string",name:"aero_cht",fieldUsage:[{path:["aero_cht"]}]},{type:"number",numberType:"integer",name:"cbd_dist",fieldUsage:[{path:["cbd_dist"]}]},{type:"string",name:"cbd_dir",fieldUsage:[{path:["cbd_dir"]}]},{type:"string",name:"act_date",fieldUsage:[{path:["act_date"]}]},{type:"string",name:"cert",fieldUsage:[{path:["cert"]}]},{type:"string",name:"fed_agree",fieldUsage:[{path:["fed_agree"]}]},{type:"string",name:"cust_intl",fieldUsage:[{path:["cust_intl"]}]},{type:"string",name:"c_ldg_rts",fieldUsage:[{path:["c_ldg_rts"]}]},{type:"string",name:"joint_use",fieldUsage:[{path:["joint_use"]}]},{type:"string",name:"mil_rts",fieldUsage:[{path:["mil_rts"]}]},{type:"string",name:"cntl_twr",fieldUsage:[{path:["cntl_twr"]}]},{type:"string",name:"major",fieldUsage:[{path:["major"]}]}],primaryKey:"code",parameters:{},as:"airports_p1"},flights_p1:{type:"table",name:"duckdb:../data/flights.parquet",dialect:"duckdb",tablePath:"../data/flights.parquet",connection:"duckdb",fields:[{type:"string",name:"carrier",fieldUsage:[{path:["carrier"]}]},{type:"string",name:"origin",fieldUsage:[{path:["origin"]}]},{type:"string",name:"destination",fieldUsage:[{path:["destination"]}]},{type:"string",name:"flight_num",fieldUsage:[{path:["flight_num"]}]},{type:"number",numberType:"integer",name:"flight_time",fieldUsage:[{path:["flight_time"]}]},{type:"string",name:"tail_num",fieldUsage:[{path:["tail_num"]}]},{type:"timestamp",name:"dep_time",fieldUsage:[{path:["dep_time"]}]},{type:"timestamp",name:"arr_time",fieldUsage:[{path:["arr_time"]}]},{type:"number",numberType:"integer",name:"dep_delay",fieldUsage:[{path:["dep_delay"]}]},{type:"number",numberType:"integer",name:"arr_delay",fieldUsage:[{path:["arr_delay"]}]},{type:"number",numberType:"integer",name:"taxi_out",fieldUsage:[{path:["taxi_out"]}]},{type:"number",numberType:"integer",name:"taxi_in",fieldUsage:[{path:["taxi_in"]}]},{type:"number",numberType:"integer",name:"distance",fieldUsage:[{path:["distance"]}]},{type:"string",name:"cancelled",fieldUsage:[{path:["cancelled"]}]},{type:"string",name:"diverted",fieldUsage:[{path:["diverted"]}]},{type:"number",numberType:"integer",name:"id2",fieldUsage:[{path:["id2"]}]},{type:"table",name:"airports_p1",dialect:"duckdb",tablePath:"../data/airports.parquet",connection:"duckdb",fields:[{type:"number",numberType:"integer",name:"id",fieldUsage:[{path:["id"]}]},{type:"string",name:"code",fieldUsage:[{path:["code"]}]},{type:"string",name:"site_number",fieldUsage:[{path:["site_number"]}]},{type:"string",name:"fac_type",fieldUsage:[{path:["fac_type"]}]},{type:"string",name:"fac_use",fieldUsage:[{path:["fac_use"]}]},{type:"string",name:"faa_region",fieldUsage:[{path:["faa_region"]}]},{type:"string",name:"faa_dist",fieldUsage:[{path:["faa_dist"]}]},{type:"string",name:"city",fieldUsage:[{path:["city"]}]},{type:"string",name:"county",fieldUsage:[{path:["county"]}]},{type:"string",name:"state",fieldUsage:[{path:["state"]}]},{type:"string",name:"full_name",fieldUsage:[{path:["full_name"]}]},{type:"string",name:"own_type",fieldUsage:[{path:["own_type"]}]},{type:"number",numberType:"float",name:"longitude",fieldUsage:[{path:["longitude"]}]},{type:"number",numberType:"float",name:"latitude",fieldUsage:[{path:["latitude"]}]},{type:"number",numberType:"integer",name:"elevation",fieldUsage:[{path:["elevation"]}]},{type:"string",name:"aero_cht",fieldUsage:[{path:["aero_cht"]}]},{type:"number",numberType:"integer",name:"cbd_dist",fieldUsage:[{path:["cbd_dist"]}]},{type:"string",name:"cbd_dir",fieldUsage:[{path:["cbd_dir"]}]},{type:"string",name:"act_date",fieldUsage:[{path:["act_date"]}]},{type:"string",name:"cert",fieldUsage:[{path:["cert"]}]},{type:"string",name:"fed_agree",fieldUsage:[{path:["fed_agree"]}]},{type:"string",name:"cust_intl",fieldUsage:[{path:["cust_intl"]}]},{type:"string",name:"c_ldg_rts",fieldUsage:[{path:["c_ldg_rts"]}]},{type:"string",name:"joint_use",fieldUsage:[{path:["joint_use"]}]},{type:"string",name:"mil_rts",fieldUsage:[{path:["mil_rts"]}]},{type:"string",name:"cntl_twr",fieldUsage:[{path:["cntl_twr"]}]},{type:"string",name:"major",fieldUsage:[{path:["major"]}]}],primaryKey:"code",parameters:{},arguments:{},join:"one",matrixOperation:"left",onExpression:{node:"=",kids:{left:{node:"field",path:["airports_p1","code"],sql:'airports_p1_0."code"'},right:{node:"field",path:["origin"],sql:'base."origin"'}}},onFieldUsage:[{path:["origin"]}]}],parameters:{},as:"flights_p1"}},queryList:[{type:"query",structRef:"flights_p1",sourceArguments:{},pipeline:[{type:"reduce",queryFields:[{type:"number",numberType:"integer",name:"source_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},{type:"number",numberType:"integer",name:"joined_count",e:{node:"aggregate",function:"count",e:{node:""},structPath:["airports_p1"]},fieldUsage:[],expressionType:"aggregate",code:"airports_p1.count()"}],filterList:[{node:"filterCondition",code:"id2 = 30272525",e:{node:"=",kids:{left:{node:"field",path:["id2"]},right:{node:"numberLiteral",literal:"30272525"}}},expressionType:"scalar",fieldUsage:[{path:["id2"]}],stableFilter:{kind:"literal_equality",field_reference:{name:"id2",path:[]},value:{kind:"number_literal",number_value:30272525}}}],fieldUsage:[{path:["id2"]}],defaultOrderBy:!0,orderBy:[{field:"source_count",dir:"desc"}]}]}],dependencies:{},references:[{type:"fieldReference",definition:{type:"string",name:"code",fieldUsage:[{path:["code"]}]},text:"code"},{type:"exploreReference",text:"airports_p1",definition:{type:"table",name:"duckdb:../data/airports.parquet",dialect:"duckdb",tablePath:"../data/airports.parquet",connection:"duckdb",fields:[{type:"number",numberType:"integer",name:"id",fieldUsage:[{path:["id"]}]},{type:"string",name:"code",fieldUsage:[{path:["code"]}]},{type:"string",name:"site_number",fieldUsage:[{path:["site_number"]}]},{type:"string",name:"fac_type",fieldUsage:[{path:["fac_type"]}]},{type:"string",name:"fac_use",fieldUsage:[{path:["fac_use"]}]},{type:"string",name:"faa_region",fieldUsage:[{path:["faa_region"]}]},{type:"string",name:"faa_dist",fieldUsage:[{path:["faa_dist"]}]},{type:"string",name:"city",fieldUsage:[{path:["city"]}]},{type:"string",name:"county",fieldUsage:[{path:["county"]}]},{type:"string",name:"state",fieldUsage:[{path:["state"]}]},{type:"string",name:"full_name",fieldUsage:[{path:["full_name"]}]},{type:"string",name:"own_type",fieldUsage:[{path:["own_type"]}]},{type:"number",numberType:"float",name:"longitude",fieldUsage:[{path:["longitude"]}]},{type:"number",numberType:"float",name:"latitude",fieldUsage:[{path:["latitude"]}]},{type:"number",numberType:"integer",name:"elevation",fieldUsage:[{path:["elevation"]}]},{type:"string",name:"aero_cht",fieldUsage:[{path:["aero_cht"]}]},{type:"number",numberType:"integer",name:"cbd_dist",fieldUsage:[{path:["cbd_dist"]}]},{type:"string",name:"cbd_dir",fieldUsage:[{path:["cbd_dir"]}]},{type:"string",name:"act_date",fieldUsage:[{path:["act_date"]}]},{type:"string",name:"cert",fieldUsage:[{path:["cert"]}]},{type:"string",name:"fed_agree",fieldUsage:[{path:["fed_agree"]}]},{type:"string",name:"cust_intl",fieldUsage:[{path:["cust_intl"]}]},{type:"string",name:"c_ldg_rts",fieldUsage:[{path:["c_ldg_rts"]}]},{type:"string",name:"joint_use",fieldUsage:[{path:["joint_use"]}]},{type:"string",name:"mil_rts",fieldUsage:[{path:["mil_rts"]}]},{type:"string",name:"cntl_twr",fieldUsage:[{path:["cntl_twr"]}]},{type:"string",name:"major",fieldUsage:[{path:["major"]}]}],primaryKey:"code",parameters:{},as:"airports_p1"}},{type:"fieldReference",definition:{type:"string",name:"origin",fieldUsage:[{path:["origin"]}]},text:"origin"},{type:"exploreReference",text:"flights_p1",definition:{type:"table",name:"duckdb:../data/flights.parquet",dialect:"duckdb",tablePath:"../data/flights.parquet",connection:"duckdb",fields:[{type:"string",name:"carrier",fieldUsage:[{path:["carrier"]}]},{type:"string",name:"origin",fieldUsage:[{path:["origin"]}]},{type:"string",name:"destination",fieldUsage:[{path:["destination"]}]},{type:"string",name:"flight_num",fieldUsage:[{path:["flight_num"]}]},{type:"number",numberType:"integer",name:"flight_time",fieldUsage:[{path:["flight_time"]}]},{type:"string",name:"tail_num",fieldUsage:[{path:["tail_num"]}]},{type:"timestamp",name:"dep_time",fieldUsage:[{path:["dep_time"]}]},{type:"timestamp",name:"arr_time",fieldUsage:[{path:["arr_time"]}]},{type:"number",numberType:"integer",name:"dep_delay",fieldUsage:[{path:["dep_delay"]}]},{type:"number",numberType:"integer",name:"arr_delay",fieldUsage:[{path:["arr_delay"]}]},{type:"number",numberType:"integer",name:"taxi_out",fieldUsage:[{path:["taxi_out"]}]},{type:"number",numberType:"integer",name:"taxi_in",fieldUsage:[{path:["taxi_in"]}]},{type:"number",numberType:"integer",name:"distance",fieldUsage:[{path:["distance"]}]},{type:"string",name:"cancelled",fieldUsage:[{path:["cancelled"]}]},{type:"string",name:"diverted",fieldUsage:[{path:["diverted"]}]},{type:"number",numberType:"integer",name:"id2",fieldUsage:[{path:["id2"]}]},{type:"table",name:"airports_p1",dialect:"duckdb",tablePath:"../data/airports.parquet",connection:"duckdb",fields:[{type:"number",numberType:"integer",name:"id",fieldUsage:[{path:["id"]}]},{type:"string",name:"code",fieldUsage:[{path:["code"]}]},{type:"string",name:"site_number",fieldUsage:[{path:["site_number"]}]},{type:"string",name:"fac_type",fieldUsage:[{path:["fac_type"]}]},{type:"string",name:"fac_use",fieldUsage:[{path:["fac_use"]}]},{type:"string",name:"faa_region",fieldUsage:[{path:["faa_region"]}]},{type:"string",name:"faa_dist",fieldUsage:[{path:["faa_dist"]}]},{type:"string",name:"city",fieldUsage:[{path:["city"]}]},{type:"string",name:"county",fieldUsage:[{path:["county"]}]},{type:"string",name:"state",fieldUsage:[{path:["state"]}]},{type:"string",name:"full_name",fieldUsage:[{path:["full_name"]}]},{type:"string",name:"own_type",fieldUsage:[{path:["own_type"]}]},{type:"number",numberType:"float",name:"longitude",fieldUsage:[{path:["longitude"]}]},{type:"number",numberType:"float",name:"latitude",fieldUsage:[{path:["latitude"]}]},{type:"number",numberType:"integer",name:"elevation",fieldUsage:[{path:["elevation"]}]},{type:"string",name:"aero_cht",fieldUsage:[{path:["aero_cht"]}]},{type:"number",numberType:"integer",name:"cbd_dist",fieldUsage:[{path:["cbd_dist"]}]},{type:"string",name:"cbd_dir",fieldUsage:[{path:["cbd_dir"]}]},{type:"string",name:"act_date",fieldUsage:[{path:["act_date"]}]},{type:"string",name:"cert",fieldUsage:[{path:["cert"]}]},{type:"string",name:"fed_agree",fieldUsage:[{path:["fed_agree"]}]},{type:"string",name:"cust_intl",fieldUsage:[{path:["cust_intl"]}]},{type:"string",name:"c_ldg_rts",fieldUsage:[{path:["c_ldg_rts"]}]},{type:"string",name:"joint_use",fieldUsage:[{path:["joint_use"]}]},{type:"string",name:"mil_rts",fieldUsage:[{path:["mil_rts"]}]},{type:"string",name:"cntl_twr",fieldUsage:[{path:["cntl_twr"]}]},{type:"string",name:"major",fieldUsage:[{path:["major"]}]}],primaryKey:"code",parameters:{},arguments:{},join:"one",matrixOperation:"left",onExpression:{node:"=",kids:{left:{node:"field",path:["airports_p1","code"]},right:{node:"field",path:["origin"]}}},onFieldUsage:[{path:["origin"]}]}],parameters:{},as:"flights_p1"}},{type:"fieldReference",definition:{type:"number",numberType:"integer",name:"id2",fieldUsage:[{path:["id2"]}]},text:"id2"}],imports:[]},t.queryResult={lastStageName:"__stage0",malloy:"",sql:'SELECT \n   COUNT(1) as "source_count",\n   COUNT(DISTINCT airports_p1_0."code") as "joined_count"\nFROM \'../data/flights.parquet\' as base\n LEFT JOIN \'../data/airports.parquet\' AS airports_p1_0\n  ON airports_p1_0."code"=base."origin"\nWHERE base."id2"=30272525\n',dependenciesToMaterialize:{},structs:[{type:"query_result",name:"__stage0",fields:[{name:"source_count",numberType:"integer",type:"number",resultMetadata:{sourceField:"source_count",sourceExpression:"count()",sourceClasses:["source_count"],referenceId:"87bd3e1c-fc9a-4e51-a9c4-dbabcc2c9e1b",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/documentation/user_guides/troubleshooting.malloynb",range:{start:{line:11,character:4},end:{line:11,character:27}}}},{name:"joined_count",numberType:"integer",type:"number",resultMetadata:{sourceField:"joined_count",sourceExpression:"airports_p1.count()",sourceClasses:["joined_count"],referenceId:"6167dea7-e064-4654-bbee-a52a1c75d7e1",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/documentation/user_guides/troubleshooting.malloynb",range:{start:{line:12,character:4},end:{line:12,character:39}}}}],dialect:"duckdb",connection:"duckdb",resultMetadata:{sourceField:"ignoreme",filterList:[{node:"filterCondition",code:"id2 = 30272525",e:{node:"=",kids:{left:{node:"field",path:["id2"],at:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/documentation/user_guides/troubleshooting.malloynb",range:{start:{line:9,character:9},end:{line:9,character:12}}},sql:'base."id2"'},right:{node:"numberLiteral",literal:"30272525",sql:"30272525"}}},expressionType:"scalar",fieldUsage:[{path:["id2"],at:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/documentation/user_guides/troubleshooting.malloynb",range:{start:{line:9,character:9},end:{line:9,character:12}}}}],stableFilter:{kind:"literal_equality",field_reference:{name:"id2",path:[]},value:{kind:"number_literal",number_value:30272525}}}],sourceClasses:["ignoreme"],fieldKind:"struct",orderBy:[{field:"source_count",dir:"desc"}],drillable:!0}}],sourceExplore:"flights_p1",sourceArguments:{},connectionName:"duckdb",result:[{source_count:1,joined_count:1}],totalRows:1},e.appendChild(t)})();</script>
      </div>
    </div>
    <div class="result-middle" data-result-kind="json" >
      <div class="result-inner">
        <pre><pre class="language-json" style="background-color: #FBFBFB"><span class="line"><span style="color: #000000">[</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;source_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;joined_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">  }</span></span>
<span class="line"><span style="color: #000000">]</span></span></pre></pre>
      </div>
    </div>
    <div class="result-middle" data-result-kind="sql" >
      <div class="result-inner">
        <pre><pre class="language-sql" style="background-color: #FBFBFB"><span class="line"><span style="color: #0000FF">SELECT</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">   </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #098658">1</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;source_count&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">   </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #0000FF">DISTINCT</span><span style="color: #000000"> airports_p1_0.</span><span style="color: #A31515">&quot;code&quot;</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;joined_count&quot;</span></span>
<span class="line"><span style="color: #0000FF">FROM</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;../data/flights.parquet&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> base</span></span>
<span class="line"><span style="color: #000000"> </span><span style="color: #0000FF">LEFT JOIN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;../data/airports.parquet&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">AS</span><span style="color: #000000"> airports_p1_0</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">ON</span><span style="color: #000000"> airports_p1_0.</span><span style="color: #A31515">&quot;code&quot;</span><span style="color: #000000">=base.</span><span style="color: #A31515">&quot;origin&quot;</span></span>
<span class="line"><span style="color: #0000FF">WHERE</span><span style="color: #000000"> base.</span><span style="color: #A31515">&quot;id2&quot;</span><span style="color: #000000">=</span><span style="color: #098658">30272525</span></span>
<span class="line"></span></pre></pre>
      </div>
    </div>
  </div></div><p>If <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">joined_count</span><span style="color: #000000"> &gt; </span><span style="color: #001080">source_count</span></span></code> for a <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">join_one</span></span></code>, your join key isn't unique.</p>

      <h3>
        <a id="the-problem" class="header-link anchor" href="#the-problem">
          The Problem
        </a>
      </h3>
    <p>Your join key doesn't uniquely identify rows in the target table. Consider a flight segments table where each flight can have multiple segments (legs):</p>
<div class="code-wrapper"><pre class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #008000">// WRONG - flight_segments keyed by (flight_id + segment_number)</span></span>
<span class="line"><span style="color: #AF00DB">join_one</span><span style="color: #000000">: </span><span style="color: #001080">flight_segments</span><span style="color: #000000"> </span><span style="color: #AF00DB">on</span><span style="color: #000000"> </span><span style="color: #001080">id2</span><span style="color: #000000"> = </span><span style="color: #001080">flight_segments</span><span style="color: #000000">.</span><span style="color: #001080">flight_id</span></span>
<span class="line"><span style="color: #008000">// One flight matches multiple segment rows  fan-out</span></span>
<span class="line"></span>
<span class="line"><span style="color: #008000">// CORRECT - include all keys that form the unique identifier</span></span>
<span class="line"><span style="color: #AF00DB">join_one</span><span style="color: #000000">: </span><span style="color: #001080">flight_segments</span><span style="color: #000000"> </span><span style="color: #AF00DB">on</span><span style="color: #000000"> </span><span style="color: #001080">id2</span><span style="color: #000000"> = </span><span style="color: #001080">flight_segments</span><span style="color: #000000">.</span><span style="color: #001080">flight_id</span></span>
<span class="line"><span style="color: #000000">                          </span><span style="color: #0000FF">and</span><span style="color: #000000"> </span><span style="color: #001080">segment_num</span><span style="color: #000000"> = </span><span style="color: #001080">flight_segments</span><span style="color: #000000">.</span><span style="color: #001080">segment_number</span></span></pre></div>
      <h3>
        <a id="fix" class="header-link anchor" href="#fix">
          Fix
        </a>
      </h3>
    <ol>
<li><p>Identify the primary key of the table you're joining to</p>
</li>
<li><p>Include ALL columns that form that key in your join condition</p>
</li>
<li><p>Re-test cardinality using the diagnostic query above</p>
</li></ol>
<hr/>

      <h2>
        <a id="problem-2-grain-mismatch" class="header-link anchor" href="#problem-2-grain-mismatch">
          Problem 2: Grain Mismatch
        </a>
      </h2>
    
      <h3>
        <a id="symptoms" class="header-link anchor" href="#symptoms">
          Symptoms
        </a>
      </h3>
    <ul>
<li><p>Joining a daily/monthly summary table to raw transaction data</p>
</li>
<li><p>Every row gets the same aggregated value</p>
</li>
<li><p>Totals are wildly inflated</p>
</li></ul>

      <h3>
        <a id="the-problem" class="header-link anchor" href="#the-problem">
          The Problem
        </a>
      </h3>
    <p>You have two tables at different granularity:</p>
<ul>
<li><p><strong>Raw table</strong>: One row per event (e.g., every flight, every order)</p>
</li>
<li><p><strong>Aggregated table</strong>: One row per time period (e.g., daily totals, monthly stats)</p>
</li></ul>
<p>When you join them, every raw row matches the same summary row. Here, we join carrier-level stats to raw flights, then group by origineach AA flight adds AA's entire total, each UA flight adds UA's total, etc:</p>
<div class="code-wrapper"><a href="https://github.dev/malloydata/malloydata.github.io/blob/main/src/documentation/user_guides/troubleshooting.malloynb#C4" target="_blank" class="open_notebook"><img src="/img/open_notebook.svg" alt="document"/></a><pre class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">source</span><span style="color: #000000">: </span><span style="color: #001080">carrier_stats</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">duckdb</span><span style="color: #000000">.</span><span style="color: #AF00DB">sql</span><span style="color: #000000">(&quot;&quot;&quot;</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">SELECT</span><span style="color: #000000"> carrier, </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(*) </span><span style="color: #0000FF">as</span><span style="color: #000000"> carrier_total</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">FROM</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;../data/flights.parquet&#39;</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">GROUP BY</span><span style="color: #000000"> carrier</span></span>
<span class="line"><span style="color: #000000">&quot;&quot;&quot;)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #AF00DB">source</span><span style="color: #000000">: </span><span style="color: #001080">flights_p2</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">duckdb</span><span style="color: #000000">.</span><span style="color: #795E26">table</span><span style="color: #000000">(</span><span style="color: #A31515">&#39;../data/flights.parquet&#39;</span><span style="color: #000000">) </span><span style="color: #AF00DB">extend</span><span style="color: #000000"> {</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">join_one</span><span style="color: #000000">: </span><span style="color: #001080">carrier_stats</span><span style="color: #000000"> </span><span style="color: #AF00DB">on</span><span style="color: #000000"> </span><span style="color: #001080">carrier</span><span style="color: #000000"> = </span><span style="color: #001080">carrier_stats</span><span style="color: #000000">.</span><span style="color: #001080">carrier</span></span>
<span class="line"><span style="color: #000000">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #008000">// WRONG: grouping by origin but summing carrier totals</span></span>
<span class="line"><span style="color: #AF00DB">run</span><span style="color: #000000">: </span><span style="color: #001080">flights_p2</span><span style="color: #000000"> -&gt; {</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">group_by</span><span style="color: #000000">: </span><span style="color: #001080">origin</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">aggregate</span><span style="color: #000000">:</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #001080">actual_flights</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #795E26">count</span><span style="color: #000000">()</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #001080">wrong_total</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">carrier_stats</span><span style="color: #000000">.</span><span style="color: #001080">carrier_total</span><span style="color: #000000">.</span><span style="color: #795E26">sum</span><span style="color: #000000">()</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">limit</span><span style="color: #000000">: </span><span style="color: #098658">5</span></span>
<span class="line"><span style="color: #000000">}</span></span></pre><div class="result-outer small">
    <div class="result-controls-bar">
      <span class="result-label">QUERY RESULTS</span>
      <div class="result-controls">
        <button class="result-control" selected data-result-kind="html">HTML</button>
        <button class="result-control"  data-result-kind="json">JSON</button>
        <button class="result-control"  data-result-kind="sql">SQL</button>
      </div>
    </div>
    <div class="result-middle" data-result-kind="html" selected>
      <div class="result-inner" id="bded43bb-25fc-4b10-9b50-127d8bf4e647">
        <script>(()=>{var e=document.getElementById("bded43bb-25fc-4b10-9b50-127d8bf4e647"),t=document.createElement("malloy-render");t.modelDef={name:"",exports:["airports_p1","flights_p1","carrier_stats","flights_p2"],contents:{airports_p1:{type:"table",name:"duckdb:../data/airports.parquet",dialect:"duckdb",tablePath:"../data/airports.parquet",connection:"duckdb",fields:[{type:"number",numberType:"integer",name:"id",fieldUsage:[{path:["id"]}]},{type:"string",name:"code",fieldUsage:[{path:["code"]}]},{type:"string",name:"site_number",fieldUsage:[{path:["site_number"]}]},{type:"string",name:"fac_type",fieldUsage:[{path:["fac_type"]}]},{type:"string",name:"fac_use",fieldUsage:[{path:["fac_use"]}]},{type:"string",name:"faa_region",fieldUsage:[{path:["faa_region"]}]},{type:"string",name:"faa_dist",fieldUsage:[{path:["faa_dist"]}]},{type:"string",name:"city",fieldUsage:[{path:["city"]}]},{type:"string",name:"county",fieldUsage:[{path:["county"]}]},{type:"string",name:"state",fieldUsage:[{path:["state"]}]},{type:"string",name:"full_name",fieldUsage:[{path:["full_name"]}]},{type:"string",name:"own_type",fieldUsage:[{path:["own_type"]}]},{type:"number",numberType:"float",name:"longitude",fieldUsage:[{path:["longitude"]}]},{type:"number",numberType:"float",name:"latitude",fieldUsage:[{path:["latitude"]}]},{type:"number",numberType:"integer",name:"elevation",fieldUsage:[{path:["elevation"]}]},{type:"string",name:"aero_cht",fieldUsage:[{path:["aero_cht"]}]},{type:"number",numberType:"integer",name:"cbd_dist",fieldUsage:[{path:["cbd_dist"]}]},{type:"string",name:"cbd_dir",fieldUsage:[{path:["cbd_dir"]}]},{type:"string",name:"act_date",fieldUsage:[{path:["act_date"]}]},{type:"string",name:"cert",fieldUsage:[{path:["cert"]}]},{type:"string",name:"fed_agree",fieldUsage:[{path:["fed_agree"]}]},{type:"string",name:"cust_intl",fieldUsage:[{path:["cust_intl"]}]},{type:"string",name:"c_ldg_rts",fieldUsage:[{path:["c_ldg_rts"]}]},{type:"string",name:"joint_use",fieldUsage:[{path:["joint_use"]}]},{type:"string",name:"mil_rts",fieldUsage:[{path:["mil_rts"]}]},{type:"string",name:"cntl_twr",fieldUsage:[{path:["cntl_twr"]}]},{type:"string",name:"major",fieldUsage:[{path:["major"]}]}],primaryKey:"code",parameters:{},as:"airports_p1"},flights_p1:{type:"table",name:"duckdb:../data/flights.parquet",dialect:"duckdb",tablePath:"../data/flights.parquet",connection:"duckdb",fields:[{type:"string",name:"carrier",fieldUsage:[{path:["carrier"]}]},{type:"string",name:"origin",fieldUsage:[{path:["origin"]}]},{type:"string",name:"destination",fieldUsage:[{path:["destination"]}]},{type:"string",name:"flight_num",fieldUsage:[{path:["flight_num"]}]},{type:"number",numberType:"integer",name:"flight_time",fieldUsage:[{path:["flight_time"]}]},{type:"string",name:"tail_num",fieldUsage:[{path:["tail_num"]}]},{type:"timestamp",name:"dep_time",fieldUsage:[{path:["dep_time"]}]},{type:"timestamp",name:"arr_time",fieldUsage:[{path:["arr_time"]}]},{type:"number",numberType:"integer",name:"dep_delay",fieldUsage:[{path:["dep_delay"]}]},{type:"number",numberType:"integer",name:"arr_delay",fieldUsage:[{path:["arr_delay"]}]},{type:"number",numberType:"integer",name:"taxi_out",fieldUsage:[{path:["taxi_out"]}]},{type:"number",numberType:"integer",name:"taxi_in",fieldUsage:[{path:["taxi_in"]}]},{type:"number",numberType:"integer",name:"distance",fieldUsage:[{path:["distance"]}]},{type:"string",name:"cancelled",fieldUsage:[{path:["cancelled"]}]},{type:"string",name:"diverted",fieldUsage:[{path:["diverted"]}]},{type:"number",numberType:"integer",name:"id2",fieldUsage:[{path:["id2"]}]},{type:"table",name:"airports_p1",dialect:"duckdb",tablePath:"../data/airports.parquet",connection:"duckdb",fields:[{type:"number",numberType:"integer",name:"id",fieldUsage:[{path:["id"]}]},{type:"string",name:"code",fieldUsage:[{path:["code"]}]},{type:"string",name:"site_number",fieldUsage:[{path:["site_number"]}]},{type:"string",name:"fac_type",fieldUsage:[{path:["fac_type"]}]},{type:"string",name:"fac_use",fieldUsage:[{path:["fac_use"]}]},{type:"string",name:"faa_region",fieldUsage:[{path:["faa_region"]}]},{type:"string",name:"faa_dist",fieldUsage:[{path:["faa_dist"]}]},{type:"string",name:"city",fieldUsage:[{path:["city"]}]},{type:"string",name:"county",fieldUsage:[{path:["county"]}]},{type:"string",name:"state",fieldUsage:[{path:["state"]}]},{type:"string",name:"full_name",fieldUsage:[{path:["full_name"]}]},{type:"string",name:"own_type",fieldUsage:[{path:["own_type"]}]},{type:"number",numberType:"float",name:"longitude",fieldUsage:[{path:["longitude"]}]},{type:"number",numberType:"float",name:"latitude",fieldUsage:[{path:["latitude"]}]},{type:"number",numberType:"integer",name:"elevation",fieldUsage:[{path:["elevation"]}]},{type:"string",name:"aero_cht",fieldUsage:[{path:["aero_cht"]}]},{type:"number",numberType:"integer",name:"cbd_dist",fieldUsage:[{path:["cbd_dist"]}]},{type:"string",name:"cbd_dir",fieldUsage:[{path:["cbd_dir"]}]},{type:"string",name:"act_date",fieldUsage:[{path:["act_date"]}]},{type:"string",name:"cert",fieldUsage:[{path:["cert"]}]},{type:"string",name:"fed_agree",fieldUsage:[{path:["fed_agree"]}]},{type:"string",name:"cust_intl",fieldUsage:[{path:["cust_intl"]}]},{type:"string",name:"c_ldg_rts",fieldUsage:[{path:["c_ldg_rts"]}]},{type:"string",name:"joint_use",fieldUsage:[{path:["joint_use"]}]},{type:"string",name:"mil_rts",fieldUsage:[{path:["mil_rts"]}]},{type:"string",name:"cntl_twr",fieldUsage:[{path:["cntl_twr"]}]},{type:"string",name:"major",fieldUsage:[{path:["major"]}]}],primaryKey:"code",parameters:{},arguments:{},join:"one",matrixOperation:"left",onExpression:{node:"=",kids:{left:{node:"field",path:["airports_p1","code"],sql:'airports_p1_0."code"'},right:{node:"field",path:["origin"],sql:'base."origin"'}}},onFieldUsage:[{path:["origin"]}]}],parameters:{},as:"flights_p1"},carrier_stats:{type:"sql_select",connection:"duckdb",selectStr:"\n  SELECT carrier, COUNT(*) as carrier_total\n  FROM '../data/flights.parquet'\n  GROUP BY carrier\n",dialect:"duckdb",fields:[{type:"string",name:"carrier",fieldUsage:[{path:["carrier"]}]},{type:"number",numberType:"integer",name:"carrier_total",fieldUsage:[{path:["carrier_total"]}]}],name:"sql://duckdb/ce8230de-858a-5fe3-9303-99423fefbc69",parameters:{},as:"carrier_stats"},flights_p2:{type:"table",name:"duckdb:../data/flights.parquet",dialect:"duckdb",tablePath:"../data/flights.parquet",connection:"duckdb",fields:[{type:"string",name:"carrier",fieldUsage:[{path:["carrier"]}]},{type:"string",name:"origin",fieldUsage:[{path:["origin"]}]},{type:"string",name:"destination",fieldUsage:[{path:["destination"]}]},{type:"string",name:"flight_num",fieldUsage:[{path:["flight_num"]}]},{type:"number",numberType:"integer",name:"flight_time",fieldUsage:[{path:["flight_time"]}]},{type:"string",name:"tail_num",fieldUsage:[{path:["tail_num"]}]},{type:"timestamp",name:"dep_time",fieldUsage:[{path:["dep_time"]}]},{type:"timestamp",name:"arr_time",fieldUsage:[{path:["arr_time"]}]},{type:"number",numberType:"integer",name:"dep_delay",fieldUsage:[{path:["dep_delay"]}]},{type:"number",numberType:"integer",name:"arr_delay",fieldUsage:[{path:["arr_delay"]}]},{type:"number",numberType:"integer",name:"taxi_out",fieldUsage:[{path:["taxi_out"]}]},{type:"number",numberType:"integer",name:"taxi_in",fieldUsage:[{path:["taxi_in"]}]},{type:"number",numberType:"integer",name:"distance",fieldUsage:[{path:["distance"]}]},{type:"string",name:"cancelled",fieldUsage:[{path:["cancelled"]}]},{type:"string",name:"diverted",fieldUsage:[{path:["diverted"]}]},{type:"number",numberType:"integer",name:"id2",fieldUsage:[{path:["id2"]}]},{type:"sql_select",connection:"duckdb",selectStr:"\n  SELECT carrier, COUNT(*) as carrier_total\n  FROM '../data/flights.parquet'\n  GROUP BY carrier\n",dialect:"duckdb",fields:[{type:"string",name:"carrier",fieldUsage:[{path:["carrier"]}]},{type:"number",numberType:"integer",name:"carrier_total",fieldUsage:[{path:["carrier_total"]}]}],name:"carrier_stats",parameters:{},arguments:{},join:"one",matrixOperation:"left",onExpression:{node:"=",kids:{left:{node:"field",path:["carrier"],sql:'base."carrier"'},right:{node:"field",path:["carrier_stats","carrier"],sql:'carrier_stats_0."carrier"'}}},onFieldUsage:[{path:["carrier"]},{path:["carrier_stats","carrier"]}]}],parameters:{},as:"flights_p2"}},queryList:[{type:"query",structRef:"flights_p2",sourceArguments:{},pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["origin"]},{type:"number",numberType:"integer",name:"actual_flights",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},{type:"number",numberType:"integer",name:"wrong_total",e:{node:"aggregate",function:"sum",e:{node:"field",path:["carrier_stats","carrier_total"]},structPath:["carrier_stats"]},fieldUsage:[{path:["carrier_total"]}],expressionType:"aggregate",code:"carrier_stats.carrier_total.sum()"}],limit:5,filterList:[],fieldUsage:[{path:["origin"]},{path:["carrier_total"]}],defaultOrderBy:!0,orderBy:[{field:"actual_flights",dir:"desc"}]}]}],dependencies:{},references:[{type:"exploreReference",text:"carrier_stats",definition:{type:"sql_select",connection:"duckdb",selectStr:"\n  SELECT carrier, COUNT(*) as carrier_total\n  FROM '../data/flights.parquet'\n  GROUP BY carrier\n",dialect:"duckdb",fields:[{type:"string",name:"carrier",fieldUsage:[{path:["carrier"]}]},{type:"number",numberType:"integer",name:"carrier_total",fieldUsage:[{path:["carrier_total"]}]}],name:"sql://duckdb/ce8230de-858a-5fe3-9303-99423fefbc69",parameters:{},as:"carrier_stats"}},{type:"fieldReference",definition:{type:"string",name:"carrier",fieldUsage:[{path:["carrier"]}]},text:"carrier"},{type:"joinReference",definition:{type:"sql_select",connection:"duckdb",selectStr:"\n  SELECT carrier, COUNT(*) as carrier_total\n  FROM '../data/flights.parquet'\n  GROUP BY carrier\n",dialect:"duckdb",fields:[{type:"string",name:"carrier",fieldUsage:[{path:["carrier"]}]},{type:"number",numberType:"integer",name:"carrier_total",fieldUsage:[{path:["carrier_total"]}]}],name:"carrier_stats",parameters:{},arguments:{},join:"one",matrixOperation:"left"},text:"carrier_stats"},{type:"fieldReference",definition:{type:"string",name:"carrier",fieldUsage:[{path:["carrier"]}]},text:"carrier"},{type:"exploreReference",text:"flights_p2",definition:{type:"table",name:"duckdb:../data/flights.parquet",dialect:"duckdb",tablePath:"../data/flights.parquet",connection:"duckdb",fields:[{type:"string",name:"carrier",fieldUsage:[{path:["carrier"]}]},{type:"string",name:"origin",fieldUsage:[{path:["origin"]}]},{type:"string",name:"destination",fieldUsage:[{path:["destination"]}]},{type:"string",name:"flight_num",fieldUsage:[{path:["flight_num"]}]},{type:"number",numberType:"integer",name:"flight_time",fieldUsage:[{path:["flight_time"]}]},{type:"string",name:"tail_num",fieldUsage:[{path:["tail_num"]}]},{type:"timestamp",name:"dep_time",fieldUsage:[{path:["dep_time"]}]},{type:"timestamp",name:"arr_time",fieldUsage:[{path:["arr_time"]}]},{type:"number",numberType:"integer",name:"dep_delay",fieldUsage:[{path:["dep_delay"]}]},{type:"number",numberType:"integer",name:"arr_delay",fieldUsage:[{path:["arr_delay"]}]},{type:"number",numberType:"integer",name:"taxi_out",fieldUsage:[{path:["taxi_out"]}]},{type:"number",numberType:"integer",name:"taxi_in",fieldUsage:[{path:["taxi_in"]}]},{type:"number",numberType:"integer",name:"distance",fieldUsage:[{path:["distance"]}]},{type:"string",name:"cancelled",fieldUsage:[{path:["cancelled"]}]},{type:"string",name:"diverted",fieldUsage:[{path:["diverted"]}]},{type:"number",numberType:"integer",name:"id2",fieldUsage:[{path:["id2"]}]},{type:"sql_select",connection:"duckdb",selectStr:"\n  SELECT carrier, COUNT(*) as carrier_total\n  FROM '../data/flights.parquet'\n  GROUP BY carrier\n",dialect:"duckdb",fields:[{type:"string",name:"carrier",fieldUsage:[{path:["carrier"]}]},{type:"number",numberType:"integer",name:"carrier_total",fieldUsage:[{path:["carrier_total"]}]}],name:"carrier_stats",parameters:{},arguments:{},join:"one",matrixOperation:"left",onExpression:{node:"=",kids:{left:{node:"field",path:["carrier"]},right:{node:"field",path:["carrier_stats","carrier"]}}},onFieldUsage:[{path:["carrier"]},{path:["carrier_stats","carrier"]}]}],parameters:{},as:"flights_p2"}},{type:"fieldReference",definition:{type:"string",name:"origin",fieldUsage:[{path:["origin"]}]},text:"origin"},{type:"joinReference",definition:{type:"sql_select",connection:"duckdb",selectStr:"\n  SELECT carrier, COUNT(*) as carrier_total\n  FROM '../data/flights.parquet'\n  GROUP BY carrier\n",dialect:"duckdb",fields:[{type:"string",name:"carrier",fieldUsage:[{path:["carrier"]}]},{type:"number",numberType:"integer",name:"carrier_total",fieldUsage:[{path:["carrier_total"]}]}],name:"carrier_stats",parameters:{},arguments:{},join:"one",matrixOperation:"left",onExpression:{node:"=",kids:{left:{node:"field",path:["carrier"]},right:{node:"field",path:["carrier_stats","carrier"]}}},onFieldUsage:[{path:["carrier"]},{path:["carrier_stats","carrier"]}]},text:"carrier_stats"},{type:"fieldReference",definition:{type:"number",numberType:"integer",name:"carrier_total",fieldUsage:[{path:["carrier_total"]}]},text:"carrier_total"}],imports:[]},t.queryResult={lastStageName:"__stage0",malloy:"",sql:'SELECT \n   base."origin" as "origin",\n   COUNT(1) as "actual_flights",\n   COALESCE((\n        SELECT SUM(a.val) as value\n        FROM (\n          SELECT UNNEST(list(distinct {key:carrier_stats_0."__distinct_key", val: carrier_stats_0."carrier_total"})) a\n        )\n      ),0) as "wrong_total"\nFROM \'../data/flights.parquet\' as base\n LEFT JOIN (SELECT GEN_RANDOM_UUID() as "__distinct_key", x.*  FROM (\n  SELECT carrier, COUNT(*) as carrier_total\n  FROM \'../data/flights.parquet\'\n  GROUP BY carrier\n) as x) AS carrier_stats_0\n  ON base."carrier"=carrier_stats_0."carrier"\nGROUP BY 1\nORDER BY 2 desc NULLS LAST\nLIMIT 5\n',dependenciesToMaterialize:{},structs:[{type:"query_result",name:"__stage0",fields:[{name:"origin",type:"string",resultMetadata:{sourceField:"origin",sourceClasses:["origin"],referenceId:"038173b9-defb-4abf-a03e-532c7e53b230",fieldKind:"dimension"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/documentation/user_guides/troubleshooting.malloynb",range:{start:{line:6,character:22},end:{line:6,character:61}}}},{name:"actual_flights",numberType:"integer",type:"number",resultMetadata:{sourceField:"actual_flights",sourceExpression:"count()",sourceClasses:["actual_flights"],referenceId:"bcecc989-94dd-47ee-9262-d913d955d8d6",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/documentation/user_guides/troubleshooting.malloynb",range:{start:{line:14,character:4},end:{line:14,character:29}}}},{name:"wrong_total",numberType:"integer",type:"number",resultMetadata:{sourceField:"wrong_total",sourceExpression:"carrier_stats.carrier_total.sum()",sourceClasses:["wrong_total"],referenceId:"c285b945-0eb2-42d3-911f-720dcc2137c5",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/documentation/user_guides/troubleshooting.malloynb",range:{start:{line:15,character:4},end:{line:15,character:52}}}}],dialect:"duckdb",primaryKey:"origin",connection:"duckdb",resultMetadata:{sourceField:"ignoreme",filterList:[],sourceClasses:["ignoreme"],fieldKind:"struct",limit:5,orderBy:[{field:"actual_flights",dir:"desc"}],drillable:!0}}],sourceExplore:"flights_p2",sourceArguments:{},connectionName:"duckdb",result:[{origin:"ATL",actual_flights:17875,wrong_total:244590},{origin:"DFW",actual_flights:17782,wrong_total:251234},{origin:"ORD",actual_flights:14214,wrong_total:223979},{origin:"PHX",actual_flights:12476,wrong_total:308769},{origin:"LAS",actual_flights:11096,wrong_total:285556}],totalRows:5},e.appendChild(t)})();</script>
      </div>
    </div>
    <div class="result-middle" data-result-kind="json" >
      <div class="result-inner">
        <pre><pre class="language-json" style="background-color: #FBFBFB"><span class="line"><span style="color: #000000">[</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;origin&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;ATL&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;actual_flights&quot;</span><span style="color: #000000">: </span><span style="color: #098658">17875</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;wrong_total&quot;</span><span style="color: #000000">: </span><span style="color: #098658">244590</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;origin&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;DFW&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;actual_flights&quot;</span><span style="color: #000000">: </span><span style="color: #098658">17782</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;wrong_total&quot;</span><span style="color: #000000">: </span><span style="color: #098658">251234</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;origin&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;ORD&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;actual_flights&quot;</span><span style="color: #000000">: </span><span style="color: #098658">14214</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;wrong_total&quot;</span><span style="color: #000000">: </span><span style="color: #098658">223979</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;origin&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;PHX&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;actual_flights&quot;</span><span style="color: #000000">: </span><span style="color: #098658">12476</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;wrong_total&quot;</span><span style="color: #000000">: </span><span style="color: #098658">308769</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;origin&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;LAS&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;actual_flights&quot;</span><span style="color: #000000">: </span><span style="color: #098658">11096</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;wrong_total&quot;</span><span style="color: #000000">: </span><span style="color: #098658">285556</span></span>
<span class="line"><span style="color: #000000">  }</span></span>
<span class="line"><span style="color: #000000">]</span></span></pre></pre>
      </div>
    </div>
    <div class="result-middle" data-result-kind="sql" >
      <div class="result-inner">
        <pre><pre class="language-sql" style="background-color: #FBFBFB"><span class="line"><span style="color: #0000FF">SELECT</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">   base.</span><span style="color: #A31515">&quot;origin&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;origin&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">   </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #098658">1</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;actual_flights&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">   </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">((</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">SELECT</span><span style="color: #000000"> </span><span style="color: #795E26">SUM</span><span style="color: #000000">(a.val) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #0000FF">value</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">FROM</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">          </span><span style="color: #0000FF">SELECT</span><span style="color: #000000"> UNNEST(list(</span><span style="color: #0000FF">distinct</span><span style="color: #000000"> {</span><span style="color: #0000FF">key</span><span style="color: #000000">:carrier_stats_0.</span><span style="color: #A31515">&quot;__distinct_key&quot;</span><span style="color: #000000">, val: carrier_stats_0.</span><span style="color: #A31515">&quot;carrier_total&quot;</span><span style="color: #000000">})) a</span></span>
<span class="line"><span style="color: #000000">        )</span></span>
<span class="line"><span style="color: #000000">      ),</span><span style="color: #098658">0</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;wrong_total&quot;</span></span>
<span class="line"><span style="color: #0000FF">FROM</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;../data/flights.parquet&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> base</span></span>
<span class="line"><span style="color: #000000"> </span><span style="color: #0000FF">LEFT JOIN</span><span style="color: #000000"> (</span><span style="color: #0000FF">SELECT</span><span style="color: #000000"> GEN_RANDOM_UUID() </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;__distinct_key&quot;</span><span style="color: #000000">, x.*  </span><span style="color: #0000FF">FROM</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">SELECT</span><span style="color: #000000"> carrier, </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(*) </span><span style="color: #0000FF">as</span><span style="color: #000000"> carrier_total</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">FROM</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;../data/flights.parquet&#39;</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">GROUP BY</span><span style="color: #000000"> carrier</span></span>
<span class="line"><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> x) </span><span style="color: #0000FF">AS</span><span style="color: #000000"> carrier_stats_0</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">ON</span><span style="color: #000000"> base.</span><span style="color: #A31515">&quot;carrier&quot;</span><span style="color: #000000">=carrier_stats_0.</span><span style="color: #A31515">&quot;carrier&quot;</span></span>
<span class="line"><span style="color: #0000FF">GROUP BY</span><span style="color: #000000"> </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #0000FF">ORDER BY</span><span style="color: #000000"> </span><span style="color: #098658">2</span><span style="color: #000000"> </span><span style="color: #0000FF">desc</span><span style="color: #000000"> NULLS </span><span style="color: #0000FF">LAST</span></span>
<span class="line"><span style="color: #0000FF">LIMIT</span><span style="color: #000000"> </span><span style="color: #098658">5</span></span>
<span class="line"></span></pre></pre>
      </div>
    </div>
  </div></div>
      <h3>
        <a id="fix" class="header-link anchor" href="#fix">
          Fix
        </a>
      </h3>
    <p><strong>Don't join aggregated tables to raw tables.</strong> Query them independentlyuse the raw table for granular questions and compute aggregations directly from it.</p>
<hr/>

      <h2>
        <a id="problem-3-slow-query" class="header-link anchor" href="#problem-3-slow-query">
          Problem 3: Slow Query
        </a>
      </h2>
    
      <h3>
        <a id="symptoms" class="header-link anchor" href="#symptoms">
          Symptoms
        </a>
      </h3>
    <ul>
<li><p>Queries take minutes instead of seconds</p>
</li>
<li><p>Timeouts on large datasets</p>
</li></ul>

      <h3>
        <a id="fix" class="header-link anchor" href="#fix">
          Fix
        </a>
      </h3>
    <p><strong>Option 0: Check your join cardinality</strong></p>
<p>Join fan-out is a common cause of slow queries. If a <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">join_one</span></span></code> isn't actually one-to-one, your dataset explodes silently. See <a href="#problem-1-non-unique-join-key">Non-Unique Join Key</a> to diagnose.</p>
<p><strong>Option 1: Add filters to reduce data scanned</strong></p>
<div class="code-wrapper"><pre class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">run</span><span style="color: #000000">: </span><span style="color: #001080">flights</span><span style="color: #000000"> -&gt; {</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">where</span><span style="color: #000000">: </span><span style="color: #001080">dep_time</span><span style="color: #000000"> ? </span><span style="color: #098658">@2003</span><span style="color: #000000">  </span><span style="color: #008000">// Filter to one year</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">aggregate</span><span style="color: #000000">: </span><span style="color: #001080">flight_count</span></span>
<span class="line"><span style="color: #000000">}</span></span></pre></div><p><strong>Option 2: Materialize a view of the data</strong></p>
<p>If the same aggregation is queried repeatedlyacross dashboards, by multiple users, or by LLM agentspre-aggregate your data using MalloySQL:</p>
<div class="code-wrapper"><pre class="language-sql" style="background-color: #FBFBFB"><span class="line"><span style="color: #008000">-- connection:duckdb</span></span>
<span class="line"><span style="color: #000000">import </span><span style="color: #A31515">&quot;models/flights.malloy&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #0000FF">CREATE</span><span style="color: #000000"> </span><span style="color: #0000FF">TABLE</span><span style="color: #000000"> monthly_stats </span><span style="color: #0000FF">AS</span></span>
<span class="line"><span style="color: #A31515">%{</span></span>
<span class="line"><span style="color: #A31515">  flights -&gt; {</span></span>
<span class="line"><span style="color: #A31515">    group_by: dep_time.month</span></span>
<span class="line"><span style="color: #A31515">    aggregate: flight_count, total_distance</span></span>
<span class="line"><span style="color: #A31515">  }</span></span>
<span class="line"><span style="color: #000000">}%</span></span></pre></div><p>Then model against the materialized table for faster queries.</p>
<p>See <a href="transform">Transform & Materialize</a> for details on materializing views with the Malloy CLI.</p>
<hr/>

      <h2>
        <a id="problem-4-circular-references" class="header-link anchor" href="#problem-4-circular-references">
          Problem 4: Circular References
        </a>
      </h2>
    
      <h3>
        <a id="symptoms" class="header-link anchor" href="#symptoms">
          Symptoms
        </a>
      </h3>
    <ul>
<li><p>Can't define two sources that each join to the other</p>
</li></ul>

      <h3>
        <a id="the-problem" class="header-link anchor" href="#the-problem">
          The Problem
        </a>
      </h3>
    <p>Malloy compiles linearly. You can't define <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">orders</span></span></code> joining to <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">customers</span></span></code> while <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">customers</span></span></code> also joins to <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">orders</span></span></code>the second source doesn't exist yet when the first is compiled.</p>

      <h3>
        <a id="fix" class="header-link anchor" href="#fix">
          Fix
        </a>
      </h3>
    <p>Define base sources first, then extend them with joins. For cyclical relationships, add a third pass:</p>
<div class="code-wrapper"><pre class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #008000">// Base sources</span></span>
<span class="line"><span style="color: #AF00DB">source</span><span style="color: #000000">: </span><span style="color: #001080">_orders</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">duckdb</span><span style="color: #000000">.</span><span style="color: #795E26">table</span><span style="color: #000000">(</span><span style="color: #A31515">&#39;orders&#39;</span><span style="color: #000000">) </span><span style="color: #AF00DB">extend</span><span style="color: #000000"> { ... }</span></span>
<span class="line"><span style="color: #AF00DB">source</span><span style="color: #000000">: </span><span style="color: #001080">_customers</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">duckdb</span><span style="color: #000000">.</span><span style="color: #795E26">table</span><span style="color: #000000">(</span><span style="color: #A31515">&#39;customers&#39;</span><span style="color: #000000">) </span><span style="color: #AF00DB">extend</span><span style="color: #000000"> { ... }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #008000">// Modeled sources with one direction of joins</span></span>
<span class="line"><span style="color: #AF00DB">source</span><span style="color: #000000">: </span><span style="color: #001080">orders_modeled</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">_orders</span><span style="color: #000000"> </span><span style="color: #AF00DB">extend</span><span style="color: #000000"> {</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">join_one</span><span style="color: #000000">: </span><span style="color: #001080">customer</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">_customers</span><span style="color: #000000"> </span><span style="color: #AF00DB">on</span><span style="color: #000000"> </span><span style="color: #001080">customer_id</span><span style="color: #000000"> = </span><span style="color: #001080">customer</span><span style="color: #000000">.</span><span style="color: #001080">id</span></span>
<span class="line"><span style="color: #000000">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #AF00DB">source</span><span style="color: #000000">: </span><span style="color: #001080">customers_modeled</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">_customers</span><span style="color: #000000"> </span><span style="color: #AF00DB">extend</span><span style="color: #000000"> { ... }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #008000">// Final sources with cyclical joins added</span></span>
<span class="line"><span style="color: #AF00DB">source</span><span style="color: #000000">: </span><span style="color: #001080">customers</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">customers_modeled</span><span style="color: #000000"> </span><span style="color: #AF00DB">extend</span><span style="color: #000000"> {</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">join_many</span><span style="color: #000000">: </span><span style="color: #001080">orders</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">orders_modeled</span><span style="color: #000000"> </span><span style="color: #AF00DB">on</span><span style="color: #000000"> </span><span style="color: #001080">id</span><span style="color: #000000"> = </span><span style="color: #001080">orders</span><span style="color: #000000">.</span><span style="color: #001080">customer_id</span></span>
<span class="line"><span style="color: #000000">}</span></span></pre></div><hr/>

      <h2>
        <a id="problem-5-date-arithmetic" class="header-link anchor" href="#problem-5-date-arithmetic">
          Problem 5: Date Arithmetic
        </a>
      </h2>
    
      <h3>
        <a id="symptoms" class="header-link anchor" href="#symptoms">
          Symptoms
        </a>
      </h3>
    <ul>
<li><p>"How do I filter to the last 30 days?"</p>
</li>
<li><p>"How do I do <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">current_date</span><span style="color: #000000"> - </span><span style="color: #001080">interval</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;50 days&#39;</span></span></code>?"</p>
</li></ul>

      <h3>
        <a id="fix" class="header-link anchor" href="#fix">
          Fix
        </a>
      </h3>
    <p>Use Malloy's time literals and ranges:</p>
<div class="code-wrapper"><pre class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">run</span><span style="color: #000000">: </span><span style="color: #001080">events</span><span style="color: #000000"> -&gt; {</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #008000">// Last 30 days</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">where</span><span style="color: #000000">: </span><span style="color: #001080">event_date</span><span style="color: #000000"> &gt; @</span><span style="color: #001080">now</span><span style="color: #000000"> - </span><span style="color: #098658">30</span><span style="color: #000000"> </span><span style="color: #0000FF">days</span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #008000">// Specific range</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">where</span><span style="color: #000000">: </span><span style="color: #001080">event_date</span><span style="color: #000000"> ? </span><span style="color: #098658">@2024-01-01</span><span style="color: #000000"> </span><span style="color: #0000FF">to</span><span style="color: #000000"> </span><span style="color: #098658">@2024-03-31</span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #008000">// Last complete month</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">where</span><span style="color: #000000">: </span><span style="color: #001080">event_date</span><span style="color: #000000"> ? @</span><span style="color: #001080">now</span><span style="color: #000000">.</span><span style="color: #0000FF">month</span><span style="color: #000000"> - </span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">month</span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">aggregate</span><span style="color: #000000">: </span><span style="color: #001080">event_count</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #795E26">count</span><span style="color: #000000">()</span></span>
<span class="line"><span style="color: #000000">}</span></span></pre></div><p>See <a href="../language/timestamp-operations">Timestamp Operations</a> for more patterns.</p>
<hr/>

      <h2>
        <a id="problem-6-multi-hop-joins" class="header-link anchor" href="#problem-6-multi-hop-joins">
          Problem 6: Multi-hop Joins
        </a>
      </h2>
    
      <h3>
        <a id="symptoms" class="header-link anchor" href="#symptoms">
          Symptoms
        </a>
      </h3>
    <ul>
<li><p>Need to join A to C through intermediate table B</p>
</li>
<li><p>"Cannot reference joined_table.joined_field in join condition"</p>
</li></ul>

      <h3>
        <a id="the-problem" class="header-link anchor" href="#the-problem">
          The Problem
        </a>
      </h3>
    <p>You can't reference a joined table's fields in another join condition:</p>
<div class="code-wrapper"><pre class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #008000">// This doesn&#39;t work</span></span>
<span class="line"><span style="color: #AF00DB">source</span><span style="color: #000000">: </span><span style="color: #001080">orders</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">duckdb</span><span style="color: #000000">.</span><span style="color: #795E26">table</span><span style="color: #000000">(</span><span style="color: #A31515">&#39;orders&#39;</span><span style="color: #000000">) </span><span style="color: #AF00DB">extend</span><span style="color: #000000"> {</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">join_one</span><span style="color: #000000">: </span><span style="color: #001080">customers</span><span style="color: #000000"> </span><span style="color: #AF00DB">with</span><span style="color: #000000"> </span><span style="color: #001080">customer_id</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #008000">// Can&#39;t use customers.region in this join condition</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">join_one</span><span style="color: #000000">: </span><span style="color: #001080">shipments</span><span style="color: #000000"> </span><span style="color: #AF00DB">on</span><span style="color: #000000"> </span><span style="color: #001080">shipments</span><span style="color: #000000">.</span><span style="color: #001080">region</span><span style="color: #000000"> = </span><span style="color: #001080">customers</span><span style="color: #000000">.</span><span style="color: #001080">region</span></span>
<span class="line"><span style="color: #000000">}</span></span></pre></div>
      <h3>
        <a id="fix" class="header-link anchor" href="#fix">
          Fix
        </a>
      </h3>
    <p><strong>Option 1: Flatten the join path</strong></p>
<p>Join directly if possible:</p>
<div class="code-wrapper"><pre class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">source</span><span style="color: #000000">: </span><span style="color: #001080">orders</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">duckdb</span><span style="color: #000000">.</span><span style="color: #795E26">table</span><span style="color: #000000">(</span><span style="color: #A31515">&#39;orders&#39;</span><span style="color: #000000">) </span><span style="color: #AF00DB">extend</span><span style="color: #000000"> {</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">join_one</span><span style="color: #000000">: </span><span style="color: #001080">customers</span><span style="color: #000000"> </span><span style="color: #AF00DB">with</span><span style="color: #000000"> </span><span style="color: #001080">customer_id</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">join_one</span><span style="color: #000000">: </span><span style="color: #001080">shipments</span><span style="color: #000000"> </span><span style="color: #AF00DB">with</span><span style="color: #000000"> </span><span style="color: #001080">shipment_id</span><span style="color: #000000">  </span><span style="color: #008000">// Direct join</span></span>
<span class="line"><span style="color: #000000">}</span></span></pre></div><p><strong>Option 2: Denormalize in SQL source</strong></p>
<div class="code-wrapper"><pre class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">source</span><span style="color: #000000">: </span><span style="color: #001080">orders_with_region</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">duckdb</span><span style="color: #000000">.</span><span style="color: #AF00DB">sql</span><span style="color: #000000">(&quot;&quot;&quot;</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">SELECT</span><span style="color: #000000"> o.*, c.region</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">FROM</span><span style="color: #000000"> orders o</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">JOIN</span><span style="color: #000000"> customers c </span><span style="color: #0000FF">ON</span><span style="color: #000000"> o.customer_id = c.customer_id</span></span>
<span class="line"><span style="color: #000000">&quot;&quot;&quot;) </span><span style="color: #AF00DB">extend</span><span style="color: #000000"> {</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">join_one</span><span style="color: #000000">: </span><span style="color: #001080">shipments</span><span style="color: #000000"> </span><span style="color: #AF00DB">on</span><span style="color: #000000"> </span><span style="color: #001080">region</span><span style="color: #000000"> = </span><span style="color: #001080">shipments</span><span style="color: #000000">.</span><span style="color: #001080">region</span></span>
<span class="line"><span style="color: #000000">}</span></span></pre></div><p>Note: Denormalization trades off the semantic relationship. If <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">customers</span><span style="color: #000000">.</span><span style="color: #001080">region</span></span></code> changes in the source table, the denormalized source won't reflect it until you rebuild the SQL query.</p>
<p><strong>Option 3: Use separate sources</strong></p>
<p>If you need different join paths for different questions, create purpose-specific sources rather than one uber-source.</p>
<hr/>

      <h2>
        <a id="common-error-messages" class="header-link anchor" href="#common-error-messages">
          Common Error Messages
        </a>
      </h2>
    <p>Quick reference for error strings and their likely causes:</p>
<table>
<thead>
<tr>
<th>Error Message</th>

<th>Likely Cause</th>

<th>Solution</th>
</tr>
</thead>
<tbody><tr>
<td><code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">Field</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;x&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">not</span><span style="color: #000000"> </span><span style="color: #001080">found</span><span style="color: #000000"> </span><span style="color: #001080">in</span><span style="color: #000000"> </span><span style="color: #AF00DB">source</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;y&#39;</span></span></code></td>

<td>Typo in field name, or missing import</td>

<td>Check spelling; verify the import includes the source</td>
</tr>

<tr>
<td><code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">Cannot</span><span style="color: #000000"> </span><span style="color: #001080">use</span><span style="color: #000000"> </span><span style="color: #AF00DB">aggregate</span><span style="color: #000000"> </span><span style="color: #001080">in</span><span style="color: #000000"> </span><span style="color: #AF00DB">dimension</span></span></code></td>

<td>Using a measure where a dimension is expected</td>

<td>Define as <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">measure</span><span style="color: #000000">:</span></span></code> not <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">dimension</span><span style="color: #000000">:</span></span></code>, or move to an <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">aggregate</span><span style="color: #000000">:</span></span></code> block</td>
</tr>

<tr>
<td><code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">Reference</span><span style="color: #000000"> </span><span style="color: #0000FF">to</span><span style="color: #000000"> </span><span style="color: #001080">undefined</span><span style="color: #000000"> </span><span style="color: #001080">object</span></span></code></td>

<td>Circular references</td>

<td>See <a href="#problem-4-circular-references">Circular References</a></td>
</tr>

<tr>
<td><code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">Source</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;x&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">not</span><span style="color: #000000"> </span><span style="color: #001080">found</span></span></code></td>

<td>Missing import statement</td>

<td>Add <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">import</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;path/to/file.malloy&quot;</span></span></code></td>
</tr>

<tr>
<td><code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">Cannot</span><span style="color: #000000"> </span><span style="color: #001080">join</span><span style="color: #000000"> </span><span style="color: #AF00DB">on</span><span style="color: #000000"> </span><span style="color: #001080">expression</span></span></code></td>

<td>Using a joined field in another join condition</td>

<td>See <a href="#problem-6-multi-hop-joins">Multi-hop Joins</a></td>
</tr>

<tr>
<td><code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">Primary</span><span style="color: #000000"> </span><span style="color: #001080">key</span><span style="color: #000000"> </span><span style="color: #001080">required</span><span style="color: #000000"> </span><span style="color: #0000FF">for</span><span style="color: #000000"> </span><span style="color: #001080">join</span></span></code></td>

<td>Missing <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">primary_key</span></span></code> declaration on joined source</td>

<td>Add <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">primary_key</span><span style="color: #000000">: </span><span style="color: #001080">field_name</span></span></code> to the target source</td>
</tr>

<tr>
<td>Syntax error on <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #0000FF">year</span></span></code>, <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #267F99">date</span></span></code>, <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #267F99">timestamp</span></span></code></td>

<td>Using a reserved word as field name</td>

<td>Use backticks: <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">`year`</span></span></code>, <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">`date`</span></span></code>, <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">`timestamp`</span></span></code></td>
</tr>
</tbody></table>
</div></div>
        </div>
        <script src="/js/view_toggles.js"></script>
        <script src="/js/jump_to_hash.js"></script>
      </div>
    </div>
    <div id="banner_wrapper">
      <div id="banner">
        <div>
          This site uses cookies from Google to deliver its services and to analyze
          traffic.
          <a
            href="https://policies.google.com/technologies/cookies"
            target="_blank"
          >
            Learn more
          </a>
        </div>
        <button id="banner_button">I Understand</button>
      </div>
    </div>
    <script src="/js/banner.js"></script>
    <script src="/js/generated/malloy-render-0.0.282.js"></script>
  </body>
</html>
