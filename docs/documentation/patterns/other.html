<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Bucketing with &#x27;Other&#x27; | Malloy Documentation</title>
    <link rel="stylesheet" href="/css/document.css" />
    <link
      rel="shortcut icon"
      type="image/x-icon"
      href="/img/favicon.ico"
    />
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-0M10W7C20Y"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
    
      gtag("config", "G-0M10W7C20Y");
    </script>
    <style>
      malloy-render::part(table-container) {
        width: 100%;
      }
    </style>
  </head>
  <body>
    <div class="top">
      <div class="header">
        <div class="header-banner">
          <a href="http://www.malloydata.dev" target="_blank">
            <img
              class="logo"
              src="/img/logo.png"
              alt="malloy logo"
            />
          </a>

          Malloy
          <span class="subtitle">Documentation</span>
        </div>
        <div class="header-right">
          <div class="header-links">
            <a href="https://github.com/malloydata/malloy" target="_blank"
              ><img
                src="/img/github.svg"
                style="transform: scale(0.5)"
            /></a>
            <a href="/slack" target="_blank"
              ><img src="/img/slack.svg"
            /></a>
          </div>
          <form onSubmit="() => alert('submit')" action="/search">
            <div class="search-input-outer">
              <img src="/img/search.svg" alt="search" />
              <input placeholder="Search" id="search-input" name="query" />
            </div>
            <input type="submit" style="display: none" />
          </form>
        </div>
      </div>
      <div class="main">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-section">
              <div id=about_malloy
                class="sidebar-section-title {% unless /documentation/index.html,/documentation/about/features.html,/documentation/about/tao.html contains page.url)} %}collapsed-this-isnt-working-its-always-collapsed-ben-took-it-out{% endunless %}"
              >
                About Malloy
                <img class="chevron-open" src="/img/section_open.svg" alt="section open"/>
                <img class="chevron-closed" src="/img/section_close.svg" alt="section closed"/>
              </div>
              <div class="sidebar-section-item-group">
                <div class='sidebar-item '>
              <a href="/documentation">
                <img src="/img/article_icon.svg" alt="document"/>
                What Is Malloy
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/about/features">
                <img src="/img/article_icon.svg" alt="document"/>
                Key Features
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/about/tao">
                <img src="/img/article_icon.svg" alt="document"/>
                The Tao of Malloy
              </a>
            </div>
              </div>
            </div>
        <div class="sidebar-section">
              <div id=setting_up malloy
                class="sidebar-section-title {% unless /documentation/setup/extension.html,/documentation/setup/connection_instructions.html contains page.url)} %}collapsed-this-isnt-working-its-always-collapsed-ben-took-it-out{% endunless %}"
              >
                Setting up Malloy
                <img class="chevron-open" src="/img/section_open.svg" alt="section open"/>
                <img class="chevron-closed" src="/img/section_close.svg" alt="section closed"/>
              </div>
              <div class="sidebar-section-item-group">
                <div class='sidebar-item '>
              <a href="/documentation/setup/extension">
                <img src="/img/article_icon.svg" alt="document"/>
                Installing the Malloy Extension
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/setup/connection_instructions">
                <img src="/img/article_icon.svg" alt="document"/>
                Connecting a Database
              </a>
            </div>
              </div>
            </div>
        <div class="sidebar-section">
              <div id=user_guides
                class="sidebar-section-title {% unless /documentation/user_guides/querying_a_model.html,/documentation/user_guides/malloy_by_example.html,/documentation/user_guides/sql_experts1.html,/documentation/user_guides/sql_experts2.html contains page.url)} %}collapsed-this-isnt-working-its-always-collapsed-ben-took-it-out{% endunless %}"
              >
                User Guides
                <img class="chevron-open" src="/img/section_open.svg" alt="section open"/>
                <img class="chevron-closed" src="/img/section_close.svg" alt="section closed"/>
              </div>
              <div class="sidebar-section-item-group">
                <div class='sidebar-item '>
              <a href="/documentation/user_guides/querying_a_model">
                <img src="/img/article_icon.svg" alt="document"/>
                Querying a Semantic Model
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/user_guides/malloy_by_example">
                <img src="/img/article_icon.svg" alt="document"/>
                Building Semantic Models
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/user_guides/sql_experts1">
                <img src="/img/article_icon.svg" alt="document"/>
                Malloy for SQL Folks
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/user_guides/sql_experts2">
                <img src="/img/article_icon.svg" alt="document"/>
                More Guidance for SQL Users
              </a>
            </div>
              </div>
            </div>
        <div class="sidebar-section">
              <div id=language_reference
                class="sidebar-section-title {% unless /documentation/language/statement.html,/documentation/language/source.html,/documentation/language/query.html,/documentation/language/views.html,/documentation/language/datatypes.html,/documentation/language/fields.html,/documentation/language/aggregates.html,/documentation/language/expressions.html,/documentation/language/functions.html,/documentation/language/filters.html,/documentation/language/calculations_windows.html,/documentation/language/order_by.html,/documentation/language/join.html,/documentation/language/nesting.html,/documentation/language/sql_sources.html,/documentation/language/imports.html,/documentation/language/connections.html,/documentation/language/tags.html,/documentation/language/quick_reference.html,/documentation/language/changelog.html,/documentation/language/dialect/bigquery.html,/documentation/language/dialect/presto-trino.html,/documentation/language/dialect/snowflake.html,/documentation/language/dialect/mysql.html,/documentation/language/dialect/duckdb.html,/documentation/language/dialect/postgres.html contains page.url)} %}collapsed-this-isnt-working-its-always-collapsed-ben-took-it-out{% endunless %}"
              >
                Language Reference
                <img class="chevron-open" src="/img/section_open.svg" alt="section open"/>
                <img class="chevron-closed" src="/img/section_close.svg" alt="section closed"/>
              </div>
              <div class="sidebar-section-item-group">
                <div class='sidebar-item '>
              <a href="/documentation/language/statement">
                <img src="/img/article_icon.svg" alt="document"/>
                Models
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/language/source">
                <img src="/img/article_icon.svg" alt="document"/>
                Sources
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/language/query">
                <img src="/img/article_icon.svg" alt="document"/>
                Queries
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/language/views">
                <img src="/img/article_icon.svg" alt="document"/>
                Views
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/language/datatypes">
                <img src="/img/article_icon.svg" alt="document"/>
                Data Types
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/language/fields">
                <img src="/img/article_icon.svg" alt="document"/>
                Fields
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/language/aggregates">
                <img src="/img/article_icon.svg" alt="document"/>
                Aggregates
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/language/expressions">
                <img src="/img/article_icon.svg" alt="document"/>
                Expressions
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/language/functions">
                <img src="/img/article_icon.svg" alt="document"/>
                Functions
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/language/filters">
                <img src="/img/article_icon.svg" alt="document"/>
                Filters
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/language/calculations_windows">
                <img src="/img/article_icon.svg" alt="document"/>
                Calculations (window functions)
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/language/order_by">
                <img src="/img/article_icon.svg" alt="document"/>
                Ordering and Limiting
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/language/join">
                <img src="/img/article_icon.svg" alt="document"/>
                Joins
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/language/nesting">
                <img src="/img/article_icon.svg" alt="document"/>
                Nested Views
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/language/sql_sources">
                <img src="/img/article_icon.svg" alt="document"/>
                SQL Sources
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/language/imports">
                <img src="/img/article_icon.svg" alt="document"/>
                Imports
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/language/connections">
                <img src="/img/article_icon.svg" alt="document"/>
                Connections
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/language/tags">
                <img src="/img/article_icon.svg" alt="document"/>
                Tags
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/language/quick_reference.html">
                <img src="/img/article_icon.svg" alt="document"/>
                Quick Reference
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/language/changelog">
                <img src="/img/article_icon.svg" alt="document"/>
                Change Log
              </a>
            </div>
        <div class="sidebar-section">
              <div id=dialects
                class="sidebar-section-title {% unless /documentation/language/dialect/bigquery.html,/documentation/language/dialect/presto-trino.html,/documentation/language/dialect/snowflake.html,/documentation/language/dialect/mysql.html,/documentation/language/dialect/duckdb.html,/documentation/language/dialect/postgres.html contains page.url)} %}collapsed-this-isnt-working-its-always-collapsed-ben-took-it-out{% endunless %}"
              >
                Dialects
                <img class="chevron-open" src="/img/section_open.svg" alt="section open"/>
                <img class="chevron-closed" src="/img/section_close.svg" alt="section closed"/>
              </div>
              <div class="sidebar-section-item-group">
                <div class='sidebar-item '>
              <a href="/documentation/language/dialect/bigquery">
                <img src="/img/article_icon.svg" alt="document"/>
                BigQuery
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/language/dialect/presto-trino">
                <img src="/img/article_icon.svg" alt="document"/>
                Presto / Trino
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/language/dialect/snowflake">
                <img src="/img/article_icon.svg" alt="document"/>
                Snowflake
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/language/dialect/mysql">
                <img src="/img/article_icon.svg" alt="document"/>
                MySQL
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/language/dialect/duckdb">
                <img src="/img/article_icon.svg" alt="document"/>
                DuckDB
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/language/dialect/postgres">
                <img src="/img/article_icon.svg" alt="document"/>
                PostgreSQL
              </a>
            </div>
              </div>
            </div>
              </div>
            </div>
        <div class="sidebar-section">
              <div id=common_patterns
                class="sidebar-section-title {% unless /documentation/patterns/yoy.html,/documentation/patterns/foreign_sums.html,/documentation/patterns/reading_nested.html,/documentation/patterns/percent_of_total.html,/documentation/patterns/cohorts.html,/documentation/patterns/nested_subtotals.html,/documentation/patterns/other.html,/documentation/patterns/autobin.html,/documentation/patterns/moving_avg.html,/documentation/patterns/transform.html,/documentation/patterns/sessionize.html,/documentation/patterns/dim_index.html contains page.url)} %}collapsed-this-isnt-working-its-always-collapsed-ben-took-it-out{% endunless %}"
              >
                Common Patterns
                <img class="chevron-open" src="/img/section_open.svg" alt="section open"/>
                <img class="chevron-closed" src="/img/section_close.svg" alt="section closed"/>
              </div>
              <div class="sidebar-section-item-group">
                <div class='sidebar-item '>
              <a href="/documentation/patterns/yoy">
                <img src="/img/article_icon.svg" alt="document"/>
                Comparing Timeframes
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/patterns/foreign_sums">
                <img src="/img/article_icon.svg" alt="document"/>
                Foreign Sums and Averages
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/patterns/reading_nested">
                <img src="/img/article_icon.svg" alt="document"/>
                Reading Nested Data
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/patterns/percent_of_total">
                <img src="/img/article_icon.svg" alt="document"/>
                Percent of Total
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/patterns/cohorts">
                <img src="/img/article_icon.svg" alt="document"/>
                Cohort Analysis
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/patterns/nested_subtotals">
                <img src="/img/article_icon.svg" alt="document"/>
                Nested Subtotals
              </a>
            </div>
        <div class='sidebar-item active'>
              <a href="/documentation/patterns/other">
                <img src="/img/article_icon.svg" alt="document"/>
                Bucketing with 'Other'
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/patterns/autobin">
                <img src="/img/article_icon.svg" alt="document"/>
                Auto-binning Histograms
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/patterns/moving_avg">
                <img src="/img/article_icon.svg" alt="document"/>
                Moving Average
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/patterns/transform">
                <img src="/img/article_icon.svg" alt="document"/>
                Transform Data
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/patterns/sessionize">
                <img src="/img/article_icon.svg" alt="document"/>
                Sessionize - Map/Reduce
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/patterns/dim_index">
                <img src="/img/article_icon.svg" alt="document"/>
                Dimensional Indexes
              </a>
            </div>
              </div>
            </div>
        <div class="sidebar-section">
              <div id=rendering_results
                class="sidebar-section-title {% unless /documentation/visualizations/about_rendering.html contains page.url)} %}collapsed-this-isnt-working-its-always-collapsed-ben-took-it-out{% endunless %}"
              >
                Rendering Results
                <img class="chevron-open" src="/img/section_open.svg" alt="section open"/>
                <img class="chevron-closed" src="/img/section_close.svg" alt="section closed"/>
              </div>
              <div class="sidebar-section-item-group">
                <div class='sidebar-item '>
              <a href="/documentation/visualizations/about_rendering">
                <img src="/img/article_icon.svg" alt="document"/>
                Overview
              </a>
            </div>
              </div>
            </div>
        <div class="sidebar-section">
              <div id=rendering_legacy docs
                class="sidebar-section-title {% unless /documentation/visualizations/overview.html,/documentation/visualizations/numbers.html,/documentation/visualizations/links.html,/documentation/visualizations/pivots.html,/documentation/visualizations/transpose.html,/documentation/visualizations/dashboards.html,/documentation/visualizations/lists.html,/documentation/visualizations/bar_charts.html,/documentation/visualizations/charts_line_chart.html,/documentation/visualizations/scatter_charts.html,/documentation/visualizations/shape_maps.html,/documentation/visualizations/segment_maps.html,/documentation/visualizations/legacy_renderer.html contains page.url)} %}collapsed-this-isnt-working-its-always-collapsed-ben-took-it-out{% endunless %}"
              >
                Rendering Legacy Docs
                <img class="chevron-open" src="/img/section_open.svg" alt="section open"/>
                <img class="chevron-closed" src="/img/section_close.svg" alt="section closed"/>
              </div>
              <div class="sidebar-section-item-group">
                <div class='sidebar-item '>
              <a href="/documentation/visualizations/overview">
                <img src="/img/article_icon.svg" alt="document"/>
                Overview
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/visualizations/numbers">
                <img src="/img/article_icon.svg" alt="document"/>
                Numbers
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/visualizations/links">
                <img src="/img/article_icon.svg" alt="document"/>
                Links
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/visualizations/pivots">
                <img src="/img/article_icon.svg" alt="document"/>
                Pivoted Tables
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/visualizations/transpose">
                <img src="/img/article_icon.svg" alt="document"/>
                Table Transpose
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/visualizations/dashboards">
                <img src="/img/article_icon.svg" alt="document"/>
                Dashboards
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/visualizations/lists">
                <img src="/img/article_icon.svg" alt="document"/>
                Lists
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/visualizations/bar_charts">
                <img src="/img/article_icon.svg" alt="document"/>
                Bar Charts
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/visualizations/charts_line_chart">
                <img src="/img/article_icon.svg" alt="document"/>
                Line Charts
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/visualizations/scatter_charts">
                <img src="/img/article_icon.svg" alt="document"/>
                Scatter Charts
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/visualizations/shape_maps">
                <img src="/img/article_icon.svg" alt="document"/>
                Shape Maps
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/visualizations/segment_maps">
                <img src="/img/article_icon.svg" alt="document"/>
                Segment Maps
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/visualizations/legacy_renderer">
                <img src="/img/article_icon.svg" alt="document"/>
                Legacy Renderer
              </a>
            </div>
              </div>
            </div>
        <div class="sidebar-section">
              <div id=malloysql
                class="sidebar-section-title {% unless /documentation/malloy_sql/index.html contains page.url)} %}collapsed-this-isnt-working-its-always-collapsed-ben-took-it-out{% endunless %}"
              >
                MalloySQL
                <img class="chevron-open" src="/img/section_open.svg" alt="section open"/>
                <img class="chevron-closed" src="/img/section_close.svg" alt="section closed"/>
              </div>
              <div class="sidebar-section-item-group">
                <div class='sidebar-item '>
              <a href="/documentation/malloy_sql/index">
                <img src="/img/article_icon.svg" alt="document"/>
                Using MalloySQL
              </a>
            </div>
              </div>
            </div>
        <div class="sidebar-section">
              <div id=malloy_cli
                class="sidebar-section-title {% unless /documentation/malloy_cli/index.html contains page.url)} %}collapsed-this-isnt-working-its-always-collapsed-ben-took-it-out{% endunless %}"
              >
                Malloy CLI
                <img class="chevron-open" src="/img/section_open.svg" alt="section open"/>
                <img class="chevron-closed" src="/img/section_close.svg" alt="section closed"/>
              </div>
              <div class="sidebar-section-item-group">
                <div class='sidebar-item '>
              <a href="/documentation/malloy_cli/index">
                <img src="/img/article_icon.svg" alt="document"/>
                The Malloy CLI
              </a>
            </div>
              </div>
            </div>
        <div class="sidebar-section">
              <div id=malloy_with python
                class="sidebar-section-title {% unless /documentation/malloy_python/python_package.html,/documentation/malloy_python/jupyter.html contains page.url)} %}collapsed-this-isnt-working-its-always-collapsed-ben-took-it-out{% endunless %}"
              >
                Malloy with Python
                <img class="chevron-open" src="/img/section_open.svg" alt="section open"/>
                <img class="chevron-closed" src="/img/section_close.svg" alt="section closed"/>
              </div>
              <div class="sidebar-section-item-group">
                <div class='sidebar-item '>
              <a href="/documentation/malloy_python/python_package">
                <img src="/img/article_icon.svg" alt="document"/>
                Malloy Python Package
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/malloy_python/jupyter">
                <img src="/img/article_icon.svg" alt="document"/>
                Malloy in Jupyter Notebooks
              </a>
            </div>
              </div>
            </div>
        <div class="sidebar-section">
              <div id=experiments_(in process features)
                class="sidebar-section-title {% unless /documentation/experiments/experiments.html,/documentation/experiments/joins.html,/documentation/experiments/sql_expressions.html,/documentation/experiments/window.html,/documentation/experiments/parameters.html,/documentation/experiments/composite_sources.html,/documentation/experiments/include.html contains page.url)} %}collapsed-this-isnt-working-its-always-collapsed-ben-took-it-out{% endunless %}"
              >
                Experiments (in process features)
                <img class="chevron-open" src="/img/section_open.svg" alt="section open"/>
                <img class="chevron-closed" src="/img/section_close.svg" alt="section closed"/>
              </div>
              <div class="sidebar-section-item-group">
                <div class='sidebar-item '>
              <a href="/documentation/experiments/experiments">
                <img src="/img/article_icon.svg" alt="document"/>
                Experiments
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/experiments/joins">
                <img src="/img/article_icon.svg" alt="document"/>
                Join INNER/RIGHT/FULL
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/experiments/sql_expressions">
                <img src="/img/article_icon.svg" alt="document"/>
                SQL Expressions
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/experiments/window">
                <img src="/img/article_icon.svg" alt="document"/>
                Window Partitions
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/experiments/parameters">
                <img src="/img/article_icon.svg" alt="document"/>
                Parameters
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/experiments/composite_sources">
                <img src="/img/article_icon.svg" alt="document"/>
                Composite "Cube" Sources
              </a>
            </div>
        <div class='sidebar-item '>
              <a href="/documentation/experiments/include">
                <img src="/img/article_icon.svg" alt="document"/>
                Access Modifiers
              </a>
            </div>
              </div>
            </div>
          </div>        <script src="/js/sidebar_state.js"></script>
        <div class="content">
          <div class="footer">
            
<div class="linear-navigation">
  <div class="item">
      <a href="nested_subtotals.html"><img src="/img/previous.svg" alt="previous"/>Nested Subtotals</a>
  </div>
  <div class="item">
      <a href="autobin.html">Auto-binning Histograms<img src="/img/next.svg" alt="next"/></a>
  </div>
</div> 
          </div>
          <div class="document-outer"><div class="document"><div class="title-row">
        
      <h1>
        <a id="bucketing-with-other-" class="header-link anchor" href="#bucketing-with-other-">
          Bucketing with 'Other'
        </a>
      </h1>
    
        <a class="edit-link" target="_blank" href="https://github.dev/malloydata/malloydata.github.io/blob/main/src/documentation/patterns/other.malloynb#C1">VSCode <img src="/img/open_notebook.svg" alt="document"/></a>
        </div>
      <p>Often you want to limit the number of group-by values in a table, and bucket everything else into an 'other' category.</p>
<p>In the <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">top_states_by_eleveation</span></span></code> query below, we have a query with two stages. The first stage calculates the top states and nests the data to be aggregated. The second pipeline stage produces the actual aggregation.</p>
<div class="code-wrapper"><a href="https://github.dev/malloydata/malloydata.github.io/blob/main/src/documentation/patterns/other.malloynb#C2" target="_blank" class="open_notebook"><img src="/img/open_notebook.svg" alt="document"/></a><pre class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">source</span><span style="color: #000000">: </span><span style="color: #001080">airports</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">duckdb</span><span style="color: #000000">.</span><span style="color: #795E26">table</span><span style="color: #000000">(</span><span style="color: #A31515">&#39;../data/airports.parquet&#39;</span><span style="color: #000000">) </span><span style="color: #AF00DB">extend</span><span style="color: #000000"> {</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">measure</span><span style="color: #000000">: </span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #001080">airport_count</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #795E26">count</span><span style="color: #000000">()</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #001080">avg_elevation</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">elevation</span><span style="color: #000000">.</span><span style="color: #795E26">avg</span><span style="color: #000000">()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">view</span><span style="color: #000000">: </span><span style="color: #001080">top_states_by_elevation</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #AF00DB">group_by</span><span style="color: #000000">: </span><span style="color: #001080">state</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #AF00DB">aggregate</span><span style="color: #000000">: </span><span style="color: #001080">avg_elevation</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #AF00DB">calculate</span><span style="color: #000000">: </span><span style="color: #001080">is_other</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #795E26">row_number</span><span style="color: #000000">() &gt; </span><span style="color: #098658">5</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #AF00DB">nest</span><span style="color: #000000">: </span><span style="color: #001080">data</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000">  {  </span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #AF00DB">group_by</span><span style="color: #000000">: </span><span style="color: #001080">code</span><span style="color: #000000">, </span><span style="color: #001080">elevation</span></span>
<span class="line"><span style="color: #000000">    }</span></span>
<span class="line"><span style="color: #000000">  } -&gt; {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #AF00DB">group_by</span><span style="color: #000000">: </span><span style="color: #001080">state</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">pick</span><span style="color: #000000"> </span><span style="color: #001080">state</span><span style="color: #000000"> </span><span style="color: #0000FF">when</span><span style="color: #000000"> </span><span style="color: #0000FF">not</span><span style="color: #000000"> </span><span style="color: #001080">is_other</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">else</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;OTHER&#39;</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #AF00DB">aggregate</span><span style="color: #000000">: </span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #001080">avg_elevation</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">data</span><span style="color: #000000">.</span><span style="color: #001080">elevation</span><span style="color: #000000">.</span><span style="color: #795E26">avg</span><span style="color: #000000">()</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #001080">airport_count</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">data</span><span style="color: #000000">.</span><span style="color: #795E26">count</span><span style="color: #000000">()</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0451A5"># hidden</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #001080">sort</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">data</span><span style="color: #000000">.</span><span style="color: #795E26">count</span><span style="color: #000000">() {</span><span style="color: #AF00DB">where</span><span style="color: #000000">: </span><span style="color: #0000FF">not</span><span style="color: #000000"> </span><span style="color: #001080">is_other</span><span style="color: #000000"> }</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #AF00DB">order_by</span><span style="color: #000000">: </span><span style="color: #001080">sort</span><span style="color: #000000"> </span><span style="color: #AF00DB">desc</span></span>
<span class="line"><span style="color: #000000">  }</span></span>
<span class="line"><span style="color: #000000">}</span></span></pre></div>
      <h2>
        <a id="basic-query" class="header-link anchor" href="#basic-query">
          Basic Query
        </a>
      </h2>
    <div class="code-wrapper"><a href="https://github.dev/malloydata/malloydata.github.io/blob/main/src/documentation/patterns/other.malloynb#C4" target="_blank" class="open_notebook"><img src="/img/open_notebook.svg" alt="document"/></a><pre class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">run</span><span style="color: #000000">: </span><span style="color: #001080">airports</span><span style="color: #000000"> -&gt; </span><span style="color: #001080">top_states_by_elevation</span></span></pre><div class="result-outer large">
    <div class="result-controls-bar">
      <span class="result-label">QUERY RESULTS</span>
      <div class="result-controls">
        <button class="result-control" selected data-result-kind="html">HTML</button>
        <button class="result-control"  data-result-kind="json">JSON</button>
        <button class="result-control"  data-result-kind="sql">SQL</button>
      </div>
    </div>
    <div class="result-middle" data-result-kind="html" selected>
      <div class="result-inner" id="2342d483-7b4b-463b-9d6b-2f650b2020fd">
        <script>(()=>{var e=document.getElementById("2342d483-7b4b-463b-9d6b-2f650b2020fd"),t=document.createElement("malloy-render");t.modelDef={name:"",exports:["airports"],contents:{airports:{type:"table",name:"duckdb:../data/airports.parquet",dialect:"duckdb",tablePath:"../data/airports.parquet",connection:"duckdb",fields:[{type:"number",numberType:"integer",name:"id",fieldUsage:[{path:["id"]}]},{type:"string",name:"code",fieldUsage:[{path:["code"]}]},{type:"string",name:"site_number",fieldUsage:[{path:["site_number"]}]},{type:"string",name:"fac_type",fieldUsage:[{path:["fac_type"]}]},{type:"string",name:"fac_use",fieldUsage:[{path:["fac_use"]}]},{type:"string",name:"faa_region",fieldUsage:[{path:["faa_region"]}]},{type:"string",name:"faa_dist",fieldUsage:[{path:["faa_dist"]}]},{type:"string",name:"city",fieldUsage:[{path:["city"]}]},{type:"string",name:"county",fieldUsage:[{path:["county"]}]},{type:"string",name:"state",fieldUsage:[{path:["state"]}]},{type:"string",name:"full_name",fieldUsage:[{path:["full_name"]}]},{type:"string",name:"own_type",fieldUsage:[{path:["own_type"]}]},{type:"number",numberType:"float",name:"longitude",fieldUsage:[{path:["longitude"]}]},{type:"number",numberType:"float",name:"latitude",fieldUsage:[{path:["latitude"]}]},{type:"number",numberType:"integer",name:"elevation",fieldUsage:[{path:["elevation"]}]},{type:"string",name:"aero_cht",fieldUsage:[{path:["aero_cht"]}]},{type:"number",numberType:"integer",name:"cbd_dist",fieldUsage:[{path:["cbd_dist"]}]},{type:"string",name:"cbd_dir",fieldUsage:[{path:["cbd_dir"]}]},{type:"string",name:"act_date",fieldUsage:[{path:["act_date"]}]},{type:"string",name:"cert",fieldUsage:[{path:["cert"]}]},{type:"string",name:"fed_agree",fieldUsage:[{path:["fed_agree"]}]},{type:"string",name:"cust_intl",fieldUsage:[{path:["cust_intl"]}]},{type:"string",name:"c_ldg_rts",fieldUsage:[{path:["c_ldg_rts"]}]},{type:"string",name:"joint_use",fieldUsage:[{path:["joint_use"]}]},{type:"string",name:"mil_rts",fieldUsage:[{path:["mil_rts"]}]},{type:"string",name:"cntl_twr",fieldUsage:[{path:["cntl_twr"]}]},{type:"string",name:"major",fieldUsage:[{path:["major"]}]},{type:"number",numberType:"integer",name:"airport_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},{type:"number",numberType:"integer",name:"avg_elevation",e:{node:"aggregate",function:"avg",e:{node:"field",path:["elevation"]}},fieldUsage:[{path:["elevation"]}],expressionType:"aggregate",code:"elevation.avg()"},{type:"turtle",name:"top_states_by_elevation",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["state"]},{type:"fieldref",path:["avg_elevation"]},{type:"boolean",name:"is_other",e:{node:">",kids:{left:{node:"function_call",overload:{returnType:{type:"number",expressionType:"scalar_analytic",evalSpace:"input"},params:[],dialect:{postgres:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0},standardsql:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0},duckdb:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0},snowflake:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0},trino:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0},presto:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0},mysql:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0}}},name:"row_number",kids:{args:[]},expressionType:"scalar_analytic"},right:{node:"numberLiteral",literal:"5"}}},expressionType:"scalar_analytic",code:"row_number() > 5"},{type:"turtle",name:"data",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["code"],drillView:"data"},{type:"fieldref",path:["elevation"],drillView:"data"}],filterList:[],fieldUsage:[{path:["code"]},{path:["elevation"]}],defaultOrderBy:!0,orderBy:[{field:"code",dir:"asc"}]}],annotation:{},fieldUsage:[{path:["code"]},{path:["elevation"]}]}],filterList:[],fieldUsage:[{path:["state"]},{path:["avg_elevation"]},{path:["code"]},{path:["elevation"]}],defaultOrderBy:!0,orderBy:[{field:"avg_elevation",dir:"desc"}]},{type:"reduce",queryFields:[{type:"string",name:"state",e:{node:"case",kids:{caseWhen:[{node:"not",e:{node:"field",path:["is_other"]}}],caseThen:[{node:"field",path:["state"]}],caseElse:{node:"stringLiteral",literal:"OTHER"}}},fieldUsage:[{path:["state"]},{path:["is_other"]}],expressionType:"scalar",code:"pick state when not is_other\n      else 'OTHER'"},{type:"number",numberType:"integer",name:"avg_elevation",e:{node:"aggregate",function:"avg",e:{node:"field",path:["data","elevation"]},structPath:["data"]},fieldUsage:[],expressionType:"aggregate",code:"data.elevation.avg()"},{type:"number",numberType:"integer",name:"airport_count",e:{node:"aggregate",function:"count",e:{node:""},structPath:["data"]},fieldUsage:[],expressionType:"aggregate",code:"data.count()"},{type:"number",numberType:"integer",name:"sort",e:{node:"filteredExpr",kids:{e:{node:"aggregate",function:"count",e:{node:""},structPath:["data"]},filterList:[{node:"filterCondition",code:"not is_other",e:{node:"not",e:{node:"field",path:["is_other"]}},expressionType:"scalar",fieldUsage:[{path:["is_other"]}]}]}},fieldUsage:[{path:["is_other"]}],expressionType:"aggregate",code:"data.count() {where: not is_other }",annotation:{notes:[{text:"# hidden\n"}]}}],orderBy:[{field:"sort",dir:"desc"}],filterList:[],fieldUsage:[{path:["state"]},{path:["is_other"]},{path:["is_other"]}]}],annotation:{}}],parameters:{},as:"airports"}},queryList:[{type:"query",structRef:"airports",sourceArguments:{},pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["state"]},{type:"fieldref",path:["avg_elevation"]},{type:"boolean",name:"is_other",e:{node:">",kids:{left:{node:"function_call",overload:{returnType:{type:"number",expressionType:"scalar_analytic",evalSpace:"input"},params:[],dialect:{postgres:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0},standardsql:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0},duckdb:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0},snowflake:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0},trino:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0},presto:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0},mysql:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0}}},name:"row_number",kids:{args:[]},expressionType:"scalar_analytic"},right:{node:"numberLiteral",literal:"5"}}},expressionType:"scalar_analytic",code:"row_number() > 5"},{type:"turtle",name:"data",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["code"],drillView:"data"},{type:"fieldref",path:["elevation"],drillView:"data"}],filterList:[],fieldUsage:[{path:["code"]},{path:["elevation"]}],defaultOrderBy:!0,orderBy:[{field:"code",dir:"asc"}]}],annotation:{},fieldUsage:[{path:["code"]},{path:["elevation"]}]}],filterList:[],fieldUsage:[{path:["state"]},{path:["avg_elevation"]},{path:["code"]},{path:["elevation"]}],defaultOrderBy:!0,orderBy:[{field:"avg_elevation",dir:"desc"}],referencedAt:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/documentation/patterns/other.malloynb",range:{start:{line:1,character:17},end:{line:1,character:40}}}},{type:"reduce",queryFields:[{type:"string",name:"state",e:{node:"case",kids:{caseWhen:[{node:"not",e:{node:"field",path:["is_other"]}}],caseThen:[{node:"field",path:["state"]}],caseElse:{node:"stringLiteral",literal:"OTHER"}}},fieldUsage:[{path:["state"]},{path:["is_other"]}],expressionType:"scalar",code:"pick state when not is_other\n      else 'OTHER'"},{type:"number",numberType:"integer",name:"avg_elevation",e:{node:"aggregate",function:"avg",e:{node:"field",path:["data","elevation"]},structPath:["data"]},fieldUsage:[],expressionType:"aggregate",code:"data.elevation.avg()"},{type:"number",numberType:"integer",name:"airport_count",e:{node:"aggregate",function:"count",e:{node:""},structPath:["data"]},fieldUsage:[],expressionType:"aggregate",code:"data.count()"},{type:"number",numberType:"integer",name:"sort",e:{node:"filteredExpr",kids:{e:{node:"aggregate",function:"count",e:{node:""},structPath:["data"]},filterList:[{node:"filterCondition",code:"not is_other",e:{node:"not",e:{node:"field",path:["is_other"]}},expressionType:"scalar",fieldUsage:[{path:["is_other"]}]}]}},fieldUsage:[{path:["is_other"]}],expressionType:"aggregate",code:"data.count() {where: not is_other }",annotation:{notes:[{text:"# hidden\n"}]}}],orderBy:[{field:"sort",dir:"desc"}],filterList:[],fieldUsage:[{path:["state"]},{path:["is_other"]},{path:["is_other"]}]}],name:"top_states_by_elevation",annotation:{notes:[],blockNotes:[{text:"#(docs) size=large limit=5000\n"}],inherits:{}}}],dependencies:{},references:[{type:"exploreReference",text:"airports",definition:{type:"table",name:"duckdb:../data/airports.parquet",dialect:"duckdb",tablePath:"../data/airports.parquet",connection:"duckdb",fields:[{type:"number",numberType:"integer",name:"id",fieldUsage:[{path:["id"]}]},{type:"string",name:"code",fieldUsage:[{path:["code"]}]},{type:"string",name:"site_number",fieldUsage:[{path:["site_number"]}]},{type:"string",name:"fac_type",fieldUsage:[{path:["fac_type"]}]},{type:"string",name:"fac_use",fieldUsage:[{path:["fac_use"]}]},{type:"string",name:"faa_region",fieldUsage:[{path:["faa_region"]}]},{type:"string",name:"faa_dist",fieldUsage:[{path:["faa_dist"]}]},{type:"string",name:"city",fieldUsage:[{path:["city"]}]},{type:"string",name:"county",fieldUsage:[{path:["county"]}]},{type:"string",name:"state",fieldUsage:[{path:["state"]}]},{type:"string",name:"full_name",fieldUsage:[{path:["full_name"]}]},{type:"string",name:"own_type",fieldUsage:[{path:["own_type"]}]},{type:"number",numberType:"float",name:"longitude",fieldUsage:[{path:["longitude"]}]},{type:"number",numberType:"float",name:"latitude",fieldUsage:[{path:["latitude"]}]},{type:"number",numberType:"integer",name:"elevation",fieldUsage:[{path:["elevation"]}]},{type:"string",name:"aero_cht",fieldUsage:[{path:["aero_cht"]}]},{type:"number",numberType:"integer",name:"cbd_dist",fieldUsage:[{path:["cbd_dist"]}]},{type:"string",name:"cbd_dir",fieldUsage:[{path:["cbd_dir"]}]},{type:"string",name:"act_date",fieldUsage:[{path:["act_date"]}]},{type:"string",name:"cert",fieldUsage:[{path:["cert"]}]},{type:"string",name:"fed_agree",fieldUsage:[{path:["fed_agree"]}]},{type:"string",name:"cust_intl",fieldUsage:[{path:["cust_intl"]}]},{type:"string",name:"c_ldg_rts",fieldUsage:[{path:["c_ldg_rts"]}]},{type:"string",name:"joint_use",fieldUsage:[{path:["joint_use"]}]},{type:"string",name:"mil_rts",fieldUsage:[{path:["mil_rts"]}]},{type:"string",name:"cntl_twr",fieldUsage:[{path:["cntl_twr"]}]},{type:"string",name:"major",fieldUsage:[{path:["major"]}]},{type:"number",numberType:"integer",name:"airport_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},{type:"number",numberType:"integer",name:"avg_elevation",e:{node:"aggregate",function:"avg",e:{node:"field",path:["elevation"]}},fieldUsage:[{path:["elevation"]}],expressionType:"aggregate",code:"elevation.avg()"},{type:"turtle",name:"top_states_by_elevation",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["state"]},{type:"fieldref",path:["avg_elevation"]},{type:"boolean",name:"is_other",e:{node:">",kids:{left:{node:"function_call",overload:{returnType:{type:"number",expressionType:"scalar_analytic",evalSpace:"input"},params:[],dialect:{postgres:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0},standardsql:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0},duckdb:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0},snowflake:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0},trino:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0},presto:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0},mysql:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0}}},name:"row_number",kids:{args:[]},expressionType:"scalar_analytic"},right:{node:"numberLiteral",literal:"5"}}},expressionType:"scalar_analytic",code:"row_number() > 5"},{type:"turtle",name:"data",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["code"],drillView:"data"},{type:"fieldref",path:["elevation"],drillView:"data"}],filterList:[],fieldUsage:[{path:["code"]},{path:["elevation"]}],defaultOrderBy:!0,orderBy:[{field:"code",dir:"asc"}]}],annotation:{},fieldUsage:[{path:["code"]},{path:["elevation"]}]}],filterList:[],fieldUsage:[{path:["state"]},{path:["avg_elevation"]},{path:["code"]},{path:["elevation"]}],defaultOrderBy:!0,orderBy:[{field:"avg_elevation",dir:"desc"}]},{type:"reduce",queryFields:[{type:"string",name:"state",e:{node:"case",kids:{caseWhen:[{node:"not",e:{node:"field",path:["is_other"]}}],caseThen:[{node:"field",path:["state"]}],caseElse:{node:"stringLiteral",literal:"OTHER"}}},fieldUsage:[{path:["state"]},{path:["is_other"]}],expressionType:"scalar",code:"pick state when not is_other\n      else 'OTHER'"},{type:"number",numberType:"integer",name:"avg_elevation",e:{node:"aggregate",function:"avg",e:{node:"field",path:["data","elevation"]},structPath:["data"]},fieldUsage:[],expressionType:"aggregate",code:"data.elevation.avg()"},{type:"number",numberType:"integer",name:"airport_count",e:{node:"aggregate",function:"count",e:{node:""},structPath:["data"]},fieldUsage:[],expressionType:"aggregate",code:"data.count()"},{type:"number",numberType:"integer",name:"sort",e:{node:"filteredExpr",kids:{e:{node:"aggregate",function:"count",e:{node:""},structPath:["data"]},filterList:[{node:"filterCondition",code:"not is_other",e:{node:"not",e:{node:"field",path:["is_other"]}},expressionType:"scalar",fieldUsage:[{path:["is_other"]}]}]}},fieldUsage:[{path:["is_other"]}],expressionType:"aggregate",code:"data.count() {where: not is_other }",annotation:{notes:[{text:"# hidden\n"}]}}],orderBy:[{field:"sort",dir:"desc"}],filterList:[],fieldUsage:[{path:["state"]},{path:["is_other"]},{path:["is_other"]}]}],annotation:{}}],parameters:{},as:"airports"}},{type:"fieldReference",definition:{type:"turtle",name:"top_states_by_elevation",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["state"]},{type:"fieldref",path:["avg_elevation"]},{type:"boolean",name:"is_other",e:{node:">",kids:{left:{node:"function_call",overload:{returnType:{type:"number",expressionType:"scalar_analytic",evalSpace:"input"},params:[],dialect:{postgres:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0},standardsql:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0},duckdb:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0},snowflake:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0},trino:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0},presto:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0},mysql:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0}}},name:"row_number",kids:{args:[]},expressionType:"scalar_analytic"},right:{node:"numberLiteral",literal:"5"}}},expressionType:"scalar_analytic",code:"row_number() > 5"},{type:"turtle",name:"data",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["code"],drillView:"data"},{type:"fieldref",path:["elevation"],drillView:"data"}],filterList:[],fieldUsage:[{path:["code"]},{path:["elevation"]}],defaultOrderBy:!0,orderBy:[{field:"code",dir:"asc"}]}],annotation:{},fieldUsage:[{path:["code"]},{path:["elevation"]}]}],filterList:[],fieldUsage:[{path:["state"]},{path:["avg_elevation"]},{path:["code"]},{path:["elevation"]}],defaultOrderBy:!0,orderBy:[{field:"avg_elevation",dir:"desc"}]},{type:"reduce",queryFields:[{type:"string",name:"state",e:{node:"case",kids:{caseWhen:[{node:"not",e:{node:"field",path:["is_other"]}}],caseThen:[{node:"field",path:["state"]}],caseElse:{node:"stringLiteral",literal:"OTHER"}}},fieldUsage:[{path:["state"]},{path:["is_other"]}],expressionType:"scalar",code:"pick state when not is_other\n      else 'OTHER'"},{type:"number",numberType:"integer",name:"avg_elevation",e:{node:"aggregate",function:"avg",e:{node:"field",path:["data","elevation"]},structPath:["data"]},fieldUsage:[],expressionType:"aggregate",code:"data.elevation.avg()"},{type:"number",numberType:"integer",name:"airport_count",e:{node:"aggregate",function:"count",e:{node:""},structPath:["data"]},fieldUsage:[],expressionType:"aggregate",code:"data.count()"},{type:"number",numberType:"integer",name:"sort",e:{node:"filteredExpr",kids:{e:{node:"aggregate",function:"count",e:{node:""},structPath:["data"]},filterList:[{node:"filterCondition",code:"not is_other",e:{node:"not",e:{node:"field",path:["is_other"]}},expressionType:"scalar",fieldUsage:[{path:["is_other"]}]}]}},fieldUsage:[{path:["is_other"]}],expressionType:"aggregate",code:"data.count() {where: not is_other }",annotation:{notes:[{text:"# hidden\n"}]}}],orderBy:[{field:"sort",dir:"desc"}],filterList:[],fieldUsage:[{path:["state"]},{path:["is_other"]},{path:["is_other"]}]}],annotation:{}},text:"top_states_by_elevation"}],imports:[]},t.queryResult={lastStageName:"__stage2",malloy:"",sql:'WITH __stage0 AS (\n  SELECT\n    group_set,\n    base."state" as "state__0",\n    CASE WHEN group_set=0 THEN\n      AVG(base."elevation")\n      END as "avg_elevation__0",\n    (CASE WHEN group_set=0 THEN ROW_NUMBER() OVER(PARTITION BY group_set  ORDER BY  CASE WHEN group_set=0 THEN\n      AVG(base."elevation")\n      END desc NULLS LAST ) END)>5 as "is_other__0",\n    CASE WHEN group_set=1 THEN\n      base."code"\n      END as "code__1",\n    CASE WHEN group_set=1 THEN\n      base."elevation"\n      END as "elevation__1"\n  FROM \'../data/airports.parquet\' as base\n  CROSS JOIN (SELECT UNNEST(GENERATE_SERIES(0,1,1)) as group_set  ) as group_set\n  GROUP BY 1,2,5,6\n)\n, __stage1 AS (\n  SELECT\n    "state__0" as "state",\n    MAX(CASE WHEN group_set=0 THEN "avg_elevation__0" END) as "avg_elevation",\n    MAX(CASE WHEN group_set=0 THEN "is_other__0" END) as "is_other",\n    COALESCE(LIST({\n      "code": "code__1", \n      "elevation": "elevation__1"}  ORDER BY  "code__1" asc NULLS LAST) FILTER (WHERE group_set=1),[]) as "data"\n  FROM __stage0\n  GROUP BY 1\n)\nSELECT \n   CASE WHEN COALESCE(NOT base."is_other",TRUE) THEN base."state" ELSE \'OTHER\' END as "state",\n   AVG(data_0."elevation") as "avg_elevation",\n   COUNT(DISTINCT base."state" || \'x\' || data_0_outer.__row_id) as "airport_count",\n   COUNT(DISTINCT CASE WHEN COALESCE(NOT base."is_other",TRUE) THEN base."state" || \'x\' || data_0_outer.__row_id END) as "sort"\nFROM __stage1 as base\nLEFT JOIN LATERAL (SELECT UNNEST(GENERATE_SERIES(1, length(base."data"),1)) as __row_id, UNNEST(base."data"), 1 as ignoreme) as data_0_outer(__row_id, data_0,ignoreme) ON  data_0_outer.ignoreme=1\nGROUP BY 1\nORDER BY 4 desc NULLS LAST\n',dependenciesToMaterialize:{},structs:[{type:"query_result",name:"__stage2",fields:[{name:"state",type:"string",resultMetadata:{sourceField:"state",sourceExpression:"pick state when not is_other\n      else 'OTHER'",sourceClasses:["state"],referenceId:"4926369b-59b7-42be-8e50-731523b7c2dd",fieldKind:"dimension"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/documentation/patterns/other.malloynb",range:{start:{line:13,character:14},end:{line:15,character:18}}}},{name:"avg_elevation",numberType:"integer",type:"number",resultMetadata:{sourceField:"avg_elevation",sourceExpression:"data.elevation.avg()",sourceClasses:["avg_elevation"],referenceId:"23a36316-2d86-4c06-9ab3-f87fdc23bad4",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/documentation/patterns/other.malloynb",range:{start:{line:17,character:6},end:{line:17,character:43}}}},{name:"airport_count",numberType:"integer",type:"number",resultMetadata:{sourceField:"airport_count",sourceExpression:"data.count()",sourceClasses:["airport_count"],referenceId:"5757845b-c669-42ae-87cd-55b3cc6901f6",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/documentation/patterns/other.malloynb",range:{start:{line:18,character:6},end:{line:18,character:35}}}},{name:"sort",numberType:"integer",type:"number",resultMetadata:{sourceField:"sort",sourceExpression:"data.count() {where: not is_other }",sourceClasses:["sort"],referenceId:"5ced6aaf-34a6-4226-87e1-2d746e9f6997",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/documentation/patterns/other.malloynb",range:{start:{line:19,character:6},end:{line:20,character:49}}},annotation:{notes:[{text:"# hidden\n",at:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/documentation/patterns/other.malloynb",range:{start:{line:19,character:6},end:{line:19,character:15}}}}]}}],dialect:"duckdb",primaryKey:"state",connection:"duckdb",resultMetadata:{sourceField:"~computeLastStage~",filterList:[],sourceClasses:["~computeLastStage~"],fieldKind:"struct",orderBy:[{field:"sort",dir:"desc"}],drillable:!0}}],sourceExplore:"airports",sourceArguments:{},queryName:"top_states_by_elevation",connectionName:"duckdb",annotation:{notes:[],blockNotes:[{text:"#(docs) size=large limit=5000\n",at:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/documentation/patterns/other.malloynb",range:{start:{line:0,character:0},end:{line:0,character:30}}}}],inherits:{}},result:[{state:"CO",avg_elevation:6255.863529411765,airport_count:425,sort:425},{state:"NM",avg_elevation:5419.635359116022,airport_count:181,sort:181},{state:"UT",avg_elevation:5066,airport_count:140,sort:140},{state:"NV",avg_elevation:4029.9765625,airport_count:128,sort:128},{state:"WY",avg_elevation:5619.365217391304,airport_count:115,sort:115},{state:"OTHER",avg_elevation:910.3459902148479,airport_count:18781,sort:0}],totalRows:6},e.appendChild(t)})();</script>
      </div>
    </div>
    <div class="result-middle" data-result-kind="json" >
      <div class="result-inner">
        <pre><pre class="language-json" style="background-color: #FBFBFB"><span class="line"><span style="color: #000000">[</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;CO&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">6255.863529411765</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">425</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;sort&quot;</span><span style="color: #000000">: </span><span style="color: #098658">425</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;NM&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">5419.635359116022</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">181</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;sort&quot;</span><span style="color: #000000">: </span><span style="color: #098658">181</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;UT&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">5066</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">140</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;sort&quot;</span><span style="color: #000000">: </span><span style="color: #098658">140</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;NV&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4029.9765625</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">128</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;sort&quot;</span><span style="color: #000000">: </span><span style="color: #098658">128</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;WY&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">5619.365217391304</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">115</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;sort&quot;</span><span style="color: #000000">: </span><span style="color: #098658">115</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;OTHER&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">910.3459902148479</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">18781</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;sort&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0</span></span>
<span class="line"><span style="color: #000000">  }</span></span>
<span class="line"><span style="color: #000000">]</span></span></pre></pre>
      </div>
    </div>
    <div class="result-middle" data-result-kind="sql" >
      <div class="result-inner">
        <pre><pre class="language-sql" style="background-color: #FBFBFB"><span class="line"><span style="color: #0000FF">WITH</span><span style="color: #000000"> __stage0 </span><span style="color: #0000FF">AS</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">SELECT</span></span>
<span class="line"><span style="color: #000000">    group_set,</span></span>
<span class="line"><span style="color: #000000">    base.</span><span style="color: #A31515">&quot;state&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;state__0&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">0</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">AVG</span><span style="color: #000000">(base.</span><span style="color: #A31515">&quot;elevation&quot;</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;avg_elevation__0&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    (</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">0</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #795E26">ROW_NUMBER</span><span style="color: #000000">() </span><span style="color: #0000FF">OVER</span><span style="color: #000000">(</span><span style="color: #0000FF">PARTITION</span><span style="color: #000000"> </span><span style="color: #0000FF">BY</span><span style="color: #000000"> group_set  </span><span style="color: #0000FF">ORDER BY</span><span style="color: #000000">  </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">0</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">AVG</span><span style="color: #000000">(base.</span><span style="color: #A31515">&quot;elevation&quot;</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">desc</span><span style="color: #000000"> NULLS </span><span style="color: #0000FF">LAST</span><span style="color: #000000"> ) </span><span style="color: #0000FF">END</span><span style="color: #000000">)&gt;</span><span style="color: #098658">5</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;is_other__0&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      base.</span><span style="color: #A31515">&quot;code&quot;</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;code__1&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      base.</span><span style="color: #A31515">&quot;elevation&quot;</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;elevation__1&quot;</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">FROM</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;../data/airports.parquet&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> base</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">CROSS</span><span style="color: #000000"> </span><span style="color: #0000FF">JOIN</span><span style="color: #000000"> (</span><span style="color: #0000FF">SELECT</span><span style="color: #000000"> UNNEST(GENERATE_SERIES(</span><span style="color: #098658">0</span><span style="color: #000000">,</span><span style="color: #098658">1</span><span style="color: #000000">,</span><span style="color: #098658">1</span><span style="color: #000000">)) </span><span style="color: #0000FF">as</span><span style="color: #000000"> group_set  ) </span><span style="color: #0000FF">as</span><span style="color: #000000"> group_set</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">GROUP BY</span><span style="color: #000000"> </span><span style="color: #098658">1</span><span style="color: #000000">,</span><span style="color: #098658">2</span><span style="color: #000000">,</span><span style="color: #098658">5</span><span style="color: #000000">,</span><span style="color: #098658">6</span></span>
<span class="line"><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">, __stage1 </span><span style="color: #0000FF">AS</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">SELECT</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #A31515">&quot;state__0&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;state&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #795E26">MAX</span><span style="color: #000000">(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">0</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;avg_elevation__0&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;avg_elevation&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #795E26">MAX</span><span style="color: #000000">(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">0</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;is_other__0&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;is_other&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(LIST({</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #A31515">&quot;code&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;code__1&quot;</span><span style="color: #000000">, </span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #A31515">&quot;elevation&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;elevation__1&quot;</span><span style="color: #000000">}  </span><span style="color: #0000FF">ORDER BY</span><span style="color: #000000">  </span><span style="color: #A31515">&quot;code__1&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">asc</span><span style="color: #000000"> NULLS </span><span style="color: #0000FF">LAST</span><span style="color: #000000">) </span><span style="color: #0000FF">FILTER</span><span style="color: #000000"> (</span><span style="color: #0000FF">WHERE</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000">),[]) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;data&quot;</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">FROM</span><span style="color: #000000"> __stage0</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">GROUP BY</span><span style="color: #000000"> </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">SELECT</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">   </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #0000FF">NOT</span><span style="color: #000000"> base.</span><span style="color: #A31515">&quot;is_other&quot;</span><span style="color: #000000">,TRUE) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> base.</span><span style="color: #A31515">&quot;state&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">ELSE</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;OTHER&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;state&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">   </span><span style="color: #795E26">AVG</span><span style="color: #000000">(data_0.</span><span style="color: #A31515">&quot;elevation&quot;</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;avg_elevation&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">   </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #0000FF">DISTINCT</span><span style="color: #000000"> base.</span><span style="color: #A31515">&quot;state&quot;</span><span style="color: #000000"> || </span><span style="color: #A31515">&#39;x&#39;</span><span style="color: #000000"> || data_0_outer.__row_id) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;airport_count&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">   </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #0000FF">DISTINCT</span><span style="color: #000000"> </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #0000FF">NOT</span><span style="color: #000000"> base.</span><span style="color: #A31515">&quot;is_other&quot;</span><span style="color: #000000">,TRUE) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> base.</span><span style="color: #A31515">&quot;state&quot;</span><span style="color: #000000"> || </span><span style="color: #A31515">&#39;x&#39;</span><span style="color: #000000"> || data_0_outer.__row_id </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;sort&quot;</span></span>
<span class="line"><span style="color: #0000FF">FROM</span><span style="color: #000000"> __stage1 </span><span style="color: #0000FF">as</span><span style="color: #000000"> base</span></span>
<span class="line"><span style="color: #0000FF">LEFT JOIN</span><span style="color: #000000"> LATERAL (</span><span style="color: #0000FF">SELECT</span><span style="color: #000000"> UNNEST(GENERATE_SERIES(</span><span style="color: #098658">1</span><span style="color: #000000">, </span><span style="color: #0000FF">length</span><span style="color: #000000">(base.</span><span style="color: #A31515">&quot;data&quot;</span><span style="color: #000000">),</span><span style="color: #098658">1</span><span style="color: #000000">)) </span><span style="color: #0000FF">as</span><span style="color: #000000"> __row_id, UNNEST(base.</span><span style="color: #A31515">&quot;data&quot;</span><span style="color: #000000">), </span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> ignoreme) </span><span style="color: #0000FF">as</span><span style="color: #000000"> data_0_outer(__row_id, data_0,ignoreme) </span><span style="color: #0000FF">ON</span><span style="color: #000000">  data_0_outer.ignoreme=</span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #0000FF">GROUP BY</span><span style="color: #000000"> </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #0000FF">ORDER BY</span><span style="color: #000000"> </span><span style="color: #098658">4</span><span style="color: #000000"> </span><span style="color: #0000FF">desc</span><span style="color: #000000"> NULLS </span><span style="color: #0000FF">LAST</span></span>
<span class="line"></span></pre></pre>
      </div>
    </div>
  </div></div>
      <h2>
        <a id="nested-query" class="header-link anchor" href="#nested-query">
          Nested Query
        </a>
      </h2>
    <div class="code-wrapper"><a href="https://github.dev/malloydata/malloydata.github.io/blob/main/src/documentation/patterns/other.malloynb#C6" target="_blank" class="open_notebook"><img src="/img/open_notebook.svg" alt="document"/></a><pre class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">run</span><span style="color: #000000">: </span><span style="color: #001080">airports</span><span style="color: #000000"> -&gt; {</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">group_by</span><span style="color: #000000">: </span><span style="color: #001080">`Facility Type`</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">fac_type</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">aggregate</span><span style="color: #000000">: </span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #001080">airport_count</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #001080">avg_elevation</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">nest</span><span style="color: #000000">: </span><span style="color: #001080">top_states_by_elevation</span></span>
<span class="line"><span style="color: #000000">}</span></span></pre><div class="result-outer large">
    <div class="result-controls-bar">
      <span class="result-label">QUERY RESULTS</span>
      <div class="result-controls">
        <button class="result-control" selected data-result-kind="html">HTML</button>
        <button class="result-control"  data-result-kind="json">JSON</button>
        <button class="result-control"  data-result-kind="sql">SQL</button>
      </div>
    </div>
    <div class="result-middle" data-result-kind="html" selected>
      <div class="result-inner" id="25dabe11-4b4f-4a1f-85bf-4dedcc898b5e">
        <script>(()=>{var e=document.getElementById("25dabe11-4b4f-4a1f-85bf-4dedcc898b5e"),t=document.createElement("malloy-render");t.modelDef={name:"",exports:["airports"],contents:{airports:{type:"table",name:"duckdb:../data/airports.parquet",dialect:"duckdb",tablePath:"../data/airports.parquet",connection:"duckdb",fields:[{type:"number",numberType:"integer",name:"id",fieldUsage:[{path:["id"]}]},{type:"string",name:"code",fieldUsage:[{path:["code"]}]},{type:"string",name:"site_number",fieldUsage:[{path:["site_number"]}]},{type:"string",name:"fac_type",fieldUsage:[{path:["fac_type"]}]},{type:"string",name:"fac_use",fieldUsage:[{path:["fac_use"]}]},{type:"string",name:"faa_region",fieldUsage:[{path:["faa_region"]}]},{type:"string",name:"faa_dist",fieldUsage:[{path:["faa_dist"]}]},{type:"string",name:"city",fieldUsage:[{path:["city"]}]},{type:"string",name:"county",fieldUsage:[{path:["county"]}]},{type:"string",name:"state",fieldUsage:[{path:["state"]}]},{type:"string",name:"full_name",fieldUsage:[{path:["full_name"]}]},{type:"string",name:"own_type",fieldUsage:[{path:["own_type"]}]},{type:"number",numberType:"float",name:"longitude",fieldUsage:[{path:["longitude"]}]},{type:"number",numberType:"float",name:"latitude",fieldUsage:[{path:["latitude"]}]},{type:"number",numberType:"integer",name:"elevation",fieldUsage:[{path:["elevation"]}]},{type:"string",name:"aero_cht",fieldUsage:[{path:["aero_cht"]}]},{type:"number",numberType:"integer",name:"cbd_dist",fieldUsage:[{path:["cbd_dist"]}]},{type:"string",name:"cbd_dir",fieldUsage:[{path:["cbd_dir"]}]},{type:"string",name:"act_date",fieldUsage:[{path:["act_date"]}]},{type:"string",name:"cert",fieldUsage:[{path:["cert"]}]},{type:"string",name:"fed_agree",fieldUsage:[{path:["fed_agree"]}]},{type:"string",name:"cust_intl",fieldUsage:[{path:["cust_intl"]}]},{type:"string",name:"c_ldg_rts",fieldUsage:[{path:["c_ldg_rts"]}]},{type:"string",name:"joint_use",fieldUsage:[{path:["joint_use"]}]},{type:"string",name:"mil_rts",fieldUsage:[{path:["mil_rts"]}]},{type:"string",name:"cntl_twr",fieldUsage:[{path:["cntl_twr"]}]},{type:"string",name:"major",fieldUsage:[{path:["major"]}]},{type:"number",numberType:"integer",name:"airport_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},{type:"number",numberType:"integer",name:"avg_elevation",e:{node:"aggregate",function:"avg",e:{node:"field",path:["elevation"]}},fieldUsage:[{path:["elevation"]}],expressionType:"aggregate",code:"elevation.avg()"},{type:"turtle",name:"top_states_by_elevation",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["state"]},{type:"fieldref",path:["avg_elevation"]},{type:"boolean",name:"is_other",e:{node:">",kids:{left:{node:"function_call",overload:{returnType:{type:"number",expressionType:"scalar_analytic",evalSpace:"input"},params:[],dialect:{postgres:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0},standardsql:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0},duckdb:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0},snowflake:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0},trino:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0},presto:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0},mysql:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0}}},name:"row_number",kids:{args:[]},expressionType:"scalar_analytic"},right:{node:"numberLiteral",literal:"5"}}},expressionType:"scalar_analytic",code:"row_number() > 5"},{type:"turtle",name:"data",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["code"],drillView:"data"},{type:"fieldref",path:["elevation"],drillView:"data"}],filterList:[],fieldUsage:[{path:["code"]},{path:["elevation"]}],defaultOrderBy:!0,orderBy:[{field:"code",dir:"asc"}]}],annotation:{},fieldUsage:[{path:["code"]},{path:["elevation"]}]}],filterList:[],fieldUsage:[{path:["state"]},{path:["avg_elevation"]},{path:["code"]},{path:["elevation"]}],defaultOrderBy:!0,orderBy:[{field:"avg_elevation",dir:"desc"}]},{type:"reduce",queryFields:[{type:"string",name:"state",e:{node:"case",kids:{caseWhen:[{node:"not",e:{node:"field",path:["is_other"]}}],caseThen:[{node:"field",path:["state"]}],caseElse:{node:"stringLiteral",literal:"OTHER"}}},fieldUsage:[{path:["state"]},{path:["is_other"]}],expressionType:"scalar",code:"pick state when not is_other\n      else 'OTHER'"},{type:"number",numberType:"integer",name:"avg_elevation",e:{node:"aggregate",function:"avg",e:{node:"field",path:["data","elevation"]},structPath:["data"]},fieldUsage:[],expressionType:"aggregate",code:"data.elevation.avg()"},{type:"number",numberType:"integer",name:"airport_count",e:{node:"aggregate",function:"count",e:{node:""},structPath:["data"]},fieldUsage:[],expressionType:"aggregate",code:"data.count()"},{type:"number",numberType:"integer",name:"sort",e:{node:"filteredExpr",kids:{e:{node:"aggregate",function:"count",e:{node:""},structPath:["data"]},filterList:[{node:"filterCondition",code:"not is_other",e:{node:"not",e:{node:"field",path:["is_other"]}},expressionType:"scalar",fieldUsage:[{path:["is_other"]}]}]}},fieldUsage:[{path:["is_other"]}],expressionType:"aggregate",code:"data.count() {where: not is_other }",annotation:{notes:[{text:"# hidden\n"}]}}],orderBy:[{field:"sort",dir:"desc"}],filterList:[],fieldUsage:[{path:["state"]},{path:["is_other"]},{path:["is_other"]}]}],annotation:{}}],parameters:{},as:"airports"}},queryList:[{type:"query",structRef:"airports",sourceArguments:{},pipeline:[{type:"reduce",queryFields:[{type:"string",name:"Facility Type",e:{node:"field",path:["fac_type"]},fieldUsage:[{path:["fac_type"]}],expressionType:"scalar",code:"fac_type"},{type:"fieldref",path:["airport_count"]},{type:"fieldref",path:["avg_elevation"]},{type:"turtle",name:"top_states_by_elevation",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["state"]},{type:"fieldref",path:["avg_elevation"]},{type:"boolean",name:"is_other",e:{node:">",kids:{left:{node:"function_call",overload:{returnType:{type:"number",expressionType:"scalar_analytic",evalSpace:"input"},params:[],dialect:{postgres:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0},standardsql:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0},duckdb:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0},snowflake:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0},trino:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0},presto:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0},mysql:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0}}},name:"row_number",kids:{args:[]},expressionType:"scalar_analytic"},right:{node:"numberLiteral",literal:"5"}}},expressionType:"scalar_analytic",code:"row_number() > 5"},{type:"turtle",name:"data",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["code"],drillView:"data"},{type:"fieldref",path:["elevation"],drillView:"data"}],filterList:[],fieldUsage:[{path:["code"]},{path:["elevation"]}],defaultOrderBy:!0,orderBy:[{field:"code",dir:"asc"}]}],annotation:{},fieldUsage:[{path:["code"]},{path:["elevation"]}]}],filterList:[],fieldUsage:[{path:["state"]},{path:["avg_elevation"]},{path:["code"]},{path:["elevation"]}],defaultOrderBy:!0,orderBy:[{field:"avg_elevation",dir:"desc"}],referencedAt:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/documentation/patterns/other.malloynb",range:{start:{line:6,character:8},end:{line:6,character:31}}}},{type:"reduce",queryFields:[{type:"string",name:"state",e:{node:"case",kids:{caseWhen:[{node:"not",e:{node:"field",path:["is_other"]}}],caseThen:[{node:"field",path:["state"]}],caseElse:{node:"stringLiteral",literal:"OTHER"}}},fieldUsage:[{path:["state"]},{path:["is_other"]}],expressionType:"scalar",code:"pick state when not is_other\n      else 'OTHER'"},{type:"number",numberType:"integer",name:"avg_elevation",e:{node:"aggregate",function:"avg",e:{node:"field",path:["data","elevation"]},structPath:["data"]},fieldUsage:[],expressionType:"aggregate",code:"data.elevation.avg()"},{type:"number",numberType:"integer",name:"airport_count",e:{node:"aggregate",function:"count",e:{node:""},structPath:["data"]},fieldUsage:[],expressionType:"aggregate",code:"data.count()"},{type:"number",numberType:"integer",name:"sort",e:{node:"filteredExpr",kids:{e:{node:"aggregate",function:"count",e:{node:""},structPath:["data"]},filterList:[{node:"filterCondition",code:"not is_other",e:{node:"not",e:{node:"field",path:["is_other"]}},expressionType:"scalar",fieldUsage:[{path:["is_other"]}]}]}},fieldUsage:[{path:["is_other"]}],expressionType:"aggregate",code:"data.count() {where: not is_other }",annotation:{notes:[{text:"# hidden\n"}]}}],orderBy:[{field:"sort",dir:"desc"}],filterList:[],fieldUsage:[{path:["state"]},{path:["is_other"]},{path:["is_other"]}]}],annotation:{inherits:{}},fieldUsage:[{path:["state"]},{path:["avg_elevation"]},{path:["code"]},{path:["elevation"]}]}],filterList:[],fieldUsage:[{path:["fac_type"]},{path:["airport_count"]},{path:["avg_elevation"]},{path:["state"]},{path:["avg_elevation"]},{path:["code"]},{path:["elevation"]}],defaultOrderBy:!0,orderBy:[{field:"airport_count",dir:"desc"}]}],annotation:{notes:[],blockNotes:[{text:"#(docs) size=large limit=5000\n"}]}}],dependencies:{},references:[{type:"exploreReference",text:"airports",definition:{type:"table",name:"duckdb:../data/airports.parquet",dialect:"duckdb",tablePath:"../data/airports.parquet",connection:"duckdb",fields:[{type:"number",numberType:"integer",name:"id",fieldUsage:[{path:["id"]}]},{type:"string",name:"code",fieldUsage:[{path:["code"]}]},{type:"string",name:"site_number",fieldUsage:[{path:["site_number"]}]},{type:"string",name:"fac_type",fieldUsage:[{path:["fac_type"]}]},{type:"string",name:"fac_use",fieldUsage:[{path:["fac_use"]}]},{type:"string",name:"faa_region",fieldUsage:[{path:["faa_region"]}]},{type:"string",name:"faa_dist",fieldUsage:[{path:["faa_dist"]}]},{type:"string",name:"city",fieldUsage:[{path:["city"]}]},{type:"string",name:"county",fieldUsage:[{path:["county"]}]},{type:"string",name:"state",fieldUsage:[{path:["state"]}]},{type:"string",name:"full_name",fieldUsage:[{path:["full_name"]}]},{type:"string",name:"own_type",fieldUsage:[{path:["own_type"]}]},{type:"number",numberType:"float",name:"longitude",fieldUsage:[{path:["longitude"]}]},{type:"number",numberType:"float",name:"latitude",fieldUsage:[{path:["latitude"]}]},{type:"number",numberType:"integer",name:"elevation",fieldUsage:[{path:["elevation"]}]},{type:"string",name:"aero_cht",fieldUsage:[{path:["aero_cht"]}]},{type:"number",numberType:"integer",name:"cbd_dist",fieldUsage:[{path:["cbd_dist"]}]},{type:"string",name:"cbd_dir",fieldUsage:[{path:["cbd_dir"]}]},{type:"string",name:"act_date",fieldUsage:[{path:["act_date"]}]},{type:"string",name:"cert",fieldUsage:[{path:["cert"]}]},{type:"string",name:"fed_agree",fieldUsage:[{path:["fed_agree"]}]},{type:"string",name:"cust_intl",fieldUsage:[{path:["cust_intl"]}]},{type:"string",name:"c_ldg_rts",fieldUsage:[{path:["c_ldg_rts"]}]},{type:"string",name:"joint_use",fieldUsage:[{path:["joint_use"]}]},{type:"string",name:"mil_rts",fieldUsage:[{path:["mil_rts"]}]},{type:"string",name:"cntl_twr",fieldUsage:[{path:["cntl_twr"]}]},{type:"string",name:"major",fieldUsage:[{path:["major"]}]},{type:"number",numberType:"integer",name:"airport_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},{type:"number",numberType:"integer",name:"avg_elevation",e:{node:"aggregate",function:"avg",e:{node:"field",path:["elevation"]}},fieldUsage:[{path:["elevation"]}],expressionType:"aggregate",code:"elevation.avg()"},{type:"turtle",name:"top_states_by_elevation",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["state"]},{type:"fieldref",path:["avg_elevation"]},{type:"boolean",name:"is_other",e:{node:">",kids:{left:{node:"function_call",overload:{returnType:{type:"number",expressionType:"scalar_analytic",evalSpace:"input"},params:[],dialect:{postgres:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0},standardsql:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0},duckdb:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0},snowflake:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0},trino:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0},presto:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0},mysql:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0}}},name:"row_number",kids:{args:[]},expressionType:"scalar_analytic"},right:{node:"numberLiteral",literal:"5"}}},expressionType:"scalar_analytic",code:"row_number() > 5"},{type:"turtle",name:"data",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["code"],drillView:"data"},{type:"fieldref",path:["elevation"],drillView:"data"}],filterList:[],fieldUsage:[{path:["code"]},{path:["elevation"]}],defaultOrderBy:!0,orderBy:[{field:"code",dir:"asc"}]}],annotation:{},fieldUsage:[{path:["code"]},{path:["elevation"]}]}],filterList:[],fieldUsage:[{path:["state"]},{path:["avg_elevation"]},{path:["code"]},{path:["elevation"]}],defaultOrderBy:!0,orderBy:[{field:"avg_elevation",dir:"desc"}]},{type:"reduce",queryFields:[{type:"string",name:"state",e:{node:"case",kids:{caseWhen:[{node:"not",e:{node:"field",path:["is_other"]}}],caseThen:[{node:"field",path:["state"]}],caseElse:{node:"stringLiteral",literal:"OTHER"}}},fieldUsage:[{path:["state"]},{path:["is_other"]}],expressionType:"scalar",code:"pick state when not is_other\n      else 'OTHER'"},{type:"number",numberType:"integer",name:"avg_elevation",e:{node:"aggregate",function:"avg",e:{node:"field",path:["data","elevation"]},structPath:["data"]},fieldUsage:[],expressionType:"aggregate",code:"data.elevation.avg()"},{type:"number",numberType:"integer",name:"airport_count",e:{node:"aggregate",function:"count",e:{node:""},structPath:["data"]},fieldUsage:[],expressionType:"aggregate",code:"data.count()"},{type:"number",numberType:"integer",name:"sort",e:{node:"filteredExpr",kids:{e:{node:"aggregate",function:"count",e:{node:""},structPath:["data"]},filterList:[{node:"filterCondition",code:"not is_other",e:{node:"not",e:{node:"field",path:["is_other"]}},expressionType:"scalar",fieldUsage:[{path:["is_other"]}]}]}},fieldUsage:[{path:["is_other"]}],expressionType:"aggregate",code:"data.count() {where: not is_other }",annotation:{notes:[{text:"# hidden\n"}]}}],orderBy:[{field:"sort",dir:"desc"}],filterList:[],fieldUsage:[{path:["state"]},{path:["is_other"]},{path:["is_other"]}]}],annotation:{}}],parameters:{},as:"airports"}},{type:"fieldReference",definition:{type:"string",name:"fac_type",fieldUsage:[{path:["fac_type"]}]},text:"fac_type"},{type:"fieldReference",definition:{type:"number",numberType:"integer",name:"airport_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},text:"airport_count"},{type:"fieldReference",definition:{type:"number",numberType:"integer",name:"avg_elevation",e:{node:"aggregate",function:"avg",e:{node:"field",path:["elevation"]}},fieldUsage:[{path:["elevation"]}],expressionType:"aggregate",code:"elevation.avg()"},text:"avg_elevation"},{type:"fieldReference",definition:{type:"turtle",name:"top_states_by_elevation",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["state"]},{type:"fieldref",path:["avg_elevation"]},{type:"boolean",name:"is_other",e:{node:">",kids:{left:{node:"function_call",overload:{returnType:{type:"number",expressionType:"scalar_analytic",evalSpace:"input"},params:[],dialect:{postgres:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0},standardsql:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0},duckdb:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0},snowflake:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0},trino:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0},presto:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0},mysql:{e:{node:"genericSQLExpr",kids:{args:[]},src:["ROW_NUMBER(",")"]},needsWindowOrderBy:!0}}},name:"row_number",kids:{args:[]},expressionType:"scalar_analytic"},right:{node:"numberLiteral",literal:"5"}}},expressionType:"scalar_analytic",code:"row_number() > 5"},{type:"turtle",name:"data",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["code"],drillView:"data"},{type:"fieldref",path:["elevation"],drillView:"data"}],filterList:[],fieldUsage:[{path:["code"]},{path:["elevation"]}],defaultOrderBy:!0,orderBy:[{field:"code",dir:"asc"}]}],annotation:{},fieldUsage:[{path:["code"]},{path:["elevation"]}]}],filterList:[],fieldUsage:[{path:["state"]},{path:["avg_elevation"]},{path:["code"]},{path:["elevation"]}],defaultOrderBy:!0,orderBy:[{field:"avg_elevation",dir:"desc"}]},{type:"reduce",queryFields:[{type:"string",name:"state",e:{node:"case",kids:{caseWhen:[{node:"not",e:{node:"field",path:["is_other"]}}],caseThen:[{node:"field",path:["state"]}],caseElse:{node:"stringLiteral",literal:"OTHER"}}},fieldUsage:[{path:["state"]},{path:["is_other"]}],expressionType:"scalar",code:"pick state when not is_other\n      else 'OTHER'"},{type:"number",numberType:"integer",name:"avg_elevation",e:{node:"aggregate",function:"avg",e:{node:"field",path:["data","elevation"]},structPath:["data"]},fieldUsage:[],expressionType:"aggregate",code:"data.elevation.avg()"},{type:"number",numberType:"integer",name:"airport_count",e:{node:"aggregate",function:"count",e:{node:""},structPath:["data"]},fieldUsage:[],expressionType:"aggregate",code:"data.count()"},{type:"number",numberType:"integer",name:"sort",e:{node:"filteredExpr",kids:{e:{node:"aggregate",function:"count",e:{node:""},structPath:["data"]},filterList:[{node:"filterCondition",code:"not is_other",e:{node:"not",e:{node:"field",path:["is_other"]}},expressionType:"scalar",fieldUsage:[{path:["is_other"]}]}]}},fieldUsage:[{path:["is_other"]}],expressionType:"aggregate",code:"data.count() {where: not is_other }",annotation:{notes:[{text:"# hidden\n"}]}}],orderBy:[{field:"sort",dir:"desc"}],filterList:[],fieldUsage:[{path:["state"]},{path:["is_other"]},{path:["is_other"]}]}],annotation:{}},text:"top_states_by_elevation"}],imports:[]},t.queryResult={lastStageName:"__stage2",malloy:"",sql:'WITH __stage0 AS (\n  SELECT\n    group_set,\n    base."fac_type" as "Facility Type__0",\n    CASE WHEN group_set=0 THEN\n      COUNT(1)\n      END as "airport_count__0",\n    CASE WHEN group_set=0 THEN\n      AVG(base."elevation")\n      END as "avg_elevation__0",\n    CASE WHEN group_set IN (1,2) THEN\n      base."state"\n      END as "state__1",\n    CASE WHEN group_set=1 THEN\n      AVG(base."elevation")\n      END as "avg_elevation__1",\n    (CASE WHEN group_set=1 THEN ROW_NUMBER() OVER(PARTITION BY group_set, base."fac_type"  ORDER BY  CASE WHEN group_set=1 THEN\n      AVG(base."elevation")\n      END desc NULLS LAST ) END)>5 as "is_other__1",\n    CASE WHEN group_set=2 THEN\n      base."code"\n      END as "code__2",\n    CASE WHEN group_set=2 THEN\n      base."elevation"\n      END as "elevation__2"\n  FROM \'../data/airports.parquet\' as base\n  CROSS JOIN (SELECT UNNEST(GENERATE_SERIES(0,2,1)) as group_set  ) as group_set\n  GROUP BY 1,2,5,8,9\n)\n, __stage1 AS (\n  SELECT \n    CASE WHEN group_set=2 THEN 1 ELSE group_set END as group_set,\n    "Facility Type__0" as "Facility Type__0",\n    FIRST("airport_count__0") FILTER (WHERE "airport_count__0" IS NOT NULL) as "airport_count__0",\n    FIRST("avg_elevation__0") FILTER (WHERE "avg_elevation__0" IS NOT NULL) as "avg_elevation__0",\n    CASE WHEN group_set IN (1,2) THEN\n      "state__1"\n      END as "state__1",\n    FIRST("avg_elevation__1") FILTER (WHERE "avg_elevation__1" IS NOT NULL) as "avg_elevation__1",\n    FIRST("is_other__1") FILTER (WHERE "is_other__1" IS NOT NULL) as "is_other__1",\n    COALESCE(LIST({\n      "code": "code__2", \n      "elevation": "elevation__2"}  ORDER BY  "code__2" asc NULLS LAST) FILTER (WHERE group_set=2),[]) as "data__1"\n  FROM __stage0\n  GROUP BY 1,2,5\n)\nSELECT\n  "Facility Type__0" as "Facility Type",\n  MAX(CASE WHEN group_set=0 THEN "airport_count__0" END) as "airport_count",\n  MAX(CASE WHEN group_set=0 THEN "avg_elevation__0" END) as "avg_elevation",\n  (WITH __stage0 AS (\n    SELECT \n       CASE WHEN COALESCE(NOT base."is_other",TRUE) THEN base."state" ELSE \'OTHER\' END as "state",\n       AVG(data_0."elevation") as "avg_elevation",\n       COUNT(DISTINCT base."__distinct_key" || \'x\' || data_0_outer.__row_id) as "airport_count",\n       COUNT(DISTINCT CASE WHEN COALESCE(NOT base."is_other",TRUE) THEN base."__distinct_key" || \'x\' || data_0_outer.__row_id END) as "sort"\n    FROM (SELECT GEN_RANDOM_UUID() as "__distinct_key", x.*  FROM (SELECT UNNEST(COALESCE(LIST({\n      "state": "state__1", \n      "avg_elevation": "avg_elevation__1", \n      "is_other": "is_other__1", \n      "data": "data__1"}  ORDER BY  "avg_elevation__1" desc NULLS LAST) FILTER (WHERE group_set=1),[])) as base) as x) as base\n    LEFT JOIN LATERAL (SELECT UNNEST(GENERATE_SERIES(1, length(base."data"),1)) as __row_id, UNNEST(base."data"), 1 as ignoreme) as data_0_outer(__row_id, data_0,ignoreme) ON  data_0_outer.ignoreme=1\n    GROUP BY 1\n    ORDER BY 4 desc NULLS LAST\n  )\n  SELECT LIST(STRUCT_PACK("state","avg_elevation","airport_count","sort") ORDER BY sort desc) FROM __stage0\n  ) as "top_states_by_elevation"\nFROM __stage1\nGROUP BY 1\nORDER BY 2 desc NULLS LAST\n',dependenciesToMaterialize:{},structs:[{type:"query_result",name:"__stage2",fields:[{name:"Facility Type",type:"string",resultMetadata:{sourceField:"Facility Type",sourceExpression:"fac_type",sourceClasses:["Facility Type"],referenceId:"9a36a0ef-83e6-4889-9278-ddc0b40ea59f",fieldKind:"dimension"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/documentation/patterns/other.malloynb",range:{start:{line:2,character:12},end:{line:2,character:39}}}},{name:"airport_count",numberType:"integer",type:"number",resultMetadata:{sourceField:"airport_count",sourceExpression:"count()",sourceClasses:["airport_count"],referenceId:"4b2ace03-e106-4784-8144-04d7a97a2b4a",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/documentation/patterns/other.malloynb",range:{start:{line:2,character:4},end:{line:2,character:28}}}},{name:"avg_elevation",numberType:"integer",type:"number",resultMetadata:{sourceField:"avg_elevation",sourceExpression:"elevation.avg()",sourceClasses:["avg_elevation"],referenceId:"3c115102-a2b6-495c-9e43-d348da132860",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/documentation/patterns/other.malloynb",range:{start:{line:3,character:4},end:{line:3,character:36}}}},{type:"array",name:"top_states_by_elevation",fields:[{name:"state",type:"string",resultMetadata:{sourceField:"state",sourceExpression:"pick state when not is_other\n      else 'OTHER'",sourceClasses:["state"],referenceId:"d610ac63-8692-4346-97b5-6ed98f2b6964",fieldKind:"dimension"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/documentation/patterns/other.malloynb",range:{start:{line:13,character:14},end:{line:15,character:18}}}},{name:"avg_elevation",numberType:"integer",type:"number",resultMetadata:{sourceField:"avg_elevation",sourceExpression:"data.elevation.avg()",sourceClasses:["avg_elevation"],referenceId:"3683bc47-d04b-42c8-86ad-e8f9af849d07",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/documentation/patterns/other.malloynb",range:{start:{line:17,character:6},end:{line:17,character:43}}}},{name:"airport_count",numberType:"integer",type:"number",resultMetadata:{sourceField:"airport_count",sourceExpression:"data.count()",sourceClasses:["airport_count"],referenceId:"f3489bd8-463f-4285-aa33-4b8d3c66a602",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/documentation/patterns/other.malloynb",range:{start:{line:18,character:6},end:{line:18,character:35}}}},{name:"sort",numberType:"integer",type:"number",resultMetadata:{sourceField:"sort",sourceExpression:"data.count() {where: not is_other }",sourceClasses:["sort"],referenceId:"bb903570-b071-469b-ad02-11334470111f",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/documentation/patterns/other.malloynb",range:{start:{line:19,character:6},end:{line:20,character:49}}},annotation:{notes:[{text:"# hidden\n",at:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/documentation/patterns/other.malloynb",range:{start:{line:19,character:6},end:{line:19,character:15}}}}]}}],dialect:"duckdb",primaryKey:"state",connection:"duckdb",resultMetadata:{sourceField:"top_states_by_elevation",filterList:[],sourceClasses:["top_states_by_elevation"],fieldKind:"struct",orderBy:[{field:"sort",dir:"desc"}],drillable:!1},annotation:{inherits:{}},elementTypeDef:{type:"record_element"},join:"many"}],dialect:"duckdb",primaryKey:"Facility Type",connection:"duckdb",resultMetadata:{sourceField:"ignoreme",filterList:[],sourceClasses:["ignoreme"],fieldKind:"struct",orderBy:[{field:"airport_count",dir:"desc"}],drillable:!0}}],sourceExplore:"airports",sourceArguments:{},connectionName:"duckdb",annotation:{notes:[],blockNotes:[{text:"#(docs) size=large limit=5000\n",at:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/documentation/patterns/other.malloynb",range:{start:{line:0,character:0},end:{line:0,character:30}}}}]},result:[{"Facility Type":"AIRPORT",airport_count:13925,avg_elevation:1237.0441651705567,top_states_by_elevation:[{state:"CO",avg_elevation:5873.0642570281125,airport_count:249,sort:249},{state:"NM",avg_elevation:5467.63870967742,airport_count:155,sort:155},{state:"NV",avg_elevation:4384.041237113402,airport_count:97,sort:97},{state:"UT",avg_elevation:5257.18556701031,airport_count:97,sort:97},{state:"WY",avg_elevation:5570.0329670329675,airport_count:91,sort:91},{state:"OTHER",avg_elevation:1017.9730281051677,airport_count:13236,sort:0}]},{"Facility Type":"HELIPORT",airport_count:5135,avg_elevation:950.5125608568646,top_states_by_elevation:[{state:"CO",avg_elevation:6816.569696969697,airport_count:165,sort:165},{state:"UT",avg_elevation:4634.720930232558,airport_count:43,sort:43},{state:"MT",avg_elevation:3756.310344827586,airport_count:29,sort:29},{state:"NM",avg_elevation:5170.76,airport_count:25,sort:25},{state:"WY",avg_elevation:5806.416666666667,airport_count:24,sort:24},{state:"OTHER",avg_elevation:655.6607547948031,airport_count:4849,sort:0}]},{"Facility Type":"SEAPLANE BASE",airport_count:473,avg_elevation:488.82241014799155,top_states_by_elevation:[{state:"ID",avg_elevation:1884.6,airport_count:5,sort:5},{state:"MT",avg_elevation:3194,airport_count:2,sort:2},{state:"NM",avg_elevation:4201,airport_count:1,sort:1},{state:"NE",avg_elevation:1946,airport_count:1,sort:1},{state:"SD",avg_elevation:1600,airport_count:1,sort:1},{state:"OTHER",avg_elevation:448.49892008639307,airport_count:463,sort:0}]},{"Facility Type":"ULTRALIGHT",airport_count:125,avg_elevation:806.144,top_states_by_elevation:[{state:"AZ",avg_elevation:2025.7142857142858,airport_count:7,sort:7},{state:"CA",avg_elevation:1335,airport_count:2,sort:2},{state:"NY",avg_elevation:1530,airport_count:2,sort:2},{state:"CO",avg_elevation:8110,airport_count:1,sort:1},{state:"MT",avg_elevation:3540,airport_count:1,sort:1},{state:"OTHER",avg_elevation:617.9285714285714,airport_count:112,sort:0}]},{"Facility Type":"STOLPORT",airport_count:86,avg_elevation:1375.046511627907,top_states_by_elevation:[{state:"CO",avg_elevation:6211.666666666667,airport_count:6,sort:6},{state:"CA",avg_elevation:4040.5,airport_count:2,sort:2},{state:"MT",avg_elevation:3776,airport_count:2,sort:2},{state:"NV",avg_elevation:4900,airport_count:1,sort:1},{state:"AZ",avg_elevation:4772,airport_count:1,sort:1},{state:"OTHER",avg_elevation:752.418918918919,airport_count:74,sort:0}]},{"Facility Type":"GLIDERPORT",airport_count:37,avg_elevation:1611.4054054054054,top_states_by_elevation:[{state:"CO",avg_elevation:7061.666666666667,airport_count:3,sort:3},{state:"AZ",avg_elevation:3539,airport_count:2,sort:2},{state:"KS",avg_elevation:2088.5,airport_count:2,sort:2},{state:"NY",avg_elevation:1484.5,airport_count:2,sort:2},{state:"NV",avg_elevation:4300,airport_count:1,sort:1},{state:"OTHER",avg_elevation:737.5185185185185,airport_count:27,sort:0}]},{"Facility Type":"BALLOONPORT",airport_count:12,avg_elevation:1047.25,top_states_by_elevation:[{state:"IL",avg_elevation:811.5,airport_count:2,sort:2},{state:"KS",avg_elevation:1250,airport_count:1,sort:1},{state:"OH",avg_elevation:1164,airport_count:1,sort:1},{state:"CO",avg_elevation:5050,airport_count:1,sort:1},{state:"MI",avg_elevation:980,airport_count:1,sort:1},{state:"OTHER",avg_elevation:416.6666666666667,airport_count:6,sort:0}]}],totalRows:7},e.appendChild(t)})();</script>
      </div>
    </div>
    <div class="result-middle" data-result-kind="json" >
      <div class="result-inner">
        <pre><pre class="language-json" style="background-color: #FBFBFB"><span class="line"><span style="color: #000000">[</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;Facility Type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;AIRPORT&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">13925</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1237.0441651705567</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;top_states_by_elevation&quot;</span><span style="color: #000000">: [</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;CO&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">5873.0642570281125</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">249</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;sort&quot;</span><span style="color: #000000">: </span><span style="color: #098658">249</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;NM&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">5467.63870967742</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">155</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;sort&quot;</span><span style="color: #000000">: </span><span style="color: #098658">155</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;NV&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4384.041237113402</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">97</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;sort&quot;</span><span style="color: #000000">: </span><span style="color: #098658">97</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;UT&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">5257.18556701031</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">97</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;sort&quot;</span><span style="color: #000000">: </span><span style="color: #098658">97</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;WY&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">5570.0329670329675</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">91</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;sort&quot;</span><span style="color: #000000">: </span><span style="color: #098658">91</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;OTHER&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1017.9730281051677</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">13236</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;sort&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0</span></span>
<span class="line"><span style="color: #000000">      }</span></span>
<span class="line"><span style="color: #000000">    ]</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;Facility Type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;HELIPORT&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">5135</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">950.5125608568646</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;top_states_by_elevation&quot;</span><span style="color: #000000">: [</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;CO&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">6816.569696969697</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">165</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;sort&quot;</span><span style="color: #000000">: </span><span style="color: #098658">165</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;UT&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4634.720930232558</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">43</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;sort&quot;</span><span style="color: #000000">: </span><span style="color: #098658">43</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;MT&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3756.310344827586</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">29</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;sort&quot;</span><span style="color: #000000">: </span><span style="color: #098658">29</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;NM&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">5170.76</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">25</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;sort&quot;</span><span style="color: #000000">: </span><span style="color: #098658">25</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;WY&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">5806.416666666667</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">24</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;sort&quot;</span><span style="color: #000000">: </span><span style="color: #098658">24</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;OTHER&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">655.6607547948031</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4849</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;sort&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0</span></span>
<span class="line"><span style="color: #000000">      }</span></span>
<span class="line"><span style="color: #000000">    ]</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;Facility Type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;SEAPLANE BASE&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">473</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">488.82241014799155</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;top_states_by_elevation&quot;</span><span style="color: #000000">: [</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;ID&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1884.6</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">5</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;sort&quot;</span><span style="color: #000000">: </span><span style="color: #098658">5</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;MT&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3194</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;sort&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;NM&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4201</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;sort&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;NE&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1946</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;sort&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;SD&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1600</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;sort&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;OTHER&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">448.49892008639307</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">463</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;sort&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0</span></span>
<span class="line"><span style="color: #000000">      }</span></span>
<span class="line"><span style="color: #000000">    ]</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;Facility Type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;ULTRALIGHT&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">125</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">806.144</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;top_states_by_elevation&quot;</span><span style="color: #000000">: [</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;AZ&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2025.7142857142858</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">7</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;sort&quot;</span><span style="color: #000000">: </span><span style="color: #098658">7</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;CA&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1335</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;sort&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;NY&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1530</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;sort&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;CO&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">8110</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;sort&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;MT&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3540</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;sort&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;OTHER&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">617.9285714285714</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">112</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;sort&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0</span></span>
<span class="line"><span style="color: #000000">      }</span></span>
<span class="line"><span style="color: #000000">    ]</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;Facility Type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;STOLPORT&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">86</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1375.046511627907</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;top_states_by_elevation&quot;</span><span style="color: #000000">: [</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;CO&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">6211.666666666667</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">6</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;sort&quot;</span><span style="color: #000000">: </span><span style="color: #098658">6</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;CA&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4040.5</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;sort&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;MT&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3776</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;sort&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;NV&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4900</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;sort&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;AZ&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4772</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;sort&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;OTHER&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">752.418918918919</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">74</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;sort&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0</span></span>
<span class="line"><span style="color: #000000">      }</span></span>
<span class="line"><span style="color: #000000">    ]</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;Facility Type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;GLIDERPORT&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">37</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1611.4054054054054</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;top_states_by_elevation&quot;</span><span style="color: #000000">: [</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;CO&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">7061.666666666667</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;sort&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;AZ&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3539</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;sort&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;KS&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2088.5</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;sort&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;NY&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1484.5</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;sort&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;NV&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4300</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;sort&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;OTHER&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">737.5185185185185</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">27</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;sort&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0</span></span>
<span class="line"><span style="color: #000000">      }</span></span>
<span class="line"><span style="color: #000000">    ]</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;Facility Type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;BALLOONPORT&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">12</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1047.25</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;top_states_by_elevation&quot;</span><span style="color: #000000">: [</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;IL&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">811.5</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;sort&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;KS&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1250</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;sort&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;OH&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1164</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;sort&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;CO&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">5050</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;sort&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;MI&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">980</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;sort&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;OTHER&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #098658">416.6666666666667</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;airport_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">6</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;sort&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0</span></span>
<span class="line"><span style="color: #000000">      }</span></span>
<span class="line"><span style="color: #000000">    ]</span></span>
<span class="line"><span style="color: #000000">  }</span></span>
<span class="line"><span style="color: #000000">]</span></span></pre></pre>
      </div>
    </div>
    <div class="result-middle" data-result-kind="sql" >
      <div class="result-inner">
        <pre><pre class="language-sql" style="background-color: #FBFBFB"><span class="line"><span style="color: #0000FF">WITH</span><span style="color: #000000"> __stage0 </span><span style="color: #0000FF">AS</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">SELECT</span></span>
<span class="line"><span style="color: #000000">    group_set,</span></span>
<span class="line"><span style="color: #000000">    base.</span><span style="color: #A31515">&quot;fac_type&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;Facility Type__0&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">0</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #098658">1</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;airport_count__0&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">0</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">AVG</span><span style="color: #000000">(base.</span><span style="color: #A31515">&quot;elevation&quot;</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;avg_elevation__0&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set </span><span style="color: #0000FF">IN</span><span style="color: #000000"> (</span><span style="color: #098658">1</span><span style="color: #000000">,</span><span style="color: #098658">2</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      base.</span><span style="color: #A31515">&quot;state&quot;</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;state__1&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">AVG</span><span style="color: #000000">(base.</span><span style="color: #A31515">&quot;elevation&quot;</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;avg_elevation__1&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    (</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #795E26">ROW_NUMBER</span><span style="color: #000000">() </span><span style="color: #0000FF">OVER</span><span style="color: #000000">(</span><span style="color: #0000FF">PARTITION</span><span style="color: #000000"> </span><span style="color: #0000FF">BY</span><span style="color: #000000"> group_set, base.</span><span style="color: #A31515">&quot;fac_type&quot;</span><span style="color: #000000">  </span><span style="color: #0000FF">ORDER BY</span><span style="color: #000000">  </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">AVG</span><span style="color: #000000">(base.</span><span style="color: #A31515">&quot;elevation&quot;</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">desc</span><span style="color: #000000"> NULLS </span><span style="color: #0000FF">LAST</span><span style="color: #000000"> ) </span><span style="color: #0000FF">END</span><span style="color: #000000">)&gt;</span><span style="color: #098658">5</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;is_other__1&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">2</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      base.</span><span style="color: #A31515">&quot;code&quot;</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;code__2&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">2</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      base.</span><span style="color: #A31515">&quot;elevation&quot;</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;elevation__2&quot;</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">FROM</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;../data/airports.parquet&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> base</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">CROSS</span><span style="color: #000000"> </span><span style="color: #0000FF">JOIN</span><span style="color: #000000"> (</span><span style="color: #0000FF">SELECT</span><span style="color: #000000"> UNNEST(GENERATE_SERIES(</span><span style="color: #098658">0</span><span style="color: #000000">,</span><span style="color: #098658">2</span><span style="color: #000000">,</span><span style="color: #098658">1</span><span style="color: #000000">)) </span><span style="color: #0000FF">as</span><span style="color: #000000"> group_set  ) </span><span style="color: #0000FF">as</span><span style="color: #000000"> group_set</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">GROUP BY</span><span style="color: #000000"> </span><span style="color: #098658">1</span><span style="color: #000000">,</span><span style="color: #098658">2</span><span style="color: #000000">,</span><span style="color: #098658">5</span><span style="color: #000000">,</span><span style="color: #098658">8</span><span style="color: #000000">,</span><span style="color: #098658">9</span></span>
<span class="line"><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">, __stage1 </span><span style="color: #0000FF">AS</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">SELECT</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">2</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">ELSE</span><span style="color: #000000"> group_set </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> group_set,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #A31515">&quot;Facility Type__0&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;Facility Type__0&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">FIRST</span><span style="color: #000000">(</span><span style="color: #A31515">&quot;airport_count__0&quot;</span><span style="color: #000000">) </span><span style="color: #0000FF">FILTER</span><span style="color: #000000"> (</span><span style="color: #0000FF">WHERE</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;airport_count__0&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">IS</span><span style="color: #000000"> </span><span style="color: #0000FF">NOT</span><span style="color: #000000"> </span><span style="color: #0000FF">NULL</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;airport_count__0&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">FIRST</span><span style="color: #000000">(</span><span style="color: #A31515">&quot;avg_elevation__0&quot;</span><span style="color: #000000">) </span><span style="color: #0000FF">FILTER</span><span style="color: #000000"> (</span><span style="color: #0000FF">WHERE</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;avg_elevation__0&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">IS</span><span style="color: #000000"> </span><span style="color: #0000FF">NOT</span><span style="color: #000000"> </span><span style="color: #0000FF">NULL</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;avg_elevation__0&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set </span><span style="color: #0000FF">IN</span><span style="color: #000000"> (</span><span style="color: #098658">1</span><span style="color: #000000">,</span><span style="color: #098658">2</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #A31515">&quot;state__1&quot;</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;state__1&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">FIRST</span><span style="color: #000000">(</span><span style="color: #A31515">&quot;avg_elevation__1&quot;</span><span style="color: #000000">) </span><span style="color: #0000FF">FILTER</span><span style="color: #000000"> (</span><span style="color: #0000FF">WHERE</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;avg_elevation__1&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">IS</span><span style="color: #000000"> </span><span style="color: #0000FF">NOT</span><span style="color: #000000"> </span><span style="color: #0000FF">NULL</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;avg_elevation__1&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">FIRST</span><span style="color: #000000">(</span><span style="color: #A31515">&quot;is_other__1&quot;</span><span style="color: #000000">) </span><span style="color: #0000FF">FILTER</span><span style="color: #000000"> (</span><span style="color: #0000FF">WHERE</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;is_other__1&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">IS</span><span style="color: #000000"> </span><span style="color: #0000FF">NOT</span><span style="color: #000000"> </span><span style="color: #0000FF">NULL</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;is_other__1&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(LIST({</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #A31515">&quot;code&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;code__2&quot;</span><span style="color: #000000">, </span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #A31515">&quot;elevation&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;elevation__2&quot;</span><span style="color: #000000">}  </span><span style="color: #0000FF">ORDER BY</span><span style="color: #000000">  </span><span style="color: #A31515">&quot;code__2&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">asc</span><span style="color: #000000"> NULLS </span><span style="color: #0000FF">LAST</span><span style="color: #000000">) </span><span style="color: #0000FF">FILTER</span><span style="color: #000000"> (</span><span style="color: #0000FF">WHERE</span><span style="color: #000000"> group_set=</span><span style="color: #098658">2</span><span style="color: #000000">),[]) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;data__1&quot;</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">FROM</span><span style="color: #000000"> __stage0</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">GROUP BY</span><span style="color: #000000"> </span><span style="color: #098658">1</span><span style="color: #000000">,</span><span style="color: #098658">2</span><span style="color: #000000">,</span><span style="color: #098658">5</span></span>
<span class="line"><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">SELECT</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #A31515">&quot;Facility Type__0&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;Facility Type&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #795E26">MAX</span><span style="color: #000000">(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">0</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;airport_count__0&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;airport_count&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #795E26">MAX</span><span style="color: #000000">(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">0</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;avg_elevation__0&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;avg_elevation&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">  (</span><span style="color: #0000FF">WITH</span><span style="color: #000000"> __stage0 </span><span style="color: #0000FF">AS</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">SELECT</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">       </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #0000FF">NOT</span><span style="color: #000000"> base.</span><span style="color: #A31515">&quot;is_other&quot;</span><span style="color: #000000">,TRUE) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> base.</span><span style="color: #A31515">&quot;state&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">ELSE</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;OTHER&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;state&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">       </span><span style="color: #795E26">AVG</span><span style="color: #000000">(data_0.</span><span style="color: #A31515">&quot;elevation&quot;</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;avg_elevation&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">       </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #0000FF">DISTINCT</span><span style="color: #000000"> base.</span><span style="color: #A31515">&quot;__distinct_key&quot;</span><span style="color: #000000"> || </span><span style="color: #A31515">&#39;x&#39;</span><span style="color: #000000"> || data_0_outer.__row_id) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;airport_count&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">       </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #0000FF">DISTINCT</span><span style="color: #000000"> </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #0000FF">NOT</span><span style="color: #000000"> base.</span><span style="color: #A31515">&quot;is_other&quot;</span><span style="color: #000000">,TRUE) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> base.</span><span style="color: #A31515">&quot;__distinct_key&quot;</span><span style="color: #000000"> || </span><span style="color: #A31515">&#39;x&#39;</span><span style="color: #000000"> || data_0_outer.__row_id </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;sort&quot;</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">FROM</span><span style="color: #000000"> (</span><span style="color: #0000FF">SELECT</span><span style="color: #000000"> GEN_RANDOM_UUID() </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;__distinct_key&quot;</span><span style="color: #000000">, x.*  </span><span style="color: #0000FF">FROM</span><span style="color: #000000"> (</span><span style="color: #0000FF">SELECT</span><span style="color: #000000"> UNNEST(</span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(LIST({</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #A31515">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;state__1&quot;</span><span style="color: #000000">, </span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #A31515">&quot;avg_elevation&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;avg_elevation__1&quot;</span><span style="color: #000000">, </span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #A31515">&quot;is_other&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;is_other__1&quot;</span><span style="color: #000000">, </span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #A31515">&quot;data&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;data__1&quot;</span><span style="color: #000000">}  </span><span style="color: #0000FF">ORDER BY</span><span style="color: #000000">  </span><span style="color: #A31515">&quot;avg_elevation__1&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">desc</span><span style="color: #000000"> NULLS </span><span style="color: #0000FF">LAST</span><span style="color: #000000">) </span><span style="color: #0000FF">FILTER</span><span style="color: #000000"> (</span><span style="color: #0000FF">WHERE</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000">),[])) </span><span style="color: #0000FF">as</span><span style="color: #000000"> base) </span><span style="color: #0000FF">as</span><span style="color: #000000"> x) </span><span style="color: #0000FF">as</span><span style="color: #000000"> base</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">LEFT JOIN</span><span style="color: #000000"> LATERAL (</span><span style="color: #0000FF">SELECT</span><span style="color: #000000"> UNNEST(GENERATE_SERIES(</span><span style="color: #098658">1</span><span style="color: #000000">, </span><span style="color: #0000FF">length</span><span style="color: #000000">(base.</span><span style="color: #A31515">&quot;data&quot;</span><span style="color: #000000">),</span><span style="color: #098658">1</span><span style="color: #000000">)) </span><span style="color: #0000FF">as</span><span style="color: #000000"> __row_id, UNNEST(base.</span><span style="color: #A31515">&quot;data&quot;</span><span style="color: #000000">), </span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> ignoreme) </span><span style="color: #0000FF">as</span><span style="color: #000000"> data_0_outer(__row_id, data_0,ignoreme) </span><span style="color: #0000FF">ON</span><span style="color: #000000">  data_0_outer.ignoreme=</span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">GROUP BY</span><span style="color: #000000"> </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">ORDER BY</span><span style="color: #000000"> </span><span style="color: #098658">4</span><span style="color: #000000"> </span><span style="color: #0000FF">desc</span><span style="color: #000000"> NULLS </span><span style="color: #0000FF">LAST</span></span>
<span class="line"><span style="color: #000000">  )</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">SELECT</span><span style="color: #000000"> LIST(STRUCT_PACK(</span><span style="color: #A31515">&quot;state&quot;</span><span style="color: #000000">,</span><span style="color: #A31515">&quot;avg_elevation&quot;</span><span style="color: #000000">,</span><span style="color: #A31515">&quot;airport_count&quot;</span><span style="color: #000000">,</span><span style="color: #A31515">&quot;sort&quot;</span><span style="color: #000000">) </span><span style="color: #0000FF">ORDER BY</span><span style="color: #000000"> sort </span><span style="color: #0000FF">desc</span><span style="color: #000000">) </span><span style="color: #0000FF">FROM</span><span style="color: #000000"> __stage0</span></span>
<span class="line"><span style="color: #000000">  ) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;top_states_by_elevation&quot;</span></span>
<span class="line"><span style="color: #0000FF">FROM</span><span style="color: #000000"> __stage1</span></span>
<span class="line"><span style="color: #0000FF">GROUP BY</span><span style="color: #000000"> </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #0000FF">ORDER BY</span><span style="color: #000000"> </span><span style="color: #098658">2</span><span style="color: #000000"> </span><span style="color: #0000FF">desc</span><span style="color: #000000"> NULLS </span><span style="color: #0000FF">LAST</span></span>
<span class="line"></span></pre></pre>
      </div>
    </div>
  </div></div></div></div>
        </div>
        <script src="/js/view_toggles.js"></script>
        <script src="/js/jump_to_hash.js"></script>
      </div>
    </div>
    <div id="banner_wrapper">
      <div id="banner">
        <div>
          This site uses cookies from Google to deliver its services and to analyze
          traffic.
          <a
            href="https://policies.google.com/technologies/cookies"
            target="_blank"
          >
            Learn more
          </a>
        </div>
        <button id="banner_button">I Understand</button>
      </div>
    </div>
    <script src="/js/banner.js"></script>
    <script src="/js/generated/malloy-render-0.0.282.js"></script>
  </body>
</html>
