<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      property="og:image"
      content="https://malloydata.github.io/blog/2024-01-28-bigquery-jobs/malloy_and_bq.png"
    />
    <title>Instant BigQuery Usage Insights with Malloy</title>
    <link rel="stylesheet" href="/css/document.css" />
    <link
      rel="shortcut icon"
      type="image/x-icon"
      href="/img/favicon.ico"
    />
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-0M10W7C20Y"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
    
      gtag("config", "G-0M10W7C20Y");
    </script>
    <style>
      malloy-render::part(table-container) {
        width: 100%;
      }
    </style>
  </head>
  <body>
    <div class="top">
      <div class="header">
        <div class="header-banner">
          <a href="http://www.malloydata.dev" target="_blank">
            <img
              class="logo"
              src="/img/logo.png"
              alt="malloy logo"
            />
          </a>

          Malloy
          <a href="/blog"><span class="subtitle">Blog</span></a>
        </div>
        <div class="header-right">
          <div class="header-links">
            <a href="https://github.com/malloydata/malloy" target="_blank"
              ><img
                src="/img/github.svg"
                style="transform: scale(0.5)"
            /></a>
            <a href="/slack" target="_blank"
              ><img src="/img/slack.svg"
            /></a>
          </div>
        </div>
      </div>
      <div class="main">
        <div class="content">
          <div class="document-outer blog">
            
            <div class="blog-header linear-navigation">
              <div class="item">
                <a href="/blog"
                  ><img
                    src="/img/previous.svg"
                    alt="previous"
                  />All Posts</a
                >
              </div>
              <div class="edit-link">
                <a
                  class="edit-link"
                  target="_blank"
                  href="https://github.dev/malloydata/malloydata.github.io/blob/main/src/blog/2024-01-28-bigquery-jobs/index.malloynb#C1"
                  >VSCode
                  <img
                    src="/img/open_notebook.svg"
                    alt="document"
                /></a>
              </div>
            </div>
             <div class="document"><img src="malloy_and_bq.png" class="no-shadow"/><div class="title-row">
        
      <h1>
        <a id="instant-bigquery-usage-insights-with-malloy" class="header-link anchor" href="#instant-bigquery-usage-insights-with-malloy">
          Instant BigQuery Usage Insights with Malloy
        </a>
      </h1>
    
        <a class="edit-link" target="_blank" href="https://github.dev/malloydata/malloydata.github.io/blob/main/src/blog/2024-01-28-bigquery-jobs/index.malloynb#C1">VSCode <img src="/img/open_notebook.svg" alt="document"/></a>
        </div>
      <p><em>January 28, 2024 by Carlin Eng</em>
<br/><br/><br/></p>
<p>Malloy is an innovative way to analyze and explore data. The Malloy team’s dedication to user experience removes much of the toil of data analysis, and turns it into a joyful experience. With some recent advances on GCP, it’s now easier than ever to run Malloy against your data in BigQuery. This blog post will show you exactly how, and provide you with some sample analysis that you can take off the shelf and use to explore your BigQuery usage patterns.</p>
<p><a href="https://cloud.google.com/shell/docs">Google Cloud Shell</a> is a browser-based environment that greatly simplifies developing and operating a GCP environment. It comes preloaded with all the necessary libraries and credentials for accessing resources in a GCP project, including BigQuery. It also comes with a VS Code-based editing environment called <a href="https://cloud.google.com/code">Cloud Code</a>, with full access to the VS Code Extension Marketplace. Navigate to <a href="https://ide.cloud.google.com" target="_blank">ide.cloud.google.com</a> and you’ll see it open up. Make sure you are running the ‘Preview’ as it has a more recent version of VS Code.</p>
<img src="cloudshell_ide.png" class="no-shadow" /><p>To start analyzing your BigQuery usage data with Malloy, you need to do a few things:</p>
<ul>
<li><p>Install the Malloy VS Code extension</p>
</li>
<li><p>Connect Cloud Code to your GCP Project</p>
</li>
<li><p>Clone the <a href="https://github.com/malloydata/bigquery_jobs" target="_blank">bigquery_jobs Github repository</a> . Let's walk through it, step-by-step:</p>
</li></ul>

      <h2>
        <a id="installing-the-extension" class="header-link anchor" href="#installing-the-extension">
          Installing the Extension
        </a>
      </h2>
    <p>In your Cloud Shell Editor, the VS Code extension is accessible through the Extension Marketplace. Click on the Extensions icon in the sidebar, search for “Malloy”, and install the extension.</p>
<img src="installing_extension.png" class="no-shadow" />
      <h2>
        <a id="signing-into-your-gcp-project" class="header-link anchor" href="#signing-into-your-gcp-project">
          Signing into your GCP Project
        </a>
      </h2>
    <p>Click the “Cloud Code - Sign In” button on the bottom of your screen. This will open an authorization dialog that prompts you to authorize Cloud Shell to your GCP Project.</p>
<img src="signing_in.png" class="no-shadow" /><p>The Status Bar at the bottom of your screen should now have the name of your GCP project. If you instead see text that says “Cloud Code - No Project”, click the “No Project” text on the status bar, and it will open up another dialog box that prompts you to select a project:</p>
<img src="select_project.png" class="no-shadow" /><p>Once you’ve selected a Google Cloud project, your Cloud Code environment is authorized to run queries against BigQuery.</p>

      <h2>
        <a id="load-the-bigquery-jobs-data-model-from-github" class="header-link anchor" href="#load-the-bigquery-jobs-data-model-from-github">
          Load the BigQuery Jobs Data Model from Github
        </a>
      </h2>
    <p>We’ve pre-built a Malloy data model on top of the <a href="https://cloud.google.com/bigquery/docs/information-schema-intro" target="_blank">BigQuery information_schema views</a>. This will allow you to gather insights about your BigQuery usage without having to do the detective work of understanding the schema of the tables yourself. Just clone the data model, point the tables to your own internal data, and run the notebooks.</p>
<p>Click on the “Clone Git Repository” button on the home screen and enter the URL for our git repository: <a href="https://github.com/malloydata/bigquery_jobs.git">https://github.com/malloydata/bigquery_jobs.git</a></p>
<img src="clone_model.png" class="no-shadow" /><p>This will clone the git repo into the filesystem of your Cloud Shell instance, and open up the repo as a folder in your VS Code environment.</p>

      <h2>
        <a id="point-the-data-models-at-your-own-data" class="header-link anchor" href="#point-the-data-models-at-your-own-data">
          Point the Data Models at your own Data
        </a>
      </h2>
    <p>Open up <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">config</span><span style="color: #000000">.</span><span style="color: #001080">malloy</span></span></code> in the repo and in each of the <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">bigquery</span><span style="color: #000000">.</span><span style="color: #795E26">sql</span><span style="color: #000000">(‘...’)</span></span></code> statements, enter the values for your own <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">information_schema</span></span></code> views. For example, if my GCP Project was in the “US” region, the config file would look like the following:</p>
<div class="code-wrapper"><pre class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">source</span><span style="color: #000000">: </span><span style="color: #001080">jobs_tbl</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">bigquery</span><span style="color: #000000">.</span><span style="color: #795E26">sql</span><span style="color: #000000">(</span><span style="color: #A31515">&#39;SELECT * FROM `region-US`.INFORMATION_SCHEMA.JOBS&#39;</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #AF00DB">source</span><span style="color: #000000">: </span><span style="color: #001080">tables_tbl</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">bigquery</span><span style="color: #000000">.</span><span style="color: #795E26">sql</span><span style="color: #000000">(</span><span style="color: #A31515">&#39;SELECT * FROM `region-US`.INFORMATION_SCHEMA.TABLES&#39;</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #AF00DB">source</span><span style="color: #000000">: </span><span style="color: #001080">table_storage_tbl</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">bigquery</span><span style="color: #000000">.</span><span style="color: #795E26">sql</span><span style="color: #000000">(</span><span style="color: #A31515">&#39;SELECT * FROM `region-US`.INFORMATION_SCHEMA.TABLE_STORAGE&#39;</span><span style="color: #000000">)</span></span></pre></div><p>Try clicking the "Preview" CodeLens action to show some examples of the data in the <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">information</span><span style="color: #000000">-</span><span style="color: #001080">schema</span></span></code>.</p>
<img src="preview_codelens.jpg"><p>If you run into an error saying "bytes billed exceeded", you'll need to update the BigQuery connection settings.</p>
<img src="update_bytes_billed.png">
      <h2>
        <a id="run-the-dashboard-queries" class="header-link anchor" href="#run-the-dashboard-queries">
          Run the Dashboard Queries
        </a>
      </h2>
    <p>Once your model has been configured to point at your own <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">information_schema</span></span></code> data, you can immediately start exploring. The <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">dashboard</span><span style="color: #000000">.</span><span style="color: #001080">malloynb</span></span></code> file contains a set of queries that will immediately give you an overview of your high level BigQuery usage patterns, including slot usage over time, hot and cold tables, most active users, and most expensive queries. Open up the <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">dashboard</span><span style="color: #000000">.</span><span style="color: #001080">malloynb</span></span></code> file and click the “Run All” button at the top to execute each of the queries, then scroll through the notebook to see the results:</p>
<img src="notebook.png" class="no-shadow" />
      <h2>
        <a id="conclusion" class="header-link anchor" href="#conclusion">
          Conclusion
        </a>
      </h2>
    <p>Data analysis is an iterative process, and the answer to one question will spawn many more questions. Within a Malloy Notebook, it’s easy to use one query as a starting point for an investigation, and branch off into many different directions. Within this notebook, I can easily add new Malloy query cells to drill in further. As a quick exercise to see the power of Malloy for yourself, try answering a few of these simple questions:</p>
<ul>
<li><p>Runaway queries in BigQuery can cause resource contention. Oftentimes these queries bump up against the <a href="https://cloud.google.com/bigquery/quotas#query_jobs">default 6 hour runtime limit</a>. Are there any recurring queries in your project that are hitting this limit and causing problems? Write a query to identify these queries, and the user responsible for issuing them.</p>
</li>
<li><p>BigQuery has the ability to instantaneously scale your compute resources up and down to meet demand. Does your BigQuery project exhibit any clear usage patterns around time of day or day of week?</p>
</li>
<li><p>The model we built in the <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">jobs</span><span style="color: #000000">.</span><span style="color: #001080">malloy</span></span></code> file is fairly basic. It includes some scalar transformations, some aggregating measures, and some queries of interest. What other calculations would you include in the model to make it interesting for your own data?</p>
</li></ul>
<p>We love hearing feedback and suggestions, so once you've tried this out, let us know how your experience went -- <a href="/slack">join the Malloy community Slack channel</a> and drop us a line!</p>
</div> 
            <div class="blog-footer linear-navigation">
              <div class="item">
                <a href="/blog//2024-01-09-whats-next-in-2024"
                  ><img
                    src="/img/previous.svg"
                    alt="previous"
                  />Previous Post</a
                >
              </div>
              <div class="item">
                <a href="/blog//2024-02-08-tables"
                  >Next Post<img
                    src="/img/next.svg"
                    alt="previous" /></a
                >
              </div>
            </div>
          </div>
        </div>
        <script src="/js/view_toggles.js"></script>
        <script src="/js/jump_to_hash.js"></script>
      </div>
    </div>
    <div id="banner_wrapper">
      <div id="banner">
        <div>
          This site uses cookies from Google to deliver its services and to analyze
          traffic.
          <a
            href="https://policies.google.com/technologies/cookies"
            target="_blank"
          >
            Learn more
          </a>
        </div>
        <button id="banner_button">I Understand</button>
      </div>
    </div>
    <script src="/js/banner.js"></script>
    <script src="/js/generated/malloy-render-0.0.282.js"></script>
  </body>
</html>
