<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Malloy Blog</title>
    <link rel="stylesheet" href="/css/document.css" />
    <link
      rel="shortcut icon"
      type="image/x-icon"
      href="/img/favicon.ico"
    />
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-0M10W7C20Y"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
    
      gtag("config", "G-0M10W7C20Y");
    </script>
    <style>
      malloy-render::part(table-container) {
        width: 100%;
      }
    </style>
  </head>
  <body>
    <div class="top">
      <div class="header">
        <div class="header-banner">
          <a href="http://www.malloydata.dev" target="_blank">
            <img
              class="logo"
              src="/img/logo.png"
              alt="malloy logo"
            />
          </a>

          Malloy
          <a href="/blog"><span class="subtitle">Blog</span></a>
        </div>
        <div class="header-right">
          <div class="header-links">
            <a href="https://github.com/malloydata/malloy" target="_blank"
              ><img
                src="/img/github.svg"
                style="transform: scale(0.5)"
            /></a>
            <a href="/slack" target="_blank"
              ><img src="/img/slack.svg"
            /></a>
          </div>
        </div>
      </div>
      <div class="main">
        <div class="content">
          <div class="document-outer blog">
            
            <div class="blog-header linear-navigation">
              <div class="item">
                <a href="/blog"
                  ><img
                    src="/img/previous.svg"
                    alt="previous"
                  />All Posts</a
                >
              </div>
              <div class="edit-link">
                <a
                  class="edit-link"
                  target="_blank"
                  href="https://github.dev/malloydata/malloydata.github.io/blob/main/src/blog/2023-11-04-data-for-kindergarten/index.malloynb#C1"
                  >VSCode
                  <img
                    src="/img/open_notebook.svg"
                    alt="document"
                /></a>
              </div>
            </div>
             <div class="document"><div class="title-row">
        
      <h1>
        <a id="data-for-kindergarteners" class="header-link anchor" href="#data-for-kindergarteners">
          Data for Kindergarteners
        </a>
      </h1>
    
        <a class="edit-link" target="_blank" href="https://github.dev/malloydata/malloydata.github.io/blob/main/src/blog/2023-11-04-data-for-kindergarten/index.malloynb#C1">VSCode <img src="/img/open_notebook.svg" alt="document"/></a>
        </div>
      <p>Given that we learn about data in Kindergarten, It is really surprising how hard it is to query data in the "big" world.  In kindergarten data we notice attributes about <em>things</em>, make piles of <em>things</em>, and count <em>things</em> in the piles.  We do this even before we learn any "real" math.  Strangely, noticing attributes about <em>things</em> and counting <em>things</em> is almost all there is to working with data.</p>

      <h3>
        <a id="two-types-of-queries-where-s-waldo-and-making-piles-" class="header-link anchor" href="#two-types-of-queries-where-s-waldo-and-making-piles-">
          Two types of queries, "Where's Waldo" and "Making Piles"
        </a>
      </h3>
    <p>There are really two types of queries in the world, <em>lookup</em> and <em>aggregating</em>.</p>
<p><em>Lookup</em> queries are pretty easy.  Google search is a lookup query.  To search, type in some terms then see a list of results. Searching in SQL this often looks like `SELECT * FROM <something> WHERE <FILTER>``.</p>
<p>The interesting queries, the kindergarten queries, are <em>aggregating</em>.  Aggregating queries tell you something about a set of data.  The an aggregating query has two main parts, the <em>dimensions</em> and <em>measures</em>.</p>
<p><em>Dimensions</em> are the attribute you use to decide which pile the <em>thing</em> goes in.</p>
<p>A <em>measure</em> is something you can say about the pile.  "How many object?", "How much does it weigh?", "What is the average size of an object in this pile?".</p>
<p>"Ok class lets take this pile of coins and separate them.  How many coins are pennies?  How many coins are nickels? Dimes?  Quarters?"</p>
<p><em>Aggregating queries</em> tell us things about a datasets.  <em>Lookup queries</em> find things.</p>

      <h2>
        <a id="data-tools-are-rectangular-" class="header-link anchor" href="#data-tools-are-rectangular-">
          Data tools are rectangular.
        </a>
      </h2>
    <p>In data world, aggregating queries the piles things we make become rows in the output an table.  We pick some attribue from the source table and for every different attribute we recognize, we make a row in the output table.  We add columns to the output by measuring things about the rows underlying object.</p>
<p>For this example we are going to use a pile of coins.  Each coin has only two attributes.  The value of the coin and the year it was minted.  We've stored the data about these coins in a data table.</p>
<p>The columns are named <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">face_value</span></span></code> and <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">year_minted</span></span></code>.  Let's see how we can notice things about these coins.</p>
<div class="code-wrapper"><a href="https://github.dev/malloydata/malloydata.github.io/blob/main/src/blog/2023-11-04-data-for-kindergarten/index.malloynb#C2" target="_blank" class="open_notebook"><img src="/img/open_notebook.svg" alt="document"/></a><pre class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">run</span><span style="color: #000000">: </span><span style="color: #001080">duckdb</span><span style="color: #000000">.</span><span style="color: #795E26">table</span><span style="color: #000000">(</span><span style="color: #A31515">&#39;coins.csv&#39;</span><span style="color: #000000">) -&gt; {</span><span style="color: #AF00DB">select</span><span style="color: #000000">:*}</span></span></pre><div class="result-outer small">
    <div class="result-controls-bar">
      <span class="result-label">QUERY RESULTS</span>
      <div class="result-controls">
        <button class="result-control" selected data-result-kind="html">HTML</button>
        <button class="result-control"  data-result-kind="json">JSON</button>
        <button class="result-control"  data-result-kind="sql">SQL</button>
      </div>
    </div>
    <div class="result-middle" data-result-kind="html" selected>
      <div class="result-inner" id="c4d974ce-4cc0-4606-8018-cb47408062f6">
        <script>(()=>{var e=document.getElementById("c4d974ce-4cc0-4606-8018-cb47408062f6"),a=document.createElement("malloy-render");a.modelDef={name:"",exports:[],contents:{},queryList:[{type:"query",structRef:{type:"table",name:"duckdb:coins.csv",dialect:"duckdb",tablePath:"coins.csv",connection:"duckdb",fields:[{type:"number",numberType:"integer",name:"face_value",fieldUsage:[{path:["face_value"]}]},{type:"number",numberType:"integer",name:"minted_year",fieldUsage:[{path:["minted_year"]}]}]},pipeline:[{type:"project",queryFields:[{type:"fieldref",path:["face_value"]},{type:"fieldref",path:["minted_year"]}],filterList:[],fieldUsage:[{path:["face_value"]},{path:["minted_year"]}]}]}],dependencies:{},references:[],imports:[]},a.queryResult={lastStageName:"__stage0",malloy:"",sql:'SELECT \n   base."face_value" as "face_value",\n   base."minted_year" as "minted_year"\nFROM coins.csv as base\n',dependenciesToMaterialize:{},structs:[{type:"query_result",name:"__stage0",fields:[{name:"face_value",numberType:"integer",type:"number",resultMetadata:{sourceField:"face_value",sourceClasses:["face_value"],referenceId:"776c2c38-cb23-4f80-957f-6e285fbf3c2b",fieldKind:"dimension"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:0,character:5},end:{line:0,character:30}}}},{name:"minted_year",numberType:"integer",type:"number",resultMetadata:{sourceField:"minted_year",sourceClasses:["minted_year"],referenceId:"81aafdec-05f3-4a09-86a3-fbcfa4920584",fieldKind:"dimension"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:0,character:5},end:{line:0,character:30}}}}],dialect:"duckdb",connection:"duckdb",resultMetadata:{sourceField:"ignoreme",filterList:[],sourceClasses:["ignoreme"],fieldKind:"struct",drillable:!0}}],sourceExplore:"duckdb:coins.csv",connectionName:"duckdb",result:[{face_value:1,minted_year:1930},{face_value:1,minted_year:1920},{face_value:1,minted_year:2022},{face_value:1,minted_year:2020},{face_value:5,minted_year:2012}],totalRows:5},e.appendChild(a)})();</script>
      </div>
    </div>
    <div class="result-middle" data-result-kind="json" >
      <div class="result-inner">
        <pre><pre class="language-json" style="background-color: #FBFBFB"><span class="line"><span style="color: #000000">[</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;face_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;minted_year&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1930</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;face_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;minted_year&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1920</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;face_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;minted_year&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2022</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;face_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;minted_year&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2020</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;face_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">5</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;minted_year&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2012</span></span>
<span class="line"><span style="color: #000000">  }</span></span>
<span class="line"><span style="color: #000000">]</span></span></pre></pre>
      </div>
    </div>
    <div class="result-middle" data-result-kind="sql" >
      <div class="result-inner">
        <pre><pre class="language-sql" style="background-color: #FBFBFB"><span class="line"><span style="color: #0000FF">SELECT</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">   base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">   base.</span><span style="color: #A31515">&quot;minted_year&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;minted_year&quot;</span></span>
<span class="line"><span style="color: #0000FF">FROM</span><span style="color: #000000"> coins.csv </span><span style="color: #0000FF">as</span><span style="color: #000000"> base</span></span>
<span class="line"></span></pre></pre>
      </div>
    </div>
  </div></div>
      <h2>
        <a id="the-first-questions-is-how-many-coins-do-we-have-" class="header-link anchor" href="#the-first-questions-is-how-many-coins-do-we-have-">
          The first questions is "How Many coins do we have?"
        </a>
      </h2>
    <p>Usually the very first question, "let's count all the coins".  In Malloy, the data <em>source</em>, <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">duckdb</span><span style="color: #000000">.</span><span style="color: #795E26">table</span><span style="color: #000000">(</span><span style="color: #A31515">&#39;coins.csv&#39;</span><span style="color: #000000">)</span></span></code>, is where the  comes from.  The <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #000000">-&gt;</span></span></code> operator asks a question from the source and the stuff in the <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #000000">{}</span></span></code> is the question.  <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">aggregate</span><span style="color: #000000">:</span></span></code> is used to write an expression that tells us something about the size of the pile.</p>
<div class="code-wrapper"><a href="https://github.dev/malloydata/malloydata.github.io/blob/main/src/blog/2023-11-04-data-for-kindergarten/index.malloynb#C4" target="_blank" class="open_notebook"><img src="/img/open_notebook.svg" alt="document"/></a><pre class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">run</span><span style="color: #000000">: </span><span style="color: #001080">duckdb</span><span style="color: #000000">.</span><span style="color: #795E26">table</span><span style="color: #000000">(</span><span style="color: #A31515">&#39;coins.csv&#39;</span><span style="color: #000000">) -&gt; {</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">aggregate</span><span style="color: #000000">: </span><span style="color: #001080">coin_count</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #795E26">count</span><span style="color: #000000">()</span></span>
<span class="line"><span style="color: #000000">}</span></span></pre><div class="result-outer small">
    <div class="result-controls-bar">
      <span class="result-label">QUERY RESULTS</span>
      <div class="result-controls">
        <button class="result-control" selected data-result-kind="html">HTML</button>
        <button class="result-control"  data-result-kind="json">JSON</button>
        <button class="result-control"  data-result-kind="sql">SQL</button>
      </div>
    </div>
    <div class="result-middle" data-result-kind="html" selected>
      <div class="result-inner" id="ac230893-f068-4499-a738-5941360be0ea">
        <script>(()=>{var e=document.getElementById("ac230893-f068-4499-a738-5941360be0ea"),n=document.createElement("malloy-render");n.modelDef={name:"",exports:[],contents:{},queryList:[{type:"query",structRef:{type:"table",name:"duckdb:coins.csv",dialect:"duckdb",tablePath:"coins.csv",connection:"duckdb",fields:[{type:"number",numberType:"integer",name:"face_value",fieldUsage:[{path:["face_value"]}]},{type:"number",numberType:"integer",name:"minted_year",fieldUsage:[{path:["minted_year"]}]}]},pipeline:[{type:"reduce",queryFields:[{type:"number",numberType:"integer",name:"coin_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"}],filterList:[],defaultOrderBy:!0,orderBy:[{field:"coin_count",dir:"desc"}]}]}],dependencies:{},references:[],imports:[]},n.queryResult={lastStageName:"__stage0",malloy:"",sql:'SELECT \n   COUNT(1) as "coin_count"\nFROM coins.csv as base\n',dependenciesToMaterialize:{},structs:[{type:"query_result",name:"__stage0",fields:[{name:"coin_count",numberType:"integer",type:"number",resultMetadata:{sourceField:"coin_count",sourceExpression:"count()",sourceClasses:["coin_count"],referenceId:"c16fb1ee-b3d8-47c3-a936-13eb86188094",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:1,character:13},end:{line:1,character:34}}}}],dialect:"duckdb",connection:"duckdb",resultMetadata:{sourceField:"ignoreme",filterList:[],sourceClasses:["ignoreme"],fieldKind:"struct",orderBy:[{field:"coin_count",dir:"desc"}],drillable:!0}}],sourceExplore:"duckdb:coins.csv",connectionName:"duckdb",result:[{coin_count:16}],totalRows:1},e.appendChild(n)})();</script>
      </div>
    </div>
    <div class="result-middle" data-result-kind="json" >
      <div class="result-inner">
        <pre><pre class="language-json" style="background-color: #FBFBFB"><span class="line"><span style="color: #000000">[</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">16</span></span>
<span class="line"><span style="color: #000000">  }</span></span>
<span class="line"><span style="color: #000000">]</span></span></pre></pre>
      </div>
    </div>
    <div class="result-middle" data-result-kind="sql" >
      <div class="result-inner">
        <pre><pre class="language-sql" style="background-color: #FBFBFB"><span class="line"><span style="color: #0000FF">SELECT</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">   </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #098658">1</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_count&quot;</span></span>
<span class="line"><span style="color: #0000FF">FROM</span><span style="color: #000000"> coins.csv </span><span style="color: #0000FF">as</span><span style="color: #000000"> base</span></span>
<span class="line"></span></pre></pre>
      </div>
    </div>
  </div></div>
      <h2>
        <a id="ok-class-how-many-of-each-coin-do-we-have-" class="header-link anchor" href="#ok-class-how-many-of-each-coin-do-we-have-">
          Ok Class, how many of each coin do we have?
        </a>
      </h2>
    <p>Lets notice things about these coins and put them into piles. The most obvious feature is the value of the coin.  Let's make piles by the <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">face_value</span></span></code> of the coins.   <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">group_by</span><span style="color: #000000">:</span></span></code> is used to determine which pile a coin goes into.  How many coins in each pile?  We can use the same <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">aggregate</span><span style="color: #000000">:</span></span></code> calculation above.</p>
<div class="code-wrapper"><a href="https://github.dev/malloydata/malloydata.github.io/blob/main/src/blog/2023-11-04-data-for-kindergarten/index.malloynb#C6" target="_blank" class="open_notebook"><img src="/img/open_notebook.svg" alt="document"/></a><pre class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">run</span><span style="color: #000000">: </span><span style="color: #001080">duckdb</span><span style="color: #000000">.</span><span style="color: #795E26">table</span><span style="color: #000000">(</span><span style="color: #A31515">&#39;coins.csv&#39;</span><span style="color: #000000">) -&gt; {</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">group_by</span><span style="color: #000000">: </span><span style="color: #001080">face_value</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">aggregate</span><span style="color: #000000">: </span><span style="color: #001080">coin_count</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #795E26">count</span><span style="color: #000000">()</span></span>
<span class="line"><span style="color: #000000">}</span></span></pre><div class="result-outer small">
    <div class="result-controls-bar">
      <span class="result-label">QUERY RESULTS</span>
      <div class="result-controls">
        <button class="result-control" selected data-result-kind="html">HTML</button>
        <button class="result-control"  data-result-kind="json">JSON</button>
        <button class="result-control"  data-result-kind="sql">SQL</button>
      </div>
    </div>
    <div class="result-middle" data-result-kind="html" selected>
      <div class="result-inner" id="3eb0e953-1099-47fb-85b8-4442fd908bd4">
        <script>(()=>{var e=document.getElementById("3eb0e953-1099-47fb-85b8-4442fd908bd4"),a=document.createElement("malloy-render");a.modelDef={name:"",exports:[],contents:{},queryList:[{type:"query",structRef:{type:"table",name:"duckdb:coins.csv",dialect:"duckdb",tablePath:"coins.csv",connection:"duckdb",fields:[{type:"number",numberType:"integer",name:"face_value",fieldUsage:[{path:["face_value"]}]},{type:"number",numberType:"integer",name:"minted_year",fieldUsage:[{path:["minted_year"]}]}]},pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["face_value"]},{type:"number",numberType:"integer",name:"coin_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"}],filterList:[],fieldUsage:[{path:["face_value"]}],defaultOrderBy:!0,orderBy:[{field:"coin_count",dir:"desc"}]}]}],dependencies:{},references:[{type:"fieldReference",definition:{type:"number",numberType:"integer",name:"face_value",fieldUsage:[{path:["face_value"]}]},text:"face_value"}],imports:[]},a.queryResult={lastStageName:"__stage0",malloy:"",sql:'SELECT \n   base."face_value" as "face_value",\n   COUNT(1) as "coin_count"\nFROM coins.csv as base\nGROUP BY 1\nORDER BY 2 desc NULLS LAST\n',dependenciesToMaterialize:{},structs:[{type:"query_result",name:"__stage0",fields:[{name:"face_value",numberType:"integer",type:"number",resultMetadata:{sourceField:"face_value",sourceClasses:["face_value"],referenceId:"1566bae1-f9b1-4121-8ebf-cd7cf06cc6fb",fieldKind:"dimension"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:0,character:5},end:{line:0,character:30}}}},{name:"coin_count",numberType:"integer",type:"number",resultMetadata:{sourceField:"coin_count",sourceExpression:"count()",sourceClasses:["coin_count"],referenceId:"7043773e-82a2-476b-bd40-fd7aebf273d1",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:2,character:13},end:{line:2,character:34}}}}],dialect:"duckdb",primaryKey:"face_value",connection:"duckdb",resultMetadata:{sourceField:"ignoreme",filterList:[],sourceClasses:["ignoreme"],fieldKind:"struct",orderBy:[{field:"coin_count",dir:"desc"}],drillable:!0}}],sourceExplore:"duckdb:coins.csv",connectionName:"duckdb",result:[{face_value:25,coin_count:6},{face_value:1,coin_count:4},{face_value:5,coin_count:3},{face_value:10,coin_count:3}],totalRows:4},e.appendChild(a)})();</script>
      </div>
    </div>
    <div class="result-middle" data-result-kind="json" >
      <div class="result-inner">
        <pre><pre class="language-json" style="background-color: #FBFBFB"><span class="line"><span style="color: #000000">[</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;face_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">25</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">6</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;face_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;face_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">5</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;face_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">10</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3</span></span>
<span class="line"><span style="color: #000000">  }</span></span>
<span class="line"><span style="color: #000000">]</span></span></pre></pre>
      </div>
    </div>
    <div class="result-middle" data-result-kind="sql" >
      <div class="result-inner">
        <pre><pre class="language-sql" style="background-color: #FBFBFB"><span class="line"><span style="color: #0000FF">SELECT</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">   base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">   </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #098658">1</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_count&quot;</span></span>
<span class="line"><span style="color: #0000FF">FROM</span><span style="color: #000000"> coins.csv </span><span style="color: #0000FF">as</span><span style="color: #000000"> base</span></span>
<span class="line"><span style="color: #0000FF">GROUP BY</span><span style="color: #000000"> </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #0000FF">ORDER BY</span><span style="color: #000000"> </span><span style="color: #098658">2</span><span style="color: #000000"> </span><span style="color: #0000FF">desc</span><span style="color: #000000"> NULLS </span><span style="color: #0000FF">LAST</span></span>
<span class="line"></span></pre></pre>
      </div>
    </div>
  </div></div>
      <h2>
        <a id="gifted-student" class="header-link anchor" href="#gifted-student">
          Gifted Student
        </a>
      </h2>
    <p>A gifted student asks "How much is each pile worth".  We can compute as many calculations as we'd like on each of the piles so we add another calculation <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">total_value</span></span></code>.  Notice that we write the calculation a little differently than in other languages.  Malloy writes <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #795E26">sum</span><span style="color: #000000">()</span></span></code> this way to insure that calculations are always correct when things get complex.</p>
<div class="code-wrapper"><a href="https://github.dev/malloydata/malloydata.github.io/blob/main/src/blog/2023-11-04-data-for-kindergarten/index.malloynb#C8" target="_blank" class="open_notebook"><img src="/img/open_notebook.svg" alt="document"/></a><pre class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">run</span><span style="color: #000000">: </span><span style="color: #001080">duckdb</span><span style="color: #000000">.</span><span style="color: #795E26">table</span><span style="color: #000000">(</span><span style="color: #A31515">&#39;coins.csv&#39;</span><span style="color: #000000">) -&gt; {</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">group_by</span><span style="color: #000000">: </span><span style="color: #001080">face_value</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">aggregate</span><span style="color: #000000">: </span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #001080">coin_count</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #795E26">count</span><span style="color: #000000">()</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #001080">total_value</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">face_value</span><span style="color: #000000">.</span><span style="color: #795E26">sum</span><span style="color: #000000">()</span></span>
<span class="line"><span style="color: #000000">}</span></span></pre><div class="result-outer small">
    <div class="result-controls-bar">
      <span class="result-label">QUERY RESULTS</span>
      <div class="result-controls">
        <button class="result-control" selected data-result-kind="html">HTML</button>
        <button class="result-control"  data-result-kind="json">JSON</button>
        <button class="result-control"  data-result-kind="sql">SQL</button>
      </div>
    </div>
    <div class="result-middle" data-result-kind="html" selected>
      <div class="result-inner" id="c34586e4-9342-4e2c-98e3-4ed440bcef94">
        <script>(()=>{var e=document.getElementById("c34586e4-9342-4e2c-98e3-4ed440bcef94"),a=document.createElement("malloy-render");a.modelDef={name:"",exports:[],contents:{},queryList:[{type:"query",structRef:{type:"table",name:"duckdb:coins.csv",dialect:"duckdb",tablePath:"coins.csv",connection:"duckdb",fields:[{type:"number",numberType:"integer",name:"face_value",fieldUsage:[{path:["face_value"]}]},{type:"number",numberType:"integer",name:"minted_year",fieldUsage:[{path:["minted_year"]}]}]},pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["face_value"]},{type:"number",numberType:"integer",name:"coin_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},{type:"number",numberType:"integer",name:"total_value",e:{node:"aggregate",function:"sum",e:{node:"field",path:["face_value"]}},fieldUsage:[{path:["face_value"]}],expressionType:"aggregate",code:"face_value.sum()"}],filterList:[],fieldUsage:[{path:["face_value"]},{path:["face_value"]}],defaultOrderBy:!0,orderBy:[{field:"coin_count",dir:"desc"}]}]}],dependencies:{},references:[{type:"fieldReference",definition:{type:"number",numberType:"integer",name:"face_value",fieldUsage:[{path:["face_value"]}]},text:"face_value"},{type:"fieldReference",definition:{type:"number",numberType:"integer",name:"face_value",fieldUsage:[{path:["face_value"]}]},text:"face_value"}],imports:[]},a.queryResult={lastStageName:"__stage0",malloy:"",sql:'SELECT \n   base."face_value" as "face_value",\n   COUNT(1) as "coin_count",\n   COALESCE(SUM(base."face_value"),0) as "total_value"\nFROM coins.csv as base\nGROUP BY 1\nORDER BY 2 desc NULLS LAST\n',dependenciesToMaterialize:{},structs:[{type:"query_result",name:"__stage0",fields:[{name:"face_value",numberType:"integer",type:"number",resultMetadata:{sourceField:"face_value",sourceClasses:["face_value"],referenceId:"1bde762d-4b89-4846-bc1f-0275bf416624",fieldKind:"dimension"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:0,character:5},end:{line:0,character:30}}}},{name:"coin_count",numberType:"integer",type:"number",resultMetadata:{sourceField:"coin_count",sourceExpression:"count()",sourceClasses:["coin_count"],referenceId:"89e96bdc-7c6e-46f7-95db-a8da0bcfe553",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:3,character:4},end:{line:3,character:25}}}},{name:"total_value",numberType:"integer",type:"number",resultMetadata:{sourceField:"total_value",sourceExpression:"face_value.sum()",sourceClasses:["total_value"],referenceId:"ef6fc352-6852-4516-9a98-3c2a1365e843",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:4,character:4},end:{line:4,character:35}}}}],dialect:"duckdb",primaryKey:"face_value",connection:"duckdb",resultMetadata:{sourceField:"ignoreme",filterList:[],sourceClasses:["ignoreme"],fieldKind:"struct",orderBy:[{field:"coin_count",dir:"desc"}],drillable:!0}}],sourceExplore:"duckdb:coins.csv",connectionName:"duckdb",result:[{face_value:25,coin_count:6,total_value:150},{face_value:1,coin_count:4,total_value:4},{face_value:5,coin_count:3,total_value:15},{face_value:10,coin_count:3,total_value:30}],totalRows:4},e.appendChild(a)})();</script>
      </div>
    </div>
    <div class="result-middle" data-result-kind="json" >
      <div class="result-inner">
        <pre><pre class="language-json" style="background-color: #FBFBFB"><span class="line"><span style="color: #000000">[</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;face_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">25</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">6</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">150</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;face_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;face_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">5</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">15</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;face_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">10</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">30</span></span>
<span class="line"><span style="color: #000000">  }</span></span>
<span class="line"><span style="color: #000000">]</span></span></pre></pre>
      </div>
    </div>
    <div class="result-middle" data-result-kind="sql" >
      <div class="result-inner">
        <pre><pre class="language-sql" style="background-color: #FBFBFB"><span class="line"><span style="color: #0000FF">SELECT</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">   base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">   </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #098658">1</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_count&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">   </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">),</span><span style="color: #098658">0</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;total_value&quot;</span></span>
<span class="line"><span style="color: #0000FF">FROM</span><span style="color: #000000"> coins.csv </span><span style="color: #0000FF">as</span><span style="color: #000000"> base</span></span>
<span class="line"><span style="color: #0000FF">GROUP BY</span><span style="color: #000000"> </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #0000FF">ORDER BY</span><span style="color: #000000"> </span><span style="color: #098658">2</span><span style="color: #000000"> </span><span style="color: #0000FF">desc</span><span style="color: #000000"> NULLS </span><span style="color: #0000FF">LAST</span></span>
<span class="line"></span></pre></pre>
      </div>
    </div>
  </div></div>
      <h2>
        <a id="we-re-repeating-ourselves-" class="header-link anchor" href="#we-re-repeating-ourselves-">
          We're repeating ourselves.
        </a>
      </h2>
    <p>Notice that we use the calculation for <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">coin_count</span></span></code> in all the queries.  It is probably a useful concept in this dataset.  Also <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">total_value</span></span></code>.  We encode these concepts into a <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">source</span><span style="color: #000000">:</span></span></code> so we can use them simply in subsequent queries. If we were ever have to change a calculation, it would be all in one place.</p>
<p>We're going to add some <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">dimension</span><span style="color: #000000">:</span></span></code> calculations too.  It would be nice to know the <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">coin_type</span></span></code> and the <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">color</span></span></code> of each of the coins.  <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">dimension</span></span></code>s are used in <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">group_by</span><span style="color: #000000">:</span></span></code> in queries.</p>
<div class="code-wrapper"><a href="https://github.dev/malloydata/malloydata.github.io/blob/main/src/blog/2023-11-04-data-for-kindergarten/index.malloynb#C10" target="_blank" class="open_notebook"><img src="/img/open_notebook.svg" alt="document"/></a><pre class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">source</span><span style="color: #000000">: </span><span style="color: #001080">coins</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">duckdb</span><span style="color: #000000">.</span><span style="color: #795E26">table</span><span style="color: #000000">(</span><span style="color: #A31515">&#39;coins.csv&#39;</span><span style="color: #000000">) </span><span style="color: #AF00DB">extend</span><span style="color: #000000"> {</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">measure</span><span style="color: #000000">:</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #001080">coin_count</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #795E26">count</span><span style="color: #000000">()</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #001080">total_value</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">face_value</span><span style="color: #000000">.</span><span style="color: #795E26">sum</span><span style="color: #000000">()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">dimension</span><span style="color: #000000">: </span><span style="color: #001080">coin_type</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">face_value</span><span style="color: #000000"> ? </span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">pick</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;penny&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">when</span><span style="color: #000000"> </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">pick</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;nickle&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">when</span><span style="color: #000000"> </span><span style="color: #098658">5</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">pick</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;dime&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">when</span><span style="color: #000000"> </span><span style="color: #098658">10</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">pick</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;quarter&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">when</span><span style="color: #000000"> </span><span style="color: #098658">25</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">else</span><span style="color: #000000"> </span><span style="color: #0000FF">null</span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">dimension</span><span style="color: #000000">: </span><span style="color: #001080">color</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">face_value</span><span style="color: #000000"> ? </span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">pick</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;copper&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">when</span><span style="color: #000000"> </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">else</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;silver&#39;</span></span>
<span class="line"><span style="color: #000000">}</span></span></pre></div>
      <h2>
        <a id="source-coins" class="header-link anchor" href="#source-coins">
          source: coins
        </a>
      </h2>
    <p>If we were to click the 'schema' button we'd see all the definition for 'coins'.  We can use named object in queries witout having to repeat the definitions.</p>
<img src="short_hand1.png">
      <h2>
        <a id="how-many-coins-of-each-color-" class="header-link anchor" href="#how-many-coins-of-each-color-">
          How many coins of each color?
        </a>
      </h2>
    <p>Asking questions is much easier now.  We have <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">coins</span></span></code> as a shorthand for <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">duckdb</span><span style="color: #000000">.</span><span style="color: #795E26">table</span><span style="color: #000000">(</span><span style="color: #A31515">&#39;coins.csv&#39;</span><span style="color: #000000">)</span></span></code> and <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">color</span></span></code> and <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">coin_count</span></span></code> as shorthad for those calculations.</p>
<div class="code-wrapper"><a href="https://github.dev/malloydata/malloydata.github.io/blob/main/src/blog/2023-11-04-data-for-kindergarten/index.malloynb#C12" target="_blank" class="open_notebook"><img src="/img/open_notebook.svg" alt="document"/></a><pre class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">run</span><span style="color: #000000">: </span><span style="color: #001080">coins</span><span style="color: #000000"> -&gt; {</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">group_by</span><span style="color: #000000">: </span><span style="color: #001080">color</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">aggregate</span><span style="color: #000000">: </span><span style="color: #001080">coin_count</span></span>
<span class="line"><span style="color: #000000">}</span></span></pre><div class="result-outer small">
    <div class="result-controls-bar">
      <span class="result-label">QUERY RESULTS</span>
      <div class="result-controls">
        <button class="result-control" selected data-result-kind="html">HTML</button>
        <button class="result-control"  data-result-kind="json">JSON</button>
        <button class="result-control"  data-result-kind="sql">SQL</button>
      </div>
    </div>
    <div class="result-middle" data-result-kind="html" selected>
      <div class="result-inner" id="87989931-bbef-49ce-b909-7e808ab42204">
        <script>(()=>{var e=document.getElementById("87989931-bbef-49ce-b909-7e808ab42204"),a=document.createElement("malloy-render");a.modelDef={name:"",exports:["coins"],contents:{coins:{type:"table",name:"duckdb:coins.csv",dialect:"duckdb",tablePath:"coins.csv",connection:"duckdb",fields:[{type:"number",numberType:"integer",name:"face_value",fieldUsage:[{path:["face_value"]}]},{type:"number",numberType:"integer",name:"minted_year",fieldUsage:[{path:["minted_year"]}]},{type:"number",numberType:"integer",name:"coin_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},{type:"number",numberType:"integer",name:"total_value",e:{node:"aggregate",function:"sum",e:{node:"field",path:["face_value"]}},fieldUsage:[{path:["face_value"]}],expressionType:"aggregate",code:"face_value.sum()"},{type:"string",name:"coin_type",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"]},right:{node:"numberLiteral",literal:"1"}}},{node:"=",kids:{left:{node:"field",path:["face_value"]},right:{node:"numberLiteral",literal:"5"}}},{node:"=",kids:{left:{node:"field",path:["face_value"]},right:{node:"numberLiteral",literal:"10"}}},{node:"=",kids:{left:{node:"field",path:["face_value"]},right:{node:"numberLiteral",literal:"25"}}}],caseThen:[{node:"stringLiteral",literal:"penny"},{node:"stringLiteral",literal:"nickle"},{node:"stringLiteral",literal:"dime"},{node:"stringLiteral",literal:"quarter"}],caseElse:{node:"null"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null"},{type:"string",name:"color",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'}],caseThen:[{node:"stringLiteral",literal:"copper",sql:"'copper'"}],caseElse:{node:"stringLiteral",literal:"silver",sql:"'silver'"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'copper' when 1\n    else 'silver'"}],parameters:{},as:"coins"}},queryList:[{type:"query",structRef:"coins",sourceArguments:{},pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["color"]},{type:"fieldref",path:["coin_count"]}],filterList:[],fieldUsage:[{path:["color"]},{path:["coin_count"]}],defaultOrderBy:!0,orderBy:[{field:"coin_count",dir:"desc"}]}]}],dependencies:{},references:[{type:"exploreReference",text:"coins",definition:{type:"table",name:"duckdb:coins.csv",dialect:"duckdb",tablePath:"coins.csv",connection:"duckdb",fields:[{type:"number",numberType:"integer",name:"face_value",fieldUsage:[{path:["face_value"]}]},{type:"number",numberType:"integer",name:"minted_year",fieldUsage:[{path:["minted_year"]}]},{type:"number",numberType:"integer",name:"coin_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},{type:"number",numberType:"integer",name:"total_value",e:{node:"aggregate",function:"sum",e:{node:"field",path:["face_value"]}},fieldUsage:[{path:["face_value"]}],expressionType:"aggregate",code:"face_value.sum()"},{type:"string",name:"coin_type",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"]},right:{node:"numberLiteral",literal:"1"}}},{node:"=",kids:{left:{node:"field",path:["face_value"]},right:{node:"numberLiteral",literal:"5"}}},{node:"=",kids:{left:{node:"field",path:["face_value"]},right:{node:"numberLiteral",literal:"10"}}},{node:"=",kids:{left:{node:"field",path:["face_value"]},right:{node:"numberLiteral",literal:"25"}}}],caseThen:[{node:"stringLiteral",literal:"penny"},{node:"stringLiteral",literal:"nickle"},{node:"stringLiteral",literal:"dime"},{node:"stringLiteral",literal:"quarter"}],caseElse:{node:"null"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null"},{type:"string",name:"color",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"]},right:{node:"numberLiteral",literal:"1"}}}],caseThen:[{node:"stringLiteral",literal:"copper"}],caseElse:{node:"stringLiteral",literal:"silver"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'copper' when 1\n    else 'silver'"}],parameters:{},as:"coins"}},{type:"fieldReference",definition:{type:"string",name:"color",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"]},right:{node:"numberLiteral",literal:"1"}}}],caseThen:[{node:"stringLiteral",literal:"copper"}],caseElse:{node:"stringLiteral",literal:"silver"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'copper' when 1\n    else 'silver'"},text:"color"},{type:"fieldReference",definition:{type:"number",numberType:"integer",name:"coin_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},text:"coin_count"}],imports:[]},a.queryResult={lastStageName:"__stage0",malloy:"",sql:'SELECT \n   CASE WHEN (base."face_value"=1) THEN \'copper\' ELSE \'silver\' END as "color",\n   COUNT(1) as "coin_count"\nFROM coins.csv as base\nGROUP BY 1\nORDER BY 2 desc NULLS LAST\n',dependenciesToMaterialize:{},structs:[{type:"query_result",name:"__stage0",fields:[{name:"color",type:"string",resultMetadata:{sourceField:"color",sourceExpression:"face_value ? \n    pick 'copper' when 1\n    else 'silver'",sourceClasses:["color"],referenceId:"e77f3b34-5288-4574-bb51-620d29e332a0",fieldKind:"dimension"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:12,character:13},end:{line:14,character:17}}}},{name:"coin_count",numberType:"integer",type:"number",resultMetadata:{sourceField:"coin_count",sourceExpression:"count()",sourceClasses:["coin_count"],referenceId:"0e4990da-cee7-4e8a-a8c1-67f467b9d425",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:2,character:4},end:{line:2,character:25}}}}],dialect:"duckdb",primaryKey:"color",connection:"duckdb",resultMetadata:{sourceField:"ignoreme",filterList:[],sourceClasses:["ignoreme"],fieldKind:"struct",orderBy:[{field:"coin_count",dir:"desc"}],drillable:!0}}],sourceExplore:"coins",sourceArguments:{},connectionName:"duckdb",result:[{color:"silver",coin_count:12},{color:"copper",coin_count:4}],totalRows:2},e.appendChild(a)})();</script>
      </div>
    </div>
    <div class="result-middle" data-result-kind="json" >
      <div class="result-inner">
        <pre><pre class="language-json" style="background-color: #FBFBFB"><span class="line"><span style="color: #000000">[</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;color&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;silver&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">12</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;color&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;copper&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4</span></span>
<span class="line"><span style="color: #000000">  }</span></span>
<span class="line"><span style="color: #000000">]</span></span></pre></pre>
      </div>
    </div>
    <div class="result-middle" data-result-kind="sql" >
      <div class="result-inner">
        <pre><pre class="language-sql" style="background-color: #FBFBFB"><span class="line"><span style="color: #0000FF">SELECT</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">   </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">1</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;copper&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">ELSE</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;silver&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;color&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">   </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #098658">1</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_count&quot;</span></span>
<span class="line"><span style="color: #0000FF">FROM</span><span style="color: #000000"> coins.csv </span><span style="color: #0000FF">as</span><span style="color: #000000"> base</span></span>
<span class="line"><span style="color: #0000FF">GROUP BY</span><span style="color: #000000"> </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #0000FF">ORDER BY</span><span style="color: #000000"> </span><span style="color: #098658">2</span><span style="color: #000000"> </span><span style="color: #0000FF">desc</span><span style="color: #000000"> NULLS </span><span style="color: #0000FF">LAST</span></span>
<span class="line"></span></pre></pre>
      </div>
    </div>
  </div></div>
      <h2>
        <a id="how-many-of-each-type-of-coin-" class="header-link anchor" href="#how-many-of-each-type-of-coin-">
          How many of each type of coin?
        </a>
      </h2>
    <p>Another easy query, and pretty easy to read too.</p>
<div class="code-wrapper"><a href="https://github.dev/malloydata/malloydata.github.io/blob/main/src/blog/2023-11-04-data-for-kindergarten/index.malloynb#C14" target="_blank" class="open_notebook"><img src="/img/open_notebook.svg" alt="document"/></a><pre class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">run</span><span style="color: #000000">: </span><span style="color: #001080">coins</span><span style="color: #000000"> -&gt; {</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">group_by</span><span style="color: #000000">: </span><span style="color: #001080">coin_type</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">aggregate</span><span style="color: #000000">: </span><span style="color: #001080">coin_count</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">aggregate</span><span style="color: #000000">: </span><span style="color: #001080">total_value</span></span>
<span class="line"><span style="color: #000000">}</span></span></pre><div class="result-outer small">
    <div class="result-controls-bar">
      <span class="result-label">QUERY RESULTS</span>
      <div class="result-controls">
        <button class="result-control" selected data-result-kind="html">HTML</button>
        <button class="result-control"  data-result-kind="json">JSON</button>
        <button class="result-control"  data-result-kind="sql">SQL</button>
      </div>
    </div>
    <div class="result-middle" data-result-kind="html" selected>
      <div class="result-inner" id="99cc224d-64d5-4937-bf8b-9abf419198ba">
        <script>(()=>{var e=document.getElementById("99cc224d-64d5-4937-bf8b-9abf419198ba"),a=document.createElement("malloy-render");a.modelDef={name:"",exports:["coins"],contents:{coins:{type:"table",name:"duckdb:coins.csv",dialect:"duckdb",tablePath:"coins.csv",connection:"duckdb",fields:[{type:"number",numberType:"integer",name:"face_value",fieldUsage:[{path:["face_value"]}]},{type:"number",numberType:"integer",name:"minted_year",fieldUsage:[{path:["minted_year"]}]},{type:"number",numberType:"integer",name:"coin_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},{type:"number",numberType:"integer",name:"total_value",e:{node:"aggregate",function:"sum",e:{node:"field",path:["face_value"]}},fieldUsage:[{path:["face_value"]}],expressionType:"aggregate",code:"face_value.sum()"},{type:"string",name:"coin_type",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"5",sql:"5"}},sql:'(base."face_value"=5)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"10",sql:"10"}},sql:'(base."face_value"=10)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"25",sql:"25"}},sql:'(base."face_value"=25)'}],caseThen:[{node:"stringLiteral",literal:"penny",sql:"'penny'"},{node:"stringLiteral",literal:"nickle",sql:"'nickle'"},{node:"stringLiteral",literal:"dime",sql:"'dime'"},{node:"stringLiteral",literal:"quarter",sql:"'quarter'"}],caseElse:{node:"null",sql:"NULL"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null"},{type:"string",name:"color",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'}],caseThen:[{node:"stringLiteral",literal:"copper",sql:"'copper'"}],caseElse:{node:"stringLiteral",literal:"silver",sql:"'silver'"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'copper' when 1\n    else 'silver'"}],parameters:{},as:"coins"}},queryList:[{type:"query",structRef:"coins",sourceArguments:{},pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["coin_type"]},{type:"fieldref",path:["coin_count"]},{type:"fieldref",path:["total_value"]}],filterList:[],fieldUsage:[{path:["coin_type"]},{path:["coin_count"]},{path:["total_value"]}],defaultOrderBy:!0,orderBy:[{field:"coin_count",dir:"desc"}]}]}],dependencies:{},references:[{type:"exploreReference",text:"coins",definition:{type:"table",name:"duckdb:coins.csv",dialect:"duckdb",tablePath:"coins.csv",connection:"duckdb",fields:[{type:"number",numberType:"integer",name:"face_value",fieldUsage:[{path:["face_value"]}]},{type:"number",numberType:"integer",name:"minted_year",fieldUsage:[{path:["minted_year"]}]},{type:"number",numberType:"integer",name:"coin_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},{type:"number",numberType:"integer",name:"total_value",e:{node:"aggregate",function:"sum",e:{node:"field",path:["face_value"]}},fieldUsage:[{path:["face_value"]}],expressionType:"aggregate",code:"face_value.sum()"},{type:"string",name:"coin_type",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"]},right:{node:"numberLiteral",literal:"1"}}},{node:"=",kids:{left:{node:"field",path:["face_value"]},right:{node:"numberLiteral",literal:"5"}}},{node:"=",kids:{left:{node:"field",path:["face_value"]},right:{node:"numberLiteral",literal:"10"}}},{node:"=",kids:{left:{node:"field",path:["face_value"]},right:{node:"numberLiteral",literal:"25"}}}],caseThen:[{node:"stringLiteral",literal:"penny"},{node:"stringLiteral",literal:"nickle"},{node:"stringLiteral",literal:"dime"},{node:"stringLiteral",literal:"quarter"}],caseElse:{node:"null"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null"},{type:"string",name:"color",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'}],caseThen:[{node:"stringLiteral",literal:"copper",sql:"'copper'"}],caseElse:{node:"stringLiteral",literal:"silver",sql:"'silver'"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'copper' when 1\n    else 'silver'"}],parameters:{},as:"coins"}},{type:"fieldReference",definition:{type:"string",name:"coin_type",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"]},right:{node:"numberLiteral",literal:"1"}}},{node:"=",kids:{left:{node:"field",path:["face_value"]},right:{node:"numberLiteral",literal:"5"}}},{node:"=",kids:{left:{node:"field",path:["face_value"]},right:{node:"numberLiteral",literal:"10"}}},{node:"=",kids:{left:{node:"field",path:["face_value"]},right:{node:"numberLiteral",literal:"25"}}}],caseThen:[{node:"stringLiteral",literal:"penny"},{node:"stringLiteral",literal:"nickle"},{node:"stringLiteral",literal:"dime"},{node:"stringLiteral",literal:"quarter"}],caseElse:{node:"null"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null"},text:"coin_type"},{type:"fieldReference",definition:{type:"number",numberType:"integer",name:"coin_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},text:"coin_count"},{type:"fieldReference",definition:{type:"number",numberType:"integer",name:"total_value",e:{node:"aggregate",function:"sum",e:{node:"field",path:["face_value"]}},fieldUsage:[{path:["face_value"]}],expressionType:"aggregate",code:"face_value.sum()"},text:"total_value"}],imports:[]},a.queryResult={lastStageName:"__stage0",malloy:"",sql:'SELECT \n   CASE WHEN (base."face_value"=1) THEN \'penny\' WHEN (base."face_value"=5) THEN \'nickle\' WHEN (base."face_value"=10) THEN \'dime\' WHEN (base."face_value"=25) THEN \'quarter\' ELSE NULL END as "coin_type",\n   COUNT(1) as "coin_count",\n   COALESCE(SUM(base."face_value"),0) as "total_value"\nFROM coins.csv as base\nGROUP BY 1\nORDER BY 2 desc NULLS LAST\n',dependenciesToMaterialize:{},structs:[{type:"query_result",name:"__stage0",fields:[{name:"coin_type",type:"string",resultMetadata:{sourceField:"coin_type",sourceExpression:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null",sourceClasses:["coin_type"],referenceId:"e248ea2c-a931-42f6-a11f-543c17e4e079",fieldKind:"dimension"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:5,character:13},end:{line:10,character:13}}}},{name:"coin_count",numberType:"integer",type:"number",resultMetadata:{sourceField:"coin_count",sourceExpression:"count()",sourceClasses:["coin_count"],referenceId:"560db6ac-8cc0-4187-bab2-4c94567dffc5",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:2,character:4},end:{line:2,character:25}}}},{name:"total_value",numberType:"integer",type:"number",resultMetadata:{sourceField:"total_value",sourceExpression:"face_value.sum()",sourceClasses:["total_value"],referenceId:"ffa65d56-77ae-4c99-8edc-01a60013ce18",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:3,character:4},end:{line:3,character:35}}}}],dialect:"duckdb",primaryKey:"coin_type",connection:"duckdb",resultMetadata:{sourceField:"ignoreme",filterList:[],sourceClasses:["ignoreme"],fieldKind:"struct",orderBy:[{field:"coin_count",dir:"desc"}],drillable:!0}}],sourceExplore:"coins",sourceArguments:{},connectionName:"duckdb",result:[{coin_type:"quarter",coin_count:6,total_value:150},{coin_type:"penny",coin_count:4,total_value:4},{coin_type:"nickle",coin_count:3,total_value:15},{coin_type:"dime",coin_count:3,total_value:30}],totalRows:4},e.appendChild(a)})();</script>
      </div>
    </div>
    <div class="result-middle" data-result-kind="json" >
      <div class="result-inner">
        <pre><pre class="language-json" style="background-color: #FBFBFB"><span class="line"><span style="color: #000000">[</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;quarter&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">6</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">150</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;penny&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;nickle&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">15</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;dime&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">30</span></span>
<span class="line"><span style="color: #000000">  }</span></span>
<span class="line"><span style="color: #000000">]</span></span></pre></pre>
      </div>
    </div>
    <div class="result-middle" data-result-kind="sql" >
      <div class="result-inner">
        <pre><pre class="language-sql" style="background-color: #FBFBFB"><span class="line"><span style="color: #0000FF">SELECT</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">   </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">1</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;penny&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">5</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;nickle&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">10</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;dime&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">25</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;quarter&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">ELSE</span><span style="color: #000000"> </span><span style="color: #0000FF">NULL</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_type&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">   </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #098658">1</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_count&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">   </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">),</span><span style="color: #098658">0</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;total_value&quot;</span></span>
<span class="line"><span style="color: #0000FF">FROM</span><span style="color: #000000"> coins.csv </span><span style="color: #0000FF">as</span><span style="color: #000000"> base</span></span>
<span class="line"><span style="color: #0000FF">GROUP BY</span><span style="color: #000000"> </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #0000FF">ORDER BY</span><span style="color: #000000"> </span><span style="color: #098658">2</span><span style="color: #000000"> </span><span style="color: #0000FF">desc</span><span style="color: #000000"> NULLS </span><span style="color: #0000FF">LAST</span></span>
<span class="line"></span></pre></pre>
      </div>
    </div>
  </div></div>
      <h2>
        <a id="see-the-definitions" class="header-link anchor" href="#see-the-definitions">
          See the definitions
        </a>
      </h2>
    <p>If we hold the control (or command) key and hovor over a variable, VSCode will show us the definition.  This can be really useful when you come upon a query you didn't write.</p>
<img src="info.png">
      <h2>
        <a id="shorter-hand-" class="header-link anchor" href="#shorter-hand-">
          Shorter-hand.
        </a>
      </h2>
    <p>Malloy is designed to make building queries easy.</p>
<p>Queries can be constructed from reusable parts.  Above we saw how e can put reusable definitions into a <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">source</span><span style="color: #000000">:</span></span></code>.  We can also use a shorthand to combine these parts (dimensions, measures, and queries) together.</p>
<p>A partial query is either a name or something between curlies (<code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #000000">{}</span></span></code>).  Partial queries can be combined with a <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #000000">+</span></span></code> operator.</p>
<p>The query below is the same as the query above.</p>
<div class="code-wrapper"><a href="https://github.dev/malloydata/malloydata.github.io/blob/main/src/blog/2023-11-04-data-for-kindergarten/index.malloynb#C16" target="_blank" class="open_notebook"><img src="/img/open_notebook.svg" alt="document"/></a><pre class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">run</span><span style="color: #000000">: </span><span style="color: #001080">coins</span><span style="color: #000000"> -&gt; </span></span>
<span class="line"><span style="color: #000000">  {</span><span style="color: #AF00DB">group_by</span><span style="color: #000000">: </span><span style="color: #001080">coin_type</span><span style="color: #000000">}</span></span>
<span class="line"><span style="color: #000000">  + {</span><span style="color: #AF00DB">aggregate</span><span style="color: #000000">: </span><span style="color: #001080">coin_count</span><span style="color: #000000">} </span></span>
<span class="line"><span style="color: #000000">  + {</span><span style="color: #AF00DB">aggregate</span><span style="color: #000000">: </span><span style="color: #001080">total_value</span><span style="color: #000000">}</span></span></pre><div class="result-outer small">
    <div class="result-controls-bar">
      <span class="result-label">QUERY RESULTS</span>
      <div class="result-controls">
        <button class="result-control" selected data-result-kind="html">HTML</button>
        <button class="result-control"  data-result-kind="json">JSON</button>
        <button class="result-control"  data-result-kind="sql">SQL</button>
      </div>
    </div>
    <div class="result-middle" data-result-kind="html" selected>
      <div class="result-inner" id="4d3dfb73-d587-423e-80a4-419939815866">
        <script>(()=>{var e=document.getElementById("4d3dfb73-d587-423e-80a4-419939815866"),a=document.createElement("malloy-render");a.modelDef={name:"",exports:["coins"],contents:{coins:{type:"table",name:"duckdb:coins.csv",dialect:"duckdb",tablePath:"coins.csv",connection:"duckdb",fields:[{type:"number",numberType:"integer",name:"face_value",fieldUsage:[{path:["face_value"]}]},{type:"number",numberType:"integer",name:"minted_year",fieldUsage:[{path:["minted_year"]}]},{type:"number",numberType:"integer",name:"coin_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},{type:"number",numberType:"integer",name:"total_value",e:{node:"aggregate",function:"sum",e:{node:"field",path:["face_value"]}},fieldUsage:[{path:["face_value"]}],expressionType:"aggregate",code:"face_value.sum()"},{type:"string",name:"coin_type",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"5",sql:"5"}},sql:'(base."face_value"=5)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"10",sql:"10"}},sql:'(base."face_value"=10)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"25",sql:"25"}},sql:'(base."face_value"=25)'}],caseThen:[{node:"stringLiteral",literal:"penny",sql:"'penny'"},{node:"stringLiteral",literal:"nickle",sql:"'nickle'"},{node:"stringLiteral",literal:"dime",sql:"'dime'"},{node:"stringLiteral",literal:"quarter",sql:"'quarter'"}],caseElse:{node:"null",sql:"NULL"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null"},{type:"string",name:"color",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'}],caseThen:[{node:"stringLiteral",literal:"copper",sql:"'copper'"}],caseElse:{node:"stringLiteral",literal:"silver",sql:"'silver'"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'copper' when 1\n    else 'silver'"}],parameters:{},as:"coins"}},queryList:[{type:"query",structRef:"coins",sourceArguments:{},pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["coin_type"]},{type:"fieldref",path:["coin_count"]},{type:"fieldref",path:["total_value"]}],filterList:[],fieldUsage:[{path:["coin_type"]},{path:["coin_count"]},{path:["total_value"]}],defaultOrderBy:!0,orderBy:[{field:"coin_count",dir:"desc"}]}]}],dependencies:{},references:[{type:"exploreReference",text:"coins",definition:{type:"table",name:"duckdb:coins.csv",dialect:"duckdb",tablePath:"coins.csv",connection:"duckdb",fields:[{type:"number",numberType:"integer",name:"face_value",fieldUsage:[{path:["face_value"]}]},{type:"number",numberType:"integer",name:"minted_year",fieldUsage:[{path:["minted_year"]}]},{type:"number",numberType:"integer",name:"coin_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},{type:"number",numberType:"integer",name:"total_value",e:{node:"aggregate",function:"sum",e:{node:"field",path:["face_value"]}},fieldUsage:[{path:["face_value"]}],expressionType:"aggregate",code:"face_value.sum()"},{type:"string",name:"coin_type",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"5",sql:"5"}},sql:'(base."face_value"=5)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"10",sql:"10"}},sql:'(base."face_value"=10)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"25",sql:"25"}},sql:'(base."face_value"=25)'}],caseThen:[{node:"stringLiteral",literal:"penny",sql:"'penny'"},{node:"stringLiteral",literal:"nickle",sql:"'nickle'"},{node:"stringLiteral",literal:"dime",sql:"'dime'"},{node:"stringLiteral",literal:"quarter",sql:"'quarter'"}],caseElse:{node:"null",sql:"NULL"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null"},{type:"string",name:"color",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'}],caseThen:[{node:"stringLiteral",literal:"copper",sql:"'copper'"}],caseElse:{node:"stringLiteral",literal:"silver",sql:"'silver'"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'copper' when 1\n    else 'silver'"}],parameters:{},as:"coins"}},{type:"fieldReference",definition:{type:"string",name:"coin_type",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"5",sql:"5"}},sql:'(base."face_value"=5)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"10",sql:"10"}},sql:'(base."face_value"=10)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"25",sql:"25"}},sql:'(base."face_value"=25)'}],caseThen:[{node:"stringLiteral",literal:"penny",sql:"'penny'"},{node:"stringLiteral",literal:"nickle",sql:"'nickle'"},{node:"stringLiteral",literal:"dime",sql:"'dime'"},{node:"stringLiteral",literal:"quarter",sql:"'quarter'"}],caseElse:{node:"null",sql:"NULL"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null"},text:"coin_type"},{type:"fieldReference",definition:{type:"number",numberType:"integer",name:"coin_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},text:"coin_count"},{type:"fieldReference",definition:{type:"number",numberType:"integer",name:"total_value",e:{node:"aggregate",function:"sum",e:{node:"field",path:["face_value"]}},fieldUsage:[{path:["face_value"]}],expressionType:"aggregate",code:"face_value.sum()"},text:"total_value"}],imports:[]},a.queryResult={lastStageName:"__stage0",malloy:"",sql:'SELECT \n   CASE WHEN (base."face_value"=1) THEN \'penny\' WHEN (base."face_value"=5) THEN \'nickle\' WHEN (base."face_value"=10) THEN \'dime\' WHEN (base."face_value"=25) THEN \'quarter\' ELSE NULL END as "coin_type",\n   COUNT(1) as "coin_count",\n   COALESCE(SUM(base."face_value"),0) as "total_value"\nFROM coins.csv as base\nGROUP BY 1\nORDER BY 2 desc NULLS LAST\n',dependenciesToMaterialize:{},structs:[{type:"query_result",name:"__stage0",fields:[{name:"coin_type",type:"string",resultMetadata:{sourceField:"coin_type",sourceExpression:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null",sourceClasses:["coin_type"],referenceId:"bfd5a141-59e0-4691-8caa-480161c2fc87",fieldKind:"dimension"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:5,character:13},end:{line:10,character:13}}}},{name:"coin_count",numberType:"integer",type:"number",resultMetadata:{sourceField:"coin_count",sourceExpression:"count()",sourceClasses:["coin_count"],referenceId:"0e192c59-8ed8-4773-975a-0c44248d3b5c",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:2,character:4},end:{line:2,character:25}}}},{name:"total_value",numberType:"integer",type:"number",resultMetadata:{sourceField:"total_value",sourceExpression:"face_value.sum()",sourceClasses:["total_value"],referenceId:"692b98a4-f515-4d20-b236-7d40f8704721",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:3,character:4},end:{line:3,character:35}}}}],dialect:"duckdb",primaryKey:"coin_type",connection:"duckdb",resultMetadata:{sourceField:"ignoreme",filterList:[],sourceClasses:["ignoreme"],fieldKind:"struct",orderBy:[{field:"coin_count",dir:"desc"}],drillable:!0}}],sourceExplore:"coins",sourceArguments:{},connectionName:"duckdb",result:[{coin_type:"quarter",coin_count:6,total_value:150},{coin_type:"penny",coin_count:4,total_value:4},{coin_type:"nickle",coin_count:3,total_value:15},{coin_type:"dime",coin_count:3,total_value:30}],totalRows:4},e.appendChild(a)})();</script>
      </div>
    </div>
    <div class="result-middle" data-result-kind="json" >
      <div class="result-inner">
        <pre><pre class="language-json" style="background-color: #FBFBFB"><span class="line"><span style="color: #000000">[</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;quarter&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">6</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">150</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;penny&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;nickle&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">15</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;dime&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">30</span></span>
<span class="line"><span style="color: #000000">  }</span></span>
<span class="line"><span style="color: #000000">]</span></span></pre></pre>
      </div>
    </div>
    <div class="result-middle" data-result-kind="sql" >
      <div class="result-inner">
        <pre><pre class="language-sql" style="background-color: #FBFBFB"><span class="line"><span style="color: #0000FF">SELECT</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">   </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">1</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;penny&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">5</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;nickle&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">10</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;dime&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">25</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;quarter&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">ELSE</span><span style="color: #000000"> </span><span style="color: #0000FF">NULL</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_type&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">   </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #098658">1</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_count&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">   </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">),</span><span style="color: #098658">0</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;total_value&quot;</span></span>
<span class="line"><span style="color: #0000FF">FROM</span><span style="color: #000000"> coins.csv </span><span style="color: #0000FF">as</span><span style="color: #000000"> base</span></span>
<span class="line"><span style="color: #0000FF">GROUP BY</span><span style="color: #000000"> </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #0000FF">ORDER BY</span><span style="color: #000000"> </span><span style="color: #098658">2</span><span style="color: #000000"> </span><span style="color: #0000FF">desc</span><span style="color: #000000"> NULLS </span><span style="color: #0000FF">LAST</span></span>
<span class="line"></span></pre></pre>
      </div>
    </div>
  </div></div>
      <h2>
        <a id="dimensions-and-measures-can-be-used-as-partial-queries-" class="header-link anchor" href="#dimensions-and-measures-can-be-used-as-partial-queries-">
          Dimensions and measures can be used as partial queries.
        </a>
      </h2>
    <p>When writing a query  <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #000000">... -&gt; {</span><span style="color: #AF00DB">group_by</span><span style="color: #000000">: </span><span style="color: #001080">coin_type</span><span style="color: #000000">} ...</span></span></code> is the same as <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #000000"> ... -&gt; </span><span style="color: #001080">coin_type</span><span style="color: #000000">  ...</span></span></code></p>
<div class="code-wrapper"><a href="https://github.dev/malloydata/malloydata.github.io/blob/main/src/blog/2023-11-04-data-for-kindergarten/index.malloynb#C18" target="_blank" class="open_notebook"><img src="/img/open_notebook.svg" alt="document"/></a><pre class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">run</span><span style="color: #000000">: </span><span style="color: #001080">coins</span><span style="color: #000000"> -&gt;       </span><span style="color: #008000">//        same as:</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #001080">coin_type</span><span style="color: #000000">         </span><span style="color: #008000">// {group_by: coin_type}</span></span>
<span class="line"><span style="color: #000000">  + </span><span style="color: #001080">coin_count</span><span style="color: #000000">      </span><span style="color: #008000">// {aggregate: coin_count}</span></span>
<span class="line"><span style="color: #000000">  + </span><span style="color: #001080">total_value</span><span style="color: #000000">     </span><span style="color: #008000">// {aggregate: coin_count}</span></span></pre><div class="result-outer small">
    <div class="result-controls-bar">
      <span class="result-label">QUERY RESULTS</span>
      <div class="result-controls">
        <button class="result-control" selected data-result-kind="html">HTML</button>
        <button class="result-control"  data-result-kind="json">JSON</button>
        <button class="result-control"  data-result-kind="sql">SQL</button>
      </div>
    </div>
    <div class="result-middle" data-result-kind="html" selected>
      <div class="result-inner" id="7008079e-2b45-4217-9686-ca58850cab7b">
        <script>(()=>{var e=document.getElementById("7008079e-2b45-4217-9686-ca58850cab7b"),a=document.createElement("malloy-render");a.modelDef={name:"",exports:["coins"],contents:{coins:{type:"table",name:"duckdb:coins.csv",dialect:"duckdb",tablePath:"coins.csv",connection:"duckdb",fields:[{type:"number",numberType:"integer",name:"face_value",fieldUsage:[{path:["face_value"]}]},{type:"number",numberType:"integer",name:"minted_year",fieldUsage:[{path:["minted_year"]}]},{type:"number",numberType:"integer",name:"coin_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},{type:"number",numberType:"integer",name:"total_value",e:{node:"aggregate",function:"sum",e:{node:"field",path:["face_value"]}},fieldUsage:[{path:["face_value"]}],expressionType:"aggregate",code:"face_value.sum()"},{type:"string",name:"coin_type",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"5",sql:"5"}},sql:'(base."face_value"=5)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"10",sql:"10"}},sql:'(base."face_value"=10)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"25",sql:"25"}},sql:'(base."face_value"=25)'}],caseThen:[{node:"stringLiteral",literal:"penny",sql:"'penny'"},{node:"stringLiteral",literal:"nickle",sql:"'nickle'"},{node:"stringLiteral",literal:"dime",sql:"'dime'"},{node:"stringLiteral",literal:"quarter",sql:"'quarter'"}],caseElse:{node:"null",sql:"NULL"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null"},{type:"string",name:"color",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'}],caseThen:[{node:"stringLiteral",literal:"copper",sql:"'copper'"}],caseElse:{node:"stringLiteral",literal:"silver",sql:"'silver'"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'copper' when 1\n    else 'silver'"}],parameters:{},as:"coins"}},queryList:[{type:"query",structRef:"coins",sourceArguments:{},pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["coin_type"]},{type:"fieldref",path:["coin_count"]},{type:"fieldref",path:["total_value"]}],fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]}]}]}],dependencies:{},references:[{type:"exploreReference",text:"coins",definition:{type:"table",name:"duckdb:coins.csv",dialect:"duckdb",tablePath:"coins.csv",connection:"duckdb",fields:[{type:"number",numberType:"integer",name:"face_value",fieldUsage:[{path:["face_value"]}]},{type:"number",numberType:"integer",name:"minted_year",fieldUsage:[{path:["minted_year"]}]},{type:"number",numberType:"integer",name:"coin_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},{type:"number",numberType:"integer",name:"total_value",e:{node:"aggregate",function:"sum",e:{node:"field",path:["face_value"]}},fieldUsage:[{path:["face_value"]}],expressionType:"aggregate",code:"face_value.sum()"},{type:"string",name:"coin_type",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"5",sql:"5"}},sql:'(base."face_value"=5)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"10",sql:"10"}},sql:'(base."face_value"=10)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"25",sql:"25"}},sql:'(base."face_value"=25)'}],caseThen:[{node:"stringLiteral",literal:"penny",sql:"'penny'"},{node:"stringLiteral",literal:"nickle",sql:"'nickle'"},{node:"stringLiteral",literal:"dime",sql:"'dime'"},{node:"stringLiteral",literal:"quarter",sql:"'quarter'"}],caseElse:{node:"null",sql:"NULL"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null"},{type:"string",name:"color",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'}],caseThen:[{node:"stringLiteral",literal:"copper",sql:"'copper'"}],caseElse:{node:"stringLiteral",literal:"silver",sql:"'silver'"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'copper' when 1\n    else 'silver'"}],parameters:{},as:"coins"}},{type:"fieldReference",definition:{type:"string",name:"coin_type",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"5",sql:"5"}},sql:'(base."face_value"=5)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"10",sql:"10"}},sql:'(base."face_value"=10)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"25",sql:"25"}},sql:'(base."face_value"=25)'}],caseThen:[{node:"stringLiteral",literal:"penny",sql:"'penny'"},{node:"stringLiteral",literal:"nickle",sql:"'nickle'"},{node:"stringLiteral",literal:"dime",sql:"'dime'"},{node:"stringLiteral",literal:"quarter",sql:"'quarter'"}],caseElse:{node:"null",sql:"NULL"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null"},text:"coin_type"},{type:"fieldReference",definition:{type:"number",numberType:"integer",name:"coin_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},text:"coin_count"},{type:"fieldReference",definition:{type:"number",numberType:"integer",name:"total_value",e:{node:"aggregate",function:"sum",e:{node:"field",path:["face_value"]}},fieldUsage:[{path:["face_value"]}],expressionType:"aggregate",code:"face_value.sum()"},text:"total_value"}],imports:[]},a.queryResult={lastStageName:"__stage0",malloy:"",sql:'SELECT \n   CASE WHEN (base."face_value"=1) THEN \'penny\' WHEN (base."face_value"=5) THEN \'nickle\' WHEN (base."face_value"=10) THEN \'dime\' WHEN (base."face_value"=25) THEN \'quarter\' ELSE NULL END as "coin_type",\n   COUNT(1) as "coin_count",\n   COALESCE(SUM(base."face_value"),0) as "total_value"\nFROM coins.csv as base\nGROUP BY 1\nORDER BY 2 desc NULLS LAST\n',dependenciesToMaterialize:{},structs:[{type:"query_result",name:"__stage0",fields:[{name:"coin_type",type:"string",resultMetadata:{sourceField:"coin_type",sourceExpression:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null",sourceClasses:["coin_type"],referenceId:"a32e78e8-2581-49c7-9435-5f8bf4b7c485",fieldKind:"dimension"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:5,character:13},end:{line:10,character:13}}}},{name:"coin_count",numberType:"integer",type:"number",resultMetadata:{sourceField:"coin_count",sourceExpression:"count()",sourceClasses:["coin_count"],referenceId:"469ca7c8-8f46-46be-a888-fa6735536e82",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:2,character:4},end:{line:2,character:25}}}},{name:"total_value",numberType:"integer",type:"number",resultMetadata:{sourceField:"total_value",sourceExpression:"face_value.sum()",sourceClasses:["total_value"],referenceId:"cf6abbc4-0953-4c2a-a65b-7a7508122318",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:3,character:4},end:{line:3,character:35}}}}],dialect:"duckdb",primaryKey:"coin_type",connection:"duckdb",resultMetadata:{sourceField:"ignoreme",filterList:[],sourceClasses:["ignoreme"],fieldKind:"struct",drillable:!0}}],sourceExplore:"coins",sourceArguments:{},connectionName:"duckdb",result:[{coin_type:"quarter",coin_count:6,total_value:150},{coin_type:"penny",coin_count:4,total_value:4},{coin_type:"dime",coin_count:3,total_value:30},{coin_type:"nickle",coin_count:3,total_value:15}],totalRows:4},e.appendChild(a)})();</script>
      </div>
    </div>
    <div class="result-middle" data-result-kind="json" >
      <div class="result-inner">
        <pre><pre class="language-json" style="background-color: #FBFBFB"><span class="line"><span style="color: #000000">[</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;quarter&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">6</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">150</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;penny&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;dime&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">30</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;nickle&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">15</span></span>
<span class="line"><span style="color: #000000">  }</span></span>
<span class="line"><span style="color: #000000">]</span></span></pre></pre>
      </div>
    </div>
    <div class="result-middle" data-result-kind="sql" >
      <div class="result-inner">
        <pre><pre class="language-sql" style="background-color: #FBFBFB"><span class="line"><span style="color: #0000FF">SELECT</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">   </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">1</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;penny&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">5</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;nickle&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">10</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;dime&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">25</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;quarter&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">ELSE</span><span style="color: #000000"> </span><span style="color: #0000FF">NULL</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_type&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">   </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #098658">1</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_count&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">   </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">),</span><span style="color: #098658">0</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;total_value&quot;</span></span>
<span class="line"><span style="color: #0000FF">FROM</span><span style="color: #000000"> coins.csv </span><span style="color: #0000FF">as</span><span style="color: #000000"> base</span></span>
<span class="line"><span style="color: #0000FF">GROUP BY</span><span style="color: #000000"> </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #0000FF">ORDER BY</span><span style="color: #000000"> </span><span style="color: #098658">2</span><span style="color: #000000"> </span><span style="color: #0000FF">desc</span><span style="color: #000000"> NULLS </span><span style="color: #0000FF">LAST</span></span>
<span class="line"></span></pre></pre>
      </div>
    </div>
  </div></div><p>We can write any part of the query either way.  All the queries below represent the same queries.</p>
<div class="code-wrapper"><pre class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">run</span><span style="color: #000000">: </span><span style="color: #001080">coins</span><span style="color: #000000"> -&gt; </span><span style="color: #001080">coin_type</span><span style="color: #000000"> + </span><span style="color: #001080">coin_count</span><span style="color: #000000"> + </span><span style="color: #001080">total_value</span></span>
<span class="line"><span style="color: #AF00DB">run</span><span style="color: #000000">: </span><span style="color: #001080">coins</span><span style="color: #000000"> -&gt; {</span><span style="color: #AF00DB">group_by</span><span style="color: #000000">: </span><span style="color: #001080">coin_type</span><span style="color: #000000">} + </span><span style="color: #001080">coin_count</span><span style="color: #000000"> + </span><span style="color: #001080">total_value</span></span>
<span class="line"><span style="color: #AF00DB">run</span><span style="color: #000000">: </span><span style="color: #001080">coins</span><span style="color: #000000"> -&gt; </span><span style="color: #001080">coin_type</span><span style="color: #000000"> + {</span><span style="color: #AF00DB">aggregate</span><span style="color: #000000">: </span><span style="color: #001080">coin_count</span><span style="color: #000000">, </span><span style="color: #001080">total_value</span><span style="color: #000000">}</span></span>
<span class="line"><span style="color: #AF00DB">run</span><span style="color: #000000">: </span><span style="color: #001080">coins</span><span style="color: #000000"> -&gt; {</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">group_by</span><span style="color: #000000">: </span><span style="color: #001080">coin_type</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">aggregate</span><span style="color: #000000">: </span><span style="color: #001080">coin_count</span><span style="color: #000000">, </span><span style="color: #001080">total_value</span></span>
<span class="line"><span style="color: #000000">}</span></span></pre></div>
      <h2>
        <a id="rendering-results" class="header-link anchor" href="#rendering-results">
          Rendering results
        </a>
      </h2>
    <p>By default, Malloy shows results as tables.  Results can be annotated by placing a line before the definition that starts with <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #A31515">#</span></span></code>  In the case below, we want to show the results as a bar_chart.  A bar chart expects 2 or three columns.  The first is the x axis, second is the y axis and the third, if it exists, controls the color.</p>
<div class="code-wrapper"><a href="https://github.dev/malloydata/malloydata.github.io/blob/main/src/blog/2023-11-04-data-for-kindergarten/index.malloynb#C20" target="_blank" class="open_notebook"><img src="/img/open_notebook.svg" alt="document"/></a><pre class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #0451A5"># bar_chart</span></span>
<span class="line"><span style="color: #AF00DB">run</span><span style="color: #000000">: </span><span style="color: #001080">coins</span><span style="color: #000000"> -&gt; </span><span style="color: #001080">coin_type</span><span style="color: #000000"> + </span><span style="color: #001080">coin_count</span><span style="color: #000000"> + </span><span style="color: #001080">total_value</span></span></pre><div class="result-outer small">
    <div class="result-controls-bar">
      <span class="result-label">QUERY RESULTS</span>
      <div class="result-controls">
        <button class="result-control" selected data-result-kind="html">HTML</button>
        <button class="result-control"  data-result-kind="json">JSON</button>
        <button class="result-control"  data-result-kind="sql">SQL</button>
      </div>
    </div>
    <div class="result-middle" data-result-kind="html" selected>
      <div class="result-inner" id="05980a10-1d6f-43b6-bb60-6f9c946093b6">
        <script>(()=>{var e=document.getElementById("05980a10-1d6f-43b6-bb60-6f9c946093b6"),a=document.createElement("malloy-render");a.modelDef={name:"",exports:["coins"],contents:{coins:{type:"table",name:"duckdb:coins.csv",dialect:"duckdb",tablePath:"coins.csv",connection:"duckdb",fields:[{type:"number",numberType:"integer",name:"face_value",fieldUsage:[{path:["face_value"]}]},{type:"number",numberType:"integer",name:"minted_year",fieldUsage:[{path:["minted_year"]}]},{type:"number",numberType:"integer",name:"coin_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},{type:"number",numberType:"integer",name:"total_value",e:{node:"aggregate",function:"sum",e:{node:"field",path:["face_value"]}},fieldUsage:[{path:["face_value"]}],expressionType:"aggregate",code:"face_value.sum()"},{type:"string",name:"coin_type",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"5",sql:"5"}},sql:'(base."face_value"=5)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"10",sql:"10"}},sql:'(base."face_value"=10)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"25",sql:"25"}},sql:'(base."face_value"=25)'}],caseThen:[{node:"stringLiteral",literal:"penny",sql:"'penny'"},{node:"stringLiteral",literal:"nickle",sql:"'nickle'"},{node:"stringLiteral",literal:"dime",sql:"'dime'"},{node:"stringLiteral",literal:"quarter",sql:"'quarter'"}],caseElse:{node:"null",sql:"NULL"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null"},{type:"string",name:"color",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'}],caseThen:[{node:"stringLiteral",literal:"copper",sql:"'copper'"}],caseElse:{node:"stringLiteral",literal:"silver",sql:"'silver'"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'copper' when 1\n    else 'silver'"}],parameters:{},as:"coins"}},queryList:[{type:"query",structRef:"coins",sourceArguments:{},pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["coin_type"]},{type:"fieldref",path:["coin_count"]},{type:"fieldref",path:["total_value"]}],fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]}]}],annotation:{notes:[],blockNotes:[{text:"# bar_chart\n"}]}}],dependencies:{},references:[{type:"exploreReference",text:"coins",definition:{type:"table",name:"duckdb:coins.csv",dialect:"duckdb",tablePath:"coins.csv",connection:"duckdb",fields:[{type:"number",numberType:"integer",name:"face_value",fieldUsage:[{path:["face_value"]}]},{type:"number",numberType:"integer",name:"minted_year",fieldUsage:[{path:["minted_year"]}]},{type:"number",numberType:"integer",name:"coin_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},{type:"number",numberType:"integer",name:"total_value",e:{node:"aggregate",function:"sum",e:{node:"field",path:["face_value"]}},fieldUsage:[{path:["face_value"]}],expressionType:"aggregate",code:"face_value.sum()"},{type:"string",name:"coin_type",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"5",sql:"5"}},sql:'(base."face_value"=5)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"10",sql:"10"}},sql:'(base."face_value"=10)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"25",sql:"25"}},sql:'(base."face_value"=25)'}],caseThen:[{node:"stringLiteral",literal:"penny",sql:"'penny'"},{node:"stringLiteral",literal:"nickle",sql:"'nickle'"},{node:"stringLiteral",literal:"dime",sql:"'dime'"},{node:"stringLiteral",literal:"quarter",sql:"'quarter'"}],caseElse:{node:"null",sql:"NULL"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null"},{type:"string",name:"color",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'}],caseThen:[{node:"stringLiteral",literal:"copper",sql:"'copper'"}],caseElse:{node:"stringLiteral",literal:"silver",sql:"'silver'"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'copper' when 1\n    else 'silver'"}],parameters:{},as:"coins"}},{type:"fieldReference",definition:{type:"string",name:"coin_type",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"5",sql:"5"}},sql:'(base."face_value"=5)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"10",sql:"10"}},sql:'(base."face_value"=10)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"25",sql:"25"}},sql:'(base."face_value"=25)'}],caseThen:[{node:"stringLiteral",literal:"penny",sql:"'penny'"},{node:"stringLiteral",literal:"nickle",sql:"'nickle'"},{node:"stringLiteral",literal:"dime",sql:"'dime'"},{node:"stringLiteral",literal:"quarter",sql:"'quarter'"}],caseElse:{node:"null",sql:"NULL"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null"},text:"coin_type"},{type:"fieldReference",definition:{type:"number",numberType:"integer",name:"coin_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},text:"coin_count"},{type:"fieldReference",definition:{type:"number",numberType:"integer",name:"total_value",e:{node:"aggregate",function:"sum",e:{node:"field",path:["face_value"]}},fieldUsage:[{path:["face_value"]}],expressionType:"aggregate",code:"face_value.sum()"},text:"total_value"}],imports:[]},a.queryResult={lastStageName:"__stage0",malloy:"",sql:'SELECT \n   CASE WHEN (base."face_value"=1) THEN \'penny\' WHEN (base."face_value"=5) THEN \'nickle\' WHEN (base."face_value"=10) THEN \'dime\' WHEN (base."face_value"=25) THEN \'quarter\' ELSE NULL END as "coin_type",\n   COUNT(1) as "coin_count",\n   COALESCE(SUM(base."face_value"),0) as "total_value"\nFROM coins.csv as base\nGROUP BY 1\nORDER BY 2 desc NULLS LAST\n',dependenciesToMaterialize:{},structs:[{type:"query_result",name:"__stage0",fields:[{name:"coin_type",type:"string",resultMetadata:{sourceField:"coin_type",sourceExpression:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null",sourceClasses:["coin_type"],referenceId:"9a7d8e5f-ee4f-4546-8509-022db6c776d9",fieldKind:"dimension"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:5,character:13},end:{line:10,character:13}}}},{name:"coin_count",numberType:"integer",type:"number",resultMetadata:{sourceField:"coin_count",sourceExpression:"count()",sourceClasses:["coin_count"],referenceId:"4760c274-bb73-4860-8f20-98147be714a7",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:2,character:4},end:{line:2,character:25}}}},{name:"total_value",numberType:"integer",type:"number",resultMetadata:{sourceField:"total_value",sourceExpression:"face_value.sum()",sourceClasses:["total_value"],referenceId:"1a56229c-8106-4e73-9837-ba7efc57aa0c",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:3,character:4},end:{line:3,character:35}}}}],dialect:"duckdb",primaryKey:"coin_type",connection:"duckdb",resultMetadata:{sourceField:"ignoreme",filterList:[],sourceClasses:["ignoreme"],fieldKind:"struct",drillable:!0}}],sourceExplore:"coins",sourceArguments:{},connectionName:"duckdb",annotation:{notes:[],blockNotes:[{text:"# bar_chart\n",at:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:0,character:0},end:{line:0,character:12}}}}]},result:[{coin_type:"quarter",coin_count:6,total_value:150},{coin_type:"penny",coin_count:4,total_value:4},{coin_type:"nickle",coin_count:3,total_value:15},{coin_type:"dime",coin_count:3,total_value:30}],totalRows:4},e.appendChild(a)})();</script>
      </div>
    </div>
    <div class="result-middle" data-result-kind="json" >
      <div class="result-inner">
        <pre><pre class="language-json" style="background-color: #FBFBFB"><span class="line"><span style="color: #000000">[</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;quarter&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">6</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">150</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;penny&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;nickle&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">15</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;dime&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">30</span></span>
<span class="line"><span style="color: #000000">  }</span></span>
<span class="line"><span style="color: #000000">]</span></span></pre></pre>
      </div>
    </div>
    <div class="result-middle" data-result-kind="sql" >
      <div class="result-inner">
        <pre><pre class="language-sql" style="background-color: #FBFBFB"><span class="line"><span style="color: #0000FF">SELECT</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">   </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">1</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;penny&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">5</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;nickle&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">10</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;dime&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">25</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;quarter&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">ELSE</span><span style="color: #000000"> </span><span style="color: #0000FF">NULL</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_type&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">   </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #098658">1</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_count&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">   </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">),</span><span style="color: #098658">0</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;total_value&quot;</span></span>
<span class="line"><span style="color: #0000FF">FROM</span><span style="color: #000000"> coins.csv </span><span style="color: #0000FF">as</span><span style="color: #000000"> base</span></span>
<span class="line"><span style="color: #0000FF">GROUP BY</span><span style="color: #000000"> </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #0000FF">ORDER BY</span><span style="color: #000000"> </span><span style="color: #098658">2</span><span style="color: #000000"> </span><span style="color: #0000FF">desc</span><span style="color: #000000"> NULLS </span><span style="color: #0000FF">LAST</span></span>
<span class="line"></span></pre></pre>
      </div>
    </div>
  </div></div>
      <h2>
        <a id="extending-sources" class="header-link anchor" href="#extending-sources">
          Extending Sources
        </a>
      </h2>
    <p>Suppose someone had written this great coin counting model and I wanted to use it in my analysis.  Malloy lets you extend (inherit from) a source and create a new source with new definitions.  We add a couple of new dimensions, a new calculation and some <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">views</span></span></code>.  In Malloy <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">views</span></span></code> are common ways of looking at data.  We've added two views here.  The first is <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">metrics</span></span></code> which is the common ways of look at data.  And by_type, the most common over all query.</p>
<div class="code-wrapper"><a href="https://github.dev/malloydata/malloydata.github.io/blob/main/src/blog/2023-11-04-data-for-kindergarten/index.malloynb#C22" target="_blank" class="open_notebook"><img src="/img/open_notebook.svg" alt="document"/></a><pre class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #008000">// import &#39;coins.malloy&#39;</span></span>
<span class="line"><span style="color: #AF00DB">source</span><span style="color: #000000">: </span><span style="color: #001080">coins2</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">coins</span><span style="color: #000000"> </span><span style="color: #AF00DB">extend</span><span style="color: #000000"> {</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">dimension</span><span style="color: #000000">: </span><span style="color: #001080">is_new</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">minted_year</span><span style="color: #000000"> &gt;= </span><span style="color: #098658">2000</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">dimension</span><span style="color: #000000">: </span><span style="color: #001080">minted_decade</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #795E26">floor</span><span style="color: #000000">(</span><span style="color: #001080">minted_year</span><span style="color: #000000">/</span><span style="color: #098658">10</span><span style="color: #000000">) * </span><span style="color: #098658">10</span></span>
<span class="line"><span style="color: #000000">  </span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">measure</span><span style="color: #000000">: </span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5"># percent</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #001080">percent_of_value</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">total_value</span><span style="color: #000000">/</span><span style="color: #795E26">all</span><span style="color: #000000">(</span><span style="color: #001080">total_value</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5"># percent</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #001080">percent_of_coins</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">coin_count</span><span style="color: #000000">/</span><span style="color: #795E26">all</span><span style="color: #000000">(</span><span style="color: #001080">coin_count</span><span style="color: #000000">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">view</span><span style="color: #000000">: </span><span style="color: #001080">metrics</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #AF00DB">aggregate</span><span style="color: #000000">: </span><span style="color: #001080">total_value</span><span style="color: #000000">, </span><span style="color: #001080">coin_count</span><span style="color: #000000">, </span><span style="color: #001080">percent_of_value</span><span style="color: #000000">, </span><span style="color: #001080">percent_of_coins</span></span>
<span class="line"><span style="color: #000000">  }</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #008000">// we always look at this data by coin type</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">view</span><span style="color: #000000">: </span><span style="color: #001080">by_type</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">coin_type</span><span style="color: #000000"> + </span><span style="color: #001080">metrics</span></span>
<span class="line"><span style="color: #000000">}</span></span></pre></div>
      <h2>
        <a id="the-schema-for-coins" class="header-link anchor" href="#the-schema-for-coins">
          The schema for coins
        </a>
      </h2>
    <img src="coins2_schema.png">
      <h2>
        <a id="views-the-most-common-ways-of-looking-at-the-data-" class="header-link anchor" href="#views-the-most-common-ways-of-looking-at-the-data-">
          Views: The most common ways of looking at the data.
        </a>
      </h2>
    <p>Notice the views.  Views can be used by them selves or in combination with other queries.  Views are bigger building blocks.</p>
<p>Let's start with <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">metrics</span></span></code>.  Metrics is a view that comuptes <em>all</em> the things we might want to ask about a pile of coins.</p>
<div class="code-wrapper"><a href="https://github.dev/malloydata/malloydata.github.io/blob/main/src/blog/2023-11-04-data-for-kindergarten/index.malloynb#C24" target="_blank" class="open_notebook"><img src="/img/open_notebook.svg" alt="document"/></a><pre class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">run</span><span style="color: #000000">: </span><span style="color: #001080">coins2</span><span style="color: #000000"> -&gt; </span><span style="color: #001080">metrics</span></span></pre><div class="result-outer small">
    <div class="result-controls-bar">
      <span class="result-label">QUERY RESULTS</span>
      <div class="result-controls">
        <button class="result-control" selected data-result-kind="html">HTML</button>
        <button class="result-control"  data-result-kind="json">JSON</button>
        <button class="result-control"  data-result-kind="sql">SQL</button>
      </div>
    </div>
    <div class="result-middle" data-result-kind="html" selected>
      <div class="result-inner" id="33c2786d-f812-4147-b92a-bddcbf645546">
        <script>(()=>{var e=document.getElementById("33c2786d-f812-4147-b92a-bddcbf645546"),a=document.createElement("malloy-render");a.modelDef={name:"",exports:["coins","coins2"],contents:{coins:{type:"table",name:"duckdb:coins.csv",dialect:"duckdb",tablePath:"coins.csv",connection:"duckdb",fields:[{type:"number",numberType:"integer",name:"face_value",fieldUsage:[{path:["face_value"]}]},{type:"number",numberType:"integer",name:"minted_year",fieldUsage:[{path:["minted_year"]}]},{type:"number",numberType:"integer",name:"coin_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},{type:"number",numberType:"integer",name:"total_value",e:{node:"aggregate",function:"sum",e:{node:"field",path:["face_value"]}},fieldUsage:[{path:["face_value"]}],expressionType:"aggregate",code:"face_value.sum()"},{type:"string",name:"coin_type",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"5",sql:"5"}},sql:'(base."face_value"=5)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"10",sql:"10"}},sql:'(base."face_value"=10)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"25",sql:"25"}},sql:'(base."face_value"=25)'}],caseThen:[{node:"stringLiteral",literal:"penny",sql:"'penny'"},{node:"stringLiteral",literal:"nickle",sql:"'nickle'"},{node:"stringLiteral",literal:"dime",sql:"'dime'"},{node:"stringLiteral",literal:"quarter",sql:"'quarter'"}],caseElse:{node:"null",sql:"NULL"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null"},{type:"string",name:"color",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'}],caseThen:[{node:"stringLiteral",literal:"copper",sql:"'copper'"}],caseElse:{node:"stringLiteral",literal:"silver",sql:"'silver'"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'copper' when 1\n    else 'silver'"}],parameters:{},as:"coins"},coins2:{type:"table",name:"duckdb:coins.csv",dialect:"duckdb",tablePath:"coins.csv",connection:"duckdb",fields:[{type:"number",numberType:"integer",name:"face_value",fieldUsage:[{path:["face_value"]}]},{type:"number",numberType:"integer",name:"minted_year",fieldUsage:[{path:["minted_year"]}]},{type:"number",numberType:"integer",name:"coin_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},{type:"number",numberType:"integer",name:"total_value",e:{node:"aggregate",function:"sum",e:{node:"field",path:["face_value"]}},fieldUsage:[{path:["face_value"]}],expressionType:"aggregate",code:"face_value.sum()"},{type:"string",name:"coin_type",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"5",sql:"5"}},sql:'(base."face_value"=5)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"10",sql:"10"}},sql:'(base."face_value"=10)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"25",sql:"25"}},sql:'(base."face_value"=25)'}],caseThen:[{node:"stringLiteral",literal:"penny",sql:"'penny'"},{node:"stringLiteral",literal:"nickle",sql:"'nickle'"},{node:"stringLiteral",literal:"dime",sql:"'dime'"},{node:"stringLiteral",literal:"quarter",sql:"'quarter'"}],caseElse:{node:"null",sql:"NULL"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null"},{type:"string",name:"color",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'}],caseThen:[{node:"stringLiteral",literal:"copper",sql:"'copper'"}],caseElse:{node:"stringLiteral",literal:"silver",sql:"'silver'"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'copper' when 1\n    else 'silver'"},{type:"boolean",name:"is_new",e:{node:">=",kids:{left:{node:"field",path:["minted_year"]},right:{node:"numberLiteral",literal:"2000"}}},fieldUsage:[{path:["minted_year"]}],expressionType:"scalar",code:"minted_year >= 2000"},{type:"number",name:"minted_decade",e:{node:"*",kids:{left:{node:"function_call",overload:{returnType:{type:"number",expressionType:"scalar",evalSpace:"input"},params:[{name:"value",allowedTypes:[{type:"number",evalSpace:"input"}],isVariadic:!1}],dialect:{postgres:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},standardsql:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},duckdb:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},snowflake:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},trino:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},presto:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},mysql:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}}}},name:"floor",kids:{args:[{node:"/",kids:{left:{node:"field",path:["minted_year"]},right:{node:"numberLiteral",literal:"10"}}}]},expressionType:"scalar"},right:{node:"numberLiteral",literal:"10"}}},fieldUsage:[{path:["minted_year"]}],expressionType:"scalar",code:"floor(minted_year/10) * 10"},{type:"number",name:"percent_of_value",e:{node:"/",kids:{left:{node:"field",path:["total_value"],sql:'(CASE WHEN group_set=1 THEN\n  COALESCE(SUM(base."face_value"),0)\n  END)'},right:{node:"all",e:{node:"field",path:["total_value"]},sql:'MAX((CASE WHEN group_set=0 THEN\n  COALESCE(SUM(base."face_value"),0)\n  END)) OVER ()'}}},fieldUsage:[{path:["total_value"]},{path:["total_value"]}],ungroupings:[{requiresGroupBy:[],fieldUsage:[{path:["total_value"]}],ungroupedFields:"*"}],expressionType:"ungrouped_aggregate",code:"total_value/all(total_value)",annotation:{notes:[{text:"# percent\n"}]}},{type:"number",name:"percent_of_coins",e:{node:"/",kids:{left:{node:"field",path:["coin_count"],sql:"(CASE WHEN group_set=1 THEN\n  COUNT(1)\n  END)"},right:{node:"all",e:{node:"field",path:["coin_count"]},sql:"MAX((CASE WHEN group_set=0 THEN\n  COUNT(1)\n  END)) OVER ()"}}},fieldUsage:[{path:["coin_count"]},{path:["coin_count"]}],ungroupings:[{requiresGroupBy:[],fieldUsage:[{path:["coin_count"]}],ungroupedFields:"*"}],expressionType:"ungrouped_aggregate",code:"coin_count/all(coin_count)",annotation:{notes:[{text:"# percent\n"}]}},{type:"turtle",name:"metrics",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["total_value"]},{type:"fieldref",path:["coin_count"]},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}}],filterList:[],fieldUsage:[{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],defaultOrderBy:!0,orderBy:[{field:"total_value",dir:"desc"}]}],annotation:{}},{type:"turtle",name:"by_type",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["coin_type"]},{type:"fieldref",path:["total_value"],drillView:"metrics"},{type:"fieldref",path:["coin_count"],drillView:"metrics"},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"}],fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],filterList:[]}],annotation:{}}],parameters:{},as:"coins2",arguments:{}}},queryList:[{type:"query",structRef:"coins2",sourceArguments:{},pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["total_value"],drillView:"metrics"},{type:"fieldref",path:["coin_count"],drillView:"metrics"},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"}],filterList:[],fieldUsage:[{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],defaultOrderBy:!0,orderBy:[{field:"total_value",dir:"desc"}],referencedAt:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:0,character:15},end:{line:0,character:22}}}}],name:"metrics",annotation:{inherits:{}}}],dependencies:{},references:[{type:"exploreReference",text:"coins2",definition:{type:"table",name:"duckdb:coins.csv",dialect:"duckdb",tablePath:"coins.csv",connection:"duckdb",fields:[{type:"number",numberType:"integer",name:"face_value",fieldUsage:[{path:["face_value"]}]},{type:"number",numberType:"integer",name:"minted_year",fieldUsage:[{path:["minted_year"]}]},{type:"number",numberType:"integer",name:"coin_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},{type:"number",numberType:"integer",name:"total_value",e:{node:"aggregate",function:"sum",e:{node:"field",path:["face_value"]}},fieldUsage:[{path:["face_value"]}],expressionType:"aggregate",code:"face_value.sum()"},{type:"string",name:"coin_type",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"5",sql:"5"}},sql:'(base."face_value"=5)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"10",sql:"10"}},sql:'(base."face_value"=10)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"25",sql:"25"}},sql:'(base."face_value"=25)'}],caseThen:[{node:"stringLiteral",literal:"penny",sql:"'penny'"},{node:"stringLiteral",literal:"nickle",sql:"'nickle'"},{node:"stringLiteral",literal:"dime",sql:"'dime'"},{node:"stringLiteral",literal:"quarter",sql:"'quarter'"}],caseElse:{node:"null",sql:"NULL"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null"},{type:"string",name:"color",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'}],caseThen:[{node:"stringLiteral",literal:"copper",sql:"'copper'"}],caseElse:{node:"stringLiteral",literal:"silver",sql:"'silver'"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'copper' when 1\n    else 'silver'"},{type:"boolean",name:"is_new",e:{node:">=",kids:{left:{node:"field",path:["minted_year"]},right:{node:"numberLiteral",literal:"2000"}}},fieldUsage:[{path:["minted_year"]}],expressionType:"scalar",code:"minted_year >= 2000"},{type:"number",name:"minted_decade",e:{node:"*",kids:{left:{node:"function_call",overload:{returnType:{type:"number",expressionType:"scalar",evalSpace:"input"},params:[{name:"value",allowedTypes:[{type:"number",evalSpace:"input"}],isVariadic:!1}],dialect:{postgres:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},standardsql:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},duckdb:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},snowflake:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},trino:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},presto:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},mysql:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}}}},name:"floor",kids:{args:[{node:"/",kids:{left:{node:"field",path:["minted_year"]},right:{node:"numberLiteral",literal:"10"}}}]},expressionType:"scalar"},right:{node:"numberLiteral",literal:"10"}}},fieldUsage:[{path:["minted_year"]}],expressionType:"scalar",code:"floor(minted_year/10) * 10"},{type:"number",name:"percent_of_value",e:{node:"/",kids:{left:{node:"field",path:["total_value"]},right:{node:"all",e:{node:"field",path:["total_value"]}}}},fieldUsage:[{path:["total_value"]},{path:["total_value"]}],ungroupings:[{requiresGroupBy:[],fieldUsage:[{path:["total_value"]}],ungroupedFields:"*"}],expressionType:"ungrouped_aggregate",code:"total_value/all(total_value)",annotation:{notes:[{text:"# percent\n"}]}},{type:"number",name:"percent_of_coins",e:{node:"/",kids:{left:{node:"field",path:["coin_count"]},right:{node:"all",e:{node:"field",path:["coin_count"]}}}},fieldUsage:[{path:["coin_count"]},{path:["coin_count"]}],ungroupings:[{requiresGroupBy:[],fieldUsage:[{path:["coin_count"]}],ungroupedFields:"*"}],expressionType:"ungrouped_aggregate",code:"coin_count/all(coin_count)",annotation:{notes:[{text:"# percent\n"}]}},{type:"turtle",name:"metrics",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["total_value"]},{type:"fieldref",path:["coin_count"]},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}}],filterList:[],fieldUsage:[{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],defaultOrderBy:!0,orderBy:[{field:"total_value",dir:"desc"}]}],annotation:{}},{type:"turtle",name:"by_type",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["coin_type"]},{type:"fieldref",path:["total_value"],drillView:"metrics"},{type:"fieldref",path:["coin_count"],drillView:"metrics"},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"}],fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],filterList:[]}],annotation:{}}],parameters:{},as:"coins2",arguments:{}}},{type:"fieldReference",definition:{type:"turtle",name:"metrics",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["total_value"]},{type:"fieldref",path:["coin_count"]},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}}],filterList:[],fieldUsage:[{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],defaultOrderBy:!0,orderBy:[{field:"total_value",dir:"desc"}]}],annotation:{}},text:"metrics"}],imports:[]},a.queryResult={lastStageName:"__stage1",malloy:"",sql:'WITH __stage0 AS (\n  SELECT\n    group_set,\n    CASE WHEN group_set=1 THEN\n      COALESCE(SUM(base."face_value"),0)\n      END as "total_value__1",\n    CASE WHEN group_set=1 THEN\n      COUNT(1)\n      END as "coin_count__1",\n    (CASE WHEN group_set=1 THEN\n      COALESCE(SUM(base."face_value"),0)\n      END)*1.0/MAX((CASE WHEN group_set=0 THEN\n      COALESCE(SUM(base."face_value"),0)\n      END)) OVER () as "percent_of_value__1",\n    (CASE WHEN group_set=1 THEN\n      COUNT(1)\n      END)*1.0/MAX((CASE WHEN group_set=0 THEN\n      COUNT(1)\n      END)) OVER () as "percent_of_coins__1"\n  FROM coins.csv as base\n  CROSS JOIN (SELECT UNNEST(GENERATE_SERIES(0,1,1)) as group_set  ) as group_set\n  GROUP BY 1\n)\nSELECT\n  MAX(CASE WHEN group_set=1 THEN "total_value__1" END) as "total_value",\n  MAX(CASE WHEN group_set=1 THEN "coin_count__1" END) as "coin_count",\n  MAX(CASE WHEN group_set=1 THEN "percent_of_value__1" END) as "percent_of_value",\n  MAX(CASE WHEN group_set=1 THEN "percent_of_coins__1" END) as "percent_of_coins"\nFROM __stage0\nWHERE group_set NOT IN (0)\n',dependenciesToMaterialize:{},structs:[{type:"query_result",name:"__stage1",fields:[{name:"total_value",numberType:"integer",type:"number",resultMetadata:{sourceField:"total_value",sourceExpression:"face_value.sum()",sourceClasses:["total_value"],referenceId:"63b6be9d-52c2-462c-921c-77d4d1853f69",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:3,character:4},end:{line:3,character:35}}},drillView:"metrics"},{name:"coin_count",numberType:"integer",type:"number",resultMetadata:{sourceField:"coin_count",sourceExpression:"count()",sourceClasses:["coin_count"],referenceId:"5227daf9-f12e-4912-8832-ddb303527f38",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:2,character:4},end:{line:2,character:25}}},drillView:"metrics"},{name:"percent_of_value",type:"number",resultMetadata:{sourceField:"percent_of_value",sourceExpression:"total_value/all(total_value)",sourceClasses:["percent_of_value"],referenceId:"eb68ec84-f5ec-4131-b3ed-083d9ca1df0f",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:6,character:4},end:{line:7,character:52}}},annotation:{inherits:{notes:[{text:"# percent\n",at:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:6,character:4},end:{line:6,character:14}}}}]}},drillView:"metrics"},{name:"percent_of_coins",type:"number",resultMetadata:{sourceField:"percent_of_coins",sourceExpression:"coin_count/all(coin_count)",sourceClasses:["percent_of_coins"],referenceId:"546d535b-0ffd-4a3d-b8af-aaa356afa6d6",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:8,character:4},end:{line:9,character:50}}},annotation:{inherits:{notes:[{text:"# percent\n",at:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:8,character:4},end:{line:8,character:14}}}}]}},drillView:"metrics"}],dialect:"duckdb",connection:"duckdb",resultMetadata:{sourceField:"ignoreme",filterList:[],sourceClasses:["ignoreme"],fieldKind:"struct",orderBy:[{field:"total_value",dir:"desc"}],drillable:!0}}],sourceExplore:"coins2",sourceArguments:{},queryName:"metrics",connectionName:"duckdb",annotation:{inherits:{}},result:[{total_value:199,coin_count:16,percent_of_value:1,percent_of_coins:1}],totalRows:1},e.appendChild(a)})();</script>
      </div>
    </div>
    <div class="result-middle" data-result-kind="json" >
      <div class="result-inner">
        <pre><pre class="language-json" style="background-color: #FBFBFB"><span class="line"><span style="color: #000000">[</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">199</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">16</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_coins&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">  }</span></span>
<span class="line"><span style="color: #000000">]</span></span></pre></pre>
      </div>
    </div>
    <div class="result-middle" data-result-kind="sql" >
      <div class="result-inner">
        <pre><pre class="language-sql" style="background-color: #FBFBFB"><span class="line"><span style="color: #0000FF">WITH</span><span style="color: #000000"> __stage0 </span><span style="color: #0000FF">AS</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">SELECT</span></span>
<span class="line"><span style="color: #000000">    group_set,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">),</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;total_value__1&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #098658">1</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_count__1&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    (</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">),</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">)*</span><span style="color: #098658">1</span><span style="color: #000000">.</span><span style="color: #098658">0</span><span style="color: #000000">/</span><span style="color: #795E26">MAX</span><span style="color: #000000">((</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">0</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">),</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">)) </span><span style="color: #0000FF">OVER</span><span style="color: #000000"> () </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_value__1&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    (</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #098658">1</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">)*</span><span style="color: #098658">1</span><span style="color: #000000">.</span><span style="color: #098658">0</span><span style="color: #000000">/</span><span style="color: #795E26">MAX</span><span style="color: #000000">((</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">0</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #098658">1</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">)) </span><span style="color: #0000FF">OVER</span><span style="color: #000000"> () </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_coins__1&quot;</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">FROM</span><span style="color: #000000"> coins.csv </span><span style="color: #0000FF">as</span><span style="color: #000000"> base</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">CROSS</span><span style="color: #000000"> </span><span style="color: #0000FF">JOIN</span><span style="color: #000000"> (</span><span style="color: #0000FF">SELECT</span><span style="color: #000000"> UNNEST(GENERATE_SERIES(</span><span style="color: #098658">0</span><span style="color: #000000">,</span><span style="color: #098658">1</span><span style="color: #000000">,</span><span style="color: #098658">1</span><span style="color: #000000">)) </span><span style="color: #0000FF">as</span><span style="color: #000000"> group_set  ) </span><span style="color: #0000FF">as</span><span style="color: #000000"> group_set</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">GROUP BY</span><span style="color: #000000"> </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">SELECT</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #795E26">MAX</span><span style="color: #000000">(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;total_value__1&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;total_value&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #795E26">MAX</span><span style="color: #000000">(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_count__1&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_count&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #795E26">MAX</span><span style="color: #000000">(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_value__1&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_value&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #795E26">MAX</span><span style="color: #000000">(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_coins__1&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_coins&quot;</span></span>
<span class="line"><span style="color: #0000FF">FROM</span><span style="color: #000000"> __stage0</span></span>
<span class="line"><span style="color: #0000FF">WHERE</span><span style="color: #000000"> group_set </span><span style="color: #0000FF">NOT</span><span style="color: #000000"> </span><span style="color: #0000FF">IN</span><span style="color: #000000"> (</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"></span></pre></pre>
      </div>
    </div>
  </div></div>
      <h2>
        <a id="composing-with-metrics" class="header-link anchor" href="#composing-with-metrics">
          Composing with metrics
        </a>
      </h2>
    <p>In our model above we've defined a view called 'metrics' and a dimension called 'color'</p>
<div class="code-wrapper"><a href="https://github.dev/malloydata/malloydata.github.io/blob/main/src/blog/2023-11-04-data-for-kindergarten/index.malloynb#C26" target="_blank" class="open_notebook"><img src="/img/open_notebook.svg" alt="document"/></a><pre class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">run</span><span style="color: #000000">: </span><span style="color: #001080">coins2</span><span style="color: #000000"> -&gt; </span><span style="color: #001080">color</span><span style="color: #000000"> + </span><span style="color: #001080">metrics</span></span></pre><div class="result-outer small">
    <div class="result-controls-bar">
      <span class="result-label">QUERY RESULTS</span>
      <div class="result-controls">
        <button class="result-control" selected data-result-kind="html">HTML</button>
        <button class="result-control"  data-result-kind="json">JSON</button>
        <button class="result-control"  data-result-kind="sql">SQL</button>
      </div>
    </div>
    <div class="result-middle" data-result-kind="html" selected>
      <div class="result-inner" id="a700d09e-2ba0-43a3-8730-82efec2986ab">
        <script>(()=>{var e=document.getElementById("a700d09e-2ba0-43a3-8730-82efec2986ab"),a=document.createElement("malloy-render");a.modelDef={name:"",exports:["coins","coins2"],contents:{coins:{type:"table",name:"duckdb:coins.csv",dialect:"duckdb",tablePath:"coins.csv",connection:"duckdb",fields:[{type:"number",numberType:"integer",name:"face_value",fieldUsage:[{path:["face_value"]}]},{type:"number",numberType:"integer",name:"minted_year",fieldUsage:[{path:["minted_year"]}]},{type:"number",numberType:"integer",name:"coin_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},{type:"number",numberType:"integer",name:"total_value",e:{node:"aggregate",function:"sum",e:{node:"field",path:["face_value"]}},fieldUsage:[{path:["face_value"]}],expressionType:"aggregate",code:"face_value.sum()"},{type:"string",name:"coin_type",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"5",sql:"5"}},sql:'(base."face_value"=5)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"10",sql:"10"}},sql:'(base."face_value"=10)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"25",sql:"25"}},sql:'(base."face_value"=25)'}],caseThen:[{node:"stringLiteral",literal:"penny",sql:"'penny'"},{node:"stringLiteral",literal:"nickle",sql:"'nickle'"},{node:"stringLiteral",literal:"dime",sql:"'dime'"},{node:"stringLiteral",literal:"quarter",sql:"'quarter'"}],caseElse:{node:"null",sql:"NULL"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null"},{type:"string",name:"color",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'}],caseThen:[{node:"stringLiteral",literal:"copper",sql:"'copper'"}],caseElse:{node:"stringLiteral",literal:"silver",sql:"'silver'"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'copper' when 1\n    else 'silver'"}],parameters:{},as:"coins"},coins2:{type:"table",name:"duckdb:coins.csv",dialect:"duckdb",tablePath:"coins.csv",connection:"duckdb",fields:[{type:"number",numberType:"integer",name:"face_value",fieldUsage:[{path:["face_value"]}]},{type:"number",numberType:"integer",name:"minted_year",fieldUsage:[{path:["minted_year"]}]},{type:"number",numberType:"integer",name:"coin_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},{type:"number",numberType:"integer",name:"total_value",e:{node:"aggregate",function:"sum",e:{node:"field",path:["face_value"]}},fieldUsage:[{path:["face_value"]}],expressionType:"aggregate",code:"face_value.sum()"},{type:"string",name:"coin_type",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"5",sql:"5"}},sql:'(base."face_value"=5)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"10",sql:"10"}},sql:'(base."face_value"=10)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"25",sql:"25"}},sql:'(base."face_value"=25)'}],caseThen:[{node:"stringLiteral",literal:"penny",sql:"'penny'"},{node:"stringLiteral",literal:"nickle",sql:"'nickle'"},{node:"stringLiteral",literal:"dime",sql:"'dime'"},{node:"stringLiteral",literal:"quarter",sql:"'quarter'"}],caseElse:{node:"null",sql:"NULL"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null"},{type:"string",name:"color",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'}],caseThen:[{node:"stringLiteral",literal:"copper",sql:"'copper'"}],caseElse:{node:"stringLiteral",literal:"silver",sql:"'silver'"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'copper' when 1\n    else 'silver'"},{type:"boolean",name:"is_new",e:{node:">=",kids:{left:{node:"field",path:["minted_year"]},right:{node:"numberLiteral",literal:"2000"}}},fieldUsage:[{path:["minted_year"]}],expressionType:"scalar",code:"minted_year >= 2000"},{type:"number",name:"minted_decade",e:{node:"*",kids:{left:{node:"function_call",overload:{returnType:{type:"number",expressionType:"scalar",evalSpace:"input"},params:[{name:"value",allowedTypes:[{type:"number",evalSpace:"input"}],isVariadic:!1}],dialect:{postgres:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},standardsql:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},duckdb:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},snowflake:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},trino:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},presto:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},mysql:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}}}},name:"floor",kids:{args:[{node:"/",kids:{left:{node:"field",path:["minted_year"]},right:{node:"numberLiteral",literal:"10"}}}]},expressionType:"scalar"},right:{node:"numberLiteral",literal:"10"}}},fieldUsage:[{path:["minted_year"]}],expressionType:"scalar",code:"floor(minted_year/10) * 10"},{type:"number",name:"percent_of_value",e:{node:"/",kids:{left:{node:"field",path:["total_value"],sql:'(CASE WHEN group_set=1 THEN\n  COALESCE(SUM(base."face_value"),0)\n  END)'},right:{node:"all",e:{node:"field",path:["total_value"]},sql:'MAX((CASE WHEN group_set=0 THEN\n  COALESCE(SUM(base."face_value"),0)\n  END)) OVER ()'}}},fieldUsage:[{path:["total_value"]},{path:["total_value"]}],ungroupings:[{requiresGroupBy:[],fieldUsage:[{path:["total_value"]}],ungroupedFields:"*"}],expressionType:"ungrouped_aggregate",code:"total_value/all(total_value)",annotation:{notes:[{text:"# percent\n"}]}},{type:"number",name:"percent_of_coins",e:{node:"/",kids:{left:{node:"field",path:["coin_count"],sql:"(CASE WHEN group_set=1 THEN\n  COUNT(1)\n  END)"},right:{node:"all",e:{node:"field",path:["coin_count"]},sql:"MAX((CASE WHEN group_set=0 THEN\n  COUNT(1)\n  END)) OVER ()"}}},fieldUsage:[{path:["coin_count"]},{path:["coin_count"]}],ungroupings:[{requiresGroupBy:[],fieldUsage:[{path:["coin_count"]}],ungroupedFields:"*"}],expressionType:"ungrouped_aggregate",code:"coin_count/all(coin_count)",annotation:{notes:[{text:"# percent\n"}]}},{type:"turtle",name:"metrics",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["total_value"]},{type:"fieldref",path:["coin_count"]},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}}],filterList:[],fieldUsage:[{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],defaultOrderBy:!0,orderBy:[{field:"total_value",dir:"desc"}]}],annotation:{}},{type:"turtle",name:"by_type",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["coin_type"]},{type:"fieldref",path:["total_value"],drillView:"metrics"},{type:"fieldref",path:["coin_count"],drillView:"metrics"},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"}],fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],filterList:[]}],annotation:{}}],parameters:{},as:"coins2",arguments:{}}},queryList:[{type:"query",structRef:"coins2",sourceArguments:{},pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["color"]},{type:"fieldref",path:["total_value"],drillView:"metrics"},{type:"fieldref",path:["coin_count"],drillView:"metrics"},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"}],fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],filterList:[]}]}],dependencies:{},references:[{type:"exploreReference",text:"coins2",definition:{type:"table",name:"duckdb:coins.csv",dialect:"duckdb",tablePath:"coins.csv",connection:"duckdb",fields:[{type:"number",numberType:"integer",name:"face_value",fieldUsage:[{path:["face_value"]}]},{type:"number",numberType:"integer",name:"minted_year",fieldUsage:[{path:["minted_year"]}]},{type:"number",numberType:"integer",name:"coin_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},{type:"number",numberType:"integer",name:"total_value",e:{node:"aggregate",function:"sum",e:{node:"field",path:["face_value"]}},fieldUsage:[{path:["face_value"]}],expressionType:"aggregate",code:"face_value.sum()"},{type:"string",name:"coin_type",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"5",sql:"5"}},sql:'(base."face_value"=5)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"10",sql:"10"}},sql:'(base."face_value"=10)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"25",sql:"25"}},sql:'(base."face_value"=25)'}],caseThen:[{node:"stringLiteral",literal:"penny",sql:"'penny'"},{node:"stringLiteral",literal:"nickle",sql:"'nickle'"},{node:"stringLiteral",literal:"dime",sql:"'dime'"},{node:"stringLiteral",literal:"quarter",sql:"'quarter'"}],caseElse:{node:"null",sql:"NULL"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null"},{type:"string",name:"color",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'}],caseThen:[{node:"stringLiteral",literal:"copper",sql:"'copper'"}],caseElse:{node:"stringLiteral",literal:"silver",sql:"'silver'"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'copper' when 1\n    else 'silver'"},{type:"boolean",name:"is_new",e:{node:">=",kids:{left:{node:"field",path:["minted_year"]},right:{node:"numberLiteral",literal:"2000"}}},fieldUsage:[{path:["minted_year"]}],expressionType:"scalar",code:"minted_year >= 2000"},{type:"number",name:"minted_decade",e:{node:"*",kids:{left:{node:"function_call",overload:{returnType:{type:"number",expressionType:"scalar",evalSpace:"input"},params:[{name:"value",allowedTypes:[{type:"number",evalSpace:"input"}],isVariadic:!1}],dialect:{postgres:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},standardsql:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},duckdb:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},snowflake:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},trino:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},presto:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},mysql:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}}}},name:"floor",kids:{args:[{node:"/",kids:{left:{node:"field",path:["minted_year"]},right:{node:"numberLiteral",literal:"10"}}}]},expressionType:"scalar"},right:{node:"numberLiteral",literal:"10"}}},fieldUsage:[{path:["minted_year"]}],expressionType:"scalar",code:"floor(minted_year/10) * 10"},{type:"number",name:"percent_of_value",e:{node:"/",kids:{left:{node:"field",path:["total_value"],sql:'(CASE WHEN group_set=1 THEN\n  COALESCE(SUM(base."face_value"),0)\n  END)'},right:{node:"all",e:{node:"field",path:["total_value"]},sql:'MAX((CASE WHEN group_set=0 THEN\n  COALESCE(SUM(base."face_value"),0)\n  END)) OVER ()'}}},fieldUsage:[{path:["total_value"]},{path:["total_value"]}],ungroupings:[{requiresGroupBy:[],fieldUsage:[{path:["total_value"]}],ungroupedFields:"*"}],expressionType:"ungrouped_aggregate",code:"total_value/all(total_value)",annotation:{notes:[{text:"# percent\n"}]}},{type:"number",name:"percent_of_coins",e:{node:"/",kids:{left:{node:"field",path:["coin_count"],sql:"(CASE WHEN group_set=1 THEN\n  COUNT(1)\n  END)"},right:{node:"all",e:{node:"field",path:["coin_count"]},sql:"MAX((CASE WHEN group_set=0 THEN\n  COUNT(1)\n  END)) OVER ()"}}},fieldUsage:[{path:["coin_count"]},{path:["coin_count"]}],ungroupings:[{requiresGroupBy:[],fieldUsage:[{path:["coin_count"]}],ungroupedFields:"*"}],expressionType:"ungrouped_aggregate",code:"coin_count/all(coin_count)",annotation:{notes:[{text:"# percent\n"}]}},{type:"turtle",name:"metrics",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["total_value"]},{type:"fieldref",path:["coin_count"]},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}}],filterList:[],fieldUsage:[{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],defaultOrderBy:!0,orderBy:[{field:"total_value",dir:"desc"}]}],annotation:{}},{type:"turtle",name:"by_type",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["coin_type"]},{type:"fieldref",path:["total_value"],drillView:"metrics"},{type:"fieldref",path:["coin_count"],drillView:"metrics"},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"}],fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],filterList:[]}],annotation:{}}],parameters:{},as:"coins2",arguments:{}}},{type:"fieldReference",definition:{type:"string",name:"color",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'}],caseThen:[{node:"stringLiteral",literal:"copper",sql:"'copper'"}],caseElse:{node:"stringLiteral",literal:"silver",sql:"'silver'"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'copper' when 1\n    else 'silver'"},text:"color"},{type:"fieldReference",definition:{type:"turtle",name:"metrics",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["total_value"]},{type:"fieldref",path:["coin_count"]},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}}],filterList:[],fieldUsage:[{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],defaultOrderBy:!0,orderBy:[{field:"total_value",dir:"desc"}]}],annotation:{}},text:"metrics"}],imports:[]},a.queryResult={lastStageName:"__stage1",malloy:"",sql:'WITH __stage0 AS (\n  SELECT\n    group_set,\n    CASE WHEN group_set=1 THEN\n      CASE WHEN (base."face_value"=1) THEN \'copper\' ELSE \'silver\' END\n      END as "color__1",\n    CASE WHEN group_set=1 THEN\n      COALESCE(SUM(base."face_value"),0)\n      END as "total_value__1",\n    CASE WHEN group_set=1 THEN\n      COUNT(1)\n      END as "coin_count__1",\n    (CASE WHEN group_set=1 THEN\n      COALESCE(SUM(base."face_value"),0)\n      END)*1.0/MAX((CASE WHEN group_set=0 THEN\n      COALESCE(SUM(base."face_value"),0)\n      END)) OVER () as "percent_of_value__1",\n    (CASE WHEN group_set=1 THEN\n      COUNT(1)\n      END)*1.0/MAX((CASE WHEN group_set=0 THEN\n      COUNT(1)\n      END)) OVER () as "percent_of_coins__1"\n  FROM coins.csv as base\n  CROSS JOIN (SELECT UNNEST(GENERATE_SERIES(0,1,1)) as group_set  ) as group_set\n  GROUP BY 1,2\n)\nSELECT\n  "color__1" as "color",\n  MAX(CASE WHEN group_set=1 THEN "total_value__1" END) as "total_value",\n  MAX(CASE WHEN group_set=1 THEN "coin_count__1" END) as "coin_count",\n  MAX(CASE WHEN group_set=1 THEN "percent_of_value__1" END) as "percent_of_value",\n  MAX(CASE WHEN group_set=1 THEN "percent_of_coins__1" END) as "percent_of_coins"\nFROM __stage0\nWHERE group_set NOT IN (0)\nGROUP BY 1\nORDER BY 2 desc NULLS LAST\n',dependenciesToMaterialize:{},structs:[{type:"query_result",name:"__stage1",fields:[{name:"color",type:"string",resultMetadata:{sourceField:"color",sourceExpression:"face_value ? \n    pick 'copper' when 1\n    else 'silver'",sourceClasses:["color"],referenceId:"6926260d-a6a7-4d50-bc5c-ea1f9baea055",fieldKind:"dimension"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:12,character:13},end:{line:14,character:17}}}},{name:"total_value",numberType:"integer",type:"number",resultMetadata:{sourceField:"total_value",sourceExpression:"face_value.sum()",sourceClasses:["total_value"],referenceId:"bdb6a27e-c5a9-426d-b887-3e33574c4774",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:3,character:4},end:{line:3,character:35}}},drillView:"metrics"},{name:"coin_count",numberType:"integer",type:"number",resultMetadata:{sourceField:"coin_count",sourceExpression:"count()",sourceClasses:["coin_count"],referenceId:"19f83548-8152-499c-aa6b-d57c2a70648f",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:2,character:4},end:{line:2,character:25}}},drillView:"metrics"},{name:"percent_of_value",type:"number",resultMetadata:{sourceField:"percent_of_value",sourceExpression:"total_value/all(total_value)",sourceClasses:["percent_of_value"],referenceId:"da7f6fde-7e0d-494d-8ca5-58a8679eb5cf",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:6,character:4},end:{line:7,character:52}}},annotation:{inherits:{notes:[{text:"# percent\n",at:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:6,character:4},end:{line:6,character:14}}}}]}},drillView:"metrics"},{name:"percent_of_coins",type:"number",resultMetadata:{sourceField:"percent_of_coins",sourceExpression:"coin_count/all(coin_count)",sourceClasses:["percent_of_coins"],referenceId:"b589d31f-f63c-4c76-a132-c53b308f428b",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:8,character:4},end:{line:9,character:50}}},annotation:{inherits:{notes:[{text:"# percent\n",at:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:8,character:4},end:{line:8,character:14}}}}]}},drillView:"metrics"}],dialect:"duckdb",primaryKey:"color",connection:"duckdb",resultMetadata:{sourceField:"ignoreme",filterList:[],sourceClasses:["ignoreme"],fieldKind:"struct",drillable:!0}}],sourceExplore:"coins2",sourceArguments:{},connectionName:"duckdb",result:[{color:"silver",total_value:195,coin_count:12,percent_of_value:.9798994974874372,percent_of_coins:.75},{color:"copper",total_value:4,coin_count:4,percent_of_value:.020100502512562814,percent_of_coins:.25}],totalRows:2},e.appendChild(a)})();</script>
      </div>
    </div>
    <div class="result-middle" data-result-kind="json" >
      <div class="result-inner">
        <pre><pre class="language-json" style="background-color: #FBFBFB"><span class="line"><span style="color: #000000">[</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;color&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;silver&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">195</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">12</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.9798994974874372</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_coins&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.75</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;color&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;copper&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.020100502512562814</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_coins&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.25</span></span>
<span class="line"><span style="color: #000000">  }</span></span>
<span class="line"><span style="color: #000000">]</span></span></pre></pre>
      </div>
    </div>
    <div class="result-middle" data-result-kind="sql" >
      <div class="result-inner">
        <pre><pre class="language-sql" style="background-color: #FBFBFB"><span class="line"><span style="color: #0000FF">WITH</span><span style="color: #000000"> __stage0 </span><span style="color: #0000FF">AS</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">SELECT</span></span>
<span class="line"><span style="color: #000000">    group_set,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">1</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;copper&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">ELSE</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;silver&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;color__1&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">),</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;total_value__1&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #098658">1</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_count__1&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    (</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">),</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">)*</span><span style="color: #098658">1</span><span style="color: #000000">.</span><span style="color: #098658">0</span><span style="color: #000000">/</span><span style="color: #795E26">MAX</span><span style="color: #000000">((</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">0</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">),</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">)) </span><span style="color: #0000FF">OVER</span><span style="color: #000000"> () </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_value__1&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    (</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #098658">1</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">)*</span><span style="color: #098658">1</span><span style="color: #000000">.</span><span style="color: #098658">0</span><span style="color: #000000">/</span><span style="color: #795E26">MAX</span><span style="color: #000000">((</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">0</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #098658">1</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">)) </span><span style="color: #0000FF">OVER</span><span style="color: #000000"> () </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_coins__1&quot;</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">FROM</span><span style="color: #000000"> coins.csv </span><span style="color: #0000FF">as</span><span style="color: #000000"> base</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">CROSS</span><span style="color: #000000"> </span><span style="color: #0000FF">JOIN</span><span style="color: #000000"> (</span><span style="color: #0000FF">SELECT</span><span style="color: #000000"> UNNEST(GENERATE_SERIES(</span><span style="color: #098658">0</span><span style="color: #000000">,</span><span style="color: #098658">1</span><span style="color: #000000">,</span><span style="color: #098658">1</span><span style="color: #000000">)) </span><span style="color: #0000FF">as</span><span style="color: #000000"> group_set  ) </span><span style="color: #0000FF">as</span><span style="color: #000000"> group_set</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">GROUP BY</span><span style="color: #000000"> </span><span style="color: #098658">1</span><span style="color: #000000">,</span><span style="color: #098658">2</span></span>
<span class="line"><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">SELECT</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #A31515">&quot;color__1&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;color&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #795E26">MAX</span><span style="color: #000000">(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;total_value__1&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;total_value&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #795E26">MAX</span><span style="color: #000000">(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_count__1&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_count&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #795E26">MAX</span><span style="color: #000000">(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_value__1&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_value&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #795E26">MAX</span><span style="color: #000000">(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_coins__1&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_coins&quot;</span></span>
<span class="line"><span style="color: #0000FF">FROM</span><span style="color: #000000"> __stage0</span></span>
<span class="line"><span style="color: #0000FF">WHERE</span><span style="color: #000000"> group_set </span><span style="color: #0000FF">NOT</span><span style="color: #000000"> </span><span style="color: #0000FF">IN</span><span style="color: #000000"> (</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">GROUP BY</span><span style="color: #000000"> </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #0000FF">ORDER BY</span><span style="color: #000000"> </span><span style="color: #098658">2</span><span style="color: #000000"> </span><span style="color: #0000FF">desc</span><span style="color: #000000"> NULLS </span><span style="color: #0000FF">LAST</span></span>
<span class="line"></span></pre></pre>
      </div>
    </div>
  </div></div>
      <h2>
        <a id="looking-at-data-by-type-is-the-most-common-query-" class="header-link anchor" href="#looking-at-data-by-type-is-the-most-common-query-">
          Looking at data by type is the most common query.
        </a>
      </h2>
    <p>Often with a dataset, we might want to commonly look at the data in a particular way.  In this case, we probably want to look at coins by coin_type so we've built a <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">by_type</span></span></code> view.</p>
<div class="code-wrapper"><a href="https://github.dev/malloydata/malloydata.github.io/blob/main/src/blog/2023-11-04-data-for-kindergarten/index.malloynb#C28" target="_blank" class="open_notebook"><img src="/img/open_notebook.svg" alt="document"/></a><pre class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">run</span><span style="color: #000000">: </span><span style="color: #001080">coins2</span><span style="color: #000000"> -&gt; </span><span style="color: #001080">by_type</span></span></pre><div class="result-outer small">
    <div class="result-controls-bar">
      <span class="result-label">QUERY RESULTS</span>
      <div class="result-controls">
        <button class="result-control" selected data-result-kind="html">HTML</button>
        <button class="result-control"  data-result-kind="json">JSON</button>
        <button class="result-control"  data-result-kind="sql">SQL</button>
      </div>
    </div>
    <div class="result-middle" data-result-kind="html" selected>
      <div class="result-inner" id="85aeee7e-e5bb-412a-b259-d49330d954a9">
        <script>(()=>{var e=document.getElementById("85aeee7e-e5bb-412a-b259-d49330d954a9"),a=document.createElement("malloy-render");a.modelDef={name:"",exports:["coins","coins2"],contents:{coins:{type:"table",name:"duckdb:coins.csv",dialect:"duckdb",tablePath:"coins.csv",connection:"duckdb",fields:[{type:"number",numberType:"integer",name:"face_value",fieldUsage:[{path:["face_value"]}]},{type:"number",numberType:"integer",name:"minted_year",fieldUsage:[{path:["minted_year"]}]},{type:"number",numberType:"integer",name:"coin_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},{type:"number",numberType:"integer",name:"total_value",e:{node:"aggregate",function:"sum",e:{node:"field",path:["face_value"]}},fieldUsage:[{path:["face_value"]}],expressionType:"aggregate",code:"face_value.sum()"},{type:"string",name:"coin_type",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"5",sql:"5"}},sql:'(base."face_value"=5)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"10",sql:"10"}},sql:'(base."face_value"=10)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"25",sql:"25"}},sql:'(base."face_value"=25)'}],caseThen:[{node:"stringLiteral",literal:"penny",sql:"'penny'"},{node:"stringLiteral",literal:"nickle",sql:"'nickle'"},{node:"stringLiteral",literal:"dime",sql:"'dime'"},{node:"stringLiteral",literal:"quarter",sql:"'quarter'"}],caseElse:{node:"null",sql:"NULL"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null"},{type:"string",name:"color",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'}],caseThen:[{node:"stringLiteral",literal:"copper",sql:"'copper'"}],caseElse:{node:"stringLiteral",literal:"silver",sql:"'silver'"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'copper' when 1\n    else 'silver'"}],parameters:{},as:"coins"},coins2:{type:"table",name:"duckdb:coins.csv",dialect:"duckdb",tablePath:"coins.csv",connection:"duckdb",fields:[{type:"number",numberType:"integer",name:"face_value",fieldUsage:[{path:["face_value"]}]},{type:"number",numberType:"integer",name:"minted_year",fieldUsage:[{path:["minted_year"]}]},{type:"number",numberType:"integer",name:"coin_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},{type:"number",numberType:"integer",name:"total_value",e:{node:"aggregate",function:"sum",e:{node:"field",path:["face_value"]}},fieldUsage:[{path:["face_value"]}],expressionType:"aggregate",code:"face_value.sum()"},{type:"string",name:"coin_type",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"5",sql:"5"}},sql:'(base."face_value"=5)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"10",sql:"10"}},sql:'(base."face_value"=10)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"25",sql:"25"}},sql:'(base."face_value"=25)'}],caseThen:[{node:"stringLiteral",literal:"penny",sql:"'penny'"},{node:"stringLiteral",literal:"nickle",sql:"'nickle'"},{node:"stringLiteral",literal:"dime",sql:"'dime'"},{node:"stringLiteral",literal:"quarter",sql:"'quarter'"}],caseElse:{node:"null",sql:"NULL"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null"},{type:"string",name:"color",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'}],caseThen:[{node:"stringLiteral",literal:"copper",sql:"'copper'"}],caseElse:{node:"stringLiteral",literal:"silver",sql:"'silver'"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'copper' when 1\n    else 'silver'"},{type:"boolean",name:"is_new",e:{node:">=",kids:{left:{node:"field",path:["minted_year"]},right:{node:"numberLiteral",literal:"2000"}}},fieldUsage:[{path:["minted_year"]}],expressionType:"scalar",code:"minted_year >= 2000"},{type:"number",name:"minted_decade",e:{node:"*",kids:{left:{node:"function_call",overload:{returnType:{type:"number",expressionType:"scalar",evalSpace:"input"},params:[{name:"value",allowedTypes:[{type:"number",evalSpace:"input"}],isVariadic:!1}],dialect:{postgres:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},standardsql:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},duckdb:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},snowflake:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},trino:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},presto:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},mysql:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}}}},name:"floor",kids:{args:[{node:"/",kids:{left:{node:"field",path:["minted_year"]},right:{node:"numberLiteral",literal:"10"}}}]},expressionType:"scalar"},right:{node:"numberLiteral",literal:"10"}}},fieldUsage:[{path:["minted_year"]}],expressionType:"scalar",code:"floor(minted_year/10) * 10"},{type:"number",name:"percent_of_value",e:{node:"/",kids:{left:{node:"field",path:["total_value"],sql:'(CASE WHEN group_set=1 THEN\n  COALESCE(SUM(base."face_value"),0)\n  END)'},right:{node:"all",e:{node:"field",path:["total_value"]},sql:'MAX((CASE WHEN group_set=0 THEN\n  COALESCE(SUM(base."face_value"),0)\n  END)) OVER ()'}}},fieldUsage:[{path:["total_value"]},{path:["total_value"]}],ungroupings:[{requiresGroupBy:[],fieldUsage:[{path:["total_value"]}],ungroupedFields:"*"}],expressionType:"ungrouped_aggregate",code:"total_value/all(total_value)",annotation:{notes:[{text:"# percent\n"}]}},{type:"number",name:"percent_of_coins",e:{node:"/",kids:{left:{node:"field",path:["coin_count"],sql:"(CASE WHEN group_set=1 THEN\n  COUNT(1)\n  END)"},right:{node:"all",e:{node:"field",path:["coin_count"]},sql:"MAX((CASE WHEN group_set=0 THEN\n  COUNT(1)\n  END)) OVER ()"}}},fieldUsage:[{path:["coin_count"]},{path:["coin_count"]}],ungroupings:[{requiresGroupBy:[],fieldUsage:[{path:["coin_count"]}],ungroupedFields:"*"}],expressionType:"ungrouped_aggregate",code:"coin_count/all(coin_count)",annotation:{notes:[{text:"# percent\n"}]}},{type:"turtle",name:"metrics",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["total_value"]},{type:"fieldref",path:["coin_count"]},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}}],filterList:[],fieldUsage:[{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],defaultOrderBy:!0,orderBy:[{field:"total_value",dir:"desc"}]}],annotation:{}},{type:"turtle",name:"by_type",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["coin_type"]},{type:"fieldref",path:["total_value"],drillView:"metrics"},{type:"fieldref",path:["coin_count"],drillView:"metrics"},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"}],fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],filterList:[]}],annotation:{}}],parameters:{},as:"coins2",arguments:{}}},queryList:[{type:"query",structRef:"coins2",sourceArguments:{},pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["coin_type"],drillView:"by_type"},{type:"fieldref",path:["total_value"],drillView:"by_type"},{type:"fieldref",path:["coin_count"],drillView:"by_type"},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"by_type"},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"by_type"}],fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],filterList:[],referencedAt:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:0,character:15},end:{line:0,character:22}}}}],name:"by_type",annotation:{inherits:{}}}],dependencies:{},references:[{type:"exploreReference",text:"coins2",definition:{type:"table",name:"duckdb:coins.csv",dialect:"duckdb",tablePath:"coins.csv",connection:"duckdb",fields:[{type:"number",numberType:"integer",name:"face_value",fieldUsage:[{path:["face_value"]}]},{type:"number",numberType:"integer",name:"minted_year",fieldUsage:[{path:["minted_year"]}]},{type:"number",numberType:"integer",name:"coin_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},{type:"number",numberType:"integer",name:"total_value",e:{node:"aggregate",function:"sum",e:{node:"field",path:["face_value"]}},fieldUsage:[{path:["face_value"]}],expressionType:"aggregate",code:"face_value.sum()"},{type:"string",name:"coin_type",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"5",sql:"5"}},sql:'(base."face_value"=5)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"10",sql:"10"}},sql:'(base."face_value"=10)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"25",sql:"25"}},sql:'(base."face_value"=25)'}],caseThen:[{node:"stringLiteral",literal:"penny",sql:"'penny'"},{node:"stringLiteral",literal:"nickle",sql:"'nickle'"},{node:"stringLiteral",literal:"dime",sql:"'dime'"},{node:"stringLiteral",literal:"quarter",sql:"'quarter'"}],caseElse:{node:"null",sql:"NULL"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null"},{type:"string",name:"color",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'}],caseThen:[{node:"stringLiteral",literal:"copper",sql:"'copper'"}],caseElse:{node:"stringLiteral",literal:"silver",sql:"'silver'"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'copper' when 1\n    else 'silver'"},{type:"boolean",name:"is_new",e:{node:">=",kids:{left:{node:"field",path:["minted_year"]},right:{node:"numberLiteral",literal:"2000"}}},fieldUsage:[{path:["minted_year"]}],expressionType:"scalar",code:"minted_year >= 2000"},{type:"number",name:"minted_decade",e:{node:"*",kids:{left:{node:"function_call",overload:{returnType:{type:"number",expressionType:"scalar",evalSpace:"input"},params:[{name:"value",allowedTypes:[{type:"number",evalSpace:"input"}],isVariadic:!1}],dialect:{postgres:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},standardsql:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},duckdb:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},snowflake:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},trino:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},presto:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},mysql:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}}}},name:"floor",kids:{args:[{node:"/",kids:{left:{node:"field",path:["minted_year"]},right:{node:"numberLiteral",literal:"10"}}}]},expressionType:"scalar"},right:{node:"numberLiteral",literal:"10"}}},fieldUsage:[{path:["minted_year"]}],expressionType:"scalar",code:"floor(minted_year/10) * 10"},{type:"number",name:"percent_of_value",e:{node:"/",kids:{left:{node:"field",path:["total_value"],sql:'(CASE WHEN group_set=1 THEN\n  COALESCE(SUM(base."face_value"),0)\n  END)'},right:{node:"all",e:{node:"field",path:["total_value"]},sql:'MAX((CASE WHEN group_set=0 THEN\n  COALESCE(SUM(base."face_value"),0)\n  END)) OVER ()'}}},fieldUsage:[{path:["total_value"]},{path:["total_value"]}],ungroupings:[{requiresGroupBy:[],fieldUsage:[{path:["total_value"]}],ungroupedFields:"*"}],expressionType:"ungrouped_aggregate",code:"total_value/all(total_value)",annotation:{notes:[{text:"# percent\n"}]}},{type:"number",name:"percent_of_coins",e:{node:"/",kids:{left:{node:"field",path:["coin_count"],sql:"(CASE WHEN group_set=1 THEN\n  COUNT(1)\n  END)"},right:{node:"all",e:{node:"field",path:["coin_count"]},sql:"MAX((CASE WHEN group_set=0 THEN\n  COUNT(1)\n  END)) OVER ()"}}},fieldUsage:[{path:["coin_count"]},{path:["coin_count"]}],ungroupings:[{requiresGroupBy:[],fieldUsage:[{path:["coin_count"]}],ungroupedFields:"*"}],expressionType:"ungrouped_aggregate",code:"coin_count/all(coin_count)",annotation:{notes:[{text:"# percent\n"}]}},{type:"turtle",name:"metrics",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["total_value"]},{type:"fieldref",path:["coin_count"]},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}}],filterList:[],fieldUsage:[{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],defaultOrderBy:!0,orderBy:[{field:"total_value",dir:"desc"}]}],annotation:{}},{type:"turtle",name:"by_type",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["coin_type"]},{type:"fieldref",path:["total_value"],drillView:"metrics"},{type:"fieldref",path:["coin_count"],drillView:"metrics"},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"}],fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],filterList:[]}],annotation:{}}],parameters:{},as:"coins2",arguments:{}}},{type:"fieldReference",definition:{type:"turtle",name:"by_type",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["coin_type"]},{type:"fieldref",path:["total_value"],drillView:"metrics"},{type:"fieldref",path:["coin_count"],drillView:"metrics"},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"}],fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],filterList:[]}],annotation:{}},text:"by_type"}],imports:[]},a.queryResult={lastStageName:"__stage1",malloy:"",sql:'WITH __stage0 AS (\n  SELECT\n    group_set,\n    CASE WHEN group_set=1 THEN\n      CASE WHEN (base."face_value"=1) THEN \'penny\' WHEN (base."face_value"=5) THEN \'nickle\' WHEN (base."face_value"=10) THEN \'dime\' WHEN (base."face_value"=25) THEN \'quarter\' ELSE NULL END\n      END as "coin_type__1",\n    CASE WHEN group_set=1 THEN\n      COALESCE(SUM(base."face_value"),0)\n      END as "total_value__1",\n    CASE WHEN group_set=1 THEN\n      COUNT(1)\n      END as "coin_count__1",\n    (CASE WHEN group_set=1 THEN\n      COALESCE(SUM(base."face_value"),0)\n      END)*1.0/MAX((CASE WHEN group_set=0 THEN\n      COALESCE(SUM(base."face_value"),0)\n      END)) OVER () as "percent_of_value__1",\n    (CASE WHEN group_set=1 THEN\n      COUNT(1)\n      END)*1.0/MAX((CASE WHEN group_set=0 THEN\n      COUNT(1)\n      END)) OVER () as "percent_of_coins__1"\n  FROM coins.csv as base\n  CROSS JOIN (SELECT UNNEST(GENERATE_SERIES(0,1,1)) as group_set  ) as group_set\n  GROUP BY 1,2\n)\nSELECT\n  "coin_type__1" as "coin_type",\n  MAX(CASE WHEN group_set=1 THEN "total_value__1" END) as "total_value",\n  MAX(CASE WHEN group_set=1 THEN "coin_count__1" END) as "coin_count",\n  MAX(CASE WHEN group_set=1 THEN "percent_of_value__1" END) as "percent_of_value",\n  MAX(CASE WHEN group_set=1 THEN "percent_of_coins__1" END) as "percent_of_coins"\nFROM __stage0\nWHERE group_set NOT IN (0)\nGROUP BY 1\nORDER BY 2 desc NULLS LAST\n',dependenciesToMaterialize:{},structs:[{type:"query_result",name:"__stage1",fields:[{name:"coin_type",type:"string",resultMetadata:{sourceField:"coin_type",sourceExpression:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null",sourceClasses:["coin_type"],referenceId:"e9b6b3a3-d278-4903-8196-8f28a8e64c32",fieldKind:"dimension"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:5,character:13},end:{line:10,character:13}}},drillView:"by_type"},{name:"total_value",numberType:"integer",type:"number",resultMetadata:{sourceField:"total_value",sourceExpression:"face_value.sum()",sourceClasses:["total_value"],referenceId:"f0fe3f03-89fe-4f28-936f-0a0e2ed6857f",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:3,character:4},end:{line:3,character:35}}},drillView:"by_type"},{name:"coin_count",numberType:"integer",type:"number",resultMetadata:{sourceField:"coin_count",sourceExpression:"count()",sourceClasses:["coin_count"],referenceId:"69030cfd-798f-4c22-9036-3502f614d266",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:2,character:4},end:{line:2,character:25}}},drillView:"by_type"},{name:"percent_of_value",type:"number",resultMetadata:{sourceField:"percent_of_value",sourceExpression:"total_value/all(total_value)",sourceClasses:["percent_of_value"],referenceId:"2f35f456-80a7-4e48-b6b1-f40f07507a8b",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:6,character:4},end:{line:7,character:52}}},annotation:{inherits:{notes:[{text:"# percent\n",at:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:6,character:4},end:{line:6,character:14}}}}]}},drillView:"by_type"},{name:"percent_of_coins",type:"number",resultMetadata:{sourceField:"percent_of_coins",sourceExpression:"coin_count/all(coin_count)",sourceClasses:["percent_of_coins"],referenceId:"f94841cd-fe56-4607-aa89-c062f3eecd53",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:8,character:4},end:{line:9,character:50}}},annotation:{inherits:{notes:[{text:"# percent\n",at:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:8,character:4},end:{line:8,character:14}}}}]}},drillView:"by_type"}],dialect:"duckdb",primaryKey:"coin_type",connection:"duckdb",resultMetadata:{sourceField:"ignoreme",filterList:[],sourceClasses:["ignoreme"],fieldKind:"struct",drillable:!0}}],sourceExplore:"coins2",sourceArguments:{},queryName:"by_type",connectionName:"duckdb",annotation:{inherits:{}},result:[{coin_type:"quarter",total_value:150,coin_count:6,percent_of_value:.7537688442211056,percent_of_coins:.375},{coin_type:"dime",total_value:30,coin_count:3,percent_of_value:.1507537688442211,percent_of_coins:.1875},{coin_type:"nickle",total_value:15,coin_count:3,percent_of_value:.07537688442211055,percent_of_coins:.1875},{coin_type:"penny",total_value:4,coin_count:4,percent_of_value:.020100502512562814,percent_of_coins:.25}],totalRows:4},e.appendChild(a)})();</script>
      </div>
    </div>
    <div class="result-middle" data-result-kind="json" >
      <div class="result-inner">
        <pre><pre class="language-json" style="background-color: #FBFBFB"><span class="line"><span style="color: #000000">[</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;quarter&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">150</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">6</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.7537688442211056</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_coins&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.375</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;dime&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">30</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.1507537688442211</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_coins&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.1875</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;nickle&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">15</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.07537688442211055</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_coins&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.1875</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;penny&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.020100502512562814</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_coins&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.25</span></span>
<span class="line"><span style="color: #000000">  }</span></span>
<span class="line"><span style="color: #000000">]</span></span></pre></pre>
      </div>
    </div>
    <div class="result-middle" data-result-kind="sql" >
      <div class="result-inner">
        <pre><pre class="language-sql" style="background-color: #FBFBFB"><span class="line"><span style="color: #0000FF">WITH</span><span style="color: #000000"> __stage0 </span><span style="color: #0000FF">AS</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">SELECT</span></span>
<span class="line"><span style="color: #000000">    group_set,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">1</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;penny&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">5</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;nickle&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">10</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;dime&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">25</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;quarter&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">ELSE</span><span style="color: #000000"> </span><span style="color: #0000FF">NULL</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_type__1&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">),</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;total_value__1&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #098658">1</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_count__1&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    (</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">),</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">)*</span><span style="color: #098658">1</span><span style="color: #000000">.</span><span style="color: #098658">0</span><span style="color: #000000">/</span><span style="color: #795E26">MAX</span><span style="color: #000000">((</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">0</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">),</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">)) </span><span style="color: #0000FF">OVER</span><span style="color: #000000"> () </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_value__1&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    (</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #098658">1</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">)*</span><span style="color: #098658">1</span><span style="color: #000000">.</span><span style="color: #098658">0</span><span style="color: #000000">/</span><span style="color: #795E26">MAX</span><span style="color: #000000">((</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">0</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #098658">1</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">)) </span><span style="color: #0000FF">OVER</span><span style="color: #000000"> () </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_coins__1&quot;</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">FROM</span><span style="color: #000000"> coins.csv </span><span style="color: #0000FF">as</span><span style="color: #000000"> base</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">CROSS</span><span style="color: #000000"> </span><span style="color: #0000FF">JOIN</span><span style="color: #000000"> (</span><span style="color: #0000FF">SELECT</span><span style="color: #000000"> UNNEST(GENERATE_SERIES(</span><span style="color: #098658">0</span><span style="color: #000000">,</span><span style="color: #098658">1</span><span style="color: #000000">,</span><span style="color: #098658">1</span><span style="color: #000000">)) </span><span style="color: #0000FF">as</span><span style="color: #000000"> group_set  ) </span><span style="color: #0000FF">as</span><span style="color: #000000"> group_set</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">GROUP BY</span><span style="color: #000000"> </span><span style="color: #098658">1</span><span style="color: #000000">,</span><span style="color: #098658">2</span></span>
<span class="line"><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">SELECT</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #A31515">&quot;coin_type__1&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_type&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #795E26">MAX</span><span style="color: #000000">(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;total_value__1&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;total_value&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #795E26">MAX</span><span style="color: #000000">(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_count__1&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_count&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #795E26">MAX</span><span style="color: #000000">(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_value__1&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_value&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #795E26">MAX</span><span style="color: #000000">(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_coins__1&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_coins&quot;</span></span>
<span class="line"><span style="color: #0000FF">FROM</span><span style="color: #000000"> __stage0</span></span>
<span class="line"><span style="color: #0000FF">WHERE</span><span style="color: #000000"> group_set </span><span style="color: #0000FF">NOT</span><span style="color: #000000"> </span><span style="color: #0000FF">IN</span><span style="color: #000000"> (</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">GROUP BY</span><span style="color: #000000"> </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #0000FF">ORDER BY</span><span style="color: #000000"> </span><span style="color: #098658">2</span><span style="color: #000000"> </span><span style="color: #0000FF">desc</span><span style="color: #000000"> NULLS </span><span style="color: #0000FF">LAST</span></span>
<span class="line"></span></pre></pre>
      </div>
    </div>
  </div></div>
      <h2>
        <a id="we-can-add-filters-to-any-query" class="header-link anchor" href="#we-can-add-filters-to-any-query">
          We can add filters to any query
        </a>
      </h2>
    <p>Adding filters let us look at subsets of the data.  In this case we are looking at coins minted this century.</p>
<div class="code-wrapper"><a href="https://github.dev/malloydata/malloydata.github.io/blob/main/src/blog/2023-11-04-data-for-kindergarten/index.malloynb#C30" target="_blank" class="open_notebook"><img src="/img/open_notebook.svg" alt="document"/></a><pre class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">run</span><span style="color: #000000">: </span><span style="color: #001080">coins2</span><span style="color: #000000"> -&gt; </span><span style="color: #001080">by_type</span><span style="color: #000000"> + {</span><span style="color: #AF00DB">where</span><span style="color: #000000">: </span><span style="color: #001080">is_new</span><span style="color: #000000">}</span></span></pre><div class="result-outer small">
    <div class="result-controls-bar">
      <span class="result-label">QUERY RESULTS</span>
      <div class="result-controls">
        <button class="result-control" selected data-result-kind="html">HTML</button>
        <button class="result-control"  data-result-kind="json">JSON</button>
        <button class="result-control"  data-result-kind="sql">SQL</button>
      </div>
    </div>
    <div class="result-middle" data-result-kind="html" selected>
      <div class="result-inner" id="f6e3567c-c0a7-470e-8015-002ae949da17">
        <script>(()=>{var e=document.getElementById("f6e3567c-c0a7-470e-8015-002ae949da17"),a=document.createElement("malloy-render");a.modelDef={name:"",exports:["coins","coins2"],contents:{coins:{type:"table",name:"duckdb:coins.csv",dialect:"duckdb",tablePath:"coins.csv",connection:"duckdb",fields:[{type:"number",numberType:"integer",name:"face_value",fieldUsage:[{path:["face_value"]}]},{type:"number",numberType:"integer",name:"minted_year",fieldUsage:[{path:["minted_year"]}]},{type:"number",numberType:"integer",name:"coin_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},{type:"number",numberType:"integer",name:"total_value",e:{node:"aggregate",function:"sum",e:{node:"field",path:["face_value"]}},fieldUsage:[{path:["face_value"]}],expressionType:"aggregate",code:"face_value.sum()"},{type:"string",name:"coin_type",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"5",sql:"5"}},sql:'(base."face_value"=5)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"10",sql:"10"}},sql:'(base."face_value"=10)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"25",sql:"25"}},sql:'(base."face_value"=25)'}],caseThen:[{node:"stringLiteral",literal:"penny",sql:"'penny'"},{node:"stringLiteral",literal:"nickle",sql:"'nickle'"},{node:"stringLiteral",literal:"dime",sql:"'dime'"},{node:"stringLiteral",literal:"quarter",sql:"'quarter'"}],caseElse:{node:"null",sql:"NULL"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null"},{type:"string",name:"color",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'}],caseThen:[{node:"stringLiteral",literal:"copper",sql:"'copper'"}],caseElse:{node:"stringLiteral",literal:"silver",sql:"'silver'"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'copper' when 1\n    else 'silver'"}],parameters:{},as:"coins"},coins2:{type:"table",name:"duckdb:coins.csv",dialect:"duckdb",tablePath:"coins.csv",connection:"duckdb",fields:[{type:"number",numberType:"integer",name:"face_value",fieldUsage:[{path:["face_value"]}]},{type:"number",numberType:"integer",name:"minted_year",fieldUsage:[{path:["minted_year"]}]},{type:"number",numberType:"integer",name:"coin_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},{type:"number",numberType:"integer",name:"total_value",e:{node:"aggregate",function:"sum",e:{node:"field",path:["face_value"]}},fieldUsage:[{path:["face_value"]}],expressionType:"aggregate",code:"face_value.sum()"},{type:"string",name:"coin_type",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"5",sql:"5"}},sql:'(base."face_value"=5)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"10",sql:"10"}},sql:'(base."face_value"=10)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"25",sql:"25"}},sql:'(base."face_value"=25)'}],caseThen:[{node:"stringLiteral",literal:"penny",sql:"'penny'"},{node:"stringLiteral",literal:"nickle",sql:"'nickle'"},{node:"stringLiteral",literal:"dime",sql:"'dime'"},{node:"stringLiteral",literal:"quarter",sql:"'quarter'"}],caseElse:{node:"null",sql:"NULL"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null"},{type:"string",name:"color",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'}],caseThen:[{node:"stringLiteral",literal:"copper",sql:"'copper'"}],caseElse:{node:"stringLiteral",literal:"silver",sql:"'silver'"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'copper' when 1\n    else 'silver'"},{type:"boolean",name:"is_new",e:{node:">=",kids:{left:{node:"field",path:["minted_year"],sql:'base."minted_year"'},right:{node:"numberLiteral",literal:"2000",sql:"2000"}}},fieldUsage:[{path:["minted_year"]}],expressionType:"scalar",code:"minted_year >= 2000"},{type:"number",name:"minted_decade",e:{node:"*",kids:{left:{node:"function_call",overload:{returnType:{type:"number",expressionType:"scalar",evalSpace:"input"},params:[{name:"value",allowedTypes:[{type:"number",evalSpace:"input"}],isVariadic:!1}],dialect:{postgres:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},standardsql:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},duckdb:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},snowflake:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},trino:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},presto:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},mysql:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}}}},name:"floor",kids:{args:[{node:"/",kids:{left:{node:"field",path:["minted_year"]},right:{node:"numberLiteral",literal:"10"}}}]},expressionType:"scalar"},right:{node:"numberLiteral",literal:"10"}}},fieldUsage:[{path:["minted_year"]}],expressionType:"scalar",code:"floor(minted_year/10) * 10"},{type:"number",name:"percent_of_value",e:{node:"/",kids:{left:{node:"field",path:["total_value"],sql:'(CASE WHEN group_set=1 THEN\n  COALESCE(SUM(base."face_value"),0)\n  END)'},right:{node:"all",e:{node:"field",path:["total_value"]},sql:'MAX((CASE WHEN group_set=0 THEN\n  COALESCE(SUM(base."face_value"),0)\n  END)) OVER ()'}}},fieldUsage:[{path:["total_value"]},{path:["total_value"]}],ungroupings:[{requiresGroupBy:[],fieldUsage:[{path:["total_value"]}],ungroupedFields:"*"}],expressionType:"ungrouped_aggregate",code:"total_value/all(total_value)",annotation:{notes:[{text:"# percent\n"}]}},{type:"number",name:"percent_of_coins",e:{node:"/",kids:{left:{node:"field",path:["coin_count"],sql:"(CASE WHEN group_set=1 THEN\n  COUNT(1)\n  END)"},right:{node:"all",e:{node:"field",path:["coin_count"]},sql:"MAX((CASE WHEN group_set=0 THEN\n  COUNT(1)\n  END)) OVER ()"}}},fieldUsage:[{path:["coin_count"]},{path:["coin_count"]}],ungroupings:[{requiresGroupBy:[],fieldUsage:[{path:["coin_count"]}],ungroupedFields:"*"}],expressionType:"ungrouped_aggregate",code:"coin_count/all(coin_count)",annotation:{notes:[{text:"# percent\n"}]}},{type:"turtle",name:"metrics",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["total_value"]},{type:"fieldref",path:["coin_count"]},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}}],filterList:[],fieldUsage:[{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],defaultOrderBy:!0,orderBy:[{field:"total_value",dir:"desc"}]}],annotation:{}},{type:"turtle",name:"by_type",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["coin_type"]},{type:"fieldref",path:["total_value"],drillView:"metrics"},{type:"fieldref",path:["coin_count"],drillView:"metrics"},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"}],fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],filterList:[]}],annotation:{}}],parameters:{},as:"coins2",arguments:{}}},queryList:[{type:"query",structRef:"coins2",sourceArguments:{},pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["coin_type"],drillView:"by_type"},{type:"fieldref",path:["total_value"],drillView:"by_type"},{type:"fieldref",path:["coin_count"],drillView:"by_type"},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"by_type"},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"by_type"}],filterList:[{node:"filterCondition",code:"is_new",e:{node:"field",path:["is_new"]},expressionType:"scalar",fieldUsage:[{path:["is_new"]}]}],fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]},{path:["is_new"]}],defaultOrderBy:!0,orderBy:[{field:"total_value",dir:"desc"}]}],annotation:{inherits:{}}}],dependencies:{},references:[{type:"exploreReference",text:"coins2",definition:{type:"table",name:"duckdb:coins.csv",dialect:"duckdb",tablePath:"coins.csv",connection:"duckdb",fields:[{type:"number",numberType:"integer",name:"face_value",fieldUsage:[{path:["face_value"]}]},{type:"number",numberType:"integer",name:"minted_year",fieldUsage:[{path:["minted_year"]}]},{type:"number",numberType:"integer",name:"coin_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},{type:"number",numberType:"integer",name:"total_value",e:{node:"aggregate",function:"sum",e:{node:"field",path:["face_value"]}},fieldUsage:[{path:["face_value"]}],expressionType:"aggregate",code:"face_value.sum()"},{type:"string",name:"coin_type",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"5",sql:"5"}},sql:'(base."face_value"=5)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"10",sql:"10"}},sql:'(base."face_value"=10)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"25",sql:"25"}},sql:'(base."face_value"=25)'}],caseThen:[{node:"stringLiteral",literal:"penny",sql:"'penny'"},{node:"stringLiteral",literal:"nickle",sql:"'nickle'"},{node:"stringLiteral",literal:"dime",sql:"'dime'"},{node:"stringLiteral",literal:"quarter",sql:"'quarter'"}],caseElse:{node:"null",sql:"NULL"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null"},{type:"string",name:"color",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'}],caseThen:[{node:"stringLiteral",literal:"copper",sql:"'copper'"}],caseElse:{node:"stringLiteral",literal:"silver",sql:"'silver'"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'copper' when 1\n    else 'silver'"},{type:"boolean",name:"is_new",e:{node:">=",kids:{left:{node:"field",path:["minted_year"]},right:{node:"numberLiteral",literal:"2000"}}},fieldUsage:[{path:["minted_year"]}],expressionType:"scalar",code:"minted_year >= 2000"},{type:"number",name:"minted_decade",e:{node:"*",kids:{left:{node:"function_call",overload:{returnType:{type:"number",expressionType:"scalar",evalSpace:"input"},params:[{name:"value",allowedTypes:[{type:"number",evalSpace:"input"}],isVariadic:!1}],dialect:{postgres:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},standardsql:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},duckdb:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},snowflake:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},trino:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},presto:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},mysql:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}}}},name:"floor",kids:{args:[{node:"/",kids:{left:{node:"field",path:["minted_year"]},right:{node:"numberLiteral",literal:"10"}}}]},expressionType:"scalar"},right:{node:"numberLiteral",literal:"10"}}},fieldUsage:[{path:["minted_year"]}],expressionType:"scalar",code:"floor(minted_year/10) * 10"},{type:"number",name:"percent_of_value",e:{node:"/",kids:{left:{node:"field",path:["total_value"],sql:'(CASE WHEN group_set=1 THEN\n  COALESCE(SUM(base."face_value"),0)\n  END)'},right:{node:"all",e:{node:"field",path:["total_value"]},sql:'MAX((CASE WHEN group_set=0 THEN\n  COALESCE(SUM(base."face_value"),0)\n  END)) OVER ()'}}},fieldUsage:[{path:["total_value"]},{path:["total_value"]}],ungroupings:[{requiresGroupBy:[],fieldUsage:[{path:["total_value"]}],ungroupedFields:"*"}],expressionType:"ungrouped_aggregate",code:"total_value/all(total_value)",annotation:{notes:[{text:"# percent\n"}]}},{type:"number",name:"percent_of_coins",e:{node:"/",kids:{left:{node:"field",path:["coin_count"],sql:"(CASE WHEN group_set=1 THEN\n  COUNT(1)\n  END)"},right:{node:"all",e:{node:"field",path:["coin_count"]},sql:"MAX((CASE WHEN group_set=0 THEN\n  COUNT(1)\n  END)) OVER ()"}}},fieldUsage:[{path:["coin_count"]},{path:["coin_count"]}],ungroupings:[{requiresGroupBy:[],fieldUsage:[{path:["coin_count"]}],ungroupedFields:"*"}],expressionType:"ungrouped_aggregate",code:"coin_count/all(coin_count)",annotation:{notes:[{text:"# percent\n"}]}},{type:"turtle",name:"metrics",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["total_value"]},{type:"fieldref",path:["coin_count"]},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}}],filterList:[],fieldUsage:[{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],defaultOrderBy:!0,orderBy:[{field:"total_value",dir:"desc"}]}],annotation:{}},{type:"turtle",name:"by_type",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["coin_type"]},{type:"fieldref",path:["total_value"],drillView:"metrics"},{type:"fieldref",path:["coin_count"],drillView:"metrics"},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"}],fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],filterList:[]}],annotation:{}}],parameters:{},as:"coins2",arguments:{}}},{type:"fieldReference",definition:{type:"turtle",name:"by_type",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["coin_type"]},{type:"fieldref",path:["total_value"],drillView:"metrics"},{type:"fieldref",path:["coin_count"],drillView:"metrics"},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"}],fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],filterList:[]}],annotation:{}},text:"by_type"},{type:"fieldReference",definition:{type:"boolean",name:"is_new",e:{node:">=",kids:{left:{node:"field",path:["minted_year"]},right:{node:"numberLiteral",literal:"2000"}}},fieldUsage:[{path:["minted_year"]}],expressionType:"scalar",code:"minted_year >= 2000"},text:"is_new"}],imports:[]},a.queryResult={lastStageName:"__stage1",malloy:"",sql:'WITH __stage0 AS (\n  SELECT\n    group_set,\n    CASE WHEN group_set=1 THEN\n      CASE WHEN (base."face_value"=1) THEN \'penny\' WHEN (base."face_value"=5) THEN \'nickle\' WHEN (base."face_value"=10) THEN \'dime\' WHEN (base."face_value"=25) THEN \'quarter\' ELSE NULL END\n      END as "coin_type__1",\n    CASE WHEN group_set=1 THEN\n      COALESCE(SUM(base."face_value"),0)\n      END as "total_value__1",\n    CASE WHEN group_set=1 THEN\n      COUNT(1)\n      END as "coin_count__1",\n    (CASE WHEN group_set=1 THEN\n      COALESCE(SUM(base."face_value"),0)\n      END)*1.0/MAX((CASE WHEN group_set=0 THEN\n      COALESCE(SUM(base."face_value"),0)\n      END)) OVER () as "percent_of_value__1",\n    (CASE WHEN group_set=1 THEN\n      COUNT(1)\n      END)*1.0/MAX((CASE WHEN group_set=0 THEN\n      COUNT(1)\n      END)) OVER () as "percent_of_coins__1"\n  FROM coins.csv as base\n  CROSS JOIN (SELECT UNNEST(GENERATE_SERIES(0,1,1)) as group_set  ) as group_set\n  WHERE (base."minted_year">=2000)\n  GROUP BY 1,2\n)\nSELECT\n  "coin_type__1" as "coin_type",\n  MAX(CASE WHEN group_set=1 THEN "total_value__1" END) as "total_value",\n  MAX(CASE WHEN group_set=1 THEN "coin_count__1" END) as "coin_count",\n  MAX(CASE WHEN group_set=1 THEN "percent_of_value__1" END) as "percent_of_value",\n  MAX(CASE WHEN group_set=1 THEN "percent_of_coins__1" END) as "percent_of_coins"\nFROM __stage0\nWHERE group_set NOT IN (0)\nGROUP BY 1\nORDER BY 2 desc NULLS LAST\n',dependenciesToMaterialize:{},structs:[{type:"query_result",name:"__stage1",fields:[{name:"coin_type",type:"string",resultMetadata:{sourceField:"coin_type",sourceExpression:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null",sourceClasses:["coin_type"],referenceId:"5d1ec8c8-6965-4bc4-8880-fe95b6baff1b",fieldKind:"dimension"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:5,character:13},end:{line:10,character:13}}},drillView:"by_type"},{name:"total_value",numberType:"integer",type:"number",resultMetadata:{sourceField:"total_value",sourceExpression:"face_value.sum()",sourceClasses:["total_value"],referenceId:"f7566f67-e416-4db5-aa8f-5792614d481f",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:3,character:4},end:{line:3,character:35}}},drillView:"by_type"},{name:"coin_count",numberType:"integer",type:"number",resultMetadata:{sourceField:"coin_count",sourceExpression:"count()",sourceClasses:["coin_count"],referenceId:"444a1fea-b15e-4782-b6b4-81c37864c387",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:2,character:4},end:{line:2,character:25}}},drillView:"by_type"},{name:"percent_of_value",type:"number",resultMetadata:{sourceField:"percent_of_value",sourceExpression:"total_value/all(total_value)",sourceClasses:["percent_of_value"],referenceId:"ed296032-6801-4d61-83d4-c1131b19ccc4",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:6,character:4},end:{line:7,character:52}}},annotation:{inherits:{notes:[{text:"# percent\n",at:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:6,character:4},end:{line:6,character:14}}}}]}},drillView:"by_type"},{name:"percent_of_coins",type:"number",resultMetadata:{sourceField:"percent_of_coins",sourceExpression:"coin_count/all(coin_count)",sourceClasses:["percent_of_coins"],referenceId:"3f38498b-8b6d-4d50-93e3-80eaa0408d20",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:8,character:4},end:{line:9,character:50}}},annotation:{inherits:{notes:[{text:"# percent\n",at:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:8,character:4},end:{line:8,character:14}}}}]}},drillView:"by_type"}],dialect:"duckdb",primaryKey:"coin_type",connection:"duckdb",resultMetadata:{sourceField:"ignoreme",filterList:[{node:"filterCondition",code:"is_new",e:{node:"field",path:["is_new"],at:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:0,character:33},end:{line:0,character:39}}}},expressionType:"scalar",fieldUsage:[{path:["is_new"],at:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:0,character:33},end:{line:0,character:39}}}}]}],sourceClasses:["ignoreme"],fieldKind:"struct",orderBy:[{field:"total_value",dir:"desc"}],drillable:!0}}],sourceExplore:"coins2",sourceArguments:{},connectionName:"duckdb",annotation:{inherits:{}},result:[{coin_type:"quarter",total_value:50,coin_count:2,percent_of_value:.5154639175257731,percent_of_coins:.2},{coin_type:"dime",total_value:30,coin_count:3,percent_of_value:.30927835051546393,percent_of_coins:.3},{coin_type:"nickle",total_value:15,coin_count:3,percent_of_value:.15463917525773196,percent_of_coins:.3},{coin_type:"penny",total_value:2,coin_count:2,percent_of_value:.020618556701030927,percent_of_coins:.2}],totalRows:4},e.appendChild(a)})();</script>
      </div>
    </div>
    <div class="result-middle" data-result-kind="json" >
      <div class="result-inner">
        <pre><pre class="language-json" style="background-color: #FBFBFB"><span class="line"><span style="color: #000000">[</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;quarter&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">50</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.5154639175257731</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_coins&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.2</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;dime&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">30</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.30927835051546393</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_coins&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.3</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;nickle&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">15</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.15463917525773196</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_coins&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.3</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;penny&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.020618556701030927</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_coins&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.2</span></span>
<span class="line"><span style="color: #000000">  }</span></span>
<span class="line"><span style="color: #000000">]</span></span></pre></pre>
      </div>
    </div>
    <div class="result-middle" data-result-kind="sql" >
      <div class="result-inner">
        <pre><pre class="language-sql" style="background-color: #FBFBFB"><span class="line"><span style="color: #0000FF">WITH</span><span style="color: #000000"> __stage0 </span><span style="color: #0000FF">AS</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">SELECT</span></span>
<span class="line"><span style="color: #000000">    group_set,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">1</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;penny&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">5</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;nickle&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">10</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;dime&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">25</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;quarter&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">ELSE</span><span style="color: #000000"> </span><span style="color: #0000FF">NULL</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_type__1&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">),</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;total_value__1&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #098658">1</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_count__1&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    (</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">),</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">)*</span><span style="color: #098658">1</span><span style="color: #000000">.</span><span style="color: #098658">0</span><span style="color: #000000">/</span><span style="color: #795E26">MAX</span><span style="color: #000000">((</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">0</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">),</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">)) </span><span style="color: #0000FF">OVER</span><span style="color: #000000"> () </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_value__1&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    (</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #098658">1</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">)*</span><span style="color: #098658">1</span><span style="color: #000000">.</span><span style="color: #098658">0</span><span style="color: #000000">/</span><span style="color: #795E26">MAX</span><span style="color: #000000">((</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">0</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #098658">1</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">)) </span><span style="color: #0000FF">OVER</span><span style="color: #000000"> () </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_coins__1&quot;</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">FROM</span><span style="color: #000000"> coins.csv </span><span style="color: #0000FF">as</span><span style="color: #000000"> base</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">CROSS</span><span style="color: #000000"> </span><span style="color: #0000FF">JOIN</span><span style="color: #000000"> (</span><span style="color: #0000FF">SELECT</span><span style="color: #000000"> UNNEST(GENERATE_SERIES(</span><span style="color: #098658">0</span><span style="color: #000000">,</span><span style="color: #098658">1</span><span style="color: #000000">,</span><span style="color: #098658">1</span><span style="color: #000000">)) </span><span style="color: #0000FF">as</span><span style="color: #000000"> group_set  ) </span><span style="color: #0000FF">as</span><span style="color: #000000"> group_set</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">WHERE</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;minted_year&quot;</span><span style="color: #000000">&gt;=</span><span style="color: #098658">2000</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">GROUP BY</span><span style="color: #000000"> </span><span style="color: #098658">1</span><span style="color: #000000">,</span><span style="color: #098658">2</span></span>
<span class="line"><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">SELECT</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #A31515">&quot;coin_type__1&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_type&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #795E26">MAX</span><span style="color: #000000">(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;total_value__1&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;total_value&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #795E26">MAX</span><span style="color: #000000">(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_count__1&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_count&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #795E26">MAX</span><span style="color: #000000">(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_value__1&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_value&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #795E26">MAX</span><span style="color: #000000">(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_coins__1&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_coins&quot;</span></span>
<span class="line"><span style="color: #0000FF">FROM</span><span style="color: #000000"> __stage0</span></span>
<span class="line"><span style="color: #0000FF">WHERE</span><span style="color: #000000"> group_set </span><span style="color: #0000FF">NOT</span><span style="color: #000000"> </span><span style="color: #0000FF">IN</span><span style="color: #000000"> (</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">GROUP BY</span><span style="color: #000000"> </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #0000FF">ORDER BY</span><span style="color: #000000"> </span><span style="color: #098658">2</span><span style="color: #000000"> </span><span style="color: #0000FF">desc</span><span style="color: #000000"> NULLS </span><span style="color: #0000FF">LAST</span></span>
<span class="line"></span></pre></pre>
      </div>
    </div>
  </div></div>
      <h2>
        <a id="we-can-query-by-more-than-one-dimension" class="header-link anchor" href="#we-can-query-by-more-than-one-dimension">
          We can query by more than one dimension
        </a>
      </h2>
    <p>(but this is hard to read)</p>
<div class="code-wrapper"><a href="https://github.dev/malloydata/malloydata.github.io/blob/main/src/blog/2023-11-04-data-for-kindergarten/index.malloynb#C32" target="_blank" class="open_notebook"><img src="/img/open_notebook.svg" alt="document"/></a><pre class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">run</span><span style="color: #000000">: </span><span style="color: #001080">coins2</span><span style="color: #000000"> -&gt; </span><span style="color: #001080">coin_type</span><span style="color: #000000"> + </span><span style="color: #001080">is_new</span><span style="color: #000000"> + </span><span style="color: #001080">metrics</span></span></pre><div class="result-outer small">
    <div class="result-controls-bar">
      <span class="result-label">QUERY RESULTS</span>
      <div class="result-controls">
        <button class="result-control" selected data-result-kind="html">HTML</button>
        <button class="result-control"  data-result-kind="json">JSON</button>
        <button class="result-control"  data-result-kind="sql">SQL</button>
      </div>
    </div>
    <div class="result-middle" data-result-kind="html" selected>
      <div class="result-inner" id="fbbd6dd1-b1b0-4734-9274-8147fd3c7a78">
        <script>(()=>{var e=document.getElementById("fbbd6dd1-b1b0-4734-9274-8147fd3c7a78"),a=document.createElement("malloy-render");a.modelDef={name:"",exports:["coins","coins2"],contents:{coins:{type:"table",name:"duckdb:coins.csv",dialect:"duckdb",tablePath:"coins.csv",connection:"duckdb",fields:[{type:"number",numberType:"integer",name:"face_value",fieldUsage:[{path:["face_value"]}]},{type:"number",numberType:"integer",name:"minted_year",fieldUsage:[{path:["minted_year"]}]},{type:"number",numberType:"integer",name:"coin_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},{type:"number",numberType:"integer",name:"total_value",e:{node:"aggregate",function:"sum",e:{node:"field",path:["face_value"]}},fieldUsage:[{path:["face_value"]}],expressionType:"aggregate",code:"face_value.sum()"},{type:"string",name:"coin_type",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"5",sql:"5"}},sql:'(base."face_value"=5)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"10",sql:"10"}},sql:'(base."face_value"=10)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"25",sql:"25"}},sql:'(base."face_value"=25)'}],caseThen:[{node:"stringLiteral",literal:"penny",sql:"'penny'"},{node:"stringLiteral",literal:"nickle",sql:"'nickle'"},{node:"stringLiteral",literal:"dime",sql:"'dime'"},{node:"stringLiteral",literal:"quarter",sql:"'quarter'"}],caseElse:{node:"null",sql:"NULL"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null"},{type:"string",name:"color",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'}],caseThen:[{node:"stringLiteral",literal:"copper",sql:"'copper'"}],caseElse:{node:"stringLiteral",literal:"silver",sql:"'silver'"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'copper' when 1\n    else 'silver'"}],parameters:{},as:"coins"},coins2:{type:"table",name:"duckdb:coins.csv",dialect:"duckdb",tablePath:"coins.csv",connection:"duckdb",fields:[{type:"number",numberType:"integer",name:"face_value",fieldUsage:[{path:["face_value"]}]},{type:"number",numberType:"integer",name:"minted_year",fieldUsage:[{path:["minted_year"]}]},{type:"number",numberType:"integer",name:"coin_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},{type:"number",numberType:"integer",name:"total_value",e:{node:"aggregate",function:"sum",e:{node:"field",path:["face_value"]}},fieldUsage:[{path:["face_value"]}],expressionType:"aggregate",code:"face_value.sum()"},{type:"string",name:"coin_type",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"5",sql:"5"}},sql:'(base."face_value"=5)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"10",sql:"10"}},sql:'(base."face_value"=10)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"25",sql:"25"}},sql:'(base."face_value"=25)'}],caseThen:[{node:"stringLiteral",literal:"penny",sql:"'penny'"},{node:"stringLiteral",literal:"nickle",sql:"'nickle'"},{node:"stringLiteral",literal:"dime",sql:"'dime'"},{node:"stringLiteral",literal:"quarter",sql:"'quarter'"}],caseElse:{node:"null",sql:"NULL"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null"},{type:"string",name:"color",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'}],caseThen:[{node:"stringLiteral",literal:"copper",sql:"'copper'"}],caseElse:{node:"stringLiteral",literal:"silver",sql:"'silver'"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'copper' when 1\n    else 'silver'"},{type:"boolean",name:"is_new",e:{node:">=",kids:{left:{node:"field",path:["minted_year"],sql:'base."minted_year"'},right:{node:"numberLiteral",literal:"2000",sql:"2000"}}},fieldUsage:[{path:["minted_year"]}],expressionType:"scalar",code:"minted_year >= 2000"},{type:"number",name:"minted_decade",e:{node:"*",kids:{left:{node:"function_call",overload:{returnType:{type:"number",expressionType:"scalar",evalSpace:"input"},params:[{name:"value",allowedTypes:[{type:"number",evalSpace:"input"}],isVariadic:!1}],dialect:{postgres:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},standardsql:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},duckdb:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},snowflake:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},trino:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},presto:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},mysql:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}}}},name:"floor",kids:{args:[{node:"/",kids:{left:{node:"field",path:["minted_year"]},right:{node:"numberLiteral",literal:"10"}}}]},expressionType:"scalar"},right:{node:"numberLiteral",literal:"10"}}},fieldUsage:[{path:["minted_year"]}],expressionType:"scalar",code:"floor(minted_year/10) * 10"},{type:"number",name:"percent_of_value",e:{node:"/",kids:{left:{node:"field",path:["total_value"],sql:'(CASE WHEN group_set=1 THEN\n  COALESCE(SUM(base."face_value"),0)\n  END)'},right:{node:"all",e:{node:"field",path:["total_value"]},sql:'MAX((CASE WHEN group_set=0 THEN\n  COALESCE(SUM(base."face_value"),0)\n  END)) OVER ()'}}},fieldUsage:[{path:["total_value"]},{path:["total_value"]}],ungroupings:[{requiresGroupBy:[],fieldUsage:[{path:["total_value"]}],ungroupedFields:"*"}],expressionType:"ungrouped_aggregate",code:"total_value/all(total_value)",annotation:{notes:[{text:"# percent\n"}]}},{type:"number",name:"percent_of_coins",e:{node:"/",kids:{left:{node:"field",path:["coin_count"],sql:"(CASE WHEN group_set=1 THEN\n  COUNT(1)\n  END)"},right:{node:"all",e:{node:"field",path:["coin_count"]},sql:"MAX((CASE WHEN group_set=0 THEN\n  COUNT(1)\n  END)) OVER ()"}}},fieldUsage:[{path:["coin_count"]},{path:["coin_count"]}],ungroupings:[{requiresGroupBy:[],fieldUsage:[{path:["coin_count"]}],ungroupedFields:"*"}],expressionType:"ungrouped_aggregate",code:"coin_count/all(coin_count)",annotation:{notes:[{text:"# percent\n"}]}},{type:"turtle",name:"metrics",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["total_value"]},{type:"fieldref",path:["coin_count"]},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}}],filterList:[],fieldUsage:[{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],defaultOrderBy:!0,orderBy:[{field:"total_value",dir:"desc"}]}],annotation:{}},{type:"turtle",name:"by_type",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["coin_type"]},{type:"fieldref",path:["total_value"],drillView:"metrics"},{type:"fieldref",path:["coin_count"],drillView:"metrics"},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"}],fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],filterList:[]}],annotation:{}}],parameters:{},as:"coins2",arguments:{}}},queryList:[{type:"query",structRef:"coins2",sourceArguments:{},pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["coin_type"]},{type:"fieldref",path:["is_new"]},{type:"fieldref",path:["total_value"],drillView:"metrics"},{type:"fieldref",path:["coin_count"],drillView:"metrics"},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"}],fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["minted_year"]},{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],filterList:[]}]}],dependencies:{},references:[{type:"exploreReference",text:"coins2",definition:{type:"table",name:"duckdb:coins.csv",dialect:"duckdb",tablePath:"coins.csv",connection:"duckdb",fields:[{type:"number",numberType:"integer",name:"face_value",fieldUsage:[{path:["face_value"]}]},{type:"number",numberType:"integer",name:"minted_year",fieldUsage:[{path:["minted_year"]}]},{type:"number",numberType:"integer",name:"coin_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},{type:"number",numberType:"integer",name:"total_value",e:{node:"aggregate",function:"sum",e:{node:"field",path:["face_value"]}},fieldUsage:[{path:["face_value"]}],expressionType:"aggregate",code:"face_value.sum()"},{type:"string",name:"coin_type",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"5",sql:"5"}},sql:'(base."face_value"=5)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"10",sql:"10"}},sql:'(base."face_value"=10)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"25",sql:"25"}},sql:'(base."face_value"=25)'}],caseThen:[{node:"stringLiteral",literal:"penny",sql:"'penny'"},{node:"stringLiteral",literal:"nickle",sql:"'nickle'"},{node:"stringLiteral",literal:"dime",sql:"'dime'"},{node:"stringLiteral",literal:"quarter",sql:"'quarter'"}],caseElse:{node:"null",sql:"NULL"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null"},{type:"string",name:"color",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'}],caseThen:[{node:"stringLiteral",literal:"copper",sql:"'copper'"}],caseElse:{node:"stringLiteral",literal:"silver",sql:"'silver'"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'copper' when 1\n    else 'silver'"},{type:"boolean",name:"is_new",e:{node:">=",kids:{left:{node:"field",path:["minted_year"],sql:'base."minted_year"'},right:{node:"numberLiteral",literal:"2000",sql:"2000"}}},fieldUsage:[{path:["minted_year"]}],expressionType:"scalar",code:"minted_year >= 2000"},{type:"number",name:"minted_decade",e:{node:"*",kids:{left:{node:"function_call",overload:{returnType:{type:"number",expressionType:"scalar",evalSpace:"input"},params:[{name:"value",allowedTypes:[{type:"number",evalSpace:"input"}],isVariadic:!1}],dialect:{postgres:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},standardsql:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},duckdb:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},snowflake:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},trino:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},presto:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},mysql:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}}}},name:"floor",kids:{args:[{node:"/",kids:{left:{node:"field",path:["minted_year"]},right:{node:"numberLiteral",literal:"10"}}}]},expressionType:"scalar"},right:{node:"numberLiteral",literal:"10"}}},fieldUsage:[{path:["minted_year"]}],expressionType:"scalar",code:"floor(minted_year/10) * 10"},{type:"number",name:"percent_of_value",e:{node:"/",kids:{left:{node:"field",path:["total_value"],sql:'(CASE WHEN group_set=1 THEN\n  COALESCE(SUM(base."face_value"),0)\n  END)'},right:{node:"all",e:{node:"field",path:["total_value"]},sql:'MAX((CASE WHEN group_set=0 THEN\n  COALESCE(SUM(base."face_value"),0)\n  END)) OVER ()'}}},fieldUsage:[{path:["total_value"]},{path:["total_value"]}],ungroupings:[{requiresGroupBy:[],fieldUsage:[{path:["total_value"]}],ungroupedFields:"*"}],expressionType:"ungrouped_aggregate",code:"total_value/all(total_value)",annotation:{notes:[{text:"# percent\n"}]}},{type:"number",name:"percent_of_coins",e:{node:"/",kids:{left:{node:"field",path:["coin_count"],sql:"(CASE WHEN group_set=1 THEN\n  COUNT(1)\n  END)"},right:{node:"all",e:{node:"field",path:["coin_count"]},sql:"MAX((CASE WHEN group_set=0 THEN\n  COUNT(1)\n  END)) OVER ()"}}},fieldUsage:[{path:["coin_count"]},{path:["coin_count"]}],ungroupings:[{requiresGroupBy:[],fieldUsage:[{path:["coin_count"]}],ungroupedFields:"*"}],expressionType:"ungrouped_aggregate",code:"coin_count/all(coin_count)",annotation:{notes:[{text:"# percent\n"}]}},{type:"turtle",name:"metrics",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["total_value"]},{type:"fieldref",path:["coin_count"]},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}}],filterList:[],fieldUsage:[{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],defaultOrderBy:!0,orderBy:[{field:"total_value",dir:"desc"}]}],annotation:{}},{type:"turtle",name:"by_type",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["coin_type"]},{type:"fieldref",path:["total_value"],drillView:"metrics"},{type:"fieldref",path:["coin_count"],drillView:"metrics"},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"}],fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],filterList:[]}],annotation:{}}],parameters:{},as:"coins2",arguments:{}}},{type:"fieldReference",definition:{type:"string",name:"coin_type",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"5",sql:"5"}},sql:'(base."face_value"=5)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"10",sql:"10"}},sql:'(base."face_value"=10)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"25",sql:"25"}},sql:'(base."face_value"=25)'}],caseThen:[{node:"stringLiteral",literal:"penny",sql:"'penny'"},{node:"stringLiteral",literal:"nickle",sql:"'nickle'"},{node:"stringLiteral",literal:"dime",sql:"'dime'"},{node:"stringLiteral",literal:"quarter",sql:"'quarter'"}],caseElse:{node:"null",sql:"NULL"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null"},text:"coin_type"},{type:"fieldReference",definition:{type:"boolean",name:"is_new",e:{node:">=",kids:{left:{node:"field",path:["minted_year"],sql:'base."minted_year"'},right:{node:"numberLiteral",literal:"2000",sql:"2000"}}},fieldUsage:[{path:["minted_year"]}],expressionType:"scalar",code:"minted_year >= 2000"},text:"is_new"},{type:"fieldReference",definition:{type:"turtle",name:"metrics",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["total_value"]},{type:"fieldref",path:["coin_count"]},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}}],filterList:[],fieldUsage:[{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],defaultOrderBy:!0,orderBy:[{field:"total_value",dir:"desc"}]}],annotation:{}},text:"metrics"}],imports:[]},a.queryResult={lastStageName:"__stage1",malloy:"",sql:'WITH __stage0 AS (\n  SELECT\n    group_set,\n    CASE WHEN group_set=1 THEN\n      CASE WHEN (base."face_value"=1) THEN \'penny\' WHEN (base."face_value"=5) THEN \'nickle\' WHEN (base."face_value"=10) THEN \'dime\' WHEN (base."face_value"=25) THEN \'quarter\' ELSE NULL END\n      END as "coin_type__1",\n    CASE WHEN group_set=1 THEN\n      base."minted_year">=2000\n      END as "is_new__1",\n    CASE WHEN group_set=1 THEN\n      COALESCE(SUM(base."face_value"),0)\n      END as "total_value__1",\n    CASE WHEN group_set=1 THEN\n      COUNT(1)\n      END as "coin_count__1",\n    (CASE WHEN group_set=1 THEN\n      COALESCE(SUM(base."face_value"),0)\n      END)*1.0/MAX((CASE WHEN group_set=0 THEN\n      COALESCE(SUM(base."face_value"),0)\n      END)) OVER () as "percent_of_value__1",\n    (CASE WHEN group_set=1 THEN\n      COUNT(1)\n      END)*1.0/MAX((CASE WHEN group_set=0 THEN\n      COUNT(1)\n      END)) OVER () as "percent_of_coins__1"\n  FROM coins.csv as base\n  CROSS JOIN (SELECT UNNEST(GENERATE_SERIES(0,1,1)) as group_set  ) as group_set\n  GROUP BY 1,2,3\n)\nSELECT\n  "coin_type__1" as "coin_type",\n  "is_new__1" as "is_new",\n  MAX(CASE WHEN group_set=1 THEN "total_value__1" END) as "total_value",\n  MAX(CASE WHEN group_set=1 THEN "coin_count__1" END) as "coin_count",\n  MAX(CASE WHEN group_set=1 THEN "percent_of_value__1" END) as "percent_of_value",\n  MAX(CASE WHEN group_set=1 THEN "percent_of_coins__1" END) as "percent_of_coins"\nFROM __stage0\nWHERE group_set NOT IN (0)\nGROUP BY 1,2\nORDER BY 3 desc NULLS LAST\n',dependenciesToMaterialize:{},structs:[{type:"query_result",name:"__stage1",fields:[{name:"coin_type",type:"string",resultMetadata:{sourceField:"coin_type",sourceExpression:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null",sourceClasses:["coin_type"],referenceId:"d3617893-8eca-45cd-8016-283f7b25b869",fieldKind:"dimension"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:5,character:13},end:{line:10,character:13}}}},{name:"is_new",type:"boolean",resultMetadata:{sourceField:"is_new",sourceExpression:"minted_year >= 2000",sourceClasses:["is_new"],referenceId:"16e5ff19-1e09-46e8-b54a-96ecf71d7084",fieldKind:"dimension"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:2,character:13},end:{line:2,character:42}}}},{name:"total_value",numberType:"integer",type:"number",resultMetadata:{sourceField:"total_value",sourceExpression:"face_value.sum()",sourceClasses:["total_value"],referenceId:"29f941bf-4ff7-4161-8f05-31672ebf36ac",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:3,character:4},end:{line:3,character:35}}},drillView:"metrics"},{name:"coin_count",numberType:"integer",type:"number",resultMetadata:{sourceField:"coin_count",sourceExpression:"count()",sourceClasses:["coin_count"],referenceId:"cdb33e98-79b0-4fe6-9420-2625992f3366",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:2,character:4},end:{line:2,character:25}}},drillView:"metrics"},{name:"percent_of_value",type:"number",resultMetadata:{sourceField:"percent_of_value",sourceExpression:"total_value/all(total_value)",sourceClasses:["percent_of_value"],referenceId:"3a19e4bb-5331-48e7-81c0-996fe4d4502e",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:6,character:4},end:{line:7,character:52}}},annotation:{inherits:{notes:[{text:"# percent\n",at:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:6,character:4},end:{line:6,character:14}}}}]}},drillView:"metrics"},{name:"percent_of_coins",type:"number",resultMetadata:{sourceField:"percent_of_coins",sourceExpression:"coin_count/all(coin_count)",sourceClasses:["percent_of_coins"],referenceId:"56882632-05c1-4be7-98dc-4a95edcf880b",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:8,character:4},end:{line:9,character:50}}},annotation:{inherits:{notes:[{text:"# percent\n",at:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:8,character:4},end:{line:8,character:14}}}}]}},drillView:"metrics"}],dialect:"duckdb",connection:"duckdb",resultMetadata:{sourceField:"ignoreme",filterList:[],sourceClasses:["ignoreme"],fieldKind:"struct",drillable:!0}}],sourceExplore:"coins2",sourceArguments:{},connectionName:"duckdb",result:[{coin_type:"quarter",is_new:!1,total_value:100,coin_count:4,percent_of_value:.5025125628140703,percent_of_coins:.25},{coin_type:"quarter",is_new:!0,total_value:50,coin_count:2,percent_of_value:.25125628140703515,percent_of_coins:.125},{coin_type:"dime",is_new:!0,total_value:30,coin_count:3,percent_of_value:.1507537688442211,percent_of_coins:.1875},{coin_type:"nickle",is_new:!0,total_value:15,coin_count:3,percent_of_value:.07537688442211055,percent_of_coins:.1875},{coin_type:"penny",is_new:!0,total_value:2,coin_count:2,percent_of_value:.010050251256281407,percent_of_coins:.125}],totalRows:5},e.appendChild(a)})();</script>
      </div>
    </div>
    <div class="result-middle" data-result-kind="json" >
      <div class="result-inner">
        <pre><pre class="language-json" style="background-color: #FBFBFB"><span class="line"><span style="color: #000000">[</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;quarter&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;is_new&quot;</span><span style="color: #000000">: </span><span style="color: #0000FF">false</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">100</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.5025125628140703</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_coins&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.25</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;quarter&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;is_new&quot;</span><span style="color: #000000">: </span><span style="color: #0000FF">true</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">50</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.25125628140703515</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_coins&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.125</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;dime&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;is_new&quot;</span><span style="color: #000000">: </span><span style="color: #0000FF">true</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">30</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.1507537688442211</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_coins&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.1875</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;nickle&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;is_new&quot;</span><span style="color: #000000">: </span><span style="color: #0000FF">true</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">15</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.07537688442211055</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_coins&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.1875</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;penny&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;is_new&quot;</span><span style="color: #000000">: </span><span style="color: #0000FF">true</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.010050251256281407</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_coins&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.125</span></span>
<span class="line"><span style="color: #000000">  }</span></span>
<span class="line"><span style="color: #000000">]</span></span></pre></pre>
      </div>
    </div>
    <div class="result-middle" data-result-kind="sql" >
      <div class="result-inner">
        <pre><pre class="language-sql" style="background-color: #FBFBFB"><span class="line"><span style="color: #0000FF">WITH</span><span style="color: #000000"> __stage0 </span><span style="color: #0000FF">AS</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">SELECT</span></span>
<span class="line"><span style="color: #000000">    group_set,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">1</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;penny&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">5</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;nickle&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">10</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;dime&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">25</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;quarter&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">ELSE</span><span style="color: #000000"> </span><span style="color: #0000FF">NULL</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_type__1&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      base.</span><span style="color: #A31515">&quot;minted_year&quot;</span><span style="color: #000000">&gt;=</span><span style="color: #098658">2000</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;is_new__1&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">),</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;total_value__1&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #098658">1</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_count__1&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    (</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">),</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">)*</span><span style="color: #098658">1</span><span style="color: #000000">.</span><span style="color: #098658">0</span><span style="color: #000000">/</span><span style="color: #795E26">MAX</span><span style="color: #000000">((</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">0</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">),</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">)) </span><span style="color: #0000FF">OVER</span><span style="color: #000000"> () </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_value__1&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    (</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #098658">1</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">)*</span><span style="color: #098658">1</span><span style="color: #000000">.</span><span style="color: #098658">0</span><span style="color: #000000">/</span><span style="color: #795E26">MAX</span><span style="color: #000000">((</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">0</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #098658">1</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">)) </span><span style="color: #0000FF">OVER</span><span style="color: #000000"> () </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_coins__1&quot;</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">FROM</span><span style="color: #000000"> coins.csv </span><span style="color: #0000FF">as</span><span style="color: #000000"> base</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">CROSS</span><span style="color: #000000"> </span><span style="color: #0000FF">JOIN</span><span style="color: #000000"> (</span><span style="color: #0000FF">SELECT</span><span style="color: #000000"> UNNEST(GENERATE_SERIES(</span><span style="color: #098658">0</span><span style="color: #000000">,</span><span style="color: #098658">1</span><span style="color: #000000">,</span><span style="color: #098658">1</span><span style="color: #000000">)) </span><span style="color: #0000FF">as</span><span style="color: #000000"> group_set  ) </span><span style="color: #0000FF">as</span><span style="color: #000000"> group_set</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">GROUP BY</span><span style="color: #000000"> </span><span style="color: #098658">1</span><span style="color: #000000">,</span><span style="color: #098658">2</span><span style="color: #000000">,</span><span style="color: #098658">3</span></span>
<span class="line"><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">SELECT</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #A31515">&quot;coin_type__1&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_type&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #A31515">&quot;is_new__1&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;is_new&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #795E26">MAX</span><span style="color: #000000">(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;total_value__1&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;total_value&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #795E26">MAX</span><span style="color: #000000">(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_count__1&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_count&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #795E26">MAX</span><span style="color: #000000">(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_value__1&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_value&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #795E26">MAX</span><span style="color: #000000">(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_coins__1&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_coins&quot;</span></span>
<span class="line"><span style="color: #0000FF">FROM</span><span style="color: #000000"> __stage0</span></span>
<span class="line"><span style="color: #0000FF">WHERE</span><span style="color: #000000"> group_set </span><span style="color: #0000FF">NOT</span><span style="color: #000000"> </span><span style="color: #0000FF">IN</span><span style="color: #000000"> (</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">GROUP BY</span><span style="color: #000000"> </span><span style="color: #098658">1</span><span style="color: #000000">,</span><span style="color: #098658">2</span></span>
<span class="line"><span style="color: #0000FF">ORDER BY</span><span style="color: #000000"> </span><span style="color: #098658">3</span><span style="color: #000000"> </span><span style="color: #0000FF">desc</span><span style="color: #000000"> NULLS </span><span style="color: #0000FF">LAST</span></span>
<span class="line"></span></pre></pre>
      </div>
    </div>
  </div></div>
      <h2>
        <a id="nesting-data-lets-us-look-at-more-than-one-dimension-at-a-time-" class="header-link anchor" href="#nesting-data-lets-us-look-at-more-than-one-dimension-at-a-time-">
          Nesting data lets us look at more than one dimension at a time.
        </a>
      </h2>
    <div class="code-wrapper"><a href="https://github.dev/malloydata/malloydata.github.io/blob/main/src/blog/2023-11-04-data-for-kindergarten/index.malloynb#C34" target="_blank" class="open_notebook"><img src="/img/open_notebook.svg" alt="document"/></a><pre class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">run</span><span style="color: #000000">: </span><span style="color: #001080">coins2</span><span style="color: #000000"> -&gt; </span><span style="color: #001080">coin_type</span><span style="color: #000000"> + </span><span style="color: #001080">metrics</span><span style="color: #000000"> + {</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">nest</span><span style="color: #000000">: </span><span style="color: #001080">is_new</span><span style="color: #000000"> + </span><span style="color: #001080">coin_count</span></span>
<span class="line"><span style="color: #000000">}</span></span></pre><div class="result-outer small">
    <div class="result-controls-bar">
      <span class="result-label">QUERY RESULTS</span>
      <div class="result-controls">
        <button class="result-control" selected data-result-kind="html">HTML</button>
        <button class="result-control"  data-result-kind="json">JSON</button>
        <button class="result-control"  data-result-kind="sql">SQL</button>
      </div>
    </div>
    <div class="result-middle" data-result-kind="html" selected>
      <div class="result-inner" id="f516ebfa-93ce-4d92-95c6-cf118b569433">
        <script>(()=>{var e=document.getElementById("f516ebfa-93ce-4d92-95c6-cf118b569433"),a=document.createElement("malloy-render");a.modelDef={name:"",exports:["coins","coins2"],contents:{coins:{type:"table",name:"duckdb:coins.csv",dialect:"duckdb",tablePath:"coins.csv",connection:"duckdb",fields:[{type:"number",numberType:"integer",name:"face_value",fieldUsage:[{path:["face_value"]}]},{type:"number",numberType:"integer",name:"minted_year",fieldUsage:[{path:["minted_year"]}]},{type:"number",numberType:"integer",name:"coin_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},{type:"number",numberType:"integer",name:"total_value",e:{node:"aggregate",function:"sum",e:{node:"field",path:["face_value"]}},fieldUsage:[{path:["face_value"]}],expressionType:"aggregate",code:"face_value.sum()"},{type:"string",name:"coin_type",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"5",sql:"5"}},sql:'(base."face_value"=5)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"10",sql:"10"}},sql:'(base."face_value"=10)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"25",sql:"25"}},sql:'(base."face_value"=25)'}],caseThen:[{node:"stringLiteral",literal:"penny",sql:"'penny'"},{node:"stringLiteral",literal:"nickle",sql:"'nickle'"},{node:"stringLiteral",literal:"dime",sql:"'dime'"},{node:"stringLiteral",literal:"quarter",sql:"'quarter'"}],caseElse:{node:"null",sql:"NULL"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null"},{type:"string",name:"color",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'}],caseThen:[{node:"stringLiteral",literal:"copper",sql:"'copper'"}],caseElse:{node:"stringLiteral",literal:"silver",sql:"'silver'"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'copper' when 1\n    else 'silver'"}],parameters:{},as:"coins"},coins2:{type:"table",name:"duckdb:coins.csv",dialect:"duckdb",tablePath:"coins.csv",connection:"duckdb",fields:[{type:"number",numberType:"integer",name:"face_value",fieldUsage:[{path:["face_value"]}]},{type:"number",numberType:"integer",name:"minted_year",fieldUsage:[{path:["minted_year"]}]},{type:"number",numberType:"integer",name:"coin_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},{type:"number",numberType:"integer",name:"total_value",e:{node:"aggregate",function:"sum",e:{node:"field",path:["face_value"]}},fieldUsage:[{path:["face_value"]}],expressionType:"aggregate",code:"face_value.sum()"},{type:"string",name:"coin_type",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"5",sql:"5"}},sql:'(base."face_value"=5)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"10",sql:"10"}},sql:'(base."face_value"=10)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"25",sql:"25"}},sql:'(base."face_value"=25)'}],caseThen:[{node:"stringLiteral",literal:"penny",sql:"'penny'"},{node:"stringLiteral",literal:"nickle",sql:"'nickle'"},{node:"stringLiteral",literal:"dime",sql:"'dime'"},{node:"stringLiteral",literal:"quarter",sql:"'quarter'"}],caseElse:{node:"null",sql:"NULL"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null"},{type:"string",name:"color",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'}],caseThen:[{node:"stringLiteral",literal:"copper",sql:"'copper'"}],caseElse:{node:"stringLiteral",literal:"silver",sql:"'silver'"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'copper' when 1\n    else 'silver'"},{type:"boolean",name:"is_new",e:{node:">=",kids:{left:{node:"field",path:["minted_year"],sql:'base."minted_year"'},right:{node:"numberLiteral",literal:"2000",sql:"2000"}}},fieldUsage:[{path:["minted_year"]}],expressionType:"scalar",code:"minted_year >= 2000"},{type:"number",name:"minted_decade",e:{node:"*",kids:{left:{node:"function_call",overload:{returnType:{type:"number",expressionType:"scalar",evalSpace:"input"},params:[{name:"value",allowedTypes:[{type:"number",evalSpace:"input"}],isVariadic:!1}],dialect:{postgres:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},standardsql:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},duckdb:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},snowflake:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},trino:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},presto:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},mysql:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}}}},name:"floor",kids:{args:[{node:"/",kids:{left:{node:"field",path:["minted_year"]},right:{node:"numberLiteral",literal:"10"}}}]},expressionType:"scalar"},right:{node:"numberLiteral",literal:"10"}}},fieldUsage:[{path:["minted_year"]}],expressionType:"scalar",code:"floor(minted_year/10) * 10"},{type:"number",name:"percent_of_value",e:{node:"/",kids:{left:{node:"field",path:["total_value"],sql:'(CASE WHEN group_set=1 THEN\n  COALESCE(SUM(base."face_value"),0)\n  END)'},right:{node:"all",e:{node:"field",path:["total_value"]},sql:'MAX((CASE WHEN group_set=0 THEN\n  COALESCE(SUM(base."face_value"),0)\n  END)) OVER ()'}}},fieldUsage:[{path:["total_value"]},{path:["total_value"]}],ungroupings:[{requiresGroupBy:[],fieldUsage:[{path:["total_value"]}],ungroupedFields:"*"}],expressionType:"ungrouped_aggregate",code:"total_value/all(total_value)",annotation:{notes:[{text:"# percent\n"}]}},{type:"number",name:"percent_of_coins",e:{node:"/",kids:{left:{node:"field",path:["coin_count"],sql:"(CASE WHEN group_set=1 THEN\n  COUNT(1)\n  END)"},right:{node:"all",e:{node:"field",path:["coin_count"]},sql:"MAX((CASE WHEN group_set=0 THEN\n  COUNT(1)\n  END)) OVER ()"}}},fieldUsage:[{path:["coin_count"]},{path:["coin_count"]}],ungroupings:[{requiresGroupBy:[],fieldUsage:[{path:["coin_count"]}],ungroupedFields:"*"}],expressionType:"ungrouped_aggregate",code:"coin_count/all(coin_count)",annotation:{notes:[{text:"# percent\n"}]}},{type:"turtle",name:"metrics",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["total_value"]},{type:"fieldref",path:["coin_count"]},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}}],filterList:[],fieldUsage:[{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],defaultOrderBy:!0,orderBy:[{field:"total_value",dir:"desc"}]}],annotation:{}},{type:"turtle",name:"by_type",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["coin_type"]},{type:"fieldref",path:["total_value"],drillView:"metrics"},{type:"fieldref",path:["coin_count"],drillView:"metrics"},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"}],fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],filterList:[]}],annotation:{}}],parameters:{},as:"coins2",arguments:{}}},queryList:[{type:"query",structRef:"coins2",sourceArguments:{},pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["coin_type"]},{type:"fieldref",path:["total_value"],drillView:"metrics"},{type:"fieldref",path:["coin_count"],drillView:"metrics"},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"},{type:"turtle",name:"is_new",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["is_new"],drillView:"is_new"},{type:"fieldref",path:["coin_count"],drillView:"is_new"}],fieldUsage:[{path:["minted_year"]}]}],annotation:{},fieldUsage:[{path:["minted_year"]}]}],filterList:[],fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]},{path:["minted_year"]}],defaultOrderBy:!0,orderBy:[{field:"total_value",dir:"desc"}]}]}],dependencies:{},references:[{type:"exploreReference",text:"coins2",definition:{type:"table",name:"duckdb:coins.csv",dialect:"duckdb",tablePath:"coins.csv",connection:"duckdb",fields:[{type:"number",numberType:"integer",name:"face_value",fieldUsage:[{path:["face_value"]}]},{type:"number",numberType:"integer",name:"minted_year",fieldUsage:[{path:["minted_year"]}]},{type:"number",numberType:"integer",name:"coin_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},{type:"number",numberType:"integer",name:"total_value",e:{node:"aggregate",function:"sum",e:{node:"field",path:["face_value"]}},fieldUsage:[{path:["face_value"]}],expressionType:"aggregate",code:"face_value.sum()"},{type:"string",name:"coin_type",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"5",sql:"5"}},sql:'(base."face_value"=5)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"10",sql:"10"}},sql:'(base."face_value"=10)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"25",sql:"25"}},sql:'(base."face_value"=25)'}],caseThen:[{node:"stringLiteral",literal:"penny",sql:"'penny'"},{node:"stringLiteral",literal:"nickle",sql:"'nickle'"},{node:"stringLiteral",literal:"dime",sql:"'dime'"},{node:"stringLiteral",literal:"quarter",sql:"'quarter'"}],caseElse:{node:"null",sql:"NULL"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null"},{type:"string",name:"color",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'}],caseThen:[{node:"stringLiteral",literal:"copper",sql:"'copper'"}],caseElse:{node:"stringLiteral",literal:"silver",sql:"'silver'"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'copper' when 1\n    else 'silver'"},{type:"boolean",name:"is_new",e:{node:">=",kids:{left:{node:"field",path:["minted_year"],sql:'base."minted_year"'},right:{node:"numberLiteral",literal:"2000",sql:"2000"}}},fieldUsage:[{path:["minted_year"]}],expressionType:"scalar",code:"minted_year >= 2000"},{type:"number",name:"minted_decade",e:{node:"*",kids:{left:{node:"function_call",overload:{returnType:{type:"number",expressionType:"scalar",evalSpace:"input"},params:[{name:"value",allowedTypes:[{type:"number",evalSpace:"input"}],isVariadic:!1}],dialect:{postgres:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},standardsql:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},duckdb:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},snowflake:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},trino:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},presto:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},mysql:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}}}},name:"floor",kids:{args:[{node:"/",kids:{left:{node:"field",path:["minted_year"]},right:{node:"numberLiteral",literal:"10"}}}]},expressionType:"scalar"},right:{node:"numberLiteral",literal:"10"}}},fieldUsage:[{path:["minted_year"]}],expressionType:"scalar",code:"floor(minted_year/10) * 10"},{type:"number",name:"percent_of_value",e:{node:"/",kids:{left:{node:"field",path:["total_value"],sql:'(CASE WHEN group_set=1 THEN\n  COALESCE(SUM(base."face_value"),0)\n  END)'},right:{node:"all",e:{node:"field",path:["total_value"]},sql:'MAX((CASE WHEN group_set=0 THEN\n  COALESCE(SUM(base."face_value"),0)\n  END)) OVER ()'}}},fieldUsage:[{path:["total_value"]},{path:["total_value"]}],ungroupings:[{requiresGroupBy:[],fieldUsage:[{path:["total_value"]}],ungroupedFields:"*"}],expressionType:"ungrouped_aggregate",code:"total_value/all(total_value)",annotation:{notes:[{text:"# percent\n"}]}},{type:"number",name:"percent_of_coins",e:{node:"/",kids:{left:{node:"field",path:["coin_count"],sql:"(CASE WHEN group_set=1 THEN\n  COUNT(1)\n  END)"},right:{node:"all",e:{node:"field",path:["coin_count"]},sql:"MAX((CASE WHEN group_set=0 THEN\n  COUNT(1)\n  END)) OVER ()"}}},fieldUsage:[{path:["coin_count"]},{path:["coin_count"]}],ungroupings:[{requiresGroupBy:[],fieldUsage:[{path:["coin_count"]}],ungroupedFields:"*"}],expressionType:"ungrouped_aggregate",code:"coin_count/all(coin_count)",annotation:{notes:[{text:"# percent\n"}]}},{type:"turtle",name:"metrics",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["total_value"]},{type:"fieldref",path:["coin_count"]},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}}],filterList:[],fieldUsage:[{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],defaultOrderBy:!0,orderBy:[{field:"total_value",dir:"desc"}]}],annotation:{}},{type:"turtle",name:"by_type",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["coin_type"]},{type:"fieldref",path:["total_value"],drillView:"metrics"},{type:"fieldref",path:["coin_count"],drillView:"metrics"},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"}],fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],filterList:[]}],annotation:{}}],parameters:{},as:"coins2",arguments:{}}},{type:"fieldReference",definition:{type:"string",name:"coin_type",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"5",sql:"5"}},sql:'(base."face_value"=5)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"10",sql:"10"}},sql:'(base."face_value"=10)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"25",sql:"25"}},sql:'(base."face_value"=25)'}],caseThen:[{node:"stringLiteral",literal:"penny",sql:"'penny'"},{node:"stringLiteral",literal:"nickle",sql:"'nickle'"},{node:"stringLiteral",literal:"dime",sql:"'dime'"},{node:"stringLiteral",literal:"quarter",sql:"'quarter'"}],caseElse:{node:"null",sql:"NULL"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null"},text:"coin_type"},{type:"fieldReference",definition:{type:"turtle",name:"metrics",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["total_value"]},{type:"fieldref",path:["coin_count"]},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}}],filterList:[],fieldUsage:[{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],defaultOrderBy:!0,orderBy:[{field:"total_value",dir:"desc"}]}],annotation:{}},text:"metrics"},{type:"fieldReference",definition:{type:"boolean",name:"is_new",e:{node:">=",kids:{left:{node:"field",path:["minted_year"],sql:'base."minted_year"'},right:{node:"numberLiteral",literal:"2000",sql:"2000"}}},fieldUsage:[{path:["minted_year"]}],expressionType:"scalar",code:"minted_year >= 2000"},text:"is_new"},{type:"fieldReference",definition:{type:"number",numberType:"integer",name:"coin_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},text:"coin_count"}],imports:[]},a.queryResult={lastStageName:"__stage1",malloy:"",sql:'WITH __stage0 AS (\n  SELECT\n    group_set,\n    CASE WHEN group_set IN (1,2) THEN\n      CASE WHEN (base."face_value"=1) THEN \'penny\' WHEN (base."face_value"=5) THEN \'nickle\' WHEN (base."face_value"=10) THEN \'dime\' WHEN (base."face_value"=25) THEN \'quarter\' ELSE NULL END\n      END as "coin_type__1",\n    CASE WHEN group_set=1 THEN\n      COALESCE(SUM(base."face_value"),0)\n      END as "total_value__1",\n    CASE WHEN group_set=1 THEN\n      COUNT(1)\n      END as "coin_count__1",\n    (CASE WHEN group_set=1 THEN\n      COALESCE(SUM(base."face_value"),0)\n      END)*1.0/MAX((CASE WHEN group_set=0 THEN\n      COALESCE(SUM(base."face_value"),0)\n      END)) OVER () as "percent_of_value__1",\n    (CASE WHEN group_set=1 THEN\n      COUNT(1)\n      END)*1.0/MAX((CASE WHEN group_set=0 THEN\n      COUNT(1)\n      END)) OVER () as "percent_of_coins__1",\n    CASE WHEN group_set=2 THEN\n      base."minted_year">=2000\n      END as "is_new__2",\n    CASE WHEN group_set=2 THEN\n      COUNT(1)\n      END as "coin_count__2"\n  FROM coins.csv as base\n  CROSS JOIN (SELECT UNNEST(GENERATE_SERIES(0,2,1)) as group_set  ) as group_set\n  GROUP BY 1,2,7\n)\nSELECT\n  "coin_type__1" as "coin_type",\n  MAX(CASE WHEN group_set=1 THEN "total_value__1" END) as "total_value",\n  MAX(CASE WHEN group_set=1 THEN "coin_count__1" END) as "coin_count",\n  MAX(CASE WHEN group_set=1 THEN "percent_of_value__1" END) as "percent_of_value",\n  MAX(CASE WHEN group_set=1 THEN "percent_of_coins__1" END) as "percent_of_coins",\n  COALESCE(LIST({\n    "is_new": "is_new__2", \n    "coin_count": "coin_count__2"}  ORDER BY  "coin_count__2" desc NULLS LAST) FILTER (WHERE group_set=2),[]) as "is_new"\nFROM __stage0\nWHERE group_set NOT IN (0)\nGROUP BY 1\nORDER BY 2 desc NULLS LAST\n',dependenciesToMaterialize:{},structs:[{type:"query_result",name:"__stage1",fields:[{name:"coin_type",type:"string",resultMetadata:{sourceField:"coin_type",sourceExpression:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null",sourceClasses:["coin_type"],referenceId:"b0c8c806-ad10-4cef-9fef-e1c5f8fd4def",fieldKind:"dimension"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:5,character:13},end:{line:10,character:13}}}},{name:"total_value",numberType:"integer",type:"number",resultMetadata:{sourceField:"total_value",sourceExpression:"face_value.sum()",sourceClasses:["total_value"],referenceId:"6ccc95a8-6669-46f0-a50a-17050ca08617",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:3,character:4},end:{line:3,character:35}}},drillView:"metrics"},{name:"coin_count",numberType:"integer",type:"number",resultMetadata:{sourceField:"coin_count",sourceExpression:"count()",sourceClasses:["coin_count"],referenceId:"d55928ad-2ef2-40f1-aefa-138c3b52a1ac",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:2,character:4},end:{line:2,character:25}}},drillView:"metrics"},{name:"percent_of_value",type:"number",resultMetadata:{sourceField:"percent_of_value",sourceExpression:"total_value/all(total_value)",sourceClasses:["percent_of_value"],referenceId:"d4b08e15-21b6-41c4-88b2-2c2df89f6029",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:6,character:4},end:{line:7,character:52}}},annotation:{inherits:{notes:[{text:"# percent\n",at:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:6,character:4},end:{line:6,character:14}}}}]}},drillView:"metrics"},{name:"percent_of_coins",type:"number",resultMetadata:{sourceField:"percent_of_coins",sourceExpression:"coin_count/all(coin_count)",sourceClasses:["percent_of_coins"],referenceId:"892d8630-d03c-4048-90e3-e4593a9072d1",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:8,character:4},end:{line:9,character:50}}},annotation:{inherits:{notes:[{text:"# percent\n",at:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:8,character:4},end:{line:8,character:14}}}}]}},drillView:"metrics"},{type:"array",name:"is_new",fields:[{name:"is_new",type:"boolean",resultMetadata:{sourceField:"is_new",sourceExpression:"minted_year >= 2000",sourceClasses:["is_new"],referenceId:"1256e7dd-33c7-475b-8e5d-572a0d6b4447",fieldKind:"dimension"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:2,character:13},end:{line:2,character:42}}},drillView:"is_new"},{name:"coin_count",numberType:"integer",type:"number",resultMetadata:{sourceField:"coin_count",sourceExpression:"count()",sourceClasses:["coin_count"],referenceId:"d55928ad-2ef2-40f1-aefa-138c3b52a1ac",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:2,character:4},end:{line:2,character:25}}},drillView:"is_new"}],dialect:"duckdb",connection:"duckdb",resultMetadata:{sourceField:"is_new",filterList:[],sourceClasses:["is_new"],fieldKind:"struct",drillable:!0},annotation:{},elementTypeDef:{type:"record_element"},join:"many"}],dialect:"duckdb",primaryKey:"coin_type",connection:"duckdb",resultMetadata:{sourceField:"ignoreme",filterList:[],sourceClasses:["ignoreme"],fieldKind:"struct",orderBy:[{field:"total_value",dir:"desc"}],drillable:!0}}],sourceExplore:"coins2",sourceArguments:{},connectionName:"duckdb",result:[{coin_type:"quarter",total_value:150,coin_count:6,percent_of_value:.7537688442211056,percent_of_coins:.375,is_new:[{is_new:!1,coin_count:4},{is_new:!0,coin_count:2}]},{coin_type:"dime",total_value:30,coin_count:3,percent_of_value:.1507537688442211,percent_of_coins:.1875,is_new:[{is_new:!0,coin_count:3}]},{coin_type:"nickle",total_value:15,coin_count:3,percent_of_value:.07537688442211055,percent_of_coins:.1875,is_new:[{is_new:!0,coin_count:3}]},{coin_type:"penny",total_value:4,coin_count:4,percent_of_value:.020100502512562814,percent_of_coins:.25,is_new:[{is_new:!1,coin_count:2},{is_new:!0,coin_count:2}]}],totalRows:4},e.appendChild(a)})();</script>
      </div>
    </div>
    <div class="result-middle" data-result-kind="json" >
      <div class="result-inner">
        <pre><pre class="language-json" style="background-color: #FBFBFB"><span class="line"><span style="color: #000000">[</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;quarter&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">150</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">6</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.7537688442211056</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_coins&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.375</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;is_new&quot;</span><span style="color: #000000">: [</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;is_new&quot;</span><span style="color: #000000">: </span><span style="color: #0000FF">false</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;is_new&quot;</span><span style="color: #000000">: </span><span style="color: #0000FF">true</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2</span></span>
<span class="line"><span style="color: #000000">      }</span></span>
<span class="line"><span style="color: #000000">    ]</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;dime&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">30</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.1507537688442211</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_coins&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.1875</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;is_new&quot;</span><span style="color: #000000">: [</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;is_new&quot;</span><span style="color: #000000">: </span><span style="color: #0000FF">true</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3</span></span>
<span class="line"><span style="color: #000000">      }</span></span>
<span class="line"><span style="color: #000000">    ]</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;nickle&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">15</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.07537688442211055</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_coins&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.1875</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;is_new&quot;</span><span style="color: #000000">: [</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;is_new&quot;</span><span style="color: #000000">: </span><span style="color: #0000FF">true</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3</span></span>
<span class="line"><span style="color: #000000">      }</span></span>
<span class="line"><span style="color: #000000">    ]</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;penny&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.020100502512562814</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_coins&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.25</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;is_new&quot;</span><span style="color: #000000">: [</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;is_new&quot;</span><span style="color: #000000">: </span><span style="color: #0000FF">false</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;is_new&quot;</span><span style="color: #000000">: </span><span style="color: #0000FF">true</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2</span></span>
<span class="line"><span style="color: #000000">      }</span></span>
<span class="line"><span style="color: #000000">    ]</span></span>
<span class="line"><span style="color: #000000">  }</span></span>
<span class="line"><span style="color: #000000">]</span></span></pre></pre>
      </div>
    </div>
    <div class="result-middle" data-result-kind="sql" >
      <div class="result-inner">
        <pre><pre class="language-sql" style="background-color: #FBFBFB"><span class="line"><span style="color: #0000FF">WITH</span><span style="color: #000000"> __stage0 </span><span style="color: #0000FF">AS</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">SELECT</span></span>
<span class="line"><span style="color: #000000">    group_set,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set </span><span style="color: #0000FF">IN</span><span style="color: #000000"> (</span><span style="color: #098658">1</span><span style="color: #000000">,</span><span style="color: #098658">2</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">1</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;penny&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">5</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;nickle&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">10</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;dime&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">25</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;quarter&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">ELSE</span><span style="color: #000000"> </span><span style="color: #0000FF">NULL</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_type__1&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">),</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;total_value__1&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #098658">1</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_count__1&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    (</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">),</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">)*</span><span style="color: #098658">1</span><span style="color: #000000">.</span><span style="color: #098658">0</span><span style="color: #000000">/</span><span style="color: #795E26">MAX</span><span style="color: #000000">((</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">0</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">),</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">)) </span><span style="color: #0000FF">OVER</span><span style="color: #000000"> () </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_value__1&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    (</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #098658">1</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">)*</span><span style="color: #098658">1</span><span style="color: #000000">.</span><span style="color: #098658">0</span><span style="color: #000000">/</span><span style="color: #795E26">MAX</span><span style="color: #000000">((</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">0</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #098658">1</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">)) </span><span style="color: #0000FF">OVER</span><span style="color: #000000"> () </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_coins__1&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">2</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      base.</span><span style="color: #A31515">&quot;minted_year&quot;</span><span style="color: #000000">&gt;=</span><span style="color: #098658">2000</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;is_new__2&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">2</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #098658">1</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_count__2&quot;</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">FROM</span><span style="color: #000000"> coins.csv </span><span style="color: #0000FF">as</span><span style="color: #000000"> base</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">CROSS</span><span style="color: #000000"> </span><span style="color: #0000FF">JOIN</span><span style="color: #000000"> (</span><span style="color: #0000FF">SELECT</span><span style="color: #000000"> UNNEST(GENERATE_SERIES(</span><span style="color: #098658">0</span><span style="color: #000000">,</span><span style="color: #098658">2</span><span style="color: #000000">,</span><span style="color: #098658">1</span><span style="color: #000000">)) </span><span style="color: #0000FF">as</span><span style="color: #000000"> group_set  ) </span><span style="color: #0000FF">as</span><span style="color: #000000"> group_set</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">GROUP BY</span><span style="color: #000000"> </span><span style="color: #098658">1</span><span style="color: #000000">,</span><span style="color: #098658">2</span><span style="color: #000000">,</span><span style="color: #098658">7</span></span>
<span class="line"><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">SELECT</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #A31515">&quot;coin_type__1&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_type&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #795E26">MAX</span><span style="color: #000000">(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;total_value__1&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;total_value&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #795E26">MAX</span><span style="color: #000000">(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_count__1&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_count&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #795E26">MAX</span><span style="color: #000000">(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_value__1&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_value&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #795E26">MAX</span><span style="color: #000000">(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_coins__1&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_coins&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(LIST({</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #A31515">&quot;is_new&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;is_new__2&quot;</span><span style="color: #000000">, </span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #A31515">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;coin_count__2&quot;</span><span style="color: #000000">}  </span><span style="color: #0000FF">ORDER BY</span><span style="color: #000000">  </span><span style="color: #A31515">&quot;coin_count__2&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">desc</span><span style="color: #000000"> NULLS </span><span style="color: #0000FF">LAST</span><span style="color: #000000">) </span><span style="color: #0000FF">FILTER</span><span style="color: #000000"> (</span><span style="color: #0000FF">WHERE</span><span style="color: #000000"> group_set=</span><span style="color: #098658">2</span><span style="color: #000000">),[]) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;is_new&quot;</span></span>
<span class="line"><span style="color: #0000FF">FROM</span><span style="color: #000000"> __stage0</span></span>
<span class="line"><span style="color: #0000FF">WHERE</span><span style="color: #000000"> group_set </span><span style="color: #0000FF">NOT</span><span style="color: #000000"> </span><span style="color: #0000FF">IN</span><span style="color: #000000"> (</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">GROUP BY</span><span style="color: #000000"> </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #0000FF">ORDER BY</span><span style="color: #000000"> </span><span style="color: #098658">2</span><span style="color: #000000"> </span><span style="color: #0000FF">desc</span><span style="color: #000000"> NULLS </span><span style="color: #0000FF">LAST</span></span>
<span class="line"></span></pre></pre>
      </div>
    </div>
  </div></div><div class="title-row">
        
      <h1>
        <a id="pivoting-data-is-even-better-" class="header-link anchor" href="#pivoting-data-is-even-better-">
          Pivoting data is even better.
        </a>
      </h1>
    
        <a class="edit-link" target="_blank" href="https://github.dev/malloydata/malloydata.github.io/blob/main/src/blog/2023-11-04-data-for-kindergarten/index.malloynb#C1">VSCode <img src="/img/open_notebook.svg" alt="document"/></a>
        </div>
      <div class="code-wrapper"><a href="https://github.dev/malloydata/malloydata.github.io/blob/main/src/blog/2023-11-04-data-for-kindergarten/index.malloynb#C36" target="_blank" class="open_notebook"><img src="/img/open_notebook.svg" alt="document"/></a><pre class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">run</span><span style="color: #000000">: </span><span style="color: #001080">coins2</span><span style="color: #000000"> -&gt; </span><span style="color: #001080">coin_type</span><span style="color: #000000"> + </span><span style="color: #001080">metrics</span><span style="color: #000000"> + {</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0451A5"># pivot</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">nest</span><span style="color: #000000">: </span><span style="color: #001080">is_new</span><span style="color: #000000"> + </span><span style="color: #001080">metrics</span></span>
<span class="line"><span style="color: #000000">}</span></span></pre><div class="result-outer small">
    <div class="result-controls-bar">
      <span class="result-label">QUERY RESULTS</span>
      <div class="result-controls">
        <button class="result-control" selected data-result-kind="html">HTML</button>
        <button class="result-control"  data-result-kind="json">JSON</button>
        <button class="result-control"  data-result-kind="sql">SQL</button>
      </div>
    </div>
    <div class="result-middle" data-result-kind="html" selected>
      <div class="result-inner" id="8c51d180-02d2-4e35-89fd-425b7fe43ecd">
        <script>(()=>{var e=document.getElementById("8c51d180-02d2-4e35-89fd-425b7fe43ecd"),a=document.createElement("malloy-render");a.modelDef={name:"",exports:["coins","coins2"],contents:{coins:{type:"table",name:"duckdb:coins.csv",dialect:"duckdb",tablePath:"coins.csv",connection:"duckdb",fields:[{type:"number",numberType:"integer",name:"face_value",fieldUsage:[{path:["face_value"]}]},{type:"number",numberType:"integer",name:"minted_year",fieldUsage:[{path:["minted_year"]}]},{type:"number",numberType:"integer",name:"coin_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},{type:"number",numberType:"integer",name:"total_value",e:{node:"aggregate",function:"sum",e:{node:"field",path:["face_value"]}},fieldUsage:[{path:["face_value"]}],expressionType:"aggregate",code:"face_value.sum()"},{type:"string",name:"coin_type",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"5",sql:"5"}},sql:'(base."face_value"=5)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"10",sql:"10"}},sql:'(base."face_value"=10)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"25",sql:"25"}},sql:'(base."face_value"=25)'}],caseThen:[{node:"stringLiteral",literal:"penny",sql:"'penny'"},{node:"stringLiteral",literal:"nickle",sql:"'nickle'"},{node:"stringLiteral",literal:"dime",sql:"'dime'"},{node:"stringLiteral",literal:"quarter",sql:"'quarter'"}],caseElse:{node:"null",sql:"NULL"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null"},{type:"string",name:"color",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'}],caseThen:[{node:"stringLiteral",literal:"copper",sql:"'copper'"}],caseElse:{node:"stringLiteral",literal:"silver",sql:"'silver'"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'copper' when 1\n    else 'silver'"}],parameters:{},as:"coins"},coins2:{type:"table",name:"duckdb:coins.csv",dialect:"duckdb",tablePath:"coins.csv",connection:"duckdb",fields:[{type:"number",numberType:"integer",name:"face_value",fieldUsage:[{path:["face_value"]}]},{type:"number",numberType:"integer",name:"minted_year",fieldUsage:[{path:["minted_year"]}]},{type:"number",numberType:"integer",name:"coin_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},{type:"number",numberType:"integer",name:"total_value",e:{node:"aggregate",function:"sum",e:{node:"field",path:["face_value"]}},fieldUsage:[{path:["face_value"]}],expressionType:"aggregate",code:"face_value.sum()"},{type:"string",name:"coin_type",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"5",sql:"5"}},sql:'(base."face_value"=5)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"10",sql:"10"}},sql:'(base."face_value"=10)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"25",sql:"25"}},sql:'(base."face_value"=25)'}],caseThen:[{node:"stringLiteral",literal:"penny",sql:"'penny'"},{node:"stringLiteral",literal:"nickle",sql:"'nickle'"},{node:"stringLiteral",literal:"dime",sql:"'dime'"},{node:"stringLiteral",literal:"quarter",sql:"'quarter'"}],caseElse:{node:"null",sql:"NULL"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null"},{type:"string",name:"color",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'}],caseThen:[{node:"stringLiteral",literal:"copper",sql:"'copper'"}],caseElse:{node:"stringLiteral",literal:"silver",sql:"'silver'"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'copper' when 1\n    else 'silver'"},{type:"boolean",name:"is_new",e:{node:">=",kids:{left:{node:"field",path:["minted_year"],sql:'base."minted_year"'},right:{node:"numberLiteral",literal:"2000",sql:"2000"}}},fieldUsage:[{path:["minted_year"]}],expressionType:"scalar",code:"minted_year >= 2000"},{type:"number",name:"minted_decade",e:{node:"*",kids:{left:{node:"function_call",overload:{returnType:{type:"number",expressionType:"scalar",evalSpace:"input"},params:[{name:"value",allowedTypes:[{type:"number",evalSpace:"input"}],isVariadic:!1}],dialect:{postgres:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},standardsql:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},duckdb:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},snowflake:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},trino:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},presto:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},mysql:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}}}},name:"floor",kids:{args:[{node:"/",kids:{left:{node:"field",path:["minted_year"]},right:{node:"numberLiteral",literal:"10"}}}]},expressionType:"scalar"},right:{node:"numberLiteral",literal:"10"}}},fieldUsage:[{path:["minted_year"]}],expressionType:"scalar",code:"floor(minted_year/10) * 10"},{type:"number",name:"percent_of_value",e:{node:"/",kids:{left:{node:"field",path:["total_value"],sql:'(CASE WHEN group_set=2 THEN\n  COALESCE(SUM(base."face_value"),0)\n  END)'},right:{node:"all",e:{node:"field",path:["total_value"]},sql:'MAX((CASE WHEN group_set=1 THEN\n  COALESCE(SUM(base."face_value"),0)\n  END)) OVER (PARTITION BY CASE WHEN group_set IN (1,2) THEN\n  CASE WHEN (base."face_value"=1) THEN \'penny\' WHEN (base."face_value"=5) THEN \'nickle\' WHEN (base."face_value"=10) THEN \'dime\' WHEN (base."face_value"=25) THEN \'quarter\' ELSE NULL END\n  END)'}}},fieldUsage:[{path:["total_value"]},{path:["total_value"]}],ungroupings:[{requiresGroupBy:[],fieldUsage:[{path:["total_value"]}],ungroupedFields:"*"}],expressionType:"ungrouped_aggregate",code:"total_value/all(total_value)",annotation:{notes:[{text:"# percent\n"}]}},{type:"number",name:"percent_of_coins",e:{node:"/",kids:{left:{node:"field",path:["coin_count"],sql:"(CASE WHEN group_set=2 THEN\n  COUNT(1)\n  END)"},right:{node:"all",e:{node:"field",path:["coin_count"]},sql:"MAX((CASE WHEN group_set=1 THEN\n  COUNT(1)\n  END)) OVER (PARTITION BY CASE WHEN group_set IN (1,2) THEN\n  CASE WHEN (base.\"face_value\"=1) THEN 'penny' WHEN (base.\"face_value\"=5) THEN 'nickle' WHEN (base.\"face_value\"=10) THEN 'dime' WHEN (base.\"face_value\"=25) THEN 'quarter' ELSE NULL END\n  END)"}}},fieldUsage:[{path:["coin_count"]},{path:["coin_count"]}],ungroupings:[{requiresGroupBy:[],fieldUsage:[{path:["coin_count"]}],ungroupedFields:"*"}],expressionType:"ungrouped_aggregate",code:"coin_count/all(coin_count)",annotation:{notes:[{text:"# percent\n"}]}},{type:"turtle",name:"metrics",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["total_value"]},{type:"fieldref",path:["coin_count"]},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}}],filterList:[],fieldUsage:[{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],defaultOrderBy:!0,orderBy:[{field:"total_value",dir:"desc"}]}],annotation:{}},{type:"turtle",name:"by_type",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["coin_type"]},{type:"fieldref",path:["total_value"],drillView:"metrics"},{type:"fieldref",path:["coin_count"],drillView:"metrics"},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"}],fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],filterList:[]}],annotation:{}}],parameters:{},as:"coins2",arguments:{}}},queryList:[{type:"query",structRef:"coins2",sourceArguments:{},pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["coin_type"]},{type:"fieldref",path:["total_value"],drillView:"metrics"},{type:"fieldref",path:["coin_count"],drillView:"metrics"},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"},{type:"turtle",name:"is_new",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["is_new"],drillView:"is_new"},{type:"fieldref",path:["total_value"],drillView:"is_new"},{type:"fieldref",path:["coin_count"],drillView:"is_new"},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"is_new"},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"is_new"}],fieldUsage:[{path:["minted_year"]},{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],filterList:[]}],annotation:{blockNotes:[{text:"# pivot\n"}]},fieldUsage:[{path:["minted_year"]},{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}]}],filterList:[],fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]},{path:["minted_year"]},{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],defaultOrderBy:!0,orderBy:[{field:"total_value",dir:"desc"}]}]}],dependencies:{},references:[{type:"exploreReference",text:"coins2",definition:{type:"table",name:"duckdb:coins.csv",dialect:"duckdb",tablePath:"coins.csv",connection:"duckdb",fields:[{type:"number",numberType:"integer",name:"face_value",fieldUsage:[{path:["face_value"]}]},{type:"number",numberType:"integer",name:"minted_year",fieldUsage:[{path:["minted_year"]}]},{type:"number",numberType:"integer",name:"coin_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},{type:"number",numberType:"integer",name:"total_value",e:{node:"aggregate",function:"sum",e:{node:"field",path:["face_value"]}},fieldUsage:[{path:["face_value"]}],expressionType:"aggregate",code:"face_value.sum()"},{type:"string",name:"coin_type",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"5",sql:"5"}},sql:'(base."face_value"=5)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"10",sql:"10"}},sql:'(base."face_value"=10)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"25",sql:"25"}},sql:'(base."face_value"=25)'}],caseThen:[{node:"stringLiteral",literal:"penny",sql:"'penny'"},{node:"stringLiteral",literal:"nickle",sql:"'nickle'"},{node:"stringLiteral",literal:"dime",sql:"'dime'"},{node:"stringLiteral",literal:"quarter",sql:"'quarter'"}],caseElse:{node:"null",sql:"NULL"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null"},{type:"string",name:"color",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'}],caseThen:[{node:"stringLiteral",literal:"copper",sql:"'copper'"}],caseElse:{node:"stringLiteral",literal:"silver",sql:"'silver'"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'copper' when 1\n    else 'silver'"},{type:"boolean",name:"is_new",e:{node:">=",kids:{left:{node:"field",path:["minted_year"],sql:'base."minted_year"'},right:{node:"numberLiteral",literal:"2000",sql:"2000"}}},fieldUsage:[{path:["minted_year"]}],expressionType:"scalar",code:"minted_year >= 2000"},{type:"number",name:"minted_decade",e:{node:"*",kids:{left:{node:"function_call",overload:{returnType:{type:"number",expressionType:"scalar",evalSpace:"input"},params:[{name:"value",allowedTypes:[{type:"number",evalSpace:"input"}],isVariadic:!1}],dialect:{postgres:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},standardsql:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},duckdb:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},snowflake:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},trino:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},presto:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},mysql:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}}}},name:"floor",kids:{args:[{node:"/",kids:{left:{node:"field",path:["minted_year"]},right:{node:"numberLiteral",literal:"10"}}}]},expressionType:"scalar"},right:{node:"numberLiteral",literal:"10"}}},fieldUsage:[{path:["minted_year"]}],expressionType:"scalar",code:"floor(minted_year/10) * 10"},{type:"number",name:"percent_of_value",e:{node:"/",kids:{left:{node:"field",path:["total_value"],sql:'(CASE WHEN group_set=1 THEN\n  COALESCE(SUM(base."face_value"),0)\n  END)'},right:{node:"all",e:{node:"field",path:["total_value"]},sql:'MAX((CASE WHEN group_set=0 THEN\n  COALESCE(SUM(base."face_value"),0)\n  END)) OVER ()'}}},fieldUsage:[{path:["total_value"]},{path:["total_value"]}],ungroupings:[{requiresGroupBy:[],fieldUsage:[{path:["total_value"]}],ungroupedFields:"*"}],expressionType:"ungrouped_aggregate",code:"total_value/all(total_value)",annotation:{notes:[{text:"# percent\n"}]}},{type:"number",name:"percent_of_coins",e:{node:"/",kids:{left:{node:"field",path:["coin_count"],sql:"(CASE WHEN group_set=1 THEN\n  COUNT(1)\n  END)"},right:{node:"all",e:{node:"field",path:["coin_count"]},sql:"MAX((CASE WHEN group_set=0 THEN\n  COUNT(1)\n  END)) OVER ()"}}},fieldUsage:[{path:["coin_count"]},{path:["coin_count"]}],ungroupings:[{requiresGroupBy:[],fieldUsage:[{path:["coin_count"]}],ungroupedFields:"*"}],expressionType:"ungrouped_aggregate",code:"coin_count/all(coin_count)",annotation:{notes:[{text:"# percent\n"}]}},{type:"turtle",name:"metrics",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["total_value"]},{type:"fieldref",path:["coin_count"]},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}}],filterList:[],fieldUsage:[{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],defaultOrderBy:!0,orderBy:[{field:"total_value",dir:"desc"}]}],annotation:{}},{type:"turtle",name:"by_type",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["coin_type"]},{type:"fieldref",path:["total_value"],drillView:"metrics"},{type:"fieldref",path:["coin_count"],drillView:"metrics"},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"}],fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],filterList:[]}],annotation:{}}],parameters:{},as:"coins2",arguments:{}}},{type:"fieldReference",definition:{type:"string",name:"coin_type",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"5",sql:"5"}},sql:'(base."face_value"=5)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"10",sql:"10"}},sql:'(base."face_value"=10)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"25",sql:"25"}},sql:'(base."face_value"=25)'}],caseThen:[{node:"stringLiteral",literal:"penny",sql:"'penny'"},{node:"stringLiteral",literal:"nickle",sql:"'nickle'"},{node:"stringLiteral",literal:"dime",sql:"'dime'"},{node:"stringLiteral",literal:"quarter",sql:"'quarter'"}],caseElse:{node:"null",sql:"NULL"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null"},text:"coin_type"},{type:"fieldReference",definition:{type:"turtle",name:"metrics",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["total_value"]},{type:"fieldref",path:["coin_count"]},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}}],filterList:[],fieldUsage:[{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],defaultOrderBy:!0,orderBy:[{field:"total_value",dir:"desc"}]}],annotation:{}},text:"metrics"},{type:"fieldReference",definition:{type:"boolean",name:"is_new",e:{node:">=",kids:{left:{node:"field",path:["minted_year"],sql:'base."minted_year"'},right:{node:"numberLiteral",literal:"2000",sql:"2000"}}},fieldUsage:[{path:["minted_year"]}],expressionType:"scalar",code:"minted_year >= 2000"},text:"is_new"},{type:"fieldReference",definition:{type:"turtle",name:"metrics",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["total_value"]},{type:"fieldref",path:["coin_count"]},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}}],filterList:[],fieldUsage:[{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],defaultOrderBy:!0,orderBy:[{field:"total_value",dir:"desc"}]}],annotation:{}},text:"metrics"}],imports:[]},a.queryResult={lastStageName:"__stage1",malloy:"",sql:'WITH __stage0 AS (\n  SELECT\n    group_set,\n    CASE WHEN group_set IN (1,2) THEN\n      CASE WHEN (base."face_value"=1) THEN \'penny\' WHEN (base."face_value"=5) THEN \'nickle\' WHEN (base."face_value"=10) THEN \'dime\' WHEN (base."face_value"=25) THEN \'quarter\' ELSE NULL END\n      END as "coin_type__1",\n    CASE WHEN group_set=1 THEN\n      COALESCE(SUM(base."face_value"),0)\n      END as "total_value__1",\n    CASE WHEN group_set=1 THEN\n      COUNT(1)\n      END as "coin_count__1",\n    (CASE WHEN group_set=1 THEN\n      COALESCE(SUM(base."face_value"),0)\n      END)*1.0/MAX((CASE WHEN group_set=0 THEN\n      COALESCE(SUM(base."face_value"),0)\n      END)) OVER () as "percent_of_value__1",\n    (CASE WHEN group_set=1 THEN\n      COUNT(1)\n      END)*1.0/MAX((CASE WHEN group_set=0 THEN\n      COUNT(1)\n      END)) OVER () as "percent_of_coins__1",\n    CASE WHEN group_set=2 THEN\n      base."minted_year">=2000\n      END as "is_new__2",\n    CASE WHEN group_set=2 THEN\n      COALESCE(SUM(base."face_value"),0)\n      END as "total_value__2",\n    CASE WHEN group_set=2 THEN\n      COUNT(1)\n      END as "coin_count__2",\n    (CASE WHEN group_set=2 THEN\n      COALESCE(SUM(base."face_value"),0)\n      END)*1.0/MAX((CASE WHEN group_set=1 THEN\n      COALESCE(SUM(base."face_value"),0)\n      END)) OVER (PARTITION BY CASE WHEN group_set IN (1,2) THEN\n      CASE WHEN (base."face_value"=1) THEN \'penny\' WHEN (base."face_value"=5) THEN \'nickle\' WHEN (base."face_value"=10) THEN \'dime\' WHEN (base."face_value"=25) THEN \'quarter\' ELSE NULL END\n      END) as "percent_of_value__2",\n    (CASE WHEN group_set=2 THEN\n      COUNT(1)\n      END)*1.0/MAX((CASE WHEN group_set=1 THEN\n      COUNT(1)\n      END)) OVER (PARTITION BY CASE WHEN group_set IN (1,2) THEN\n      CASE WHEN (base."face_value"=1) THEN \'penny\' WHEN (base."face_value"=5) THEN \'nickle\' WHEN (base."face_value"=10) THEN \'dime\' WHEN (base."face_value"=25) THEN \'quarter\' ELSE NULL END\n      END) as "percent_of_coins__2"\n  FROM coins.csv as base\n  CROSS JOIN (SELECT UNNEST(GENERATE_SERIES(0,2,1)) as group_set  ) as group_set\n  GROUP BY 1,2,7\n)\nSELECT\n  "coin_type__1" as "coin_type",\n  MAX(CASE WHEN group_set=1 THEN "total_value__1" END) as "total_value",\n  MAX(CASE WHEN group_set=1 THEN "coin_count__1" END) as "coin_count",\n  MAX(CASE WHEN group_set=1 THEN "percent_of_value__1" END) as "percent_of_value",\n  MAX(CASE WHEN group_set=1 THEN "percent_of_coins__1" END) as "percent_of_coins",\n  COALESCE(LIST({\n    "is_new": "is_new__2", \n    "total_value": "total_value__2", \n    "coin_count": "coin_count__2", \n    "percent_of_value": "percent_of_value__2", \n    "percent_of_coins": "percent_of_coins__2"}  ORDER BY  "total_value__2" desc NULLS LAST) FILTER (WHERE group_set=2),[]) as "is_new"\nFROM __stage0\nWHERE group_set NOT IN (0)\nGROUP BY 1\nORDER BY 2 desc NULLS LAST\n',dependenciesToMaterialize:{},structs:[{type:"query_result",name:"__stage1",fields:[{name:"coin_type",type:"string",resultMetadata:{sourceField:"coin_type",sourceExpression:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null",sourceClasses:["coin_type"],referenceId:"be703f21-ed3f-4fb7-9396-04e5de4d39b1",fieldKind:"dimension"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:5,character:13},end:{line:10,character:13}}}},{name:"total_value",numberType:"integer",type:"number",resultMetadata:{sourceField:"total_value",sourceExpression:"face_value.sum()",sourceClasses:["total_value"],referenceId:"b3828272-2242-4187-9153-0cca02e99192",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:3,character:4},end:{line:3,character:35}}},drillView:"metrics"},{name:"coin_count",numberType:"integer",type:"number",resultMetadata:{sourceField:"coin_count",sourceExpression:"count()",sourceClasses:["coin_count"],referenceId:"bcd1372d-a627-45fc-ac78-ef0dc15d79c6",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:2,character:4},end:{line:2,character:25}}},drillView:"metrics"},{name:"percent_of_value",type:"number",resultMetadata:{sourceField:"percent_of_value",sourceExpression:"total_value/all(total_value)",sourceClasses:["percent_of_value"],referenceId:"764102c9-7910-4b62-976f-9a5099e7cdc2",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:6,character:4},end:{line:7,character:52}}},annotation:{inherits:{notes:[{text:"# percent\n",at:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:6,character:4},end:{line:6,character:14}}}}]}},drillView:"metrics"},{name:"percent_of_coins",type:"number",resultMetadata:{sourceField:"percent_of_coins",sourceExpression:"coin_count/all(coin_count)",sourceClasses:["percent_of_coins"],referenceId:"3a4ca0e3-cff8-4bcf-9d97-e9b336a5ec11",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:8,character:4},end:{line:9,character:50}}},annotation:{inherits:{notes:[{text:"# percent\n",at:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:8,character:4},end:{line:8,character:14}}}}]}},drillView:"metrics"},{type:"array",name:"is_new",fields:[{name:"is_new",type:"boolean",resultMetadata:{sourceField:"is_new",sourceExpression:"minted_year >= 2000",sourceClasses:["is_new"],referenceId:"b3242343-d683-4472-ab0e-e2ae21e9e348",fieldKind:"dimension"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:2,character:13},end:{line:2,character:42}}},drillView:"is_new"},{name:"total_value",numberType:"integer",type:"number",resultMetadata:{sourceField:"total_value",sourceExpression:"face_value.sum()",sourceClasses:["total_value"],referenceId:"b3828272-2242-4187-9153-0cca02e99192",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:3,character:4},end:{line:3,character:35}}},drillView:"is_new"},{name:"coin_count",numberType:"integer",type:"number",resultMetadata:{sourceField:"coin_count",sourceExpression:"count()",sourceClasses:["coin_count"],referenceId:"bcd1372d-a627-45fc-ac78-ef0dc15d79c6",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:2,character:4},end:{line:2,character:25}}},drillView:"is_new"},{name:"percent_of_value",type:"number",resultMetadata:{sourceField:"percent_of_value",sourceExpression:"total_value/all(total_value)",sourceClasses:["percent_of_value"],referenceId:"764102c9-7910-4b62-976f-9a5099e7cdc2",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:6,character:4},end:{line:7,character:52}}},annotation:{inherits:{notes:[{text:"# percent\n",at:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:6,character:4},end:{line:6,character:14}}}}]}},drillView:"is_new"},{name:"percent_of_coins",type:"number",resultMetadata:{sourceField:"percent_of_coins",sourceExpression:"coin_count/all(coin_count)",sourceClasses:["percent_of_coins"],referenceId:"3a4ca0e3-cff8-4bcf-9d97-e9b336a5ec11",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:8,character:4},end:{line:9,character:50}}},annotation:{inherits:{notes:[{text:"# percent\n",at:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:8,character:4},end:{line:8,character:14}}}}]}},drillView:"is_new"}],dialect:"duckdb",connection:"duckdb",resultMetadata:{sourceField:"is_new",filterList:[],sourceClasses:["is_new"],fieldKind:"struct",drillable:!0},annotation:{blockNotes:[{text:"# pivot\n",at:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:1,character:2},end:{line:1,character:10}}}}]},elementTypeDef:{type:"record_element"},join:"many"}],dialect:"duckdb",primaryKey:"coin_type",connection:"duckdb",resultMetadata:{sourceField:"ignoreme",filterList:[],sourceClasses:["ignoreme"],fieldKind:"struct",orderBy:[{field:"total_value",dir:"desc"}],drillable:!0}}],sourceExplore:"coins2",sourceArguments:{},connectionName:"duckdb",result:[{coin_type:"quarter",total_value:150,coin_count:6,percent_of_value:.7537688442211056,percent_of_coins:.375,is_new:[{is_new:!1,total_value:100,coin_count:4,percent_of_value:.6666666666666666,percent_of_coins:.6666666666666666},{is_new:!0,total_value:50,coin_count:2,percent_of_value:.3333333333333333,percent_of_coins:.3333333333333333}]},{coin_type:"dime",total_value:30,coin_count:3,percent_of_value:.1507537688442211,percent_of_coins:.1875,is_new:[{is_new:!0,total_value:30,coin_count:3,percent_of_value:1,percent_of_coins:1}]},{coin_type:"nickle",total_value:15,coin_count:3,percent_of_value:.07537688442211055,percent_of_coins:.1875,is_new:[{is_new:!0,total_value:15,coin_count:3,percent_of_value:1,percent_of_coins:1}]},{coin_type:"penny",total_value:4,coin_count:4,percent_of_value:.020100502512562814,percent_of_coins:.25,is_new:[{is_new:!1,total_value:2,coin_count:2,percent_of_value:.5,percent_of_coins:.5},{is_new:!0,total_value:2,coin_count:2,percent_of_value:.5,percent_of_coins:.5}]}],totalRows:4},e.appendChild(a)})();</script>
      </div>
    </div>
    <div class="result-middle" data-result-kind="json" >
      <div class="result-inner">
        <pre><pre class="language-json" style="background-color: #FBFBFB"><span class="line"><span style="color: #000000">[</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;quarter&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">150</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">6</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.7537688442211056</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_coins&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.375</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;is_new&quot;</span><span style="color: #000000">: [</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;is_new&quot;</span><span style="color: #000000">: </span><span style="color: #0000FF">false</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">100</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;percent_of_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.6666666666666666</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;percent_of_coins&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.6666666666666666</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;is_new&quot;</span><span style="color: #000000">: </span><span style="color: #0000FF">true</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">50</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;percent_of_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.3333333333333333</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;percent_of_coins&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.3333333333333333</span></span>
<span class="line"><span style="color: #000000">      }</span></span>
<span class="line"><span style="color: #000000">    ]</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;dime&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">30</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.1507537688442211</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_coins&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.1875</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;is_new&quot;</span><span style="color: #000000">: [</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;is_new&quot;</span><span style="color: #000000">: </span><span style="color: #0000FF">true</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">30</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;percent_of_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;percent_of_coins&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">      }</span></span>
<span class="line"><span style="color: #000000">    ]</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;nickle&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">15</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.07537688442211055</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_coins&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.1875</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;is_new&quot;</span><span style="color: #000000">: [</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;is_new&quot;</span><span style="color: #000000">: </span><span style="color: #0000FF">true</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">15</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;percent_of_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;percent_of_coins&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">      }</span></span>
<span class="line"><span style="color: #000000">    ]</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;penny&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.020100502512562814</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_coins&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.25</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;is_new&quot;</span><span style="color: #000000">: [</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;is_new&quot;</span><span style="color: #000000">: </span><span style="color: #0000FF">false</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;percent_of_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.5</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;percent_of_coins&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.5</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;is_new&quot;</span><span style="color: #000000">: </span><span style="color: #0000FF">true</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;percent_of_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.5</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;percent_of_coins&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.5</span></span>
<span class="line"><span style="color: #000000">      }</span></span>
<span class="line"><span style="color: #000000">    ]</span></span>
<span class="line"><span style="color: #000000">  }</span></span>
<span class="line"><span style="color: #000000">]</span></span></pre></pre>
      </div>
    </div>
    <div class="result-middle" data-result-kind="sql" >
      <div class="result-inner">
        <pre><pre class="language-sql" style="background-color: #FBFBFB"><span class="line"><span style="color: #0000FF">WITH</span><span style="color: #000000"> __stage0 </span><span style="color: #0000FF">AS</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">SELECT</span></span>
<span class="line"><span style="color: #000000">    group_set,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set </span><span style="color: #0000FF">IN</span><span style="color: #000000"> (</span><span style="color: #098658">1</span><span style="color: #000000">,</span><span style="color: #098658">2</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">1</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;penny&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">5</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;nickle&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">10</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;dime&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">25</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;quarter&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">ELSE</span><span style="color: #000000"> </span><span style="color: #0000FF">NULL</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_type__1&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">),</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;total_value__1&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #098658">1</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_count__1&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    (</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">),</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">)*</span><span style="color: #098658">1</span><span style="color: #000000">.</span><span style="color: #098658">0</span><span style="color: #000000">/</span><span style="color: #795E26">MAX</span><span style="color: #000000">((</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">0</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">),</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">)) </span><span style="color: #0000FF">OVER</span><span style="color: #000000"> () </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_value__1&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    (</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #098658">1</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">)*</span><span style="color: #098658">1</span><span style="color: #000000">.</span><span style="color: #098658">0</span><span style="color: #000000">/</span><span style="color: #795E26">MAX</span><span style="color: #000000">((</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">0</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #098658">1</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">)) </span><span style="color: #0000FF">OVER</span><span style="color: #000000"> () </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_coins__1&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">2</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      base.</span><span style="color: #A31515">&quot;minted_year&quot;</span><span style="color: #000000">&gt;=</span><span style="color: #098658">2000</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;is_new__2&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">2</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">),</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;total_value__2&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">2</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #098658">1</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_count__2&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    (</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">2</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">),</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">)*</span><span style="color: #098658">1</span><span style="color: #000000">.</span><span style="color: #098658">0</span><span style="color: #000000">/</span><span style="color: #795E26">MAX</span><span style="color: #000000">((</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">),</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">)) </span><span style="color: #0000FF">OVER</span><span style="color: #000000"> (</span><span style="color: #0000FF">PARTITION</span><span style="color: #000000"> </span><span style="color: #0000FF">BY</span><span style="color: #000000"> </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set </span><span style="color: #0000FF">IN</span><span style="color: #000000"> (</span><span style="color: #098658">1</span><span style="color: #000000">,</span><span style="color: #098658">2</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">1</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;penny&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">5</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;nickle&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">10</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;dime&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">25</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;quarter&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">ELSE</span><span style="color: #000000"> </span><span style="color: #0000FF">NULL</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_value__2&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    (</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">2</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #098658">1</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">)*</span><span style="color: #098658">1</span><span style="color: #000000">.</span><span style="color: #098658">0</span><span style="color: #000000">/</span><span style="color: #795E26">MAX</span><span style="color: #000000">((</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #098658">1</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">)) </span><span style="color: #0000FF">OVER</span><span style="color: #000000"> (</span><span style="color: #0000FF">PARTITION</span><span style="color: #000000"> </span><span style="color: #0000FF">BY</span><span style="color: #000000"> </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set </span><span style="color: #0000FF">IN</span><span style="color: #000000"> (</span><span style="color: #098658">1</span><span style="color: #000000">,</span><span style="color: #098658">2</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">1</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;penny&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">5</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;nickle&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">10</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;dime&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">25</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;quarter&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">ELSE</span><span style="color: #000000"> </span><span style="color: #0000FF">NULL</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_coins__2&quot;</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">FROM</span><span style="color: #000000"> coins.csv </span><span style="color: #0000FF">as</span><span style="color: #000000"> base</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">CROSS</span><span style="color: #000000"> </span><span style="color: #0000FF">JOIN</span><span style="color: #000000"> (</span><span style="color: #0000FF">SELECT</span><span style="color: #000000"> UNNEST(GENERATE_SERIES(</span><span style="color: #098658">0</span><span style="color: #000000">,</span><span style="color: #098658">2</span><span style="color: #000000">,</span><span style="color: #098658">1</span><span style="color: #000000">)) </span><span style="color: #0000FF">as</span><span style="color: #000000"> group_set  ) </span><span style="color: #0000FF">as</span><span style="color: #000000"> group_set</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">GROUP BY</span><span style="color: #000000"> </span><span style="color: #098658">1</span><span style="color: #000000">,</span><span style="color: #098658">2</span><span style="color: #000000">,</span><span style="color: #098658">7</span></span>
<span class="line"><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">SELECT</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #A31515">&quot;coin_type__1&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_type&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #795E26">MAX</span><span style="color: #000000">(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;total_value__1&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;total_value&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #795E26">MAX</span><span style="color: #000000">(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_count__1&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_count&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #795E26">MAX</span><span style="color: #000000">(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_value__1&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_value&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #795E26">MAX</span><span style="color: #000000">(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_coins__1&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_coins&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(LIST({</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #A31515">&quot;is_new&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;is_new__2&quot;</span><span style="color: #000000">, </span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #A31515">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;total_value__2&quot;</span><span style="color: #000000">, </span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #A31515">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;coin_count__2&quot;</span><span style="color: #000000">, </span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #A31515">&quot;percent_of_value&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;percent_of_value__2&quot;</span><span style="color: #000000">, </span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #A31515">&quot;percent_of_coins&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;percent_of_coins__2&quot;</span><span style="color: #000000">}  </span><span style="color: #0000FF">ORDER BY</span><span style="color: #000000">  </span><span style="color: #A31515">&quot;total_value__2&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">desc</span><span style="color: #000000"> NULLS </span><span style="color: #0000FF">LAST</span><span style="color: #000000">) </span><span style="color: #0000FF">FILTER</span><span style="color: #000000"> (</span><span style="color: #0000FF">WHERE</span><span style="color: #000000"> group_set=</span><span style="color: #098658">2</span><span style="color: #000000">),[]) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;is_new&quot;</span></span>
<span class="line"><span style="color: #0000FF">FROM</span><span style="color: #000000"> __stage0</span></span>
<span class="line"><span style="color: #0000FF">WHERE</span><span style="color: #000000"> group_set </span><span style="color: #0000FF">NOT</span><span style="color: #000000"> </span><span style="color: #0000FF">IN</span><span style="color: #000000"> (</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">GROUP BY</span><span style="color: #000000"> </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #0000FF">ORDER BY</span><span style="color: #000000"> </span><span style="color: #098658">2</span><span style="color: #000000"> </span><span style="color: #0000FF">desc</span><span style="color: #000000"> NULLS </span><span style="color: #0000FF">LAST</span></span>
<span class="line"></span></pre></pre>
      </div>
    </div>
  </div></div><div class="title-row">
        
      <h1>
        <a id="we-can-nest-any-query-to-get-a-more-complete-understanding-of-the-data-" class="header-link anchor" href="#we-can-nest-any-query-to-get-a-more-complete-understanding-of-the-data-">
          We can nest any query to get a more complete understanding of the data.
        </a>
      </h1>
    
        <a class="edit-link" target="_blank" href="https://github.dev/malloydata/malloydata.github.io/blob/main/src/blog/2023-11-04-data-for-kindergarten/index.malloynb#C1">VSCode <img src="/img/open_notebook.svg" alt="document"/></a>
        </div>
      <div class="code-wrapper"><a href="https://github.dev/malloydata/malloydata.github.io/blob/main/src/blog/2023-11-04-data-for-kindergarten/index.malloynb#C38" target="_blank" class="open_notebook"><img src="/img/open_notebook.svg" alt="document"/></a><pre class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">run</span><span style="color: #000000">: </span><span style="color: #001080">coins2</span><span style="color: #000000"> -&gt; </span><span style="color: #001080">coin_type</span><span style="color: #000000"> + </span><span style="color: #001080">metrics</span><span style="color: #000000"> + {</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">nest</span><span style="color: #000000">: </span><span style="color: #001080">minted_year</span><span style="color: #000000"> + </span><span style="color: #001080">coin_count</span></span>
<span class="line"><span style="color: #000000">}</span></span></pre><div class="result-outer small">
    <div class="result-controls-bar">
      <span class="result-label">QUERY RESULTS</span>
      <div class="result-controls">
        <button class="result-control" selected data-result-kind="html">HTML</button>
        <button class="result-control"  data-result-kind="json">JSON</button>
        <button class="result-control"  data-result-kind="sql">SQL</button>
      </div>
    </div>
    <div class="result-middle" data-result-kind="html" selected>
      <div class="result-inner" id="0e9acdad-e51b-4b72-b769-300cf752d73d">
        <script>(()=>{var e=document.getElementById("0e9acdad-e51b-4b72-b769-300cf752d73d"),a=document.createElement("malloy-render");a.modelDef={name:"",exports:["coins","coins2"],contents:{coins:{type:"table",name:"duckdb:coins.csv",dialect:"duckdb",tablePath:"coins.csv",connection:"duckdb",fields:[{type:"number",numberType:"integer",name:"face_value",fieldUsage:[{path:["face_value"]}]},{type:"number",numberType:"integer",name:"minted_year",fieldUsage:[{path:["minted_year"]}]},{type:"number",numberType:"integer",name:"coin_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},{type:"number",numberType:"integer",name:"total_value",e:{node:"aggregate",function:"sum",e:{node:"field",path:["face_value"]}},fieldUsage:[{path:["face_value"]}],expressionType:"aggregate",code:"face_value.sum()"},{type:"string",name:"coin_type",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"5",sql:"5"}},sql:'(base."face_value"=5)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"10",sql:"10"}},sql:'(base."face_value"=10)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"25",sql:"25"}},sql:'(base."face_value"=25)'}],caseThen:[{node:"stringLiteral",literal:"penny",sql:"'penny'"},{node:"stringLiteral",literal:"nickle",sql:"'nickle'"},{node:"stringLiteral",literal:"dime",sql:"'dime'"},{node:"stringLiteral",literal:"quarter",sql:"'quarter'"}],caseElse:{node:"null",sql:"NULL"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null"},{type:"string",name:"color",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'}],caseThen:[{node:"stringLiteral",literal:"copper",sql:"'copper'"}],caseElse:{node:"stringLiteral",literal:"silver",sql:"'silver'"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'copper' when 1\n    else 'silver'"}],parameters:{},as:"coins"},coins2:{type:"table",name:"duckdb:coins.csv",dialect:"duckdb",tablePath:"coins.csv",connection:"duckdb",fields:[{type:"number",numberType:"integer",name:"face_value",fieldUsage:[{path:["face_value"]}]},{type:"number",numberType:"integer",name:"minted_year",fieldUsage:[{path:["minted_year"]}]},{type:"number",numberType:"integer",name:"coin_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},{type:"number",numberType:"integer",name:"total_value",e:{node:"aggregate",function:"sum",e:{node:"field",path:["face_value"]}},fieldUsage:[{path:["face_value"]}],expressionType:"aggregate",code:"face_value.sum()"},{type:"string",name:"coin_type",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"5",sql:"5"}},sql:'(base."face_value"=5)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"10",sql:"10"}},sql:'(base."face_value"=10)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"25",sql:"25"}},sql:'(base."face_value"=25)'}],caseThen:[{node:"stringLiteral",literal:"penny",sql:"'penny'"},{node:"stringLiteral",literal:"nickle",sql:"'nickle'"},{node:"stringLiteral",literal:"dime",sql:"'dime'"},{node:"stringLiteral",literal:"quarter",sql:"'quarter'"}],caseElse:{node:"null",sql:"NULL"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null"},{type:"string",name:"color",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'}],caseThen:[{node:"stringLiteral",literal:"copper",sql:"'copper'"}],caseElse:{node:"stringLiteral",literal:"silver",sql:"'silver'"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'copper' when 1\n    else 'silver'"},{type:"boolean",name:"is_new",e:{node:">=",kids:{left:{node:"field",path:["minted_year"],sql:'base."minted_year"'},right:{node:"numberLiteral",literal:"2000",sql:"2000"}}},fieldUsage:[{path:["minted_year"]}],expressionType:"scalar",code:"minted_year >= 2000"},{type:"number",name:"minted_decade",e:{node:"*",kids:{left:{node:"function_call",overload:{returnType:{type:"number",expressionType:"scalar",evalSpace:"input"},params:[{name:"value",allowedTypes:[{type:"number",evalSpace:"input"}],isVariadic:!1}],dialect:{postgres:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},standardsql:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},duckdb:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},snowflake:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},trino:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},presto:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},mysql:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}}}},name:"floor",kids:{args:[{node:"/",kids:{left:{node:"field",path:["minted_year"]},right:{node:"numberLiteral",literal:"10"}}}]},expressionType:"scalar"},right:{node:"numberLiteral",literal:"10"}}},fieldUsage:[{path:["minted_year"]}],expressionType:"scalar",code:"floor(minted_year/10) * 10"},{type:"number",name:"percent_of_value",e:{node:"/",kids:{left:{node:"field",path:["total_value"],sql:'(CASE WHEN group_set=1 THEN\n  COALESCE(SUM(base."face_value"),0)\n  END)'},right:{node:"all",e:{node:"field",path:["total_value"]},sql:'MAX((CASE WHEN group_set=0 THEN\n  COALESCE(SUM(base."face_value"),0)\n  END)) OVER ()'}}},fieldUsage:[{path:["total_value"]},{path:["total_value"]}],ungroupings:[{requiresGroupBy:[],fieldUsage:[{path:["total_value"]}],ungroupedFields:"*"}],expressionType:"ungrouped_aggregate",code:"total_value/all(total_value)",annotation:{notes:[{text:"# percent\n"}]}},{type:"number",name:"percent_of_coins",e:{node:"/",kids:{left:{node:"field",path:["coin_count"],sql:"(CASE WHEN group_set=1 THEN\n  COUNT(1)\n  END)"},right:{node:"all",e:{node:"field",path:["coin_count"]},sql:"MAX((CASE WHEN group_set=0 THEN\n  COUNT(1)\n  END)) OVER ()"}}},fieldUsage:[{path:["coin_count"]},{path:["coin_count"]}],ungroupings:[{requiresGroupBy:[],fieldUsage:[{path:["coin_count"]}],ungroupedFields:"*"}],expressionType:"ungrouped_aggregate",code:"coin_count/all(coin_count)",annotation:{notes:[{text:"# percent\n"}]}},{type:"turtle",name:"metrics",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["total_value"]},{type:"fieldref",path:["coin_count"]},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}}],filterList:[],fieldUsage:[{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],defaultOrderBy:!0,orderBy:[{field:"total_value",dir:"desc"}]}],annotation:{}},{type:"turtle",name:"by_type",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["coin_type"]},{type:"fieldref",path:["total_value"],drillView:"metrics"},{type:"fieldref",path:["coin_count"],drillView:"metrics"},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"}],fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],filterList:[]}],annotation:{}}],parameters:{},as:"coins2",arguments:{}}},queryList:[{type:"query",structRef:"coins2",sourceArguments:{},pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["coin_type"]},{type:"fieldref",path:["total_value"],drillView:"metrics"},{type:"fieldref",path:["coin_count"],drillView:"metrics"},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"},{type:"turtle",name:"minted_year",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["minted_year"],drillView:"minted_year"},{type:"fieldref",path:["coin_count"],drillView:"minted_year"}],fieldUsage:[{path:["minted_year"]}]}],annotation:{},fieldUsage:[{path:["minted_year"]}]}],filterList:[],fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]},{path:["minted_year"]}],defaultOrderBy:!0,orderBy:[{field:"total_value",dir:"desc"}]}]}],dependencies:{},references:[{type:"exploreReference",text:"coins2",definition:{type:"table",name:"duckdb:coins.csv",dialect:"duckdb",tablePath:"coins.csv",connection:"duckdb",fields:[{type:"number",numberType:"integer",name:"face_value",fieldUsage:[{path:["face_value"]}]},{type:"number",numberType:"integer",name:"minted_year",fieldUsage:[{path:["minted_year"]}]},{type:"number",numberType:"integer",name:"coin_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},{type:"number",numberType:"integer",name:"total_value",e:{node:"aggregate",function:"sum",e:{node:"field",path:["face_value"]}},fieldUsage:[{path:["face_value"]}],expressionType:"aggregate",code:"face_value.sum()"},{type:"string",name:"coin_type",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"5",sql:"5"}},sql:'(base."face_value"=5)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"10",sql:"10"}},sql:'(base."face_value"=10)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"25",sql:"25"}},sql:'(base."face_value"=25)'}],caseThen:[{node:"stringLiteral",literal:"penny",sql:"'penny'"},{node:"stringLiteral",literal:"nickle",sql:"'nickle'"},{node:"stringLiteral",literal:"dime",sql:"'dime'"},{node:"stringLiteral",literal:"quarter",sql:"'quarter'"}],caseElse:{node:"null",sql:"NULL"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null"},{type:"string",name:"color",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'}],caseThen:[{node:"stringLiteral",literal:"copper",sql:"'copper'"}],caseElse:{node:"stringLiteral",literal:"silver",sql:"'silver'"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'copper' when 1\n    else 'silver'"},{type:"boolean",name:"is_new",e:{node:">=",kids:{left:{node:"field",path:["minted_year"],sql:'base."minted_year"'},right:{node:"numberLiteral",literal:"2000",sql:"2000"}}},fieldUsage:[{path:["minted_year"]}],expressionType:"scalar",code:"minted_year >= 2000"},{type:"number",name:"minted_decade",e:{node:"*",kids:{left:{node:"function_call",overload:{returnType:{type:"number",expressionType:"scalar",evalSpace:"input"},params:[{name:"value",allowedTypes:[{type:"number",evalSpace:"input"}],isVariadic:!1}],dialect:{postgres:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},standardsql:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},duckdb:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},snowflake:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},trino:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},presto:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},mysql:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}}}},name:"floor",kids:{args:[{node:"/",kids:{left:{node:"field",path:["minted_year"]},right:{node:"numberLiteral",literal:"10"}}}]},expressionType:"scalar"},right:{node:"numberLiteral",literal:"10"}}},fieldUsage:[{path:["minted_year"]}],expressionType:"scalar",code:"floor(minted_year/10) * 10"},{type:"number",name:"percent_of_value",e:{node:"/",kids:{left:{node:"field",path:["total_value"],sql:'(CASE WHEN group_set=2 THEN\n  COALESCE(SUM(base."face_value"),0)\n  END)'},right:{node:"all",e:{node:"field",path:["total_value"]},sql:'MAX((CASE WHEN group_set=1 THEN\n  COALESCE(SUM(base."face_value"),0)\n  END)) OVER (PARTITION BY CASE WHEN group_set IN (1,2) THEN\n  CASE WHEN (base."face_value"=1) THEN \'penny\' WHEN (base."face_value"=5) THEN \'nickle\' WHEN (base."face_value"=10) THEN \'dime\' WHEN (base."face_value"=25) THEN \'quarter\' ELSE NULL END\n  END)'}}},fieldUsage:[{path:["total_value"]},{path:["total_value"]}],ungroupings:[{requiresGroupBy:[],fieldUsage:[{path:["total_value"]}],ungroupedFields:"*"}],expressionType:"ungrouped_aggregate",code:"total_value/all(total_value)",annotation:{notes:[{text:"# percent\n"}]}},{type:"number",name:"percent_of_coins",e:{node:"/",kids:{left:{node:"field",path:["coin_count"],sql:"(CASE WHEN group_set=2 THEN\n  COUNT(1)\n  END)"},right:{node:"all",e:{node:"field",path:["coin_count"]},sql:"MAX((CASE WHEN group_set=1 THEN\n  COUNT(1)\n  END)) OVER (PARTITION BY CASE WHEN group_set IN (1,2) THEN\n  CASE WHEN (base.\"face_value\"=1) THEN 'penny' WHEN (base.\"face_value\"=5) THEN 'nickle' WHEN (base.\"face_value\"=10) THEN 'dime' WHEN (base.\"face_value\"=25) THEN 'quarter' ELSE NULL END\n  END)"}}},fieldUsage:[{path:["coin_count"]},{path:["coin_count"]}],ungroupings:[{requiresGroupBy:[],fieldUsage:[{path:["coin_count"]}],ungroupedFields:"*"}],expressionType:"ungrouped_aggregate",code:"coin_count/all(coin_count)",annotation:{notes:[{text:"# percent\n"}]}},{type:"turtle",name:"metrics",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["total_value"]},{type:"fieldref",path:["coin_count"]},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}}],filterList:[],fieldUsage:[{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],defaultOrderBy:!0,orderBy:[{field:"total_value",dir:"desc"}]}],annotation:{}},{type:"turtle",name:"by_type",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["coin_type"]},{type:"fieldref",path:["total_value"],drillView:"metrics"},{type:"fieldref",path:["coin_count"],drillView:"metrics"},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"}],fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],filterList:[]}],annotation:{}}],parameters:{},as:"coins2",arguments:{}}},{type:"fieldReference",definition:{type:"string",name:"coin_type",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"5",sql:"5"}},sql:'(base."face_value"=5)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"10",sql:"10"}},sql:'(base."face_value"=10)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"25",sql:"25"}},sql:'(base."face_value"=25)'}],caseThen:[{node:"stringLiteral",literal:"penny",sql:"'penny'"},{node:"stringLiteral",literal:"nickle",sql:"'nickle'"},{node:"stringLiteral",literal:"dime",sql:"'dime'"},{node:"stringLiteral",literal:"quarter",sql:"'quarter'"}],caseElse:{node:"null",sql:"NULL"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null"},text:"coin_type"},{type:"fieldReference",definition:{type:"turtle",name:"metrics",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["total_value"]},{type:"fieldref",path:["coin_count"]},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}}],filterList:[],fieldUsage:[{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],defaultOrderBy:!0,orderBy:[{field:"total_value",dir:"desc"}]}],annotation:{}},text:"metrics"},{type:"fieldReference",definition:{type:"number",numberType:"integer",name:"minted_year",fieldUsage:[{path:["minted_year"]}]},text:"minted_year"},{type:"fieldReference",definition:{type:"number",numberType:"integer",name:"coin_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},text:"coin_count"}],imports:[]},a.queryResult={lastStageName:"__stage1",malloy:"",sql:'WITH __stage0 AS (\n  SELECT\n    group_set,\n    CASE WHEN group_set IN (1,2) THEN\n      CASE WHEN (base."face_value"=1) THEN \'penny\' WHEN (base."face_value"=5) THEN \'nickle\' WHEN (base."face_value"=10) THEN \'dime\' WHEN (base."face_value"=25) THEN \'quarter\' ELSE NULL END\n      END as "coin_type__1",\n    CASE WHEN group_set=1 THEN\n      COALESCE(SUM(base."face_value"),0)\n      END as "total_value__1",\n    CASE WHEN group_set=1 THEN\n      COUNT(1)\n      END as "coin_count__1",\n    (CASE WHEN group_set=1 THEN\n      COALESCE(SUM(base."face_value"),0)\n      END)*1.0/MAX((CASE WHEN group_set=0 THEN\n      COALESCE(SUM(base."face_value"),0)\n      END)) OVER () as "percent_of_value__1",\n    (CASE WHEN group_set=1 THEN\n      COUNT(1)\n      END)*1.0/MAX((CASE WHEN group_set=0 THEN\n      COUNT(1)\n      END)) OVER () as "percent_of_coins__1",\n    CASE WHEN group_set=2 THEN\n      base."minted_year"\n      END as "minted_year__2",\n    CASE WHEN group_set=2 THEN\n      COUNT(1)\n      END as "coin_count__2"\n  FROM coins.csv as base\n  CROSS JOIN (SELECT UNNEST(GENERATE_SERIES(0,2,1)) as group_set  ) as group_set\n  GROUP BY 1,2,7\n)\nSELECT\n  "coin_type__1" as "coin_type",\n  MAX(CASE WHEN group_set=1 THEN "total_value__1" END) as "total_value",\n  MAX(CASE WHEN group_set=1 THEN "coin_count__1" END) as "coin_count",\n  MAX(CASE WHEN group_set=1 THEN "percent_of_value__1" END) as "percent_of_value",\n  MAX(CASE WHEN group_set=1 THEN "percent_of_coins__1" END) as "percent_of_coins",\n  COALESCE(LIST({\n    "minted_year": "minted_year__2", \n    "coin_count": "coin_count__2"}  ORDER BY  "coin_count__2" desc NULLS LAST) FILTER (WHERE group_set=2),[]) as "minted_year"\nFROM __stage0\nWHERE group_set NOT IN (0)\nGROUP BY 1\nORDER BY 2 desc NULLS LAST\n',dependenciesToMaterialize:{},structs:[{type:"query_result",name:"__stage1",fields:[{name:"coin_type",type:"string",resultMetadata:{sourceField:"coin_type",sourceExpression:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null",sourceClasses:["coin_type"],referenceId:"6f26c573-a752-453d-83bb-cf2e97081273",fieldKind:"dimension"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:5,character:13},end:{line:10,character:13}}}},{name:"total_value",numberType:"integer",type:"number",resultMetadata:{sourceField:"total_value",sourceExpression:"face_value.sum()",sourceClasses:["total_value"],referenceId:"fa0d8acc-9f17-4be1-b67f-e1aec4e6ac0f",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:3,character:4},end:{line:3,character:35}}},drillView:"metrics"},{name:"coin_count",numberType:"integer",type:"number",resultMetadata:{sourceField:"coin_count",sourceExpression:"count()",sourceClasses:["coin_count"],referenceId:"1894c7c9-0e75-4156-87a8-ffa8fba27299",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:2,character:4},end:{line:2,character:25}}},drillView:"metrics"},{name:"percent_of_value",type:"number",resultMetadata:{sourceField:"percent_of_value",sourceExpression:"total_value/all(total_value)",sourceClasses:["percent_of_value"],referenceId:"f32dc134-fa5f-4299-aa6c-67f210595334",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:6,character:4},end:{line:7,character:52}}},annotation:{inherits:{notes:[{text:"# percent\n",at:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:6,character:4},end:{line:6,character:14}}}}]}},drillView:"metrics"},{name:"percent_of_coins",type:"number",resultMetadata:{sourceField:"percent_of_coins",sourceExpression:"coin_count/all(coin_count)",sourceClasses:["percent_of_coins"],referenceId:"6726a67b-9015-4aaa-abb0-b04a9f30e3c5",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:8,character:4},end:{line:9,character:50}}},annotation:{inherits:{notes:[{text:"# percent\n",at:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:8,character:4},end:{line:8,character:14}}}}]}},drillView:"metrics"},{type:"array",name:"minted_year",fields:[{name:"minted_year",numberType:"integer",type:"number",resultMetadata:{sourceField:"minted_year",sourceClasses:["minted_year"],referenceId:"727cc442-bce2-490f-8e57-8c96e298a911",fieldKind:"dimension"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:0,character:17},end:{line:0,character:42}}},drillView:"minted_year"},{name:"coin_count",numberType:"integer",type:"number",resultMetadata:{sourceField:"coin_count",sourceExpression:"count()",sourceClasses:["coin_count"],referenceId:"1894c7c9-0e75-4156-87a8-ffa8fba27299",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:2,character:4},end:{line:2,character:25}}},drillView:"minted_year"}],dialect:"duckdb",connection:"duckdb",resultMetadata:{sourceField:"minted_year",filterList:[],sourceClasses:["minted_year"],fieldKind:"struct",drillable:!0},annotation:{},elementTypeDef:{type:"record_element"},join:"many"}],dialect:"duckdb",primaryKey:"coin_type",connection:"duckdb",resultMetadata:{sourceField:"ignoreme",filterList:[],sourceClasses:["ignoreme"],fieldKind:"struct",orderBy:[{field:"total_value",dir:"desc"}],drillable:!0}}],sourceExplore:"coins2",sourceArguments:{},connectionName:"duckdb",result:[{coin_type:"quarter",total_value:150,coin_count:6,percent_of_value:.7537688442211056,percent_of_coins:.375,minted_year:[{minted_year:2022,coin_count:1},{minted_year:1988,coin_count:1},{minted_year:2013,coin_count:1},{minted_year:1968,coin_count:1},{minted_year:1999,coin_count:1},{minted_year:1977,coin_count:1}]},{coin_type:"dime",total_value:30,coin_count:3,percent_of_value:.1507537688442211,percent_of_coins:.1875,minted_year:[{minted_year:2004,coin_count:1},{minted_year:2018,coin_count:1},{minted_year:2017,coin_count:1}]},{coin_type:"nickle",total_value:15,coin_count:3,percent_of_value:.07537688442211055,percent_of_coins:.1875,minted_year:[{minted_year:2012,coin_count:1},{minted_year:2014,coin_count:1},{minted_year:2e3,coin_count:1}]},{coin_type:"penny",total_value:4,coin_count:4,percent_of_value:.020100502512562814,percent_of_coins:.25,minted_year:[{minted_year:1930,coin_count:1},{minted_year:1920,coin_count:1},{minted_year:2020,coin_count:1},{minted_year:2022,coin_count:1}]}],totalRows:4},e.appendChild(a)})();</script>
      </div>
    </div>
    <div class="result-middle" data-result-kind="json" >
      <div class="result-inner">
        <pre><pre class="language-json" style="background-color: #FBFBFB"><span class="line"><span style="color: #000000">[</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;quarter&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">150</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">6</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.7537688442211056</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_coins&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.375</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;minted_year&quot;</span><span style="color: #000000">: [</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;minted_year&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2022</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;minted_year&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1988</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;minted_year&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2013</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;minted_year&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1968</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;minted_year&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1999</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;minted_year&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1977</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">      }</span></span>
<span class="line"><span style="color: #000000">    ]</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;dime&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">30</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.1507537688442211</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_coins&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.1875</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;minted_year&quot;</span><span style="color: #000000">: [</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;minted_year&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2004</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;minted_year&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2018</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;minted_year&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2017</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">      }</span></span>
<span class="line"><span style="color: #000000">    ]</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;nickle&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">15</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.07537688442211055</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_coins&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.1875</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;minted_year&quot;</span><span style="color: #000000">: [</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;minted_year&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2012</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;minted_year&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2014</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;minted_year&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2000</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">      }</span></span>
<span class="line"><span style="color: #000000">    ]</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;penny&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.020100502512562814</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_coins&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.25</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;minted_year&quot;</span><span style="color: #000000">: [</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;minted_year&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1930</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;minted_year&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1920</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;minted_year&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2020</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;minted_year&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2022</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">      }</span></span>
<span class="line"><span style="color: #000000">    ]</span></span>
<span class="line"><span style="color: #000000">  }</span></span>
<span class="line"><span style="color: #000000">]</span></span></pre></pre>
      </div>
    </div>
    <div class="result-middle" data-result-kind="sql" >
      <div class="result-inner">
        <pre><pre class="language-sql" style="background-color: #FBFBFB"><span class="line"><span style="color: #0000FF">WITH</span><span style="color: #000000"> __stage0 </span><span style="color: #0000FF">AS</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">SELECT</span></span>
<span class="line"><span style="color: #000000">    group_set,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set </span><span style="color: #0000FF">IN</span><span style="color: #000000"> (</span><span style="color: #098658">1</span><span style="color: #000000">,</span><span style="color: #098658">2</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">1</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;penny&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">5</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;nickle&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">10</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;dime&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">25</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;quarter&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">ELSE</span><span style="color: #000000"> </span><span style="color: #0000FF">NULL</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_type__1&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">),</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;total_value__1&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #098658">1</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_count__1&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    (</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">),</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">)*</span><span style="color: #098658">1</span><span style="color: #000000">.</span><span style="color: #098658">0</span><span style="color: #000000">/</span><span style="color: #795E26">MAX</span><span style="color: #000000">((</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">0</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">),</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">)) </span><span style="color: #0000FF">OVER</span><span style="color: #000000"> () </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_value__1&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    (</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #098658">1</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">)*</span><span style="color: #098658">1</span><span style="color: #000000">.</span><span style="color: #098658">0</span><span style="color: #000000">/</span><span style="color: #795E26">MAX</span><span style="color: #000000">((</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">0</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #098658">1</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">)) </span><span style="color: #0000FF">OVER</span><span style="color: #000000"> () </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_coins__1&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">2</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      base.</span><span style="color: #A31515">&quot;minted_year&quot;</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;minted_year__2&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">2</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #098658">1</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_count__2&quot;</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">FROM</span><span style="color: #000000"> coins.csv </span><span style="color: #0000FF">as</span><span style="color: #000000"> base</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">CROSS</span><span style="color: #000000"> </span><span style="color: #0000FF">JOIN</span><span style="color: #000000"> (</span><span style="color: #0000FF">SELECT</span><span style="color: #000000"> UNNEST(GENERATE_SERIES(</span><span style="color: #098658">0</span><span style="color: #000000">,</span><span style="color: #098658">2</span><span style="color: #000000">,</span><span style="color: #098658">1</span><span style="color: #000000">)) </span><span style="color: #0000FF">as</span><span style="color: #000000"> group_set  ) </span><span style="color: #0000FF">as</span><span style="color: #000000"> group_set</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">GROUP BY</span><span style="color: #000000"> </span><span style="color: #098658">1</span><span style="color: #000000">,</span><span style="color: #098658">2</span><span style="color: #000000">,</span><span style="color: #098658">7</span></span>
<span class="line"><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">SELECT</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #A31515">&quot;coin_type__1&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_type&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #795E26">MAX</span><span style="color: #000000">(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;total_value__1&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;total_value&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #795E26">MAX</span><span style="color: #000000">(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_count__1&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_count&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #795E26">MAX</span><span style="color: #000000">(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_value__1&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_value&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #795E26">MAX</span><span style="color: #000000">(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_coins__1&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_coins&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(LIST({</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #A31515">&quot;minted_year&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;minted_year__2&quot;</span><span style="color: #000000">, </span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #A31515">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;coin_count__2&quot;</span><span style="color: #000000">}  </span><span style="color: #0000FF">ORDER BY</span><span style="color: #000000">  </span><span style="color: #A31515">&quot;coin_count__2&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">desc</span><span style="color: #000000"> NULLS </span><span style="color: #0000FF">LAST</span><span style="color: #000000">) </span><span style="color: #0000FF">FILTER</span><span style="color: #000000"> (</span><span style="color: #0000FF">WHERE</span><span style="color: #000000"> group_set=</span><span style="color: #098658">2</span><span style="color: #000000">),[]) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;minted_year&quot;</span></span>
<span class="line"><span style="color: #0000FF">FROM</span><span style="color: #000000"> __stage0</span></span>
<span class="line"><span style="color: #0000FF">WHERE</span><span style="color: #000000"> group_set </span><span style="color: #0000FF">NOT</span><span style="color: #000000"> </span><span style="color: #0000FF">IN</span><span style="color: #000000"> (</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">GROUP BY</span><span style="color: #000000"> </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #0000FF">ORDER BY</span><span style="color: #000000"> </span><span style="color: #098658">2</span><span style="color: #000000"> </span><span style="color: #0000FF">desc</span><span style="color: #000000"> NULLS </span><span style="color: #0000FF">LAST</span></span>
<span class="line"></span></pre></pre>
      </div>
    </div>
  </div></div>
      <h2>
        <a id="we-nested-data-can-be-shown-with-a-variety-can-have-a-variety-of-rendering-options-" class="header-link anchor" href="#we-nested-data-can-be-shown-with-a-variety-can-have-a-variety-of-rendering-options-">
          We nested data can be shown with a variety can have a variety of rendering options.
        </a>
      </h2>
    <div class="code-wrapper"><a href="https://github.dev/malloydata/malloydata.github.io/blob/main/src/blog/2023-11-04-data-for-kindergarten/index.malloynb#C40" target="_blank" class="open_notebook"><img src="/img/open_notebook.svg" alt="document"/></a><pre class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">run</span><span style="color: #000000">: </span><span style="color: #001080">coins2</span><span style="color: #000000"> -&gt; </span><span style="color: #001080">coin_type</span><span style="color: #000000"> + </span><span style="color: #001080">metrics</span><span style="color: #000000"> + {</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0451A5"># list_detail</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">nest</span><span style="color: #000000">: </span><span style="color: #001080">minted_year</span><span style="color: #000000"> + </span><span style="color: #001080">coin_count</span></span>
<span class="line"><span style="color: #000000">}</span></span></pre><div class="result-outer small">
    <div class="result-controls-bar">
      <span class="result-label">QUERY RESULTS</span>
      <div class="result-controls">
        <button class="result-control" selected data-result-kind="html">HTML</button>
        <button class="result-control"  data-result-kind="json">JSON</button>
        <button class="result-control"  data-result-kind="sql">SQL</button>
      </div>
    </div>
    <div class="result-middle" data-result-kind="html" selected>
      <div class="result-inner" id="20694228-4eba-4088-8605-5bade1f7e111">
        <script>(()=>{var e=document.getElementById("20694228-4eba-4088-8605-5bade1f7e111"),a=document.createElement("malloy-render");a.modelDef={name:"",exports:["coins","coins2"],contents:{coins:{type:"table",name:"duckdb:coins.csv",dialect:"duckdb",tablePath:"coins.csv",connection:"duckdb",fields:[{type:"number",numberType:"integer",name:"face_value",fieldUsage:[{path:["face_value"]}]},{type:"number",numberType:"integer",name:"minted_year",fieldUsage:[{path:["minted_year"]}]},{type:"number",numberType:"integer",name:"coin_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},{type:"number",numberType:"integer",name:"total_value",e:{node:"aggregate",function:"sum",e:{node:"field",path:["face_value"]}},fieldUsage:[{path:["face_value"]}],expressionType:"aggregate",code:"face_value.sum()"},{type:"string",name:"coin_type",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"5",sql:"5"}},sql:'(base."face_value"=5)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"10",sql:"10"}},sql:'(base."face_value"=10)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"25",sql:"25"}},sql:'(base."face_value"=25)'}],caseThen:[{node:"stringLiteral",literal:"penny",sql:"'penny'"},{node:"stringLiteral",literal:"nickle",sql:"'nickle'"},{node:"stringLiteral",literal:"dime",sql:"'dime'"},{node:"stringLiteral",literal:"quarter",sql:"'quarter'"}],caseElse:{node:"null",sql:"NULL"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null"},{type:"string",name:"color",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'}],caseThen:[{node:"stringLiteral",literal:"copper",sql:"'copper'"}],caseElse:{node:"stringLiteral",literal:"silver",sql:"'silver'"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'copper' when 1\n    else 'silver'"}],parameters:{},as:"coins"},coins2:{type:"table",name:"duckdb:coins.csv",dialect:"duckdb",tablePath:"coins.csv",connection:"duckdb",fields:[{type:"number",numberType:"integer",name:"face_value",fieldUsage:[{path:["face_value"]}]},{type:"number",numberType:"integer",name:"minted_year",fieldUsage:[{path:["minted_year"]}]},{type:"number",numberType:"integer",name:"coin_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},{type:"number",numberType:"integer",name:"total_value",e:{node:"aggregate",function:"sum",e:{node:"field",path:["face_value"]}},fieldUsage:[{path:["face_value"]}],expressionType:"aggregate",code:"face_value.sum()"},{type:"string",name:"coin_type",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"5",sql:"5"}},sql:'(base."face_value"=5)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"10",sql:"10"}},sql:'(base."face_value"=10)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"25",sql:"25"}},sql:'(base."face_value"=25)'}],caseThen:[{node:"stringLiteral",literal:"penny",sql:"'penny'"},{node:"stringLiteral",literal:"nickle",sql:"'nickle'"},{node:"stringLiteral",literal:"dime",sql:"'dime'"},{node:"stringLiteral",literal:"quarter",sql:"'quarter'"}],caseElse:{node:"null",sql:"NULL"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null"},{type:"string",name:"color",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'}],caseThen:[{node:"stringLiteral",literal:"copper",sql:"'copper'"}],caseElse:{node:"stringLiteral",literal:"silver",sql:"'silver'"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'copper' when 1\n    else 'silver'"},{type:"boolean",name:"is_new",e:{node:">=",kids:{left:{node:"field",path:["minted_year"],sql:'base."minted_year"'},right:{node:"numberLiteral",literal:"2000",sql:"2000"}}},fieldUsage:[{path:["minted_year"]}],expressionType:"scalar",code:"minted_year >= 2000"},{type:"number",name:"minted_decade",e:{node:"*",kids:{left:{node:"function_call",overload:{returnType:{type:"number",expressionType:"scalar",evalSpace:"input"},params:[{name:"value",allowedTypes:[{type:"number",evalSpace:"input"}],isVariadic:!1}],dialect:{postgres:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},standardsql:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},duckdb:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},snowflake:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},trino:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},presto:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},mysql:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}}}},name:"floor",kids:{args:[{node:"/",kids:{left:{node:"field",path:["minted_year"]},right:{node:"numberLiteral",literal:"10"}}}]},expressionType:"scalar"},right:{node:"numberLiteral",literal:"10"}}},fieldUsage:[{path:["minted_year"]}],expressionType:"scalar",code:"floor(minted_year/10) * 10"},{type:"number",name:"percent_of_value",e:{node:"/",kids:{left:{node:"field",path:["total_value"],sql:'(CASE WHEN group_set=1 THEN\n  COALESCE(SUM(base."face_value"),0)\n  END)'},right:{node:"all",e:{node:"field",path:["total_value"]},sql:'MAX((CASE WHEN group_set=0 THEN\n  COALESCE(SUM(base."face_value"),0)\n  END)) OVER ()'}}},fieldUsage:[{path:["total_value"]},{path:["total_value"]}],ungroupings:[{requiresGroupBy:[],fieldUsage:[{path:["total_value"]}],ungroupedFields:"*"}],expressionType:"ungrouped_aggregate",code:"total_value/all(total_value)",annotation:{notes:[{text:"# percent\n"}]}},{type:"number",name:"percent_of_coins",e:{node:"/",kids:{left:{node:"field",path:["coin_count"],sql:"(CASE WHEN group_set=1 THEN\n  COUNT(1)\n  END)"},right:{node:"all",e:{node:"field",path:["coin_count"]},sql:"MAX((CASE WHEN group_set=0 THEN\n  COUNT(1)\n  END)) OVER ()"}}},fieldUsage:[{path:["coin_count"]},{path:["coin_count"]}],ungroupings:[{requiresGroupBy:[],fieldUsage:[{path:["coin_count"]}],ungroupedFields:"*"}],expressionType:"ungrouped_aggregate",code:"coin_count/all(coin_count)",annotation:{notes:[{text:"# percent\n"}]}},{type:"turtle",name:"metrics",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["total_value"]},{type:"fieldref",path:["coin_count"]},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}}],filterList:[],fieldUsage:[{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],defaultOrderBy:!0,orderBy:[{field:"total_value",dir:"desc"}]}],annotation:{}},{type:"turtle",name:"by_type",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["coin_type"]},{type:"fieldref",path:["total_value"],drillView:"metrics"},{type:"fieldref",path:["coin_count"],drillView:"metrics"},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"}],fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],filterList:[]}],annotation:{}}],parameters:{},as:"coins2",arguments:{}}},queryList:[{type:"query",structRef:"coins2",sourceArguments:{},pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["coin_type"]},{type:"fieldref",path:["total_value"],drillView:"metrics"},{type:"fieldref",path:["coin_count"],drillView:"metrics"},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"},{type:"turtle",name:"minted_year",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["minted_year"],drillView:"minted_year"},{type:"fieldref",path:["coin_count"],drillView:"minted_year"}],fieldUsage:[{path:["minted_year"]}]}],annotation:{blockNotes:[{text:"# list_detail\n"}]},fieldUsage:[{path:["minted_year"]}]}],filterList:[],fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]},{path:["minted_year"]}],defaultOrderBy:!0,orderBy:[{field:"total_value",dir:"desc"}]}]}],dependencies:{},references:[{type:"exploreReference",text:"coins2",definition:{type:"table",name:"duckdb:coins.csv",dialect:"duckdb",tablePath:"coins.csv",connection:"duckdb",fields:[{type:"number",numberType:"integer",name:"face_value",fieldUsage:[{path:["face_value"]}]},{type:"number",numberType:"integer",name:"minted_year",fieldUsage:[{path:["minted_year"]}]},{type:"number",numberType:"integer",name:"coin_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},{type:"number",numberType:"integer",name:"total_value",e:{node:"aggregate",function:"sum",e:{node:"field",path:["face_value"]}},fieldUsage:[{path:["face_value"]}],expressionType:"aggregate",code:"face_value.sum()"},{type:"string",name:"coin_type",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"5",sql:"5"}},sql:'(base."face_value"=5)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"10",sql:"10"}},sql:'(base."face_value"=10)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"25",sql:"25"}},sql:'(base."face_value"=25)'}],caseThen:[{node:"stringLiteral",literal:"penny",sql:"'penny'"},{node:"stringLiteral",literal:"nickle",sql:"'nickle'"},{node:"stringLiteral",literal:"dime",sql:"'dime'"},{node:"stringLiteral",literal:"quarter",sql:"'quarter'"}],caseElse:{node:"null",sql:"NULL"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null"},{type:"string",name:"color",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'}],caseThen:[{node:"stringLiteral",literal:"copper",sql:"'copper'"}],caseElse:{node:"stringLiteral",literal:"silver",sql:"'silver'"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'copper' when 1\n    else 'silver'"},{type:"boolean",name:"is_new",e:{node:">=",kids:{left:{node:"field",path:["minted_year"],sql:'base."minted_year"'},right:{node:"numberLiteral",literal:"2000",sql:"2000"}}},fieldUsage:[{path:["minted_year"]}],expressionType:"scalar",code:"minted_year >= 2000"},{type:"number",name:"minted_decade",e:{node:"*",kids:{left:{node:"function_call",overload:{returnType:{type:"number",expressionType:"scalar",evalSpace:"input"},params:[{name:"value",allowedTypes:[{type:"number",evalSpace:"input"}],isVariadic:!1}],dialect:{postgres:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},standardsql:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},duckdb:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},snowflake:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},trino:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},presto:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},mysql:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}}}},name:"floor",kids:{args:[{node:"/",kids:{left:{node:"field",path:["minted_year"]},right:{node:"numberLiteral",literal:"10"}}}]},expressionType:"scalar"},right:{node:"numberLiteral",literal:"10"}}},fieldUsage:[{path:["minted_year"]}],expressionType:"scalar",code:"floor(minted_year/10) * 10"},{type:"number",name:"percent_of_value",e:{node:"/",kids:{left:{node:"field",path:["total_value"],sql:'(CASE WHEN group_set=1 THEN\n  COALESCE(SUM(base."face_value"),0)\n  END)'},right:{node:"all",e:{node:"field",path:["total_value"]},sql:'MAX((CASE WHEN group_set=0 THEN\n  COALESCE(SUM(base."face_value"),0)\n  END)) OVER ()'}}},fieldUsage:[{path:["total_value"]},{path:["total_value"]}],ungroupings:[{requiresGroupBy:[],fieldUsage:[{path:["total_value"]}],ungroupedFields:"*"}],expressionType:"ungrouped_aggregate",code:"total_value/all(total_value)",annotation:{notes:[{text:"# percent\n"}]}},{type:"number",name:"percent_of_coins",e:{node:"/",kids:{left:{node:"field",path:["coin_count"],sql:"(CASE WHEN group_set=1 THEN\n  COUNT(1)\n  END)"},right:{node:"all",e:{node:"field",path:["coin_count"]},sql:"MAX((CASE WHEN group_set=0 THEN\n  COUNT(1)\n  END)) OVER ()"}}},fieldUsage:[{path:["coin_count"]},{path:["coin_count"]}],ungroupings:[{requiresGroupBy:[],fieldUsage:[{path:["coin_count"]}],ungroupedFields:"*"}],expressionType:"ungrouped_aggregate",code:"coin_count/all(coin_count)",annotation:{notes:[{text:"# percent\n"}]}},{type:"turtle",name:"metrics",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["total_value"]},{type:"fieldref",path:["coin_count"]},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}}],filterList:[],fieldUsage:[{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],defaultOrderBy:!0,orderBy:[{field:"total_value",dir:"desc"}]}],annotation:{}},{type:"turtle",name:"by_type",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["coin_type"]},{type:"fieldref",path:["total_value"],drillView:"metrics"},{type:"fieldref",path:["coin_count"],drillView:"metrics"},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"}],fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],filterList:[]}],annotation:{}}],parameters:{},as:"coins2",arguments:{}}},{type:"fieldReference",definition:{type:"string",name:"coin_type",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"5",sql:"5"}},sql:'(base."face_value"=5)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"10",sql:"10"}},sql:'(base."face_value"=10)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"25",sql:"25"}},sql:'(base."face_value"=25)'}],caseThen:[{node:"stringLiteral",literal:"penny",sql:"'penny'"},{node:"stringLiteral",literal:"nickle",sql:"'nickle'"},{node:"stringLiteral",literal:"dime",sql:"'dime'"},{node:"stringLiteral",literal:"quarter",sql:"'quarter'"}],caseElse:{node:"null",sql:"NULL"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null"},text:"coin_type"},{type:"fieldReference",definition:{type:"turtle",name:"metrics",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["total_value"]},{type:"fieldref",path:["coin_count"]},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}}],filterList:[],fieldUsage:[{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],defaultOrderBy:!0,orderBy:[{field:"total_value",dir:"desc"}]}],annotation:{}},text:"metrics"},{type:"fieldReference",definition:{type:"number",numberType:"integer",name:"minted_year",fieldUsage:[{path:["minted_year"]}]},text:"minted_year"},{type:"fieldReference",definition:{type:"number",numberType:"integer",name:"coin_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},text:"coin_count"}],imports:[]},a.queryResult={lastStageName:"__stage1",malloy:"",sql:'WITH __stage0 AS (\n  SELECT\n    group_set,\n    CASE WHEN group_set IN (1,2) THEN\n      CASE WHEN (base."face_value"=1) THEN \'penny\' WHEN (base."face_value"=5) THEN \'nickle\' WHEN (base."face_value"=10) THEN \'dime\' WHEN (base."face_value"=25) THEN \'quarter\' ELSE NULL END\n      END as "coin_type__1",\n    CASE WHEN group_set=1 THEN\n      COALESCE(SUM(base."face_value"),0)\n      END as "total_value__1",\n    CASE WHEN group_set=1 THEN\n      COUNT(1)\n      END as "coin_count__1",\n    (CASE WHEN group_set=1 THEN\n      COALESCE(SUM(base."face_value"),0)\n      END)*1.0/MAX((CASE WHEN group_set=0 THEN\n      COALESCE(SUM(base."face_value"),0)\n      END)) OVER () as "percent_of_value__1",\n    (CASE WHEN group_set=1 THEN\n      COUNT(1)\n      END)*1.0/MAX((CASE WHEN group_set=0 THEN\n      COUNT(1)\n      END)) OVER () as "percent_of_coins__1",\n    CASE WHEN group_set=2 THEN\n      base."minted_year"\n      END as "minted_year__2",\n    CASE WHEN group_set=2 THEN\n      COUNT(1)\n      END as "coin_count__2"\n  FROM coins.csv as base\n  CROSS JOIN (SELECT UNNEST(GENERATE_SERIES(0,2,1)) as group_set  ) as group_set\n  GROUP BY 1,2,7\n)\nSELECT\n  "coin_type__1" as "coin_type",\n  MAX(CASE WHEN group_set=1 THEN "total_value__1" END) as "total_value",\n  MAX(CASE WHEN group_set=1 THEN "coin_count__1" END) as "coin_count",\n  MAX(CASE WHEN group_set=1 THEN "percent_of_value__1" END) as "percent_of_value",\n  MAX(CASE WHEN group_set=1 THEN "percent_of_coins__1" END) as "percent_of_coins",\n  COALESCE(LIST({\n    "minted_year": "minted_year__2", \n    "coin_count": "coin_count__2"}  ORDER BY  "coin_count__2" desc NULLS LAST) FILTER (WHERE group_set=2),[]) as "minted_year"\nFROM __stage0\nWHERE group_set NOT IN (0)\nGROUP BY 1\nORDER BY 2 desc NULLS LAST\n',dependenciesToMaterialize:{},structs:[{type:"query_result",name:"__stage1",fields:[{name:"coin_type",type:"string",resultMetadata:{sourceField:"coin_type",sourceExpression:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null",sourceClasses:["coin_type"],referenceId:"a5f1dda7-3d3a-4d1e-943f-2b98ef2cfd3a",fieldKind:"dimension"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:5,character:13},end:{line:10,character:13}}}},{name:"total_value",numberType:"integer",type:"number",resultMetadata:{sourceField:"total_value",sourceExpression:"face_value.sum()",sourceClasses:["total_value"],referenceId:"c60c37b5-c124-4222-92dc-d855712c4d10",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:3,character:4},end:{line:3,character:35}}},drillView:"metrics"},{name:"coin_count",numberType:"integer",type:"number",resultMetadata:{sourceField:"coin_count",sourceExpression:"count()",sourceClasses:["coin_count"],referenceId:"51f15f56-3e70-4523-98dc-7452cee52061",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:2,character:4},end:{line:2,character:25}}},drillView:"metrics"},{name:"percent_of_value",type:"number",resultMetadata:{sourceField:"percent_of_value",sourceExpression:"total_value/all(total_value)",sourceClasses:["percent_of_value"],referenceId:"95ad894b-9b24-4d2f-925a-b723af985ef4",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:6,character:4},end:{line:7,character:52}}},annotation:{inherits:{notes:[{text:"# percent\n",at:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:6,character:4},end:{line:6,character:14}}}}]}},drillView:"metrics"},{name:"percent_of_coins",type:"number",resultMetadata:{sourceField:"percent_of_coins",sourceExpression:"coin_count/all(coin_count)",sourceClasses:["percent_of_coins"],referenceId:"cc451828-f6fb-4555-acc1-3576e0982746",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:8,character:4},end:{line:9,character:50}}},annotation:{inherits:{notes:[{text:"# percent\n",at:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:8,character:4},end:{line:8,character:14}}}}]}},drillView:"metrics"},{type:"array",name:"minted_year",fields:[{name:"minted_year",numberType:"integer",type:"number",resultMetadata:{sourceField:"minted_year",sourceClasses:["minted_year"],referenceId:"49772c47-fd34-4b4a-a0e9-7104a203fbc9",fieldKind:"dimension"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:0,character:17},end:{line:0,character:42}}},drillView:"minted_year"},{name:"coin_count",numberType:"integer",type:"number",resultMetadata:{sourceField:"coin_count",sourceExpression:"count()",sourceClasses:["coin_count"],referenceId:"51f15f56-3e70-4523-98dc-7452cee52061",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:2,character:4},end:{line:2,character:25}}},drillView:"minted_year"}],dialect:"duckdb",connection:"duckdb",resultMetadata:{sourceField:"minted_year",filterList:[],sourceClasses:["minted_year"],fieldKind:"struct",drillable:!0},annotation:{blockNotes:[{text:"# list_detail\n",at:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:1,character:2},end:{line:1,character:16}}}}]},elementTypeDef:{type:"record_element"},join:"many"}],dialect:"duckdb",primaryKey:"coin_type",connection:"duckdb",resultMetadata:{sourceField:"ignoreme",filterList:[],sourceClasses:["ignoreme"],fieldKind:"struct",orderBy:[{field:"total_value",dir:"desc"}],drillable:!0}}],sourceExplore:"coins2",sourceArguments:{},connectionName:"duckdb",result:[{coin_type:"quarter",total_value:150,coin_count:6,percent_of_value:.7537688442211056,percent_of_coins:.375,minted_year:[{minted_year:2022,coin_count:1},{minted_year:1988,coin_count:1},{minted_year:2013,coin_count:1},{minted_year:1968,coin_count:1},{minted_year:1999,coin_count:1},{minted_year:1977,coin_count:1}]},{coin_type:"dime",total_value:30,coin_count:3,percent_of_value:.1507537688442211,percent_of_coins:.1875,minted_year:[{minted_year:2004,coin_count:1},{minted_year:2018,coin_count:1},{minted_year:2017,coin_count:1}]},{coin_type:"nickle",total_value:15,coin_count:3,percent_of_value:.07537688442211055,percent_of_coins:.1875,minted_year:[{minted_year:2012,coin_count:1},{minted_year:2014,coin_count:1},{minted_year:2e3,coin_count:1}]},{coin_type:"penny",total_value:4,coin_count:4,percent_of_value:.020100502512562814,percent_of_coins:.25,minted_year:[{minted_year:1930,coin_count:1},{minted_year:1920,coin_count:1},{minted_year:2020,coin_count:1},{minted_year:2022,coin_count:1}]}],totalRows:4},e.appendChild(a)})();</script>
      </div>
    </div>
    <div class="result-middle" data-result-kind="json" >
      <div class="result-inner">
        <pre><pre class="language-json" style="background-color: #FBFBFB"><span class="line"><span style="color: #000000">[</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;quarter&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">150</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">6</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.7537688442211056</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_coins&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.375</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;minted_year&quot;</span><span style="color: #000000">: [</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;minted_year&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2022</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;minted_year&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1988</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;minted_year&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2013</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;minted_year&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1968</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;minted_year&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1999</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;minted_year&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1977</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">      }</span></span>
<span class="line"><span style="color: #000000">    ]</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;dime&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">30</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.1507537688442211</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_coins&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.1875</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;minted_year&quot;</span><span style="color: #000000">: [</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;minted_year&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2004</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;minted_year&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2018</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;minted_year&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2017</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">      }</span></span>
<span class="line"><span style="color: #000000">    ]</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;nickle&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">15</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.07537688442211055</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_coins&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.1875</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;minted_year&quot;</span><span style="color: #000000">: [</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;minted_year&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2012</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;minted_year&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2014</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;minted_year&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2000</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">      }</span></span>
<span class="line"><span style="color: #000000">    ]</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;penny&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.020100502512562814</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_coins&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.25</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;minted_year&quot;</span><span style="color: #000000">: [</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;minted_year&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1930</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;minted_year&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1920</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;minted_year&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2020</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;minted_year&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2022</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">      }</span></span>
<span class="line"><span style="color: #000000">    ]</span></span>
<span class="line"><span style="color: #000000">  }</span></span>
<span class="line"><span style="color: #000000">]</span></span></pre></pre>
      </div>
    </div>
    <div class="result-middle" data-result-kind="sql" >
      <div class="result-inner">
        <pre><pre class="language-sql" style="background-color: #FBFBFB"><span class="line"><span style="color: #0000FF">WITH</span><span style="color: #000000"> __stage0 </span><span style="color: #0000FF">AS</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">SELECT</span></span>
<span class="line"><span style="color: #000000">    group_set,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set </span><span style="color: #0000FF">IN</span><span style="color: #000000"> (</span><span style="color: #098658">1</span><span style="color: #000000">,</span><span style="color: #098658">2</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">1</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;penny&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">5</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;nickle&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">10</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;dime&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">25</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;quarter&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">ELSE</span><span style="color: #000000"> </span><span style="color: #0000FF">NULL</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_type__1&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">),</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;total_value__1&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #098658">1</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_count__1&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    (</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">),</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">)*</span><span style="color: #098658">1</span><span style="color: #000000">.</span><span style="color: #098658">0</span><span style="color: #000000">/</span><span style="color: #795E26">MAX</span><span style="color: #000000">((</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">0</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">),</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">)) </span><span style="color: #0000FF">OVER</span><span style="color: #000000"> () </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_value__1&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    (</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #098658">1</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">)*</span><span style="color: #098658">1</span><span style="color: #000000">.</span><span style="color: #098658">0</span><span style="color: #000000">/</span><span style="color: #795E26">MAX</span><span style="color: #000000">((</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">0</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #098658">1</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">)) </span><span style="color: #0000FF">OVER</span><span style="color: #000000"> () </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_coins__1&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">2</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      base.</span><span style="color: #A31515">&quot;minted_year&quot;</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;minted_year__2&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">2</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #098658">1</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_count__2&quot;</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">FROM</span><span style="color: #000000"> coins.csv </span><span style="color: #0000FF">as</span><span style="color: #000000"> base</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">CROSS</span><span style="color: #000000"> </span><span style="color: #0000FF">JOIN</span><span style="color: #000000"> (</span><span style="color: #0000FF">SELECT</span><span style="color: #000000"> UNNEST(GENERATE_SERIES(</span><span style="color: #098658">0</span><span style="color: #000000">,</span><span style="color: #098658">2</span><span style="color: #000000">,</span><span style="color: #098658">1</span><span style="color: #000000">)) </span><span style="color: #0000FF">as</span><span style="color: #000000"> group_set  ) </span><span style="color: #0000FF">as</span><span style="color: #000000"> group_set</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">GROUP BY</span><span style="color: #000000"> </span><span style="color: #098658">1</span><span style="color: #000000">,</span><span style="color: #098658">2</span><span style="color: #000000">,</span><span style="color: #098658">7</span></span>
<span class="line"><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">SELECT</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #A31515">&quot;coin_type__1&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_type&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #795E26">MAX</span><span style="color: #000000">(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;total_value__1&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;total_value&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #795E26">MAX</span><span style="color: #000000">(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_count__1&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_count&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #795E26">MAX</span><span style="color: #000000">(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_value__1&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_value&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #795E26">MAX</span><span style="color: #000000">(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_coins__1&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_coins&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(LIST({</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #A31515">&quot;minted_year&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;minted_year__2&quot;</span><span style="color: #000000">, </span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #A31515">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;coin_count__2&quot;</span><span style="color: #000000">}  </span><span style="color: #0000FF">ORDER BY</span><span style="color: #000000">  </span><span style="color: #A31515">&quot;coin_count__2&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">desc</span><span style="color: #000000"> NULLS </span><span style="color: #0000FF">LAST</span><span style="color: #000000">) </span><span style="color: #0000FF">FILTER</span><span style="color: #000000"> (</span><span style="color: #0000FF">WHERE</span><span style="color: #000000"> group_set=</span><span style="color: #098658">2</span><span style="color: #000000">),[]) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;minted_year&quot;</span></span>
<span class="line"><span style="color: #0000FF">FROM</span><span style="color: #000000"> __stage0</span></span>
<span class="line"><span style="color: #0000FF">WHERE</span><span style="color: #000000"> group_set </span><span style="color: #0000FF">NOT</span><span style="color: #000000"> </span><span style="color: #0000FF">IN</span><span style="color: #000000"> (</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">GROUP BY</span><span style="color: #000000"> </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #0000FF">ORDER BY</span><span style="color: #000000"> </span><span style="color: #098658">2</span><span style="color: #000000"> </span><span style="color: #0000FF">desc</span><span style="color: #000000"> NULLS </span><span style="color: #0000FF">LAST</span></span>
<span class="line"></span></pre></pre>
      </div>
    </div>
  </div></div>
      <h2>
        <a id="choosing-a-different-outer-dimension-teaches-us-something-entirely-different-" class="header-link anchor" href="#choosing-a-different-outer-dimension-teaches-us-something-entirely-different-">
          Choosing a different outer dimension teaches us something entirely different.
        </a>
      </h2>
    <div class="code-wrapper"><a href="https://github.dev/malloydata/malloydata.github.io/blob/main/src/blog/2023-11-04-data-for-kindergarten/index.malloynb#C42" target="_blank" class="open_notebook"><img src="/img/open_notebook.svg" alt="document"/></a><pre class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">run</span><span style="color: #000000">: </span><span style="color: #001080">coins2</span><span style="color: #000000"> -&gt; </span><span style="color: #001080">minted_decade</span><span style="color: #000000"> + </span><span style="color: #001080">metrics</span><span style="color: #000000"> + {</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">order_by</span><span style="color: #000000">: </span><span style="color: #001080">minted_decade</span><span style="color: #000000"> </span><span style="color: #AF00DB">desc</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">nest</span><span style="color: #000000">: </span><span style="color: #001080">by_type</span></span>
<span class="line"><span style="color: #000000">}</span></span></pre><div class="result-outer small">
    <div class="result-controls-bar">
      <span class="result-label">QUERY RESULTS</span>
      <div class="result-controls">
        <button class="result-control" selected data-result-kind="html">HTML</button>
        <button class="result-control"  data-result-kind="json">JSON</button>
        <button class="result-control"  data-result-kind="sql">SQL</button>
      </div>
    </div>
    <div class="result-middle" data-result-kind="html" selected>
      <div class="result-inner" id="5f4e1a7b-1d32-4c05-a222-b7992f4c76b0">
        <script>(()=>{var e=document.getElementById("5f4e1a7b-1d32-4c05-a222-b7992f4c76b0"),a=document.createElement("malloy-render");a.modelDef={name:"",exports:["coins","coins2"],contents:{coins:{type:"table",name:"duckdb:coins.csv",dialect:"duckdb",tablePath:"coins.csv",connection:"duckdb",fields:[{type:"number",numberType:"integer",name:"face_value",fieldUsage:[{path:["face_value"]}]},{type:"number",numberType:"integer",name:"minted_year",fieldUsage:[{path:["minted_year"]}]},{type:"number",numberType:"integer",name:"coin_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},{type:"number",numberType:"integer",name:"total_value",e:{node:"aggregate",function:"sum",e:{node:"field",path:["face_value"]}},fieldUsage:[{path:["face_value"]}],expressionType:"aggregate",code:"face_value.sum()"},{type:"string",name:"coin_type",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"5",sql:"5"}},sql:'(base."face_value"=5)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"10",sql:"10"}},sql:'(base."face_value"=10)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"25",sql:"25"}},sql:'(base."face_value"=25)'}],caseThen:[{node:"stringLiteral",literal:"penny",sql:"'penny'"},{node:"stringLiteral",literal:"nickle",sql:"'nickle'"},{node:"stringLiteral",literal:"dime",sql:"'dime'"},{node:"stringLiteral",literal:"quarter",sql:"'quarter'"}],caseElse:{node:"null",sql:"NULL"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null"},{type:"string",name:"color",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'}],caseThen:[{node:"stringLiteral",literal:"copper",sql:"'copper'"}],caseElse:{node:"stringLiteral",literal:"silver",sql:"'silver'"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'copper' when 1\n    else 'silver'"}],parameters:{},as:"coins"},coins2:{type:"table",name:"duckdb:coins.csv",dialect:"duckdb",tablePath:"coins.csv",connection:"duckdb",fields:[{type:"number",numberType:"integer",name:"face_value",fieldUsage:[{path:["face_value"]}]},{type:"number",numberType:"integer",name:"minted_year",fieldUsage:[{path:["minted_year"]}]},{type:"number",numberType:"integer",name:"coin_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},{type:"number",numberType:"integer",name:"total_value",e:{node:"aggregate",function:"sum",e:{node:"field",path:["face_value"]}},fieldUsage:[{path:["face_value"]}],expressionType:"aggregate",code:"face_value.sum()"},{type:"string",name:"coin_type",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"5",sql:"5"}},sql:'(base."face_value"=5)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"10",sql:"10"}},sql:'(base."face_value"=10)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"25",sql:"25"}},sql:'(base."face_value"=25)'}],caseThen:[{node:"stringLiteral",literal:"penny",sql:"'penny'"},{node:"stringLiteral",literal:"nickle",sql:"'nickle'"},{node:"stringLiteral",literal:"dime",sql:"'dime'"},{node:"stringLiteral",literal:"quarter",sql:"'quarter'"}],caseElse:{node:"null",sql:"NULL"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null"},{type:"string",name:"color",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'}],caseThen:[{node:"stringLiteral",literal:"copper",sql:"'copper'"}],caseElse:{node:"stringLiteral",literal:"silver",sql:"'silver'"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'copper' when 1\n    else 'silver'"},{type:"boolean",name:"is_new",e:{node:">=",kids:{left:{node:"field",path:["minted_year"],sql:'base."minted_year"'},right:{node:"numberLiteral",literal:"2000",sql:"2000"}}},fieldUsage:[{path:["minted_year"]}],expressionType:"scalar",code:"minted_year >= 2000"},{type:"number",name:"minted_decade",e:{node:"*",kids:{left:{node:"function_call",overload:{returnType:{type:"number",expressionType:"scalar",evalSpace:"input"},params:[{name:"value",allowedTypes:[{type:"number",evalSpace:"input"}],isVariadic:!1}],dialect:{postgres:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},standardsql:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},duckdb:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},snowflake:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},trino:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},presto:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},mysql:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}}}},name:"floor",kids:{args:[{node:"/",kids:{left:{node:"field",path:["minted_year"],sql:'base."minted_year"'},right:{node:"numberLiteral",literal:"10",sql:"10"}},sql:'(base."minted_year"*1.0/10)'}]},expressionType:"scalar",sql:'(FLOOR(base."minted_year"*1.0/10))'},right:{node:"numberLiteral",literal:"10",sql:"10"}}},fieldUsage:[{path:["minted_year"]}],expressionType:"scalar",code:"floor(minted_year/10) * 10"},{type:"number",name:"percent_of_value",e:{node:"/",kids:{left:{node:"field",path:["total_value"],sql:'(CASE WHEN group_set=2 THEN\n  COALESCE(SUM(base."face_value"),0)\n  END)'},right:{node:"all",e:{node:"field",path:["total_value"]},sql:'MAX((CASE WHEN group_set=1 THEN\n  COALESCE(SUM(base."face_value"),0)\n  END)) OVER (PARTITION BY CASE WHEN group_set IN (1,2) THEN\n  (FLOOR(base."minted_year"*1.0/10))*10\n  END)'}}},fieldUsage:[{path:["total_value"]},{path:["total_value"]}],ungroupings:[{requiresGroupBy:[],fieldUsage:[{path:["total_value"]}],ungroupedFields:"*"}],expressionType:"ungrouped_aggregate",code:"total_value/all(total_value)",annotation:{notes:[{text:"# percent\n"}]}},{type:"number",name:"percent_of_coins",e:{node:"/",kids:{left:{node:"field",path:["coin_count"],sql:"(CASE WHEN group_set=2 THEN\n  COUNT(1)\n  END)"},right:{node:"all",e:{node:"field",path:["coin_count"]},sql:'MAX((CASE WHEN group_set=1 THEN\n  COUNT(1)\n  END)) OVER (PARTITION BY CASE WHEN group_set IN (1,2) THEN\n  (FLOOR(base."minted_year"*1.0/10))*10\n  END)'}}},fieldUsage:[{path:["coin_count"]},{path:["coin_count"]}],ungroupings:[{requiresGroupBy:[],fieldUsage:[{path:["coin_count"]}],ungroupedFields:"*"}],expressionType:"ungrouped_aggregate",code:"coin_count/all(coin_count)",annotation:{notes:[{text:"# percent\n"}]}},{type:"turtle",name:"metrics",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["total_value"]},{type:"fieldref",path:["coin_count"]},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}}],filterList:[],fieldUsage:[{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],defaultOrderBy:!0,orderBy:[{field:"total_value",dir:"desc"}]}],annotation:{}},{type:"turtle",name:"by_type",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["coin_type"]},{type:"fieldref",path:["total_value"],drillView:"metrics"},{type:"fieldref",path:["coin_count"],drillView:"metrics"},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"}],fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],filterList:[]}],annotation:{}}],parameters:{},as:"coins2",arguments:{}}},queryList:[{type:"query",structRef:"coins2",sourceArguments:{},pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["minted_decade"]},{type:"fieldref",path:["total_value"],drillView:"metrics"},{type:"fieldref",path:["coin_count"],drillView:"metrics"},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"},{type:"turtle",name:"by_type",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["coin_type"],drillView:"by_type"},{type:"fieldref",path:["total_value"],drillView:"by_type"},{type:"fieldref",path:["coin_count"],drillView:"by_type"},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"by_type"},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"by_type"}],fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],filterList:[],referencedAt:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:2,character:8},end:{line:2,character:15}}}}],annotation:{inherits:{}},fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}]}],orderBy:[{field:"minted_decade",dir:"desc"}],filterList:[],fieldUsage:[{path:["minted_year"]},{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}]}]}],dependencies:{},references:[{type:"exploreReference",text:"coins2",definition:{type:"table",name:"duckdb:coins.csv",dialect:"duckdb",tablePath:"coins.csv",connection:"duckdb",fields:[{type:"number",numberType:"integer",name:"face_value",fieldUsage:[{path:["face_value"]}]},{type:"number",numberType:"integer",name:"minted_year",fieldUsage:[{path:["minted_year"]}]},{type:"number",numberType:"integer",name:"coin_count",e:{node:"aggregate",function:"count",e:{node:""}},fieldUsage:[],expressionType:"aggregate",code:"count()"},{type:"number",numberType:"integer",name:"total_value",e:{node:"aggregate",function:"sum",e:{node:"field",path:["face_value"]}},fieldUsage:[{path:["face_value"]}],expressionType:"aggregate",code:"face_value.sum()"},{type:"string",name:"coin_type",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"5",sql:"5"}},sql:'(base."face_value"=5)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"10",sql:"10"}},sql:'(base."face_value"=10)'},{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"25",sql:"25"}},sql:'(base."face_value"=25)'}],caseThen:[{node:"stringLiteral",literal:"penny",sql:"'penny'"},{node:"stringLiteral",literal:"nickle",sql:"'nickle'"},{node:"stringLiteral",literal:"dime",sql:"'dime'"},{node:"stringLiteral",literal:"quarter",sql:"'quarter'"}],caseElse:{node:"null",sql:"NULL"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null"},{type:"string",name:"color",e:{node:"case",kids:{caseWhen:[{node:"=",kids:{left:{node:"field",path:["face_value"],sql:'base."face_value"'},right:{node:"numberLiteral",literal:"1",sql:"1"}},sql:'(base."face_value"=1)'}],caseThen:[{node:"stringLiteral",literal:"copper",sql:"'copper'"}],caseElse:{node:"stringLiteral",literal:"silver",sql:"'silver'"}}},fieldUsage:[{path:["face_value"]},{path:["face_value"]}],expressionType:"scalar",code:"face_value ? \n    pick 'copper' when 1\n    else 'silver'"},{type:"boolean",name:"is_new",e:{node:">=",kids:{left:{node:"field",path:["minted_year"],sql:'base."minted_year"'},right:{node:"numberLiteral",literal:"2000",sql:"2000"}}},fieldUsage:[{path:["minted_year"]}],expressionType:"scalar",code:"minted_year >= 2000"},{type:"number",name:"minted_decade",e:{node:"*",kids:{left:{node:"function_call",overload:{returnType:{type:"number",expressionType:"scalar",evalSpace:"input"},params:[{name:"value",allowedTypes:[{type:"number",evalSpace:"input"}],isVariadic:!1}],dialect:{postgres:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},standardsql:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},duckdb:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},snowflake:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},trino:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},presto:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},mysql:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}}}},name:"floor",kids:{args:[{node:"/",kids:{left:{node:"field",path:["minted_year"]},right:{node:"numberLiteral",literal:"10"}}}]},expressionType:"scalar"},right:{node:"numberLiteral",literal:"10"}}},fieldUsage:[{path:["minted_year"]}],expressionType:"scalar",code:"floor(minted_year/10) * 10"},{type:"number",name:"percent_of_value",e:{node:"/",kids:{left:{node:"field",path:["total_value"],sql:'(CASE WHEN group_set=1 THEN\n  COALESCE(SUM(base."face_value"),0)\n  END)'},right:{node:"all",e:{node:"field",path:["total_value"]},sql:'MAX((CASE WHEN group_set=0 THEN\n  COALESCE(SUM(base."face_value"),0)\n  END)) OVER ()'}}},fieldUsage:[{path:["total_value"]},{path:["total_value"]}],ungroupings:[{requiresGroupBy:[],fieldUsage:[{path:["total_value"]}],ungroupedFields:"*"}],expressionType:"ungrouped_aggregate",code:"total_value/all(total_value)",annotation:{notes:[{text:"# percent\n"}]}},{type:"number",name:"percent_of_coins",e:{node:"/",kids:{left:{node:"field",path:["coin_count"],sql:"(CASE WHEN group_set=1 THEN\n  COUNT(1)\n  END)"},right:{node:"all",e:{node:"field",path:["coin_count"]},sql:"MAX((CASE WHEN group_set=0 THEN\n  COUNT(1)\n  END)) OVER ()"}}},fieldUsage:[{path:["coin_count"]},{path:["coin_count"]}],ungroupings:[{requiresGroupBy:[],fieldUsage:[{path:["coin_count"]}],ungroupedFields:"*"}],expressionType:"ungrouped_aggregate",code:"coin_count/all(coin_count)",annotation:{notes:[{text:"# percent\n"}]}},{type:"turtle",name:"metrics",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["total_value"]},{type:"fieldref",path:["coin_count"]},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}}],filterList:[],fieldUsage:[{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],defaultOrderBy:!0,orderBy:[{field:"total_value",dir:"desc"}]}],annotation:{}},{type:"turtle",name:"by_type",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["coin_type"]},{type:"fieldref",path:["total_value"],drillView:"metrics"},{type:"fieldref",path:["coin_count"],drillView:"metrics"},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"}],fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],filterList:[]}],annotation:{}}],parameters:{},as:"coins2",arguments:{}}},{type:"fieldReference",definition:{type:"number",name:"minted_decade",e:{node:"*",kids:{left:{node:"function_call",overload:{returnType:{type:"number",expressionType:"scalar",evalSpace:"input"},params:[{name:"value",allowedTypes:[{type:"number",evalSpace:"input"}],isVariadic:!1}],dialect:{postgres:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},standardsql:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},duckdb:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},snowflake:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},trino:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},presto:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},mysql:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}}}},name:"floor",kids:{args:[{node:"/",kids:{left:{node:"field",path:["minted_year"]},right:{node:"numberLiteral",literal:"10"}}}]},expressionType:"scalar"},right:{node:"numberLiteral",literal:"10"}}},fieldUsage:[{path:["minted_year"]}],expressionType:"scalar",code:"floor(minted_year/10) * 10"},text:"minted_decade"},{type:"fieldReference",definition:{type:"turtle",name:"metrics",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["total_value"]},{type:"fieldref",path:["coin_count"]},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}}}],filterList:[],fieldUsage:[{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],defaultOrderBy:!0,orderBy:[{field:"total_value",dir:"desc"}]}],annotation:{}},text:"metrics"},{type:"fieldReference",definition:{type:"number",name:"minted_decade",e:{node:"*",kids:{left:{node:"function_call",overload:{returnType:{type:"number",expressionType:"scalar",evalSpace:"input"},params:[{name:"value",allowedTypes:[{type:"number",evalSpace:"input"}],isVariadic:!1}],dialect:{postgres:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},standardsql:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},duckdb:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},snowflake:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},trino:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},presto:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}},mysql:{e:{node:"genericSQLExpr",kids:{args:[{node:"function_parameter",name:"value"}]},src:["FLOOR(",")"]}}}},name:"floor",kids:{args:[{node:"/",kids:{left:{node:"field",path:["minted_year"]},right:{node:"numberLiteral",literal:"10"}}}]},expressionType:"scalar"},right:{node:"numberLiteral",literal:"10"}}},fieldUsage:[{path:["minted_year"]}],expressionType:"scalar",code:"floor(minted_year/10) * 10"},text:"minted_decade"},{type:"fieldReference",definition:{type:"turtle",name:"by_type",pipeline:[{type:"reduce",queryFields:[{type:"fieldref",path:["coin_type"]},{type:"fieldref",path:["total_value"],drillView:"metrics"},{type:"fieldref",path:["coin_count"],drillView:"metrics"},{type:"fieldref",path:["percent_of_value"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"},{type:"fieldref",path:["percent_of_coins"],annotation:{inherits:{notes:[{text:"# percent\n"}]}},drillView:"metrics"}],fieldUsage:[{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["face_value"]},{path:["total_value"]},{path:["coin_count"]},{path:["percent_of_value"]},{path:["percent_of_coins"]}],filterList:[]}],annotation:{}},text:"by_type"}],imports:[]},a.queryResult={lastStageName:"__stage1",malloy:"",sql:'WITH __stage0 AS (\n  SELECT\n    group_set,\n    CASE WHEN group_set IN (1,2) THEN\n      (FLOOR(base."minted_year"*1.0/10))*10\n      END as "minted_decade__1",\n    CASE WHEN group_set=1 THEN\n      COALESCE(SUM(base."face_value"),0)\n      END as "total_value__1",\n    CASE WHEN group_set=1 THEN\n      COUNT(1)\n      END as "coin_count__1",\n    (CASE WHEN group_set=1 THEN\n      COALESCE(SUM(base."face_value"),0)\n      END)*1.0/MAX((CASE WHEN group_set=0 THEN\n      COALESCE(SUM(base."face_value"),0)\n      END)) OVER () as "percent_of_value__1",\n    (CASE WHEN group_set=1 THEN\n      COUNT(1)\n      END)*1.0/MAX((CASE WHEN group_set=0 THEN\n      COUNT(1)\n      END)) OVER () as "percent_of_coins__1",\n    CASE WHEN group_set=2 THEN\n      CASE WHEN (base."face_value"=1) THEN \'penny\' WHEN (base."face_value"=5) THEN \'nickle\' WHEN (base."face_value"=10) THEN \'dime\' WHEN (base."face_value"=25) THEN \'quarter\' ELSE NULL END\n      END as "coin_type__2",\n    CASE WHEN group_set=2 THEN\n      COALESCE(SUM(base."face_value"),0)\n      END as "total_value__2",\n    CASE WHEN group_set=2 THEN\n      COUNT(1)\n      END as "coin_count__2",\n    (CASE WHEN group_set=2 THEN\n      COALESCE(SUM(base."face_value"),0)\n      END)*1.0/MAX((CASE WHEN group_set=1 THEN\n      COALESCE(SUM(base."face_value"),0)\n      END)) OVER (PARTITION BY CASE WHEN group_set IN (1,2) THEN\n      (FLOOR(base."minted_year"*1.0/10))*10\n      END) as "percent_of_value__2",\n    (CASE WHEN group_set=2 THEN\n      COUNT(1)\n      END)*1.0/MAX((CASE WHEN group_set=1 THEN\n      COUNT(1)\n      END)) OVER (PARTITION BY CASE WHEN group_set IN (1,2) THEN\n      (FLOOR(base."minted_year"*1.0/10))*10\n      END) as "percent_of_coins__2"\n  FROM coins.csv as base\n  CROSS JOIN (SELECT UNNEST(GENERATE_SERIES(0,2,1)) as group_set  ) as group_set\n  GROUP BY 1,2,7\n)\nSELECT\n  "minted_decade__1" as "minted_decade",\n  MAX(CASE WHEN group_set=1 THEN "total_value__1" END) as "total_value",\n  MAX(CASE WHEN group_set=1 THEN "coin_count__1" END) as "coin_count",\n  MAX(CASE WHEN group_set=1 THEN "percent_of_value__1" END) as "percent_of_value",\n  MAX(CASE WHEN group_set=1 THEN "percent_of_coins__1" END) as "percent_of_coins",\n  COALESCE(LIST({\n    "coin_type": "coin_type__2", \n    "total_value": "total_value__2", \n    "coin_count": "coin_count__2", \n    "percent_of_value": "percent_of_value__2", \n    "percent_of_coins": "percent_of_coins__2"}  ORDER BY  "total_value__2" desc NULLS LAST) FILTER (WHERE group_set=2),[]) as "by_type"\nFROM __stage0\nWHERE group_set NOT IN (0)\nGROUP BY 1\nORDER BY 1 desc NULLS LAST\n',dependenciesToMaterialize:{},structs:[{type:"query_result",name:"__stage1",fields:[{name:"minted_decade",type:"number",resultMetadata:{sourceField:"minted_decade",sourceExpression:"floor(minted_year/10) * 10",sourceClasses:["minted_decade"],referenceId:"7ad837b2-b42d-4369-8a59-9a322f19fc6c",fieldKind:"dimension"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:3,character:13},end:{line:3,character:56}}}},{name:"total_value",numberType:"integer",type:"number",resultMetadata:{sourceField:"total_value",sourceExpression:"face_value.sum()",sourceClasses:["total_value"],referenceId:"bd58aa1c-dce5-4068-aab5-dd0479cc5080",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:3,character:4},end:{line:3,character:35}}},drillView:"metrics"},{name:"coin_count",numberType:"integer",type:"number",resultMetadata:{sourceField:"coin_count",sourceExpression:"count()",sourceClasses:["coin_count"],referenceId:"bbb9a84b-e341-4d60-914f-012c9471226e",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:2,character:4},end:{line:2,character:25}}},drillView:"metrics"},{name:"percent_of_value",type:"number",resultMetadata:{sourceField:"percent_of_value",sourceExpression:"total_value/all(total_value)",sourceClasses:["percent_of_value"],referenceId:"3eb96659-d8dd-4631-8003-479c8bd90a31",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:6,character:4},end:{line:7,character:52}}},annotation:{inherits:{notes:[{text:"# percent\n",at:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:6,character:4},end:{line:6,character:14}}}}]}},drillView:"metrics"},{name:"percent_of_coins",type:"number",resultMetadata:{sourceField:"percent_of_coins",sourceExpression:"coin_count/all(coin_count)",sourceClasses:["percent_of_coins"],referenceId:"59e05ad4-e99d-4ffb-b0d7-c578eebd483c",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:8,character:4},end:{line:9,character:50}}},annotation:{inherits:{notes:[{text:"# percent\n",at:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:8,character:4},end:{line:8,character:14}}}}]}},drillView:"metrics"},{type:"array",name:"by_type",fields:[{name:"coin_type",type:"string",resultMetadata:{sourceField:"coin_type",sourceExpression:"face_value ? \n    pick 'penny' when 1\n    pick 'nickle' when 5\n    pick 'dime' when 10\n    pick 'quarter' when 25\n    else null",sourceClasses:["coin_type"],referenceId:"f79f03db-f1cd-4829-9745-1cd02cf398d4",fieldKind:"dimension"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:5,character:13},end:{line:10,character:13}}},drillView:"by_type"},{name:"total_value",numberType:"integer",type:"number",resultMetadata:{sourceField:"total_value",sourceExpression:"face_value.sum()",sourceClasses:["total_value"],referenceId:"bd58aa1c-dce5-4068-aab5-dd0479cc5080",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:3,character:4},end:{line:3,character:35}}},drillView:"by_type"},{name:"coin_count",numberType:"integer",type:"number",resultMetadata:{sourceField:"coin_count",sourceExpression:"count()",sourceClasses:["coin_count"],referenceId:"bbb9a84b-e341-4d60-914f-012c9471226e",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:2,character:4},end:{line:2,character:25}}},drillView:"by_type"},{name:"percent_of_value",type:"number",resultMetadata:{sourceField:"percent_of_value",sourceExpression:"total_value/all(total_value)",sourceClasses:["percent_of_value"],referenceId:"3eb96659-d8dd-4631-8003-479c8bd90a31",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:6,character:4},end:{line:7,character:52}}},annotation:{inherits:{notes:[{text:"# percent\n",at:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:6,character:4},end:{line:6,character:14}}}}]}},drillView:"by_type"},{name:"percent_of_coins",type:"number",resultMetadata:{sourceField:"percent_of_coins",sourceExpression:"coin_count/all(coin_count)",sourceClasses:["percent_of_coins"],referenceId:"59e05ad4-e99d-4ffb-b0d7-c578eebd483c",filterList:[],fieldKind:"measure"},location:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:8,character:4},end:{line:9,character:50}}},annotation:{inherits:{notes:[{text:"# percent\n",at:{url:"file:///home/runner/work/malloydata.github.io/malloydata.github.io/src/blog/2023-11-04-data-for-kindergarten/index.malloynb",range:{start:{line:8,character:4},end:{line:8,character:14}}}}]}},drillView:"by_type"}],dialect:"duckdb",connection:"duckdb",resultMetadata:{sourceField:"by_type",filterList:[],sourceClasses:["by_type"],fieldKind:"struct",drillable:!0},annotation:{inherits:{}},elementTypeDef:{type:"record_element"},join:"many"}],dialect:"duckdb",primaryKey:"minted_decade",connection:"duckdb",resultMetadata:{sourceField:"ignoreme",filterList:[],sourceClasses:["ignoreme"],fieldKind:"struct",orderBy:[{field:"minted_decade",dir:"desc"}],drillable:!0}}],sourceExplore:"coins2",sourceArguments:{},connectionName:"duckdb",result:[{minted_decade:2020,total_value:27,coin_count:3,percent_of_value:.135678391959799,percent_of_coins:.1875,by_type:[{coin_type:"quarter",total_value:25,coin_count:1,percent_of_value:.9259259259259259,percent_of_coins:.3333333333333333},{coin_type:"penny",total_value:2,coin_count:2,percent_of_value:.07407407407407407,percent_of_coins:.6666666666666666}]},{minted_decade:2010,total_value:55,coin_count:5,percent_of_value:.27638190954773867,percent_of_coins:.3125,by_type:[{coin_type:"quarter",total_value:25,coin_count:1,percent_of_value:.45454545454545453,percent_of_coins:.2},{coin_type:"dime",total_value:20,coin_count:2,percent_of_value:.36363636363636365,percent_of_coins:.4},{coin_type:"nickle",total_value:10,coin_count:2,percent_of_value:.18181818181818182,percent_of_coins:.4}]},{minted_decade:2e3,total_value:15,coin_count:2,percent_of_value:.07537688442211055,percent_of_coins:.125,by_type:[{coin_type:"dime",total_value:10,coin_count:1,percent_of_value:.6666666666666666,percent_of_coins:.5},{coin_type:"nickle",total_value:5,coin_count:1,percent_of_value:.3333333333333333,percent_of_coins:.5}]},{minted_decade:1990,total_value:25,coin_count:1,percent_of_value:.12562814070351758,percent_of_coins:.0625,by_type:[{coin_type:"quarter",total_value:25,coin_count:1,percent_of_value:1,percent_of_coins:1}]},{minted_decade:1980,total_value:25,coin_count:1,percent_of_value:.12562814070351758,percent_of_coins:.0625,by_type:[{coin_type:"quarter",total_value:25,coin_count:1,percent_of_value:1,percent_of_coins:1}]}],totalRows:5},e.appendChild(a)})();</script>
      </div>
    </div>
    <div class="result-middle" data-result-kind="json" >
      <div class="result-inner">
        <pre><pre class="language-json" style="background-color: #FBFBFB"><span class="line"><span style="color: #000000">[</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;minted_decade&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2020</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">27</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.135678391959799</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_coins&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.1875</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;by_type&quot;</span><span style="color: #000000">: [</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;quarter&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">25</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;percent_of_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.9259259259259259</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;percent_of_coins&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.3333333333333333</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;penny&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;percent_of_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.07407407407407407</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;percent_of_coins&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.6666666666666666</span></span>
<span class="line"><span style="color: #000000">      }</span></span>
<span class="line"><span style="color: #000000">    ]</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;minted_decade&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2010</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">55</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">5</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.27638190954773867</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_coins&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.3125</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;by_type&quot;</span><span style="color: #000000">: [</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;quarter&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">25</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;percent_of_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.45454545454545453</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;percent_of_coins&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.2</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;dime&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">20</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;percent_of_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.36363636363636365</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;percent_of_coins&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.4</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;nickle&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">10</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;percent_of_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.18181818181818182</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;percent_of_coins&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.4</span></span>
<span class="line"><span style="color: #000000">      }</span></span>
<span class="line"><span style="color: #000000">    ]</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;minted_decade&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2000</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">15</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.07537688442211055</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_coins&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.125</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;by_type&quot;</span><span style="color: #000000">: [</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;dime&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">10</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;percent_of_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.6666666666666666</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;percent_of_coins&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.5</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;nickle&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">5</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;percent_of_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.3333333333333333</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;percent_of_coins&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.5</span></span>
<span class="line"><span style="color: #000000">      }</span></span>
<span class="line"><span style="color: #000000">    ]</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;minted_decade&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1990</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">25</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.12562814070351758</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_coins&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.0625</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;by_type&quot;</span><span style="color: #000000">: [</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;quarter&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">25</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;percent_of_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;percent_of_coins&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">      }</span></span>
<span class="line"><span style="color: #000000">    ]</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;minted_decade&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1980</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">25</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.12562814070351758</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;percent_of_coins&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.0625</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;by_type&quot;</span><span style="color: #000000">: [</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;quarter&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">25</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;percent_of_value&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;percent_of_coins&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">      }</span></span>
<span class="line"><span style="color: #000000">    ]</span></span>
<span class="line"><span style="color: #000000">  }</span></span>
<span class="line"><span style="color: #000000">]</span></span></pre></pre>
      </div>
    </div>
    <div class="result-middle" data-result-kind="sql" >
      <div class="result-inner">
        <pre><pre class="language-sql" style="background-color: #FBFBFB"><span class="line"><span style="color: #0000FF">WITH</span><span style="color: #000000"> __stage0 </span><span style="color: #0000FF">AS</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">SELECT</span></span>
<span class="line"><span style="color: #000000">    group_set,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set </span><span style="color: #0000FF">IN</span><span style="color: #000000"> (</span><span style="color: #098658">1</span><span style="color: #000000">,</span><span style="color: #098658">2</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      (</span><span style="color: #795E26">FLOOR</span><span style="color: #000000">(base.</span><span style="color: #A31515">&quot;minted_year&quot;</span><span style="color: #000000">*</span><span style="color: #098658">1</span><span style="color: #000000">.</span><span style="color: #098658">0</span><span style="color: #000000">/</span><span style="color: #098658">10</span><span style="color: #000000">))*</span><span style="color: #098658">10</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;minted_decade__1&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">),</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;total_value__1&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #098658">1</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_count__1&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    (</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">),</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">)*</span><span style="color: #098658">1</span><span style="color: #000000">.</span><span style="color: #098658">0</span><span style="color: #000000">/</span><span style="color: #795E26">MAX</span><span style="color: #000000">((</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">0</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">),</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">)) </span><span style="color: #0000FF">OVER</span><span style="color: #000000"> () </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_value__1&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    (</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #098658">1</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">)*</span><span style="color: #098658">1</span><span style="color: #000000">.</span><span style="color: #098658">0</span><span style="color: #000000">/</span><span style="color: #795E26">MAX</span><span style="color: #000000">((</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">0</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #098658">1</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">)) </span><span style="color: #0000FF">OVER</span><span style="color: #000000"> () </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_coins__1&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">2</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">1</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;penny&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">5</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;nickle&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">10</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;dime&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">=</span><span style="color: #098658">25</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;quarter&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">ELSE</span><span style="color: #000000"> </span><span style="color: #0000FF">NULL</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_type__2&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">2</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">),</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;total_value__2&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">2</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #098658">1</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_count__2&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    (</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">2</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">),</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">)*</span><span style="color: #098658">1</span><span style="color: #000000">.</span><span style="color: #098658">0</span><span style="color: #000000">/</span><span style="color: #795E26">MAX</span><span style="color: #000000">((</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(base.</span><span style="color: #A31515">&quot;face_value&quot;</span><span style="color: #000000">),</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">)) </span><span style="color: #0000FF">OVER</span><span style="color: #000000"> (</span><span style="color: #0000FF">PARTITION</span><span style="color: #000000"> </span><span style="color: #0000FF">BY</span><span style="color: #000000"> </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set </span><span style="color: #0000FF">IN</span><span style="color: #000000"> (</span><span style="color: #098658">1</span><span style="color: #000000">,</span><span style="color: #098658">2</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      (</span><span style="color: #795E26">FLOOR</span><span style="color: #000000">(base.</span><span style="color: #A31515">&quot;minted_year&quot;</span><span style="color: #000000">*</span><span style="color: #098658">1</span><span style="color: #000000">.</span><span style="color: #098658">0</span><span style="color: #000000">/</span><span style="color: #098658">10</span><span style="color: #000000">))*</span><span style="color: #098658">10</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_value__2&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    (</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">2</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #098658">1</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">)*</span><span style="color: #098658">1</span><span style="color: #000000">.</span><span style="color: #098658">0</span><span style="color: #000000">/</span><span style="color: #795E26">MAX</span><span style="color: #000000">((</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #098658">1</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">)) </span><span style="color: #0000FF">OVER</span><span style="color: #000000"> (</span><span style="color: #0000FF">PARTITION</span><span style="color: #000000"> </span><span style="color: #0000FF">BY</span><span style="color: #000000"> </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set </span><span style="color: #0000FF">IN</span><span style="color: #000000"> (</span><span style="color: #098658">1</span><span style="color: #000000">,</span><span style="color: #098658">2</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      (</span><span style="color: #795E26">FLOOR</span><span style="color: #000000">(base.</span><span style="color: #A31515">&quot;minted_year&quot;</span><span style="color: #000000">*</span><span style="color: #098658">1</span><span style="color: #000000">.</span><span style="color: #098658">0</span><span style="color: #000000">/</span><span style="color: #098658">10</span><span style="color: #000000">))*</span><span style="color: #098658">10</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_coins__2&quot;</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">FROM</span><span style="color: #000000"> coins.csv </span><span style="color: #0000FF">as</span><span style="color: #000000"> base</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">CROSS</span><span style="color: #000000"> </span><span style="color: #0000FF">JOIN</span><span style="color: #000000"> (</span><span style="color: #0000FF">SELECT</span><span style="color: #000000"> UNNEST(GENERATE_SERIES(</span><span style="color: #098658">0</span><span style="color: #000000">,</span><span style="color: #098658">2</span><span style="color: #000000">,</span><span style="color: #098658">1</span><span style="color: #000000">)) </span><span style="color: #0000FF">as</span><span style="color: #000000"> group_set  ) </span><span style="color: #0000FF">as</span><span style="color: #000000"> group_set</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">GROUP BY</span><span style="color: #000000"> </span><span style="color: #098658">1</span><span style="color: #000000">,</span><span style="color: #098658">2</span><span style="color: #000000">,</span><span style="color: #098658">7</span></span>
<span class="line"><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">SELECT</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #A31515">&quot;minted_decade__1&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;minted_decade&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #795E26">MAX</span><span style="color: #000000">(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;total_value__1&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;total_value&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #795E26">MAX</span><span style="color: #000000">(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_count__1&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;coin_count&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #795E26">MAX</span><span style="color: #000000">(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_value__1&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_value&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #795E26">MAX</span><span style="color: #000000">(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_coins__1&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;percent_of_coins&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(LIST({</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #A31515">&quot;coin_type&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;coin_type__2&quot;</span><span style="color: #000000">, </span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #A31515">&quot;total_value&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;total_value__2&quot;</span><span style="color: #000000">, </span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #A31515">&quot;coin_count&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;coin_count__2&quot;</span><span style="color: #000000">, </span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #A31515">&quot;percent_of_value&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;percent_of_value__2&quot;</span><span style="color: #000000">, </span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #A31515">&quot;percent_of_coins&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;percent_of_coins__2&quot;</span><span style="color: #000000">}  </span><span style="color: #0000FF">ORDER BY</span><span style="color: #000000">  </span><span style="color: #A31515">&quot;total_value__2&quot;</span><span style="color: #000000"> </span><span style="color: #0000FF">desc</span><span style="color: #000000"> NULLS </span><span style="color: #0000FF">LAST</span><span style="color: #000000">) </span><span style="color: #0000FF">FILTER</span><span style="color: #000000"> (</span><span style="color: #0000FF">WHERE</span><span style="color: #000000"> group_set=</span><span style="color: #098658">2</span><span style="color: #000000">),[]) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #A31515">&quot;by_type&quot;</span></span>
<span class="line"><span style="color: #0000FF">FROM</span><span style="color: #000000"> __stage0</span></span>
<span class="line"><span style="color: #0000FF">WHERE</span><span style="color: #000000"> group_set </span><span style="color: #0000FF">NOT</span><span style="color: #000000"> </span><span style="color: #0000FF">IN</span><span style="color: #000000"> (</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">GROUP BY</span><span style="color: #000000"> </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #0000FF">ORDER BY</span><span style="color: #000000"> </span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">desc</span><span style="color: #000000"> NULLS </span><span style="color: #0000FF">LAST</span></span>
<span class="line"></span></pre></pre>
      </div>
    </div>
  </div></div></div> 
            <div class="blog-footer linear-navigation">
              <div class="item">
                
              </div>
              <div class="item">
                
              </div>
            </div>
          </div>
        </div>
        <script src="/js/view_toggles.js"></script>
        <script src="/js/jump_to_hash.js"></script>
      </div>
    </div>
    <div id="banner_wrapper">
      <div id="banner">
        <div>
          This site uses cookies from Google to deliver its services and to analyze
          traffic.
          <a
            href="https://policies.google.com/technologies/cookies"
            target="_blank"
          >
            Learn more
          </a>
        </div>
        <button id="banner_button">I Understand</button>
      </div>
    </div>
    <script src="/js/banner.js"></script>
    <script src="/js/generated/malloy-render-0.0.282.js"></script>
  </body>
</html>
